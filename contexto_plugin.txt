ARQUITECTURA DEL PLUGIN WORDPRESS:


========================================
FILE: wp-agenda-automatizada.php
========================================
<?php
/**
 * Plugin Name: WP Agenda Automatizada
 * Description: Sistema de gestiÃ³n de citas con integraciÃ³n a Google Calendar
 * Version: 2.0.0
 * Author: Tu Nombre
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');

// Detectar entorno automÃ¡ticamente
$site_url = get_site_url();

if (strpos($site_url, 'localhost') !== false || strpos($site_url, '127.0.0.1') !== false) {
    define('AA_API_BASE_URL', 'http://localhost:3000');
} else {
    define('AA_API_BASE_URL', 'https://deoia-oauth-backend.onrender.com');
}

// ===============================
// ðŸ”¹ ORDEN CORRECTO DE INCLUSIÃ“N
// ===============================

// 0ï¸âƒ£ Componentes UI reutilizables
require_once plugin_dir_path(__FILE__) . 'admin/admin-components.php';

// 1ï¸âƒ£ Helpers y utilidades base
require_once plugin_dir_path(__FILE__) . 'includes/auth-helper.php';

// 2ï¸âƒ£ Modelos (acceso a datos)
require_once plugin_dir_path(__FILE__) . 'clientes.php';

// 3ï¸âƒ£ Servicios
require_once plugin_dir_path(__FILE__) . 'includes/services/availability-proxy.php';
require_once plugin_dir_path(__FILE__) . 'includes/services/SyncService.php';

// 4ï¸âƒ£ Controladores (lÃ³gica de negocio)
require_once plugin_dir_path(__FILE__) . 'includes/controllers/availability-controller.php';
require_once plugin_dir_path(__FILE__) . 'includes/controllers/proximasCitasController.php';
require_once plugin_dir_path(__FILE__) . 'includes/controllers/confirmController.php';
require_once plugin_dir_path(__FILE__) . 'includes/controllers/WebhooksController.php';

// 5ï¸âƒ£ Controlador de encolado (DEBE IR DESPUÃ‰S de availability-controller)
require_once plugin_dir_path(__FILE__) . 'includes/controllers/enqueueController.php';

// 6ï¸âƒ£ Vistas
require_once plugin_dir_path(__FILE__) . 'views/asistant-controls.php';
require_once plugin_dir_path(__FILE__) . 'views/admin-controls.php';

// 7ï¸âƒ£ MÃ³dulos adicionales
require_once plugin_dir_path(__FILE__) . 'asistant-user.php';
require_once plugin_dir_path(__FILE__) . 'historial-citas.php';

// 8ï¸âƒ£ Admin: Iframe Test (UI aislada)
require_once plugin_dir_path(__FILE__) . 'includes/admin/iframe-test.php';

// ================================
// ðŸ”¹ MENÃš ADMIN: Nueva UI en iframe
// ================================
function aa_render_ui_iframe() {
    $url = plugin_dir_url(__FILE__) . 'admin/ui/index.php';
    echo "<iframe src='{$url}' style='width:100%; min-height: calc(100vh - 100px); border:none;'></iframe>";
}

add_action('admin_menu', function() {
    add_menu_page(
        'Agenda Automatizada',
        'Agenda Automatizada',
        'manage_options',
        'aa_ui',
        'aa_render_ui_iframe',
        'dashicons-calendar-alt',
        3
    );
});

// ================================
// ðŸ”¹ REGISTRO DE WEBHOOKS REST API
// ================================
add_action('rest_api_init', function() {
    $webhooks_controller = new Webhooks_Controller();
    $webhooks_controller->register_routes();
});

// ================================
// ðŸ”¹ Endpoint AJAX: Guardar cita desde el frontend
// ================================
add_action('wp_ajax_nopriv_aa_save_reservation', 'aa_save_reservation');
add_action('wp_ajax_aa_save_reservation', 'aa_save_reservation');

function aa_save_reservation() {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';

    // Leer cuerpo JSON enviado desde JS
    $data = json_decode(file_get_contents('php://input'), true);

    // âœ… Validar nonce de seguridad
    if (empty($data['nonce']) || !wp_verify_nonce($data['nonce'], 'aa_reservation_nonce')) {
        wp_send_json_error(['message' => 'Error de validaciÃ³n de seguridad (nonce invÃ¡lido).']);
    }

    // âœ… Validar honeypot (campo invisible anti-bot)
    if (!empty($data['extra_field'])) {
        wp_send_json_error(['message' => 'DetecciÃ³n de bot: envÃ­o no permitido.']);
    }

    // âœ… ValidaciÃ³n bÃ¡sica de datos requeridos
    if (empty($data['servicio']) || empty($data['fecha']) || empty($data['nombre'])) {
        wp_send_json_error(['message' => 'Datos incompletos.']);
    }

    // ðŸ”¹ Obtener la zona horaria configurada
    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    
    // âœ… SanitizaciÃ³n y conversiÃ³n de fecha a la zona horaria del negocio
    $servicio = sanitize_text_field($data['servicio']);
    
    // ðŸ”¹ Convertir ISO UTC a DateTime en zona horaria local
    try {
        $fechaObj = new DateTime($data['fecha'], new DateTimeZone('UTC'));
        $fechaObj->setTimezone(new DateTimeZone($timezone));
        $fecha = $fechaObj->format('Y-m-d H:i:s');
    } catch (Exception $e) {
        wp_send_json_error(['message' => 'Formato de fecha invÃ¡lido.']);
    }
    
    $nombre   = sanitize_text_field($data['nombre']);
    $telefono = sanitize_text_field($data['telefono']);
    $correo   = sanitize_email($data['correo']);

    // ðŸ”¹ Buscar o crear cliente (funciÃ³n modularizada)
    $cliente_id = aa_get_or_create_cliente($nombre, $telefono, $correo);

    // âœ… InserciÃ³n en la tabla
    $result = $wpdb->insert($table, [
        'servicio'   => $servicio,
        'fecha'      => $fecha,
        'nombre'     => $nombre,
        'telefono'   => $telefono,
        'correo'     => $correo,
        'id_cliente' => $cliente_id,
        'estado'     => 'pending',
        'created_at' => current_time('mysql')
    ]);

    // âœ… Control de error
    if ($result === false) {
        error_log("âŒ Error al insertar reserva: " . $wpdb->last_error);
        wp_send_json_error([
            'message' => 'Error al guardar en la base de datos.',
            'error'   => $wpdb->last_error
        ]);
    }

    // âœ… Retornar ID de la reserva creada
    $reserva_id = $wpdb->insert_id;
    
    if (!$reserva_id) {
        error_log("âš ï¸ Reserva guardada pero no se obtuvo insert_id");
        wp_send_json_error(['message' => 'Reserva guardada pero ID no disponible.']);
    }

    error_log("âœ… Reserva guardada correctamente con ID: $reserva_id (Cliente: $cliente_id)");
    
    wp_send_json_success([
        'message' => 'Reserva almacenada correctamente.',
        'id' => $reserva_id,
        'cliente_id' => $cliente_id
    ]);
}

// ðŸ”¹ Crear tablas al activar el plugin
register_activation_hook(__FILE__, function() {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    $charset = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        servicio varchar(255) NOT NULL,
        fecha datetime NOT NULL,
        nombre varchar(255) NOT NULL,
        telefono varchar(50) NOT NULL,
        correo varchar(255),
        estado varchar(50) DEFAULT 'pending',
        calendar_uid varchar(255) DEFAULT NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY calendar_uid (calendar_uid)
    ) $charset;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
    
    aa_create_clientes_table();
    aa_add_cliente_column_to_reservas();
    aa_add_calendar_uid_column();
    
    // ðŸ”¹ Inicializar estado de sincronizaciÃ³n como vÃ¡lido
    if (get_option('aa_estado_gsync') === false) {
        add_option('aa_estado_gsync', 'valid');
    }
});

// ===============================
// ðŸ”¹ FunciÃ³n para agregar columna calendar_uid
// ===============================
function aa_add_calendar_uid_column() {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    $column_exists = $wpdb->get_results(
        $wpdb->prepare(
            "SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = %s AND TABLE_NAME = %s AND COLUMN_NAME = 'calendar_uid'",
            DB_NAME,
            $table
        )
    );
    
    if (empty($column_exists)) {
        $wpdb->query("ALTER TABLE $table ADD COLUMN calendar_uid varchar(255) DEFAULT NULL AFTER estado");
        $wpdb->query("ALTER TABLE $table ADD INDEX idx_calendar_uid (calendar_uid)");
        error_log("âœ… Columna calendar_uid agregada a aa_reservas");
    }
}

// ðŸ”¹ FunciÃ³n helper para obtener la hora actual segÃºn aa_timezone
function aa_get_current_datetime() {
    $timezone_string = get_option('aa_timezone', 'America/Mexico_City');
    
    try {
        $timezone = new DateTimeZone($timezone_string);
        $now = new DateTime('now', $timezone);
        return $now->format('Y-m-d H:i:s');
    } catch (Exception $e) {
        error_log("âŒ Error al obtener zona horaria: " . $e->getMessage());
        return current_time('mysql');
    }
}

// ===============================
// ðŸŸ  SHORTCODE: Formulario de agenda
// ===============================
function wpaa_render_form() {
    ob_start(); ?>

    <form id="agenda-form">

        <!-- Servicio -->
        <select id="servicio" name="servicio" required>
    <option value="">Motivo de la cita</option>
    <?php
    $motivos_json = get_option('aa_google_motivo', json_encode(['Cita general']));
    $motivos = json_decode($motivos_json, true);

    if (is_array($motivos) && !empty($motivos)) {
        foreach ($motivos as $motivo) {
            $motivo = esc_html($motivo);
            echo "<option value='{$motivo}'>{$motivo}</option>";
        }
    }
    ?>
    </select>

        <!-- Calendario -->
        <div id="wpagenda-calendar"></div>
        <input type="hidden" id="fecha" name="fecha" required>

        <!-- Slots -->
        <div id="aa-slot-title" class="aa-slots-title" style="display:none;"></div>
        <div id="slot-container"></div>
        <input type="hidden" id="slot-selector" name="slot" required>

        <!-- Datos del cliente -->
        <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
        <input type="tel" id="telefono" name="telefono" placeholder="TelÃ©fono" required>
        <input type="email" id="correo" name="correo" placeholder="Correo" required>

        <!-- BotÃ³n enviar -->
        <button type="submit">Agendar</button>

    </form>

    <div id="respuesta-agenda"></div>

    <?php
    return ob_get_clean();
}
add_shortcode('agenda_automatizada', 'wpaa_render_form');




========================================
FILE: assets\css\admin.css
========================================
*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }.\!container{width:100%!important}.container{width:100%}@media (min-width:640px){.\!container{max-width:640px!important}.container{max-width:640px}}@media (min-width:768px){.\!container{max-width:768px!important}.container{max-width:768px}}@media (min-width:1024px){.\!container{max-width:1024px!important}.container{max-width:1024px}}@media (min-width:1280px){.\!container{max-width:1280px!important}.container{max-width:1280px}}@media (min-width:1536px){.\!container{max-width:1536px!important}.container{max-width:1536px}}.visible{visibility:visible}.invisible{visibility:hidden}.static{position:static}.relative{position:relative}.sticky{position:sticky}.bottom-4{bottom:1rem}.mx-auto{margin-left:auto;margin-right:auto}.-ml-5{margin-left:-1.25rem}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-8{margin-left:2rem}.ml-auto{margin-left:auto}.mt-1{margin-top:.25rem}.mt-10{margin-top:2.5rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-10{height:2.5rem}.h-12{height:3rem}.h-14{height:3.5rem}.h-16{height:4rem}.h-20{height:5rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-8{height:2rem}.min-h-screen{min-height:100vh}.w-10{width:2.5rem}.w-12{width:3rem}.w-14{width:3.5rem}.w-16{width:4rem}.w-20{width:5rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-8{width:2rem}.w-full{width:100%}.min-w-\[200px\]{min-width:200px}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.resize-none{resize:none}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-8>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem*var(--tw-space-y-reverse))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px*(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px*var(--tw-divide-y-reverse))}.divide-gray-100>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgb(243 244 246/var(--tw-divide-opacity,1))}.overflow-hidden{overflow:hidden}.rounded{border-radius:.25rem}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1))}.border-green-100{--tw-border-opacity:1;border-color:rgb(220 252 231/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.border-red-200{--tw-border-opacity:1;border-color:rgb(254 202 202/var(--tw-border-opacity,1))}.bg-amber-100{--tw-bg-opacity:1;background-color:rgb(254 243 199/var(--tw-bg-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-blue-100{background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-100,.bg-blue-50{--tw-bg-opacity:1}.bg-blue-50{background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-200{background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.bg-gray-200,.bg-gray-50{--tw-bg-opacity:1}.bg-gray-50{background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-indigo-100{--tw-bg-opacity:1;background-color:rgb(224 231 255/var(--tw-bg-opacity,1))}.bg-purple-100{--tw-bg-opacity:1;background-color:rgb(243 232 255/var(--tw-bg-opacity,1))}.bg-red-100{background-color:rgb(254 226 226/var(--tw-bg-opacity,1))}.bg-red-100,.bg-red-50{--tw-bg-opacity:1}.bg-red-50{background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.bg-red-600{background-color:rgb(220 38 38/var(--tw-bg-opacity,1))}.bg-red-600,.bg-white{--tw-bg-opacity:1}.bg-white{background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right,var(--tw-gradient-stops))}.from-blue-500{--tw-gradient-from:#3b82f6 var(--tw-gradient-from-position);--tw-gradient-to:rgba(59,130,246,0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.to-indigo-600{--tw-gradient-to:#4f46e5 var(--tw-gradient-to-position)}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.px-8{padding-left:2rem;padding-right:2rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-2\.5{padding-top:.625rem;padding-bottom:.625rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pb-6{padding-bottom:1.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-normal{font-weight:400}.font-semibold{font-weight:600}.text-amber-500{--tw-text-opacity:1;color:rgb(245 158 11/var(--tw-text-opacity,1))}.text-amber-600{--tw-text-opacity:1;color:rgb(217 119 6/var(--tw-text-opacity,1))}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-700{--tw-text-opacity:1;color:rgb(21 128 61/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.text-red-800{color:rgb(153 27 27/var(--tw-text-opacity,1))}.text-red-800,.text-white{--tw-text-opacity:1}.text-white{color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-lg,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline{outline-style:solid}.ring-2{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.ring-blue-500{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-300{transition-duration:.3s}.aa-root{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;color:#111827}.aa-root input:not([type=checkbox]):not([type=radio]),.aa-root select,.aa-root textarea{border-radius:.5rem;border-width:1px;--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1));--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1));padding:.5rem .75rem;--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow);font-size:.875rem}.aa-root input:focus,.aa-root select:focus,.aa-root textarea:focus{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1));outline:2px solid transparent;outline-offset:2px;--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000);--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}.aa-root input[type=checkbox],.aa-root input[type=radio]{height:1.25rem;width:1.25rem;border-radius:.25rem;--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1));--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1));-webkit-appearance:auto;-moz-appearance:auto;appearance:auto}.aa-root label{font-size:.875rem;line-height:1.25rem;font-weight:500;color:rgb(55 65 81/var(--tw-text-opacity,1))}.aa-root h2,.aa-root label{--tw-text-opacity:1}.aa-root h2{font-size:1.125rem;line-height:1.75rem;font-weight:600;color:rgb(17 24 39/var(--tw-text-opacity,1))}.aa-accordion-body{overflow:hidden;max-height:0;transition:max-height .3s ease-out}.aa-accordion.is-open .aa-accordion-body{max-height:2000px}.aa-accordion-header{cursor:pointer}.aa-accordion-header:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.aa-accordion-icon{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.3s}.aa-accordion.is-open .aa-accordion-icon{transform:rotate(180deg)}.aa-root .space-y-2>*+*{margin-top:.5rem}.aa-root .space-y-3>*+*{margin-top:.75rem}.aa-root .space-y-4>*+*{margin-top:1rem}.hover\:border-gray-200:hover{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-red-100:hover{--tw-bg-opacity:1;background-color:rgb(254 226 226/var(--tw-bg-opacity,1))}.hover\:bg-red-50:hover{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.hover\:bg-red-700:hover{--tw-bg-opacity:1;background-color:rgb(185 28 28/var(--tw-bg-opacity,1))}.hover\:text-blue-800:hover{--tw-text-opacity:1;color:rgb(30 64 175/var(--tw-text-opacity,1))}.hover\:text-red-700:hover{--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.hover\:text-red-800:hover{--tw-text-opacity:1;color:rgb(153 27 27/var(--tw-text-opacity,1))}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}@media (min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:p-8{padding:2rem}.md\:text-3xl{font-size:1.875rem;line-height:2.25rem}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}


========================================
FILE: assets\js\controllers\adminConfirmController.js
========================================
/**
 * Controlador: ConfirmaciÃ³n de Citas (Admin)
 * 
 * Responsable de:
 * - Callbacks para confirmar/cancelar/crear cliente
 * - DelegaciÃ³n a ConfirmService
 * - Mostrar alertas y recargar tabla
 * 
 * NO contiene llamadas AJAX directas.
 */

window.AdminConfirmController = (function() {
    'use strict';
    
    let recargarCallback = null;
    
    /**
     * Inicializar controlador
     * @param {Function} onRecargar - Callback para recargar la tabla
     */
    function init(onRecargar) {
        recargarCallback = onRecargar;
    }
    
    /**
     * Confirmar una cita
     * @param {number} id - ID de la cita
     */
    function onConfirmar(id) {
        if (!window.ConfirmService) {
            console.error('âŒ ConfirmService no estÃ¡ cargado');
            alert('âŒ Error: Servicio de confirmaciÃ³n no disponible.');
            return;
        }
        
        window.ConfirmService.confirmar(id)
            .then(data => {
                if (data.success) {
                    alert('âœ… Cita confirmada. Se enviÃ³ correo de confirmaciÃ³n.');
                    if (recargarCallback) {
                        recargarCallback();
                    }
                } else {
                    alert('âŒ Error: ' + (data.data?.message || 'No se pudo confirmar la cita.'));
                }
            })
            .catch(err => {
                console.error('Error al confirmar cita:', err);
                alert('âŒ Error de conexiÃ³n: ' + err.message);
            });
    }
    
    /**
     * Cancelar una cita
     * @param {number} id - ID de la cita
     */
    function onCancelar(id) {
        if (!window.ConfirmService) {
            console.error('âŒ ConfirmService no estÃ¡ cargado');
            alert('âŒ Error: Servicio de cancelaciÃ³n no disponible.');
            return;
        }
        
        window.ConfirmService.cancelar(id)
            .then(data => {
                if (data.success) {
                    let mensaje = 'âœ… Cita cancelada correctamente.';
                    
                    if (data.data?.calendar_deleted) {
                        mensaje += '\nðŸ—“ï¸ El evento tambiÃ©n fue eliminado de Google Calendar.';
                    }
                    
                    alert(mensaje);
                    if (recargarCallback) {
                        recargarCallback();
                    }
                } else {
                    alert('âŒ Error: ' + (data.data?.message || 'No se pudo cancelar la cita.'));
                }
            })
            .catch(err => {
                console.error('Error al cancelar cita:', err);
                alert('âŒ Error de conexiÃ³n: ' + err.message);
            });
    }
    
    /**
     * Crear cliente desde una cita
     * @param {number} reservaId - ID de la reserva
     * @param {string} nombre - Nombre del cliente
     * @param {string} telefono - TelÃ©fono del cliente
     * @param {string} correo - Correo del cliente
     */
    function onCrearCliente(reservaId, nombre, telefono, correo) {
        if (!window.ConfirmService) {
            console.error('âŒ ConfirmService no estÃ¡ cargado');
            alert('âŒ Error: Servicio de clientes no disponible.');
            return;
        }
        
        window.ConfirmService.crearClienteDesdeCita(reservaId, nombre, telefono, correo)
            .then(data => {
                if (data.success) {
                    alert('âœ… ' + data.data.message);
                    if (recargarCallback) {
                        recargarCallback();
                    }
                } else {
                    alert('âŒ Error: ' + (data.data?.message || 'No se pudo crear el cliente.'));
                }
            })
            .catch(err => {
                console.error('Error al crear cliente desde cita:', err);
                alert('âŒ Error de conexiÃ³n: ' + err.message);
            });
    }
    
    // ===============================
    // ðŸ”¹ API PÃºblica
    // ===============================
    return {
        init,
        onConfirmar,
        onCancelar,
        onCrearCliente
    };
})();



========================================
FILE: assets\js\controllers\adminReservationController.js
========================================
// ==============================
// ðŸ”¹ Admin Reservation Controller
// ==============================

export function initAdminReservationController(config) {
  const {
    btnToggle,
    formNuevaCita,
    btnCancelar,
    form
  } = config;

  if (!btnToggle || !formNuevaCita || !form) {
    console.error('âŒ No se encontraron los elementos del formulario de admin');
    return;
  }

  // Toggle formulario
  btnToggle.addEventListener('click', function() {
    formNuevaCita.classList.toggle('visible');
    if (formNuevaCita.classList.contains('visible')) {
      btnToggle.textContent = 'âˆ’ Ocultar formulario';
    } else {
      btnToggle.textContent = '+ Crear nueva cita';
    }
  });

  // Cancelar formulario
  if (btnCancelar) {
    btnCancelar.addEventListener('click', function() {
      formNuevaCita.classList.remove('visible');
      btnToggle.textContent = '+ Crear nueva cita';
      form.reset();
      document.getElementById('slot-container-admin').innerHTML = '';
    });
  }

  // ==============================
  // ðŸ”¹ EnvÃ­o del formulario (USANDO ReservationService)
  // ==============================
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const clienteSelect = document.getElementById('cita-cliente');
    const slotSelector = document.getElementById('slot-selector-admin');
    const selectedSlotISO = slotSelector ? slotSelector.value : null;

    if (!selectedSlotISO) {
      alert('âŒ Por favor, selecciona una fecha y hora vÃ¡lidas.');
      return;
    }

    const clienteOption = clienteSelect.options[clienteSelect.selectedIndex];

    const datos = {
      servicio: document.getElementById('cita-servicio').value,
      fecha: selectedSlotISO,
      nombre: clienteOption.dataset.nombre,
      telefono: clienteOption.dataset.telefono,
      correo: clienteOption.dataset.correo,
      nonce: aa_asistant_vars.nonce_crear_cita || ''
    };

    try {
      // ðŸ”¹ PASO 1: Guardar la reserva usando ReservationService
      const data = await window.ReservationService.saveReservation(datos);

      // ðŸ”¹ PASO 2: AÃ±adir ID de la reserva
      if (data.data && data.data.id) {
        datos.id_reserva = data.data.id;
        console.log('ðŸ†” ID de reserva asignado:', datos.id_reserva);
      } else if (data.id) {
        datos.id_reserva = data.id;
        console.warn('âš ï¸ ID de reserva recibido en formato alternativo:', datos.id_reserva);
      } else {
        console.warn('âš ï¸ No se recibiÃ³ ID de reserva en la respuesta del backend.');
      }

      // ðŸ”¹ PASO 3: Enviar confirmaciÃ³n usando ReservationService (sin bloquear)
      window.ReservationService.sendConfirmation(datos).catch(emailError => {
        console.warn('âš ï¸ Error al enviar correo (no crÃ­tico):', emailError);
      });

      // ðŸ”¹ PASO 4: Mostrar mensaje de Ã©xito y recargar
      alert('âœ… Cita agendada correctamente. Se ha enviado correo de confirmaciÃ³n.');
      location.reload();

    } catch (err) {
      console.error('âŒ Error al agendar:', err);
      alert('âŒ Error al agendar: ' + err.message);
    }
  });

  console.log('âœ… AdminReservationController inicializado');
}

// ==============================
// ðŸ”¹ Exponer en window para compatibilidad
// ==============================
window.AdminReservationController = {
  init: initAdminReservationController
};

console.log('âœ… AdminReservationController cargado y expuesto globalmente');


========================================
FILE: assets\js\controllers\availabilityController.js
========================================
/**
 * Controlador de Disponibilidad
 */
(function() {
  'use strict';

  // ==============================
  // ðŸ”¹ Referencias locales (dentro del IIFE)
  // ==============================
  const AvailabilityService = window.AvailabilityService;
  const ymd = window.DateUtils.ymd;
  const hm = window.DateUtils.hm;

  // ==============================
  // ðŸ”¹ Variables del mÃ³dulo
  // ==============================
  let availabilityProxyInstance = null;
  let calendarInstance = null;
  let slotsInstance = null;

  // ==============================
  // ðŸ”¹ PASO 3: Renderizar UI con datos iniciales
  // ==============================
  function renderInitialUI(fechaInputSelector, slotContainerSelector, isAdmin, initialData) {
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ðŸŽ¨ RENDERIZANDO UI INICIAL');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    const fechaInput = document.querySelector(fechaInputSelector);
    if (!fechaInput) {
      console.warn(`âš ï¸ No se encontrÃ³ ${fechaInputSelector}`);
      return null;
    }

    const { availableSlotsPerDay, minDate, maxDate } = initialData;

    // FunciÃ³n helper para determinar si una fecha tiene slots
    const isDateAvailable = (date) => {
      return (availableSlotsPerDay[ymd(date)]?.length || 0) > 0;
    };

    const disableDateFn = (date) => !isDateAvailable(date);

    if (isAdmin) {
      if (typeof window.CalendarAdminUI !== 'undefined') {
        const picker = window.CalendarAdminUI.render({
          fechaInput,
          slotContainerSelector,
          slotsMap: availableSlotsPerDay,
          minDate,
          maxDate,
          disableDateFn
        });
        
        console.log('âœ… Calendario ADMIN renderizado con datos locales');
        
        // âœ… RENDERIZAR SLOTS INICIALES para la primera fecha disponible
        if (picker) {
          const firstAvailableDate = AvailabilityService.findFirstAvailable(
            minDate, 
            maxDate, 
            availableSlotsPerDay
          );
          
          if (firstAvailableDate) {
            const validSlots = availableSlotsPerDay[ymd(firstAvailableDate)] || [];
            
            console.log(`ðŸ“… Admin: Renderizando slots iniciales para ${ymd(firstAvailableDate)}`);
            console.log(`ðŸ“… Admin: ${validSlots.length} slots disponibles`);
            console.log(`ðŸ“… Admin: Slots:`, validSlots.map(s => s.toLocaleTimeString('es-MX')));
            
            // âœ… Esperar un tick para asegurar que el listener estÃ© registrado
            setTimeout(() => {
              // Disparar evento para que SlotSelectorAdminUI renderice los slots
              document.dispatchEvent(new CustomEvent('aa:admin:date-selected', {
                detail: {
                  containerId: slotContainerSelector,
                  validSlots,
                  selectedDate: firstAvailableDate,
                  fechaInput
                }
              }));
            }, 0);
            
            // Establecer fecha en Flatpickr (sin disparar onChange)
            picker.setDate(firstAvailableDate, false);
          }
        }
        
        return picker;
      } else {
        console.error('âŒ CalendarAdminUI no disponible');
      }
    } else {
      // ========== FRONTEND: Usar WPAgenda adaptadores ==========
      const calendarAdapterInstance = WPAgenda?.ui?.calendar || window.calendarDefaultAdapter.create();
      const slotsAdapterInstance = WPAgenda?.ui?.slots || window.slotsDefaultAdapter.create();

      calendarInstance = calendarAdapterInstance;
      slotsInstance = slotsAdapterInstance;

      calendarInstance.render({
        container: '#wpagenda-calendar',
        minDate,
        maxDate,
        disableDateFn,
        onDateSelected: (selectedDate) => {
          const slots = availableSlotsPerDay[ymd(selectedDate)] || [];

          // Mostrar tÃ­tulo solo si hay slots
          const titleEl = document.getElementById('aa-slot-title');
          if (slots.length > 0) {
            titleEl.innerText = 'Horarios disponibles';
            titleEl.style.display = 'block';
          } else {
            titleEl.style.display = 'none';
          }

          slotsInstance.render('#slot-container', slots, (chosenSlot) => {
            const fechaStr = ymd(selectedDate);
            const horaStr = hm(chosenSlot);
            fechaInput.value = `${fechaStr} ${horaStr}`;
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = chosenSlot.toISOString();
            }
          });

          if (slots[0]) {
            const fechaStr = ymd(selectedDate);
            const horaStr = hm(slots[0]);
            fechaInput.value = `${fechaStr} ${horaStr}`;
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = slots[0].toISOString();
            }
          }
        }
      });
      console.log('âœ… Calendario FRONTEND renderizado con WPAgenda adaptadores');
      return calendarInstance;
    }

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
  }

  // ==============================
  // ðŸ”¹ PASO 4: Iniciar consulta a Google Calendar (async)
  // ==============================
  function startGoogleCalendarSync(fechaInputSelector, slotContainerSelector, isAdmin, initialData) {
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ðŸ”„ INICIANDO SINCRONIZACIÃ“N CON GOOGLE CALENDAR');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    if (typeof window.AvailabilityProxy === 'undefined') {
      console.error("âŒ AvailabilityProxy no estÃ¡ disponible");
      return;
    }

    // Validar si existe email configurado
    const email = (typeof aa_backend !== 'undefined' && aa_backend.email) 
      ? aa_backend.email 
      : '';

    const config = {
      ajaxUrl: (typeof aa_backend !== 'undefined' && aa_backend.ajax_url) 
        ? aa_backend.ajax_url 
        : '/wp-admin/admin-ajax.php',
      action: (typeof aa_backend !== 'undefined' && aa_backend.action) 
        ? aa_backend.action 
        : 'aa_get_availability',
      email: email,
      maxAttempts: 20,
      retryInterval: 15000
    };

    // âœ… Instanciar siempre para evitar errores en UI
    availabilityProxyInstance = new window.AvailabilityProxy(config);
    window.availabilityProxyInstance = availabilityProxyInstance;
    
    // âœ… IMPORTANTE: Siempre inyectar datos locales al proxy para que onChange funcione
    const localBusyRanges = window.AvailabilityService.loadLocal();
    availabilityProxyInstance.busyRanges = localBusyRanges;
    availabilityProxyInstance.availableSlotsPerDay = initialData.availableSlotsPerDay || {};
    
    console.log(`ðŸ“Š Proxy inicializado con ${Object.keys(availabilityProxyInstance.availableSlotsPerDay).length} dÃ­as locales`);
    
    // ðŸ›‘ CLÃUSULA DE GUARDA: Si no hay email, nos quedamos en MODO LOCAL
    if (!email) {
      console.warn('âš ï¸ aa_google_email no configurado. Operando en modo LOCAL SOLAMENTE.');
      return;
    }

    console.log('âœ… Email detectado. Iniciando sincronizaciÃ³n con Google Calendar...');

    // âœ… IMPORTANTE: Registrar listener ANTES de iniciar
    const handleAvailabilityLoaded = (event) => {
      if (!event.detail || !event.detail.proxy) {
        console.warn('âš ï¸ Evento recibido sin proxy, ignorando...');
        return;
      }
      
      const proxy = event.detail.proxy;
      const { schedule, futureWindow, slotDuration } = initialData;
      const updatedSlotsMap = proxy.calculateAvailableSlots(schedule, futureWindow, slotDuration);
      
      refreshUI(fechaInputSelector, slotContainerSelector, isAdmin, {
        ...initialData,
        availableSlotsPerDay: updatedSlotsMap,
        proxy
      });
      
      console.log('âœ… UI refrescada, listener permanece activo para futuras actualizaciones');
    };

    document.addEventListener('aa:availability:loaded', handleAvailabilityLoaded);
    availabilityProxyInstance.start();
  }

  // ==============================
  // ðŸ”¹ PASO 5: Refrescar UI con datos externos
  // ==============================
  function refreshUI(fechaInputSelector, slotContainerSelector, isAdmin, updatedData) {
    console.log('ðŸ”„ Refrescando UI con datos actualizados...');
    
    const fechaInput = document.querySelector(fechaInputSelector);
    
    const hasCalendar = isAdmin ? (fechaInput && fechaInput._flatpickr) : (calendarInstance !== null);
    if (!hasCalendar) {
      console.warn('âš ï¸ No se puede refrescar: calendario no encontrado');
      return;
    }

    const { availableSlotsPerDay, minDate, maxDate, proxy } = updatedData;
    const disableDateFn = (date) => !proxy.isDateAvailable(date);

    const currentSelectedDate = isAdmin 
      ? fechaInput._flatpickr.selectedDates[0]
      : calendarInstance.getSelectedDate();

    if (isAdmin) {
      if (typeof window.CalendarAdminUI !== 'undefined') {
        const picker = window.CalendarAdminUI.render({
          fechaInput,
          slotContainerSelector,
          slotsMap: availableSlotsPerDay,
          minDate,
          maxDate,
          disableDateFn: (date) => window.AvailabilityService.disable(proxy, date)
        });
        
        console.log('âœ… Calendario ADMIN actualizado con datos de Google');
        
        const dateToSelect = currentSelectedDate && proxy.isDateAvailable(currentSelectedDate)
          ? currentSelectedDate
          : AvailabilityService.findFirstAvailable(minDate, maxDate, availableSlotsPerDay);
        
        if (dateToSelect && picker) {
          const validSlots = window.AvailabilityService.slotsForDate(proxy, dateToSelect);
          
          console.log(`ðŸ“… Admin: Actualizando slots para ${ymd(dateToSelect)}`);
          console.log(`ðŸ“… Admin: ${validSlots.length} slots disponibles (con Google)`);
          
          document.dispatchEvent(new CustomEvent('aa:admin:date-selected', {
            detail: {
              containerId: slotContainerSelector,
              validSlots,
              selectedDate: dateToSelect,
              fechaInput
            }
          }));
          
          picker.setDate(dateToSelect, false);
        }
      }
    } else {
      if (calendarInstance) {
        calendarInstance.destroy();
      }
      
      const calendarAdapterInstance = WPAgenda?.ui?.calendar || window.calendarDefaultAdapter.create();
      calendarInstance = calendarAdapterInstance;
      
      calendarInstance.render({
        container: '#wpagenda-calendar',
        minDate,
        maxDate,
        disableDateFn: (date) => window.AvailabilityService.disable(proxy, date),
        onDateSelected: (selectedDate) => {
          const slots = window.AvailabilityService.slotsForDate(proxy, selectedDate);

          // Mostrar tÃ­tulo solo si hay slots
          const titleEl = document.getElementById('aa-slot-title');
          if (slots.length > 0) {
            titleEl.innerText = 'Horarios disponibles';
            titleEl.style.display = 'block';
          } else {
            titleEl.style.display = 'none';
          }

          slotsInstance.render('#slot-container', slots, (chosenSlot) => {
            const input = document.querySelector(fechaInputSelector);
            if (input) {
              const fechaStr = ymd(selectedDate);
              const horaStr = hm(chosenSlot);
              input.value = `${fechaStr} ${horaStr}`;
            }
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = chosenSlot.toISOString();
            }
          });

          if (slots[0]) {
            const input = document.querySelector(fechaInputSelector);
            if (input) {
              const fechaStr = ymd(selectedDate);
              const horaStr = hm(slots[0]);
              input.value = `${fechaStr} ${horaStr}`;
            }
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = slots[0].toISOString();
            }
          }
        }
      });
      
      if (currentSelectedDate && proxy.isDateAvailable(currentSelectedDate)) {
        calendarInstance.setDate(currentSelectedDate, true);
      }
      
      console.log('âœ… Calendario FRONTEND actualizado con WPAgenda adaptadores');
    }
  }

  // ==============================
  // ðŸ”¹ FUNCIÃ“N PRINCIPAL
  // ==============================
  function initAvailabilityController(config) {
    const {
      fechaInputSelector,
      slotContainerSelector = '#slot-container',
      isAdmin = false
    } = config;

    console.log('\nðŸš€ INICIANDO AVAILABILITY CONTROLLER');
    console.log(`ðŸš€ Modo: ${isAdmin ? 'ADMIN' : 'FRONTEND'}\n`);

    const localBusyRanges = AvailabilityService.loadLocal();
    const initialData = AvailabilityService.calculateInitial(localBusyRanges);

    renderInitialUI(fechaInputSelector, slotContainerSelector, isAdmin, initialData);
    startGoogleCalendarSync(fechaInputSelector, slotContainerSelector, isAdmin, initialData);
  }

  // ==============================
  // ðŸ”¹ Exponer en window
  // ==============================
  window.AvailabilityController = {
    init: initAvailabilityController
  };

  console.log('âœ… AvailabilityController cargado (flujo corregido)');
})();


========================================
FILE: assets\js\controllers\proximasCitasController.js
========================================
/**
 * Controlador: PrÃ³ximas Citas
 * 
 * Responsable de:
 * - GestiÃ³n de estado (paginaciÃ³n, filtros)
 * - CoordinaciÃ³n entre UI y servicios
 * - OrquestaciÃ³n del flujo de carga
 * 
 * NO contiene llamadas AJAX directas ni renderizado de UI.
 */

window.ProximasCitasController = (function() {
    'use strict';
    
    let paginaActual = 1;
    let containerElement = null;
    let paginacionElement = null;
    
    /**
     * Inicializar controlador
     */
    function init() {
        containerElement = document.getElementById('aa-proximas-container');
        paginacionElement = document.getElementById('aa-proximas-paginacion');
        
        if (!containerElement) {
            console.warn('âš ï¸ Container de prÃ³ximas citas no encontrado');
            return;
        }
        
        // Inicializar AdminConfirmController con callback de recarga
        if (window.AdminConfirmController) {
            window.AdminConfirmController.init(cargarProximasCitas);
        }
        
        // Cargar prÃ³ximas citas al inicio
        cargarProximasCitas();
        
        // Configurar event listeners
        setupEventListeners();
    }
    
    /**
     * Configurar event listeners para filtros
     */
    function setupEventListeners() {
        // BotÃ³n buscar
        const btnBuscar = document.getElementById('aa-btn-buscar-proximas');
        if (btnBuscar) {
            btnBuscar.addEventListener('click', function() {
                paginaActual = 1;
                cargarProximasCitas();
            });
        }
        
        // BotÃ³n limpiar
        const btnLimpiar = document.getElementById('aa-btn-limpiar-proximas');
        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', function() {
                const inputBuscar = document.getElementById('aa-buscar-proximas');
                const selectOrdenar = document.getElementById('aa-ordenar-proximas');
                
                if (inputBuscar) inputBuscar.value = '';
                if (selectOrdenar) selectOrdenar.value = 'fecha_asc';
                
                paginaActual = 1;
                cargarProximasCitas();
            });
        }
        
        // Cambio en ordenamiento
        const selectOrdenar = document.getElementById('aa-ordenar-proximas');
        if (selectOrdenar) {
            selectOrdenar.addEventListener('change', function() {
                paginaActual = 1;
                cargarProximasCitas();
            });
        }
        
        // Enter en el buscador
        const inputBuscar = document.getElementById('aa-buscar-proximas');
        if (inputBuscar) {
            inputBuscar.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    paginaActual = 1;
                    cargarProximasCitas();
                }
            });
        }
    }
    
    /**
     * Cargar prÃ³ximas citas desde el servidor
     */
    function cargarProximasCitas() {
        if (!containerElement) return;
        
        const inputBuscar = document.getElementById('aa-buscar-proximas');
        const selectOrdenar = document.getElementById('aa-ordenar-proximas');
        
        const buscar = inputBuscar ? inputBuscar.value : '';
        const ordenar = selectOrdenar ? selectOrdenar.value : 'fecha_asc';
        
        // Mostrar estado de carga (UI)
        if (window.ProximasCitasUI) {
            window.ProximasCitasUI.mostrarCargando(containerElement);
        } else {
            containerElement.innerHTML = '<p style="text-align: center; color: #999;">â³ Cargando...</p>';
        }
        
        // Realizar llamada AJAX
        const formData = new FormData();
        formData.append('action', 'aa_get_proximas_citas');
        formData.append('buscar', buscar);
        formData.append('ordenar', ordenar);
        formData.append('pagina', paginaActual);
        formData.append('_wpnonce', aa_proximas_vars.nonce);
        
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderizarResultados(data.data);
            } else {
                mostrarError(data.data?.message || 'No se pudo cargar las prÃ³ximas citas.');
            }
        })
        .catch(err => {
            console.error('Error al cargar prÃ³ximas citas:', err);
            mostrarError('Error de conexiÃ³n.');
        });
    }
    
    /**
     * Renderizar resultados usando el mÃ³dulo UI
     * @param {Object} data - Datos de la respuesta AJAX
     */
    function renderizarResultados(data) {
        if (!window.ProximasCitasUI) {
            console.error('âŒ MÃ³dulo ProximasCitasUI no cargado');
            if (containerElement) {
                containerElement.innerHTML = '<p style="color: #e74c3c;">âŒ Error: MÃ³dulo UI no disponible.</p>';
            }
            return;
        }
        
        if (!window.AdminConfirmController) {
            console.error('âŒ MÃ³dulo AdminConfirmController no cargado');
            if (containerElement) {
                containerElement.innerHTML = '<p style="color: #e74c3c;">âŒ Error: Controlador de confirmaciÃ³n no disponible.</p>';
            }
            return;
        }
        
        // Renderizar tabla
        window.ProximasCitasUI.renderizarProximasCitas(data.citas, containerElement, {
            onConfirmar: window.AdminConfirmController.onConfirmar,
            onCancelar: window.AdminConfirmController.onCancelar,
            onCrearCliente: window.AdminConfirmController.onCrearCliente
        });
        
        // Renderizar paginaciÃ³n
        if (paginacionElement) {
            window.ProximasCitasUI.renderizarPaginacion(
                data.pagina_actual,
                data.total_paginas,
                paginacionElement,
                function(nuevaPagina) {
                    paginaActual = nuevaPagina;
                    cargarProximasCitas();
                }
            );
        }
    }
    
    /**
     * Mostrar error usando el mÃ³dulo UI
     * @param {string} mensaje - Mensaje de error
     */
    function mostrarError(mensaje) {
        if (window.ProximasCitasUI && containerElement) {
            window.ProximasCitasUI.mostrarError(containerElement, mensaje);
        } else if (containerElement) {
            containerElement.innerHTML = '<p style="color: #e74c3c;">âŒ Error: ' + mensaje + '</p>';
        }
    }
    
    // ===============================
    // ðŸ”¹ API PÃºblica
    // ===============================
    return {
        init
    };
})();

// ===============================
// ðŸ”¹ Auto-inicializaciÃ³n
// ===============================
document.addEventListener('DOMContentLoaded', function() {
    if (window.ProximasCitasController) {
        window.ProximasCitasController.init();
    }
});



========================================
FILE: assets\js\controllers\reservationController.js
========================================
// ==============================
// ðŸ”¹ Controlador de reservas
// ==============================

/**
 * Inicializa el controlador de reservas
 */
function initReservationController(formSelector) {
  const form = document.querySelector(formSelector);
  
  if (!form) {
    console.error(`âŒ No se encontrÃ³ el formulario: ${formSelector}`);
    return;
  }

  // âœ… Crear campo honeypot invisible anti-bot
  const honeypot = document.createElement('input');
  honeypot.type = 'text';
  honeypot.name = 'extra_field';
  honeypot.style.display = 'none';
  form.appendChild(honeypot);

  // ==============================
  // ðŸ”¹ Manejar envÃ­o del formulario
  // ==============================
  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const respuestaDiv = document.getElementById('respuesta-agenda');
    
    if (!respuestaDiv) {
      console.error('âŒ No se encontrÃ³ el div de respuesta');
      return;
    }

    respuestaDiv.innerText = 'Procesando solicitud...';

    // ðŸ”¹ Obtener el slot seleccionado del selector
    const slotSelector = document.getElementById('slot-selector');
    const selectedSlotISO = slotSelector ? slotSelector.value : null;
    
    // ðŸ”¹ Validar que se haya seleccionado un horario
    if (!selectedSlotISO) {
      respuestaDiv.innerText = 'âŒ Por favor, selecciona una fecha y hora vÃ¡lidas.';
      console.warn('âš ï¸ No se ha seleccionado ningÃºn horario');
      return;
    }

    // ðŸ”¹ Construir objeto de datos
    const datos = {
      servicio: form.servicio.value,
      fecha: selectedSlotISO,
      nombre: form.nombre.value,
      telefono: form.telefono.value,
      correo: form.correo.value || '',
      nonce: wpaa_vars.nonce,
      extra_field: honeypot.value || ''
    };

    try {
      // ðŸ”¹ PASO 1: Guardar la reserva
      const data = await window.ReservationService.saveReservation(datos);

      // ðŸ”¹ PASO 2: AÃ±adir ID de la reserva
      if (data.data && data.data.id) {
        datos.id_reserva = data.data.id;
        console.log('ðŸ†” ID de reserva asignado:', datos.id_reserva);
      } else if (data.id) {
        datos.id_reserva = data.id;
        console.warn('âš ï¸ ID de reserva recibido en formato alternativo:', datos.id_reserva);
      } else {
        console.warn('âš ï¸ No se recibiÃ³ ID de reserva en la respuesta del backend.');
      }

      // ðŸ”¹ PASO 3: Enviar confirmaciÃ³n por correo (sin bloquear el flujo)
      window.ReservationService.sendConfirmation(datos).catch(emailError => {
        console.warn('âš ï¸ Error al enviar correo (no crÃ­tico):', emailError);
      });

      // ðŸ”¹ PASO 4: Formatear la fecha para WhatsApp
      const fechaObj = new Date(selectedSlotISO);
      const userLocale = (typeof wpaa_vars !== 'undefined' && wpaa_vars.locale) 
        ? wpaa_vars.locale 
        : 'es-MX';
      
      const fechaLegible = fechaObj.toLocaleString(userLocale, {
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: wpaa_vars.timezone || 'America/Mexico_City'
      });

      respuestaDiv.innerText = 'âœ… Cita agendada correctamente. Redirigiendo a WhatsApp...';

      // ðŸ”¹ PASO 5: Redirigir a WhatsApp despuÃ©s de 2 segundos
      setTimeout(() => {
        redirectToWhatsApp(datos.nombre, datos.servicio, fechaLegible, datos.telefono);
      }, 2000);

    } catch (err) {
      console.error('âŒ Error al agendar:', err);
      respuestaDiv.innerText = `âŒ Error al agendar: ${err.message}`;
    }
  });

  console.log('âœ… ReservationController inicializado');
}

/**
 * Redirige a WhatsApp con mensaje prellenado
 */
function redirectToWhatsApp(nombre, servicio, fechaLegible, telefono) {
  const whatsappNumber = (typeof wpaa_vars !== 'undefined' && wpaa_vars.whatsapp_number) 
    ? wpaa_vars.whatsapp_number 
    : '5215522992290';

  const mensaje = `Hola, soy ${nombre}. Me gustarÃ­a agendar una cita para: ${servicio} el dÃ­a ${fechaLegible}. Mi telÃ©fono es ${telefono}.`;
  
  window.location.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(mensaje)}`;
}

// ==============================
// ðŸ”¹ Exponer en window
// ==============================
window.ReservationController = {
  init: initReservationController
};

console.log('âœ… ReservationController cargado y expuesto globalmente');


========================================
FILE: assets\js\main-admin.js
========================================
// ==============================
// ðŸ”¹ Punto de entrada principal del admin
// ==============================

document.addEventListener('DOMContentLoaded', function () {
  console.log('ðŸš€ Inicializando aplicaciÃ³n admin...');

  // âœ… Inicializar controlador de disponibilidad PRIMERO
  if (typeof window.AvailabilityController !== 'undefined') {
    window.AvailabilityController.init({
      fechaInputSelector: '#cita-fecha',
      slotContainerSelector: 'slot-container-admin',
      isAdmin: true
    });
  } else {
    console.error('âŒ AvailabilityController no estÃ¡ cargado');
  }

  // âœ… Inicializar controlador de reservas
  const btnToggle = document.getElementById('btn-toggle-form-nueva-cita');
  const formNuevaCita = document.getElementById('form-nueva-cita');
  const btnCancelar = document.getElementById('btn-cancelar-cita-form');
  const form = document.getElementById('form-crear-cita-admin');

  if (typeof window.AdminReservationController !== 'undefined') {
    window.AdminReservationController.init({
      btnToggle,
      formNuevaCita,
      btnCancelar,
      form
    });
  } else {
    console.error('âŒ AdminReservationController no estÃ¡ cargado');
  }

  console.log('âœ… AplicaciÃ³n admin inicializada correctamente');
});


========================================
FILE: assets\js\main-frontend.js
========================================
// ==============================
// ðŸ”¹ Punto de entrada principal del frontend
// ==============================

document.addEventListener('DOMContentLoaded', function () {
  console.log('ðŸš€ Inicializando aplicaciÃ³n frontend...');

  // ==============================
  // ðŸ”¹ FASE 1: Validar input de fecha y configuraciÃ³n
  // ==============================
  if (typeof window.CalendarUI !== 'undefined') {
    const fechaInput = window.CalendarUI.findDateInput();
    
    if (!fechaInput) {
      console.error('âŒ No se encontrÃ³ input de fecha, abortando inicializaciÃ³n');
      return;
    }

    // Leer duraciÃ³n de slot
    const slotDuration = window.CalendarUI.getSlotDuration();
    console.log(`âœ… Input encontrado: #${fechaInput.id}`);
    console.log(`âœ… Slot duration: ${slotDuration} min`);

    // ==============================
    // ðŸ”¹ FASE 2: Inicializar calendario bÃ¡sico INMEDIATAMENTE
    // ==============================
    console.log('ðŸ“… Inicializando calendario bÃ¡sico...');
    

  } else {
    console.error('âŒ CalendarUI no estÃ¡ disponible');
  }

  // ==============================
  // ðŸ”¹ FASE 3: Inicializar controlador de disponibilidad
  // (IniciarÃ¡ el proxy y se activarÃ¡ cuando lleguen los datos)
  // ==============================
  if (typeof window.AvailabilityController !== 'undefined') {
    window.AvailabilityController.init({
      fechaInputSelector: '#fecha',
      slotContainerSelector: 'slot-container',
      isAdmin: false
    });
  } else {
    console.error('âŒ AvailabilityController no estÃ¡ cargado');
  }

  // ==============================
  // ðŸ”¹ FASE 4: Inicializar controlador de reservas
  // ==============================
  if (typeof window.ReservationController !== 'undefined') {
    window.ReservationController.init('#agenda-form');
  } else {
    console.error('âŒ ReservationController no estÃ¡ cargado');
  }

  console.log('âœ… AplicaciÃ³n frontend inicializada correctamente');
});


========================================
FILE: assets\js\services\availability\busyRanges.js
========================================
/**
 * MÃ³dulo de Busy Ranges
 */

/**
 * Generar busyRanges desde eventos ocupados
 */
function generateBusyRanges(busyEvents) {
  if (!busyEvents || !Array.isArray(busyEvents)) {
    console.warn('âš ï¸ generateBusyRanges: No se recibieron eventos vÃ¡lidos');
    return [];
  }

  console.log(`ðŸ” Generando busyRanges desde ${busyEvents.length} eventos ocupados`);
  
  const busyRanges = busyEvents.map(ev => ({
    start: new Date(ev.start),
    end: new Date(ev.end)
  }));
  
  console.log(`âœ… ${busyRanges.length} busyRanges generados`);
  
  return busyRanges;
}

/**
 * Cargar disponibilidad local desde window
 */
function loadLocalBusyRanges() {
  const localBusyRanges = [];

  if (typeof window.aa_local_availability !== 'undefined' && window.aa_local_availability.local_busy) {
    console.log('âœ… Datos locales encontrados:', window.aa_local_availability);
    
    window.aa_local_availability.local_busy.forEach((slot) => {
      const start = new Date(slot.start);
      const end = new Date(slot.end);
      
      if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
        localBusyRanges.push({ start, end });
      }
    });
    
    console.log(`ðŸ“Š Total eventos locales: ${localBusyRanges.length}`);
  } else {
    console.log('â„¹ï¸ No hay datos locales de disponibilidad');
  }
  
  return localBusyRanges;
}

// âœ… Exponer globalmente
window.BusyRanges = {
  generateBusyRanges,
  loadLocalBusyRanges
};

console.log('âœ… busyRanges.js cargado');


========================================
FILE: assets\js\services\availability\combineLocalExternal.js
========================================
/**
 * MÃ³dulo de CombinaciÃ³n de Disponibilidad Local y Externa
 */

/**
 * Combinar disponibilidad local y externa
 */
function combineLocalExternal(externalAvailability, localAvailability) {
  if (!localAvailability || !localAvailability.local_busy) {
    console.log('â„¹ï¸ No hay datos locales para combinar');
    return;
  }

  console.log("ðŸ“Š Combinando disponibilidad local con datos externos");
  
  if (!externalAvailability) {
    console.warn('âš ï¸ No hay disponibilidad externa para combinar');
    return;
  }

  const externalBusy = externalAvailability.busy || [];
  const localBusy = localAvailability.local_busy.map(slot => ({
    start: new Date(slot.start),
    end: new Date(slot.end)
  }));
  
  // âœ… COMBINAR sin duplicar
  externalAvailability.busy = [...externalBusy, ...localBusy];
  
  console.log(`âœ… Total combinado: ${externalAvailability.busy.length}`);
  console.log(`   - Google Calendar: ${externalBusy.length}`);
  console.log(`   - Local: ${localBusy.length}`);
}

// âœ… Exponer globalmente
window.CombineLocalExternal = {
  combineLocalExternal
};

console.log('âœ… combineLocalExternal.js cargado');


========================================
FILE: assets\js\services\availability\proxyFetch.js
========================================
/**
 * MÃ³dulo de Fetch con Reintentos
 */

/**
 * Construir URL de consulta
 */
function buildUrl(config) {
  const { ajaxUrl, action, email } = config;
  return `${ajaxUrl}?action=${encodeURIComponent(action)}&email=${encodeURIComponent(email)}`;
}

/**
 * Estado interno del loop de reintentos
 */
let attempts = 0;
let intervalId = null;
let dataReceived = false;

/**
 * Realizar fetch de disponibilidad (single attempt)
 */
async function fetchAvailability(config, onSuccess, onError) {
  if (dataReceived) return;

  attempts++;
  console.log(`ðŸ”„ Intento #${attempts} de consultar disponibilidad...`);

  const url = buildUrl(config);
  console.log("ðŸ“¡ Consultando disponibilidad:", url);

  try {
    const start = Date.now();
    const response = await fetch(url, { 
      method: 'GET', 
      credentials: 'same-origin' 
    });
    const duration = Date.now() - start;
    
    console.log(`ðŸ“¥ Respuesta recibida (HTTP ${response.status}) en ${duration}ms`);

    const text = await response.text();
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${text}`);
    }

    const data = JSON.parse(text);
    console.log("âœ… Datos recibidos:", data);

    // âœ… Procesar y normalizar data.busy (eventos ocupados)
    if (data.busy && Array.isArray(data.busy)) {
      console.log(`ðŸ” Procesando ${data.busy.length} eventos ocupados`);
      
      data.busy = data.busy.map(ev => {
        const start = new Date(ev.start);
        const end = new Date(ev.end);
        
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
          console.warn('âš ï¸ Evento con fechas invÃ¡lidas:', ev);
          return null;
        }
        
        return { start, end };
      }).filter(Boolean);
      
      console.log(`âœ… ${data.busy.length} eventos vÃ¡lidos procesados`);
    }

    // Guardar en window para compatibilidad
    window.aa_availability = data;
    dataReceived = true;

    // Detener reintentos
    stopFetchLoop();

    // Callback de Ã©xito
    if (onSuccess) {
      onSuccess(data);
    }

    // Emitir evento de Ã©xito
    console.log("ðŸ”” Disparando evento 'aa:availability:loaded'");
    document.dispatchEvent(new CustomEvent('aa:availability:loaded', { 
      detail: data
    }));

  } catch (err) {
    console.warn(`âš ï¸ Error en intento #${attempts}:`, err.message);
    
    if (attempts >= config.maxAttempts) {
      console.error("âŒ MÃ¡ximo de intentos alcanzado");
      stopFetchLoop();
      
      // Callback de error
      if (onError) {
        onError(err);
      }
      
      // Emitir evento de error
      document.dispatchEvent(new CustomEvent('aa:availability:error', { 
        detail: { error: err } 
      }));
    }
  }
}

/**
 * Iniciar loop de reintentos automÃ¡ticos
 */
function startFetchLoop(config, onSuccess, onError) {
  console.log("ðŸš€ Iniciando loop de fetch con reintentos");
  
  // Reset estado
  attempts = 0;
  dataReceived = false;
  
  // Primer intento inmediato
  fetchAvailability(config, onSuccess, onError);
  
  // Reintentos periÃ³dicos
  intervalId = setInterval(() => {
    fetchAvailability(config, onSuccess, onError);
  }, config.retryInterval);
}

/**
 * Detener reintentos
 */
function stopFetchLoop() {
  if (intervalId) {
    clearInterval(intervalId);
    intervalId = null;
    console.log("â¹ï¸ Loop de fetch detenido");
  }
}

/**
 * Reset estado (Ãºtil para testing o re-inicializaciÃ³n)
 */
function resetFetchState() {
  attempts = 0;
  dataReceived = false;
  stopFetchLoop();
}

// âœ… Exponer globalmente
window.ProxyFetch = {
  buildUrl,
  fetchAvailability,
  startFetchLoop,
  stopFetchLoop,
  resetFetchState
};

console.log('âœ… proxyFetch.js cargado');


========================================
FILE: assets\js\services\availability\slotCalculator.js
========================================
/**
 * MÃ³dulo de CÃ¡lculo de Slots
 */
(function() {
  'use strict';

  // âœ… Referencias locales (dentro del IIFE, no hay conflicto)
  const { ymd, getWeekdayName, getDayIntervals, generateSlotsForDay } = window.DateUtils;

  /**
   * Calcular slots disponibles para una fecha especÃ­fica
   */
  function calculateSlotsForDate(date, schedule, busyRanges, slotDuration) {
    const weekday = getWeekdayName(date);
    const intervals = getDayIntervals(schedule, weekday);
    const slots = generateSlotsForDay(date, intervals, busyRanges, slotDuration);
    
    return slots;
  }

  /**
   * Calcular slots disponibles para un rango de fechas
   */
  function calculateSlotsRange(minDate, maxDate, schedule, busyRanges, slotDuration) {
    const availableSlotsPerDay = {};
    
    console.log(`ðŸ—“ï¸ Calculando slots disponibles del ${ymd(minDate)} al ${ymd(maxDate)}`);
    console.log(`âš™ï¸ ConfiguraciÃ³n: duraciÃ³n=${slotDuration}min, eventos ocupados=${busyRanges.length}`);
    
    for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
      const day = new Date(d);
      const slots = calculateSlotsForDate(day, schedule, busyRanges, slotDuration);
      
      availableSlotsPerDay[ymd(day)] = slots;
      
      if (slots.length > 0) {
        console.log(`ðŸ“… ${ymd(day)}: ${slots.length} slots disponibles`);
      }
    }
    
    console.log(`âœ… CÃ¡lculo completado para ${Object.keys(availableSlotsPerDay).length} dÃ­as`);
    
    return availableSlotsPerDay;
  }

  // âœ… Exponer globalmente
  window.SlotCalculator = {
    calculateSlotsForDate,
    calculateSlotsRange
  };

  console.log('âœ… slotCalculator.js cargado');
})();


========================================
FILE: assets\js\services\availabilityService.js
========================================
/**
 * Servicio Proxy de Disponibilidad
 */
(function() {
  'use strict';

  // âœ… Referencias locales (dentro del IIFE)
  const { startFetchLoop, stopFetchLoop } = window.ProxyFetch;
  const { combineLocalExternal } = window.CombineLocalExternal;
  const { generateBusyRanges, loadLocalBusyRanges } = window.BusyRanges;
  const { calculateSlotsRange } = window.SlotCalculator;

  class AvailabilityProxy {
    constructor(config = {}) {
      this.ajaxUrl = config.ajaxUrl || '/wp-admin/admin-ajax.php';
      this.action = config.action || 'aa_get_availability';
      this.email = config.email || '';
      this.maxAttempts = config.maxAttempts || 20;
      this.retryInterval = config.retryInterval || 15000;
      
      this.availableSlotsPerDay = {};
      this.busyRanges = [];
    }

    calculateAvailableSlots(schedule, futureWindow, slotDuration) {
      const minDate = new Date();
      const maxDate = new Date();
      maxDate.setDate(minDate.getDate() + futureWindow);

      this.availableSlotsPerDay = calculateSlotsRange(
        minDate, 
        maxDate, 
        schedule, 
        this.busyRanges, 
        slotDuration
      );
      
      return this.availableSlotsPerDay;
    }

    isDateAvailable(date) {
      return (this.availableSlotsPerDay[window.DateUtils.ymd(date)]?.length || 0) > 0;
    }

    disableDate(date) {
      return !this.isDateAvailable(date);
    }

    getSlotsForDate(date) {
      const key = window.DateUtils.ymd(date);
      const slots = this.availableSlotsPerDay[key] || [];
      
      console.log(`ðŸ” getSlotsForDate(${key}): ${slots.length} slots disponibles`);
      
      return slots;
    }

    start() {
      console.log("ðŸš€ Iniciando AvailabilityProxy");
      
      const config = {
        ajaxUrl: this.ajaxUrl,
        action: this.action,
        email: this.email,
        maxAttempts: this.maxAttempts,
        retryInterval: this.retryInterval
      };

      const onSuccess = (data) => {
        combineLocalExternal(window.aa_availability, window.aa_local_availability);
        this.busyRanges = generateBusyRanges(window.aa_availability?.busy || []);

        console.log("ðŸ”” Disparando evento 'aa:availability:loaded' con proxy");
        document.dispatchEvent(new CustomEvent('aa:availability:loaded', { 
          detail: {
            ...data,
            busyRanges: this.busyRanges,
            proxy: this
          }
        }));
      };

      const onError = (err) => {
        console.error("âŒ Error al cargar disponibilidad:", err);
      };

      startFetchLoop(config, onSuccess, onError);
    }

    stop() {
      stopFetchLoop();
    }
  }

  // âœ… Exponer clase globalmente
  window.AvailabilityProxy = AvailabilityProxy;

  // ==============================
  // ðŸ”¹ Capa de Servicio
  // ==============================
  const AvailabilityService = {

    loadLocal() {
      return loadLocalBusyRanges();
    },

    calculateInitial(busyRanges) {
      const schedule = window.aa_schedule || {};
      const futureWindow = window.aa_future_window || 14;
      const slotDuration = parseInt(window.aa_slot_duration, 10) || 60;

      const minDate = new Date();
      const maxDate = new Date();
      maxDate.setDate(minDate.getDate() + futureWindow);

      const availableSlotsPerDay = calculateSlotsRange(
        minDate,
        maxDate,
        schedule,
        busyRanges,
        slotDuration
      );

      return {
        availableSlotsPerDay,
        schedule,
        futureWindow,
        slotDuration,
        minDate,
        maxDate
      };
    },

    findFirstAvailable(minDate, maxDate, availableSlotsPerDay) {
      for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
        const day = new Date(d);
        const slots = availableSlotsPerDay[window.DateUtils.ymd(day)] || [];
        
        if (slots.length > 0) {
          return day;
        }
      }
      
      return null;
    },

    calculate(proxy, { schedule, futureWindow, slotDuration }) {
      return proxy.calculateAvailableSlots(schedule, futureWindow, slotDuration);
    },

    disable(proxy, date) {
      return proxy.disableDate(date);
    },

    slotsForDate(proxy, date) {
      return proxy.getSlotsForDate(date);
    }
  };

  // âœ… Exponer servicio globalmente
  window.AvailabilityService = AvailabilityService;

  console.log('âœ… AvailabilityProxy cargado');
  console.log('âœ… AvailabilityService cargado');
})();


========================================
FILE: assets\js\services\confirmService.js
========================================
/**
 * Servicio: ConfirmaciÃ³n de Citas
 * 
 * Responsable de:
 * - Llamadas AJAX para confirmar citas
 * - Llamadas AJAX para cancelar citas
 * - Llamadas AJAX para crear clientes desde citas
 * 
 * NO contiene lÃ³gica de UI ni callbacks.
 */

window.ConfirmService = (function() {
    'use strict';
    
    /**
     * Confirmar una cita
     * @param {number} id - ID de la cita
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function confirmar(id) {
        const formData = new FormData();
        formData.append('action', 'aa_confirmar_cita');
        formData.append('id', id);
        formData.append('_wpnonce', aa_asistant_vars.nonce_confirmar);
        
        return fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json());
    }
    
    /**
     * Cancelar una cita
     * @param {number} id - ID de la cita
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function cancelar(id) {
        const formData = new FormData();
        formData.append('action', 'aa_cancelar_cita');
        formData.append('id', id);
        formData.append('_wpnonce', aa_asistant_vars.nonce_cancelar);
        
        return fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json());
    }
    
    /**
     * Crear cliente desde una cita
     * @param {number} reservaId - ID de la reserva
     * @param {string} nombre - Nombre del cliente
     * @param {string} telefono - TelÃ©fono del cliente
     * @param {string} correo - Correo del cliente
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function crearClienteDesdeCita(reservaId, nombre, telefono, correo) {
        const formData = new FormData();
        formData.append('action', 'aa_crear_cliente_desde_cita');
        formData.append('reserva_id', reservaId);
        formData.append('nombre', nombre);
        formData.append('telefono', telefono);
        formData.append('correo', correo);
        formData.append('_wpnonce', aa_asistant_vars.nonce_crear_cliente_desde_cita);
        
        return fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json());
    }
    
    // ===============================
    // ðŸ”¹ API PÃºblica
    // ===============================
    return {
        confirmar,
        cancelar,
        crearClienteDesdeCita
    };
})();



========================================
FILE: assets\js\services\reservationService.js
========================================
// ==============================
// ðŸ”¹ Servicio de reservas
// ==============================

/**
 * Guarda una reserva en el backend
 */
async function saveReservation(datos) {
  if (typeof wpaa_vars === 'undefined' || !wpaa_vars.ajax_url) {
    throw new Error('Variables de configuraciÃ³n no disponibles (wpaa_vars)');
  }

  console.group('ðŸ§© saveReservation: datos que se enviarÃ¡n al backend');
  console.log('Tipo de datos:', typeof datos);
  console.log('Contenido del objeto:', datos);
  console.log('Fecha ISO final enviada:', datos.fecha);
  console.groupEnd();

  // Validar estructura antes del fetch
  ['servicio', 'fecha', 'nombre', 'telefono'].forEach(campo => {
    if (!datos[campo]) {
      console.warn(`âš ï¸ El campo "${campo}" estÃ¡ vacÃ­o o indefinido`);
    }
  });

  try {
    const response = await fetch(wpaa_vars.ajax_url + '?action=aa_save_reservation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(datos)
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.data?.message || 'Error desconocido al guardar.');
    }

    console.log('âœ… Reserva guardada correctamente:', data);

    return data;
  } catch (error) {
    console.error('âŒ Error al guardar reserva:', error);
    throw error;
  }
}

/**
 * EnvÃ­a correo de confirmaciÃ³n de reserva
 */
async function sendConfirmation(datos) {
  if (typeof wpaa_vars === 'undefined' || !wpaa_vars.ajax_url) {
    throw new Error('Variables de configuraciÃ³n no disponibles (wpaa_vars)');
  }

  console.log("ðŸ“§ sendConfirmation: Enviando correo de confirmaciÃ³n...");
  console.log("ðŸ“¦ Datos:", datos);

  try {
    const response = await fetch(wpaa_vars.ajax_url + '?action=aa_enviar_confirmacion', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(datos)
    });

    const emailData = await response.json();
    
    console.log('ðŸ“§ Resultado del envÃ­o de correo:', emailData);
    
    return emailData;
  } catch (error) {
    console.warn('âš ï¸ Error al enviar correo (no crÃ­tico):', error);
    throw error;
  }
}

// ==============================
// ðŸ”¹ Exponer en window
// ==============================
window.ReservationService = {
  saveReservation,
  sendConfirmation
};

console.log('âœ… ReservationService cargado y expuesto globalmente');


========================================
FILE: assets\js\ui\calendarAdminUI.js
========================================
// ==============================
// ðŸ”¹ UI de Calendario para Admin
// ==============================

console.log('ðŸ”„ Cargando calendarAdminUI.js...');

/**
 * Renderiza el calendario admin con Flatpickr
 * @param {Object} config - ConfiguraciÃ³n del calendario admin
 */
export function render(config) {
  const {
    fechaInput,
    slotContainerSelector,
    slotsMap,
    minDate,
    maxDate,
    disableDateFn
  } = config;

  console.log('ðŸ”„ CalendarAdminUI.render() llamado con config:', config);
  
  if (!fechaInput) {
    console.error('âŒ calendarAdminUI: fechaInput no proporcionado');
    return null;
  }

  if (typeof flatpickr === "undefined") {
    console.error('âŒ calendarAdminUI: Flatpickr no estÃ¡ disponible');
    return null;
  }
  
  // Destruir instancia previa si existe
  if (fechaInput._flatpickr) {
    console.log('ðŸ—‘ï¸ Destruyendo instancia anterior de Flatpickr (admin)');
    fechaInput._flatpickr.destroy();
  }
  
  // Crear nueva instancia de Flatpickr
  const picker = flatpickr(fechaInput, {
    disableMobile: true,
    dateFormat: "d-m-Y",
    minDate,
    maxDate,
    locale: "es",
    disable: [disableDateFn],
    onChange: function(selectedDates) {
      if (!selectedDates.length) return;
      
      const selectedDate = selectedDates[0];
      
      console.log('ðŸ” DEBUG onChange:', {
        proxyExists: !!window.availabilityProxyInstance,
        proxyHasSlots: window.availabilityProxyInstance ? Object.keys(window.availabilityProxyInstance.availableSlotsPerDay || {}).length : 0,
        selectedDateKey: window.DateUtils.ymd(selectedDate)
      });
      
      const validSlots = window.AvailabilityService.slotsForDate(
        window.availabilityProxyInstance || {}, 
        selectedDate
      );
      
      console.log(`ðŸ“… Admin: Fecha seleccionada: ${selectedDate.toLocaleDateString()}`);
      console.log(`ðŸ“… Admin: Slots disponibles: ${validSlots.length}`);
      
      // Disparar evento personalizado para que SlotSelectorAdminUI lo maneje
      document.dispatchEvent(new CustomEvent('aa:admin:date-selected', {
        detail: {
          containerId: slotContainerSelector,
          validSlots,
          selectedDate,
          fechaInput
        }
      }));
    },
    onReady: function() {
      console.log('âœ… Flatpickr admin inicializado correctamente');
    }
  });
  
  console.log('âœ… Calendario admin renderizado');
  
  return picker;
}

/**
 * LEGACY: Mantener compatibilidad con cÃ³digo antiguo
 */
export function renderAdminCalendar(fechaInput, slotContainerSelector, proxy, config) {
  console.warn('âš ï¸ renderAdminCalendar() es legacy, usa render() en su lugar');
  
  return render({
    fechaInput,
    slotContainerSelector,
    slotsMap: proxy.availableSlotsPerDay,
    minDate: config.minDate,
    maxDate: config.maxDate,
    disableDateFn: (date) => window.AvailabilityService.disable(proxy, date)
  });
}

// ==============================
// ðŸ”¹ Exponer en window para compatibilidad
// ==============================
window.CalendarAdminUI = {
  render,
  renderAdminCalendar
};

console.log('âœ… CalendarAdminUI cargado y expuesto globalmente');


========================================
FILE: assets\js\ui\calendarUI.js
========================================
// ==============================
// ðŸ”¹ Funciones UI de Flatpickr
// ==============================

console.log('ðŸ”„ Cargando calendarUI.js...');

/**
 * Buscar y validar input de fecha
 */
function findDateInput() {
  const fechaInput = document.getElementById("fecha") || document.getElementById("cita-fecha");
  
  console.log('aa_debug: fechaInput =>', !!fechaInput);
  console.log('aa_debug: fechaInput ID =>', fechaInput ? fechaInput.id : 'null');

  if (!fechaInput) {
    console.warn('âš ï¸ aa_debug: No se encontrÃ³ input #fecha ni #cita-fecha');
    return null;
  }

  return fechaInput;
}

/**
 * Leer duraciÃ³n de slot desde configuraciÃ³n global
 */
function getSlotDuration() {
  const slotDuration = (typeof window.aa_slot_duration !== 'undefined') 
    ? window.aa_slot_duration 
    : 60;
  
  console.log(`âš™ï¸ DuraciÃ³n de slot configurada: ${slotDuration} minutos`);
  
  return slotDuration;
}

/**
 * Inicializa Flatpickr en modo bÃ¡sico (sin reglas de disponibilidad)
 */
function initBasicCalendar(fechaSelector) {
  console.log('ðŸ“… initBasicCalendar llamado con selector:', fechaSelector);
  
  if (typeof flatpickr === "undefined" || typeof flatpickr.l10ns === "undefined") {
    console.error('âŒ Flatpickr no estÃ¡ cargado correctamente.');
    return null;
  }

  flatpickr.localize(flatpickr.l10ns.es);
  
  const instance = flatpickr(fechaSelector, {
    disableMobile: true,
    dateFormat: "d-m-Y",
    minDate: "today",
    locale: "es",
    maxDate: new Date().fp_incr(14),
    onReady: function () {
      console.log("ðŸ“… Flatpickr inicializado correctamente (modo bÃ¡sico).");
    }
  });

  return instance;
}

/**
 * Renderiza el calendario frontend con reglas de disponibilidad
 */
function render(config) {
  const {
    fechaInput,
    minDate,
    maxDate,
    disableDateFn,
    onDateSelected
  } = config;

  console.log('ðŸ”„ CalendarUI.render() llamado con config:', config);

  if (!fechaInput || typeof flatpickr === "undefined") {
    console.error('âŒ No se puede renderizar el calendario: input o Flatpickr no disponibles');
    return null;
  }

  if (fechaInput._flatpickr) {
    console.log('ðŸ—‘ï¸ Destruyendo instancia anterior de Flatpickr');
    fechaInput._flatpickr.destroy();
  }

  const picker = flatpickr(fechaInput, {
    disableMobile: true,
    dateFormat: "d-m-Y",
    minDate: minDate,
    maxDate: maxDate,
    locale: "es",
    disable: [disableDateFn],
    onChange: function(selectedDates) {
      if (!selectedDates.length) return;
      
      const selectedDate = selectedDates[0];
      
      if (onDateSelected && typeof onDateSelected === 'function') {
        onDateSelected(selectedDate, this);
      }
    }
  });

  console.log('âœ… Flatpickr frontend renderizado con reglas de disponibilidad');

  return picker;
}

/**
 * Reconstruye el calendario con reglas de disponibilidad (LEGACY)
 */
function rebuildCalendar(options) {
  console.warn('âš ï¸ rebuildCalendar() es legacy, usa render() en su lugar');
  return render(options);
}

// ==============================
// ðŸ”¹ Exponer en window
// ==============================
window.CalendarUI = {
  findDateInput,
  getSlotDuration,
  initBasicCalendar,
  rebuildCalendar,
  render
};

console.log('âœ… CalendarUI cargado y expuesto globalmente');
console.log('   - window.CalendarUI:', window.CalendarUI);
console.log('   - Funciones disponibles:', Object.keys(window.CalendarUI));


========================================
FILE: assets\js\ui\proximasCitasUI.js
========================================
/**
 * MÃ³dulo UI: PrÃ³ximas Citas
 * 
 * Responsable exclusivamente de:
 * - Renderizado de tablas
 * - Renderizado de paginaciÃ³n
 * - AsignaciÃ³n de eventos a botones
 * - ManipulaciÃ³n del DOM
 * - Feedback visual
 * 
 * NO contiene lÃ³gica de negocio ni llamadas AJAX.
 */

window.ProximasCitasUI = (function() {
    'use strict';
    
    // ===============================
    // ðŸ”¹ Renderizar tabla de citas
    // ===============================
    function renderizarProximasCitas(citas, container, callbacks) {
        if (!container) {
            console.error('âŒ Container no proporcionado para renderizar prÃ³ximas citas');
            return;
        }
        
        if (!citas || citas.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999;">ðŸ“­ No hay prÃ³ximas citas registradas.</p>';
            return;
        }
        
        // ðŸ”¹ Wrapper para scroll horizontal
        let html = '<div class="aa-table-wrapper">';
        html += '<table class="widefat aa-table-scroll">';
        html += '<thead><tr><th>Cliente</th><th>TelÃ©fono</th><th>Servicio</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr></thead>';
        html += '<tbody>';
        
        citas.forEach(cita => {
            const estadoClass = 'aa-estado-' + cita.estado.toLowerCase();
            let estadoTexto = '';
            
            switch(cita.estado) {
                case 'confirmed':
                    estadoTexto = 'Confirmada';
                    break;
                case 'pending':
                    estadoTexto = 'Pendiente';
                    break;
                case 'cancelled':
                    estadoTexto = 'Cancelada';
                    break;
                default:
                    estadoTexto = cita.estado;
            }
            
            const fecha = new Date(cita.fecha.replace(' ', 'T'));
            const fechaFormateada = fecha.toLocaleDateString('es-MX', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            html += '<tr>';
            html += '<td>' + escapeHtml(cita.nombre) + '</td>';
            html += '<td>' + escapeHtml(cita.telefono) + '</td>';
            html += '<td>' + escapeHtml(cita.servicio) + '</td>';
            html += '<td>' + fechaFormateada + '</td>';
            html += '<td class="' + estadoClass + '">' + estadoTexto + '</td>';
            html += '<td>';
            
            // ðŸ”¹ BotÃ³n confirmar (solo si estÃ¡ pendiente)
            if (cita.estado === 'pending') {
                html += '<button class="aa-btn-confirmar" data-id="' + cita.id + '" data-nombre="' + escapeHtml(cita.nombre) + '" data-correo="' + escapeHtml(cita.correo) + '">âœ“ Confirmar</button> ';
            }
            
            // ðŸ”¹ BotÃ³n cancelar (si estÃ¡ confirmada o pendiente)
            if (cita.estado === 'confirmed' || cita.estado === 'pending') {
                html += '<button class="aa-btn-cancelar" data-id="' + cita.id + '" data-nombre="' + escapeHtml(cita.nombre) + '" data-correo="' + escapeHtml(cita.correo) + '">âœ• Cancelar</button> ';
            }
            
            // ðŸ”¹ BotÃ³n crear cliente (si no tiene id_cliente)
            if (!cita.id_cliente) {
                html += '<button class="aa-btn-crear-cliente-desde-cita" data-reserva-id="' + cita.id + '" data-nombre="' + escapeHtml(cita.nombre) + '" data-telefono="' + escapeHtml(cita.telefono) + '" data-correo="' + escapeHtml(cita.correo) + '">+ Cliente</button>';
            }
            
            html += '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += '</div>'; // Cerrar wrapper
        container.innerHTML = html;
        
        // ðŸ”¹ Asignar eventos a los botones
        asignarEventosBotones(container, callbacks);
    }
    
    // ===============================
    // ðŸ”¹ Asignar eventos a botones de acciÃ³n
    // ===============================
    function asignarEventosBotones(container, callbacks) {
        if (!callbacks) {
            console.warn('âš ï¸ No se proporcionaron callbacks para los botones');
            return;
        }
        
        // Botones de confirmar
        container.querySelectorAll('.aa-btn-confirmar').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nombre = this.dataset.nombre;
                const correo = this.dataset.correo;
                
                if (confirm('Â¿Confirmar la cita de ' + nombre + '?\n\nSe enviarÃ¡ un correo de confirmaciÃ³n a: ' + correo)) {
                    if (callbacks.onConfirmar) {
                        callbacks.onConfirmar(id);
                    }
                }
            });
        });
        
        // Botones de cancelar
        container.querySelectorAll('.aa-btn-cancelar').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nombre = this.dataset.nombre;
                const correo = this.dataset.correo;
                
                if (confirm('âš ï¸ Â¿CANCELAR la cita de ' + nombre + '?\n\nSe enviarÃ¡ un correo de cancelaciÃ³n a: ' + correo + '\n\nEsta acciÃ³n no se puede deshacer.')) {
                    if (callbacks.onCancelar) {
                        callbacks.onCancelar(id);
                    }
                }
            });
        });
        
        // Botones de crear cliente
        container.querySelectorAll('.aa-btn-crear-cliente-desde-cita').forEach(btn => {
            btn.addEventListener('click', function() {
                const reservaId = this.dataset.reservaId;
                const nombre = this.dataset.nombre;
                const telefono = this.dataset.telefono;
                const correo = this.dataset.correo;
                
                if (confirm('Â¿Crear cliente con los siguientes datos?\n\nNombre: ' + nombre + '\nTelÃ©fono: ' + telefono + '\nCorreo: ' + correo)) {
                    if (callbacks.onCrearCliente) {
                        callbacks.onCrearCliente(reservaId, nombre, telefono, correo);
                    }
                }
            });
        });
    }
    
    // ===============================
    // ðŸ”¹ Renderizar paginaciÃ³n
    // ===============================
    function renderizarPaginacion(actual, total, container, onCambiarPagina) {
        if (!container) {
            console.error('âŒ Container no proporcionado para renderizar paginaciÃ³n');
            return;
        }
        
        if (total <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<div class="aa-paginacion-botones">';
        
        // BotÃ³n anterior
        if (actual > 1) {
            html += '<button class="aa-btn-paginacion" data-pagina="' + (actual - 1) + '">Â« Anterior</button>';
        }
        
        // NÃºmeros de pÃ¡gina
        for (let i = 1; i <= total; i++) {
            if (i === actual) {
                html += '<span class="aa-pagina-actual">' + i + '</span>';
            } else if (i === 1 || i === total || (i >= actual - 2 && i <= actual + 2)) {
                html += '<button class="aa-btn-paginacion" data-pagina="' + i + '">' + i + '</button>';
            } else if (i === actual - 3 || i === actual + 3) {
                html += '<span>...</span>';
            }
        }
        
        // BotÃ³n siguiente
        if (actual < total) {
            html += '<button class="aa-btn-paginacion" data-pagina="' + (actual + 1) + '">Siguiente Â»</button>';
        }
        
        html += '</div>';
        container.innerHTML = html;
        
        // Eventos de paginaciÃ³n
        if (onCambiarPagina) {
            container.querySelectorAll('.aa-btn-paginacion').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pagina = parseInt(this.dataset.pagina);
                    onCambiarPagina(pagina);
                });
            });
        }
    }
    
    // ===============================
    // ðŸ”¹ Mostrar mensaje de carga
    // ===============================
    function mostrarCargando(container) {
        if (container) {
            container.innerHTML = '<p style="text-align: center; color: #999;">â³ Cargando...</p>';
        }
    }
    
    // ===============================
    // ðŸ”¹ Mostrar mensaje de error
    // ===============================
    function mostrarError(container, mensaje) {
        if (container) {
            container.innerHTML = '<p style="color: #e74c3c;">âŒ Error: ' + escapeHtml(mensaje || 'No se pudo cargar las prÃ³ximas citas.') + '</p>';
        }
    }
    
    // ===============================
    // ðŸ”¹ Utilidad: Escapar HTML
    // ===============================
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }
    
    // ===============================
    // ðŸ”¹ API PÃºblica
    // ===============================
    return {
        renderizarProximasCitas,
        renderizarPaginacion,
        mostrarCargando,
        mostrarError,
        escapeHtml
    };
})();


========================================
FILE: assets\js\ui\slotSelectorAdminUI.js
========================================
// ==============================
// ðŸ”¹ UI de Selector de Slots para Admin
// ==============================

console.log('ðŸ”„ Cargando slotSelectorAdminUI.js...');

/**
 * Renderiza los slots disponibles en un select para admin
 * @param {string} containerId - ID del contenedor
 * @param {Array<Date>} validSlots - Array de fechas disponibles
 * @param {Date} selectedDate - Fecha seleccionada
 * @param {HTMLElement} fechaInput - Input donde se escribe la fecha+hora final
 */
export function renderAdminSlots(containerId, validSlots, selectedDate, fechaInput) {
  const container = document.getElementById(containerId);
  
  if (!container) {
    console.warn(`âš ï¸ slotSelectorAdminUI: No se encontrÃ³ contenedor #${containerId}`);
    return;
  }
  
  // Limpiar contenedor
  container.innerHTML = '';
  
  // Caso: No hay slots disponibles
  if (!validSlots || validSlots.length === 0) {
    container.textContent = 'No hay horarios disponibles para esta fecha.';
    console.log('â„¹ï¸ slotSelectorAdminUI: Sin slots disponibles');
    return;
  }
  
  console.log(`ðŸ“‹ slotSelectorAdminUI: Renderizando ${validSlots.length} slots`);
  
  // Crear select
  const select = document.createElement('select');
  select.id = 'slot-selector-admin';
  select.className = 'slot-selector-admin';
  select.style.width = '100%';
  select.style.padding = '8px';
  select.style.marginTop = '10px';
  select.style.fontSize = '14px';
  select.style.border = '1px solid #ddd';
  select.style.borderRadius = '4px';
  
  // Agregar opciones
  validSlots.forEach((slotDate, index) => {
    const option = document.createElement('option');
    option.value = slotDate.toISOString();
    option.textContent = slotDate.toLocaleTimeString('es-MX', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    select.appendChild(option);
    
    if (index === 0) {
      option.selected = true;
    }
  });
  
  // Evento de cambio
  select.addEventListener('change', () => {
    const chosenSlot = new Date(select.value);
    const formattedDate = selectedDate.toLocaleDateString('es-MX', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    const formattedTime = chosenSlot.toLocaleTimeString('es-MX', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    fechaInput.value = `${formattedDate} ${formattedTime}`;
    
    console.log(`ðŸ•’ Slot seleccionado: ${fechaInput.value}`);
  });
  
  // Agregar al contenedor
  container.appendChild(select);
  
  // âœ… NO setear valor inicial automÃ¡ticamente
  // El valor solo debe cambiar cuando el usuario seleccione explÃ­citamente
  console.log(`âœ… Select renderizado con ${validSlots.length} opciones`);
}

/**
 * Inicializar escucha de eventos de selecciÃ³n de fecha
 */
function initEventListeners() {
  document.addEventListener('aa:admin:date-selected', (event) => {
    console.log('ðŸ“¨ slotSelectorAdminUI: Evento aa:admin:date-selected recibido');
    const { containerId, validSlots, selectedDate, fechaInput } = event.detail;
    renderAdminSlots(containerId, validSlots, selectedDate, fechaInput);
  });
  
  console.log('ðŸ‘‚ slotSelectorAdminUI: Escuchando eventos aa:admin:date-selected');
}

// âœ… IMPORTANTE: Inicializar INMEDIATAMENTE (no esperar DOMContentLoaded)
// porque availabilityController.js dispara eventos durante DOMContentLoaded
initEventListeners();

// ==============================
// ðŸ”¹ Exponer en window para compatibilidad
// ==============================
window.SlotSelectorAdminUI = {
  renderAdminSlots
};

console.log('âœ… SlotSelectorAdminUI cargado y expuesto globalmente');


========================================
FILE: assets\js\ui\slotSelectorUI.js
========================================
// ==============================
// ðŸ”¹ Funciones UI de selector de slots
// ==============================

/**
 * Renderiza selector de slots para frontend
 */
function render(containerId, validSlots, onSelectSlot) {
  const container = document.getElementById(containerId);
  
  if (!container) {
    console.warn(`âš ï¸ SlotSelectorUI: No se encontrÃ³ contenedor #${containerId}`);
    return;
  }
  
  container.innerHTML = ''; // limpiar

  if (!validSlots.length) {
    container.textContent = 'No hay horarios disponibles para este dÃ­a.';
    return;
  }

  const label = document.createElement('label');
  label.textContent = 'Horarios disponibles:';
  label.style.display = 'block';
  label.style.marginTop = '8px';

  const select = document.createElement('select');
  select.id = 'slot-selector';
  select.style.marginTop = '4px';
  select.style.width = '100%';
  select.style.padding = '4px';

  validSlots.forEach(date => {
    const option = document.createElement('option');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    option.value = date.toISOString();
    option.textContent = `${hours}:${minutes}`;
    select.appendChild(option);
  });

  select.addEventListener('change', () => {
    const chosen = new Date(select.value);
    onSelectSlot(chosen);
  });

  container.appendChild(label);
  container.appendChild(select);
}

/**
 * LEGACY: Mantener compatibilidad
 */
function renderAvailableSlots(containerId, validSlots, onSelectSlot) {
  console.warn('âš ï¸ renderAvailableSlots() es legacy, usa render() en su lugar');
  return render(containerId, validSlots, onSelectSlot);
}

// ==============================
// ðŸ”¹ Exponer en window
// ==============================
window.SlotSelectorUI = {
  render,
  renderAvailableSlots
};

console.log('âœ… SlotSelectorUI cargado y expuesto globalmente');


========================================
FILE: assets\js\ui-adapters\calendarDefaultAdapter.js
========================================
/**
 * CalendarDefaultAdapter - Adaptador de calendario nativo para WPAgenda
 * 
 * Calendario HTML puro sin dependencias externas.
 * Compatible con WPAgenda.registerCalendarAdapter().
 */

(function(global) {
    'use strict';

    const { ymd } = global.DateUtils || {};

    /**
     * Crea una instancia del adaptador de calendario.
     * @returns {Object} Adaptador con mÃ©todos render, setDate, getSelectedDate, destroy.
     */
    function create() {
        let container = null;
        let selectedDate = null;
        let viewDate = new Date();
        let config = {};

        const DAYS_ES = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
        const MONTHS_ES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        /**
         * Verifica si una fecha estÃ¡ deshabilitada.
         */
        function isDateDisabled(date) {
            if (config.minDate && date < new Date(config.minDate.setHours(0,0,0,0))) return true;
            if (config.maxDate && date > new Date(config.maxDate.setHours(23,59,59,999))) return true;
            if (config.disableDateFn && typeof config.disableDateFn === 'function') {
                return config.disableDateFn(date);
            }
            return false;
        }

        /**
         * Genera el HTML del encabezado con navegaciÃ³n.
         */
        function renderHeader() {
            return `
                <div class="aa-calendar-header">
                    <span class="aa-calendar-nav aa-calendar-prev">&lt;</span>
                    <span class="aa-calendar-title">${MONTHS_ES[viewDate.getMonth()]} ${viewDate.getFullYear()}</span>
                    <span class="aa-calendar-nav aa-calendar-next">&gt;</span>
                </div>
            `;
        }

        /**
         * Genera el HTML del grid de dÃ­as.
         */
        function renderDays() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = ymd ? ymd(new Date()) : '';

            let html = '<div class="aa-calendar-weekdays">';
            DAYS_ES.forEach(d => html += `<span>${d}</span>`);
            html += '</div><div class="aa-calendar-grid">';

            // Espacios vacÃ­os antes del primer dÃ­a
            for (let i = 0; i < firstDay; i++) {
                html += '<span class="aa-day aa-day--empty"></span>';
            }

            // DÃ­as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = ymd ? ymd(date) : '';
                const isSelected = selectedDate && ymd && ymd(selectedDate) === dateStr;
                const isToday = dateStr === today;
                const isDisabled = isDateDisabled(date);

                let classes = 'aa-day';
                if (isSelected) classes += ' aa-day--selected';
                if (isToday) classes += ' aa-day--today';
                if (isDisabled) classes += ' aa-day--disabled';

                html += `<span class="${classes}" data-date="${dateStr}">${day}</span>`;
            }

            html += '</div>';
            return html;
        }

        /**
         * Maneja el click en un dÃ­a.
         */
        function handleDayClick(e) {
            const target = e.target;
            if (!target.classList.contains('aa-day') || target.classList.contains('aa-day--disabled')) return;

            const dateStr = target.dataset.date;
            if (!dateStr) return;

            const [year, month, day] = dateStr.split('-').map(Number);
            selectedDate = new Date(year, month - 1, day);

            renderCalendar();

            if (config.onDateSelected && typeof config.onDateSelected === 'function') {
                config.onDateSelected(selectedDate);
            }
        }

        /**
         * Navega al mes anterior.
         */
        function prevMonth() {
            viewDate.setMonth(viewDate.getMonth() - 1);
            renderCalendar();
        }

        /**
         * Navega al mes siguiente.
         */
        function nextMonth() {
            viewDate.setMonth(viewDate.getMonth() + 1);
            renderCalendar();
        }

        /**
         * Renderiza el calendario completo.
         */
        function renderCalendar() {
            if (!container) return;
            container.innerHTML = `
                <div class="aa-calendar">
                    ${renderHeader()}
                    ${renderDays()}
                </div>
            `;

            container.querySelector('.aa-calendar-prev')?.addEventListener('click', prevMonth);
            container.querySelector('.aa-calendar-next')?.addEventListener('click', nextMonth);
            container.querySelector('.aa-calendar-grid')?.addEventListener('click', handleDayClick);
        }

        // =====================================================================
        // API PÃºblica del Adaptador
        // =====================================================================

        return {
            /**
             * Renderiza el calendario en el contenedor especificado.
             * @param {Object} cfg - ConfiguraciÃ³n: { container, minDate, maxDate, disableDateFn, onDateSelected }
             */
            render(cfg) {
                config = cfg || {};
                container = cfg.container instanceof HTMLElement 
                    ? cfg.container 
                    : document.querySelector(cfg.container);

                if (!container) {
                    console.error('[CalendarDefaultAdapter] Contenedor no encontrado');
                    return;
                }

                viewDate = config.minDate ? new Date(config.minDate) : new Date();
                renderCalendar();
            },

            /**
             * Establece la fecha seleccionada.
             * @param {Date} date - Fecha a seleccionar.
             * @param {boolean} triggerChange - Si true, dispara onDateSelected.
             */
            setDate(date, triggerChange = false) {
                if (!(date instanceof Date)) return;
                selectedDate = date;
                viewDate = new Date(date);
                renderCalendar();

                if (triggerChange && config.onDateSelected) {
                    config.onDateSelected(selectedDate);
                }
            },

            /**
             * Obtiene la fecha seleccionada actualmente.
             * @returns {Date|null}
             */
            getSelectedDate() {
                return selectedDate;
            },

            /**
             * Destruye el calendario y limpia el DOM.
             */
            destroy() {
                if (container) {
                    container.innerHTML = '';
                    container = null;
                }
                selectedDate = null;
                config = {};
            }
        };
    }

    // =========================================================================
    // Exportar globalmente
    // =========================================================================

    global.calendarDefaultAdapter = { create };

    console.log('âœ… calendarDefaultAdapter.js cargado');

})(window);



========================================
FILE: assets\js\ui-adapters\modalDefaultAdapter.js
========================================
/**
 * ModalDefaultAdapter - Adaptador de modal nativo para WPAgenda
 * 
 * Modal HTML puro para confirmaciÃ³n de reservas.
 * Compatible con WPAgenda.registerModalAdapter().
 */

(function(global) {
    'use strict';

    /**
     * Crea una instancia del adaptador de modal.
     * @returns {Object} Adaptador con mÃ©todos open, close, setLoading.
     */
    function create() {
        let overlayEl = null;
        let modalEl = null;
        let submitBtn = null;
        let onSubmitCallback = null;
        const originalBtnText = 'Confirmar';

        /**
         * Genera el HTML del modal.
         * @param {Object} options - { servicio, fecha, hora }
         * @returns {string}
         */
        function buildModalHTML(options) {
            const { servicio, fecha, hora } = options;

            return `
                <div class="aa-modal-overlay"></div>
                <div class="aa-modal">
                    <button type="button" class="aa-modal-close">&times;</button>
                    <h3 class="aa-modal-title">Confirmar reserva</h3>

                    <div class="aa-modal-summary">
                        <p><strong>Servicio:</strong> ${servicio || 'No especificado'}</p>
                        <p><strong>Fecha:</strong> ${fecha || ''}</p>
                        <p><strong>Hora:</strong> ${hora || ''}</p>
                    </div>

                    <form class="aa-modal-form">
                        <label for="aa-nombre">Nombre</label>
                        <input type="text" id="aa-nombre" class="aa-input" required>

                        <label for="aa-telefono">TelÃ©fono</label>
                        <input type="tel" id="aa-telefono" class="aa-input" required>

                        <label for="aa-correo">Correo</label>
                        <input type="email" id="aa-correo" class="aa-input" required>

                        <button type="submit" class="aa-btn">${originalBtnText}</button>
                    </form>
                </div>
            `;
        }

        /**
         * Maneja el envÃ­o del formulario.
         * @param {Event} e
         */
        function handleSubmit(e) {
            e.preventDefault();

            const nombre = modalEl.querySelector('#aa-nombre').value.trim();
            const telefono = modalEl.querySelector('#aa-telefono').value.trim();
            const correo = modalEl.querySelector('#aa-correo').value.trim();

            // ValidaciÃ³n simple
            if (!nombre || !telefono || !correo) {
                console.warn('[ModalDefaultAdapter] Todos los campos son obligatorios');
                return;
            }

            if (onSubmitCallback && typeof onSubmitCallback === 'function') {
                onSubmitCallback({ nombre, telefono, correo });
            }
        }

        /**
         * Remueve el modal del DOM.
         */
        function removeFromDOM() {
            if (overlayEl && overlayEl.parentNode) {
                overlayEl.parentNode.removeChild(overlayEl);
            }
            if (modalEl && modalEl.parentNode) {
                modalEl.parentNode.removeChild(modalEl);
            }
            overlayEl = null;
            modalEl = null;
            submitBtn = null;
            onSubmitCallback = null;
        }

        // =====================================================================
        // API PÃºblica del Adaptador
        // =====================================================================

        return {
            /**
             * Abre el modal con la informaciÃ³n de la reserva.
             * @param {Object} options - { servicio, fecha, hora, onSubmit }
             */
            open(options) {
                // Cerrar modal previo si existe
                this.close();

                const { onSubmit } = options || {};
                onSubmitCallback = onSubmit;

                // Crear contenedor temporal para parsear HTML
                const wrapper = document.createElement('div');
                wrapper.innerHTML = buildModalHTML(options);

                overlayEl = wrapper.querySelector('.aa-modal-overlay');
                modalEl = wrapper.querySelector('.aa-modal');
                submitBtn = modalEl.querySelector('.aa-btn');

                // Insertar en el DOM
                document.body.appendChild(overlayEl);
                document.body.appendChild(modalEl);

                // Event listeners
                overlayEl.addEventListener('click', () => this.close());
                modalEl.querySelector('.aa-modal-close')?.addEventListener('click', () => this.close());
                modalEl.querySelector('.aa-modal-form')?.addEventListener('submit', handleSubmit);
            },

            /**
             * Cierra el modal y limpia el DOM.
             */
            close() {
                removeFromDOM();
            },

            /**
             * Establece el estado de carga del botÃ³n submit.
             * @param {boolean} isLoading
             */
            setLoading(isLoading) {
                if (!submitBtn) return;

                if (isLoading) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Procesandoâ€¦';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            }
        };
    }

    // =========================================================================
    // Exportar globalmente
    // =========================================================================

    global.modalDefaultAdapter = { create };

    console.log('âœ… modalDefaultAdapter.js cargado');

})(window);



========================================
FILE: assets\js\ui-adapters\slotsDefaultAdapter.js
========================================
/**
 * SlotsDefaultAdapter - Adaptador de slots nativo para WPAgenda
 * 
 * Renderiza lista de horarios disponibles en HTML puro.
 * Compatible con WPAgenda.registerSlotsAdapter().
 */

(function(global) {
    'use strict';

    /**
     * Crea una instancia del adaptador de slots.
     * @returns {Object} Adaptador con mÃ©todos render, getSelectedSlot, clear.
     */
    function create() {
        let container = null;
        let selectedSlot = null;
        let onSelectCallback = null;

        /**
         * Formatea un Date a string HH:MM.
         * @param {Date} date
         * @returns {string}
         */
        function formatTime(date) {
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        }

        /**
         * Compara dos fechas por valor de tiempo.
         * @param {Date} a
         * @param {Date} b
         * @returns {boolean}
         */
        function isSameSlot(a, b) {
            if (!a || !b) return false;
            return a.getTime() === b.getTime();
        }

        /**
         * Maneja el click en un slot.
         * @param {Event} e
         * @param {Date[]} slots
         */
        function handleSlotClick(e, slots) {
            let target = e.target;
            
            // Si se hizo click en el span, subir al li
            if (target.tagName === 'SPAN' && target.parentElement.classList.contains('aa-slot')) {
                target = target.parentElement;
            }
            
            if (!target.classList.contains('aa-slot') || target.classList.contains('aa-slot--disabled')) return;

            const index = parseInt(target.dataset.index, 10);
            if (isNaN(index) || !slots[index]) return;

            selectedSlot = slots[index];

            // Actualizar clases visuales
            container.querySelectorAll('.aa-slot').forEach(el => {
                el.classList.remove('aa-slot--selected');
            });
            target.classList.add('aa-slot--selected');

            if (onSelectCallback && typeof onSelectCallback === 'function') {
                onSelectCallback(selectedSlot);
            }
        }

        /**
         * Renderiza el HTML de los slots.
         * @param {Date[]} slots
         */
        function renderSlots(slots) {
            if (!container) return;

            if (!slots || slots.length === 0) {
                container.innerHTML = '<p class="aa-slots-empty">No hay horarios disponibles</p>';
                return;
            }

            let html = '<ul class="aa-slots">';

            slots.forEach((slot, index) => {
                const isSelected = isSameSlot(slot, selectedSlot);
                let classes = 'aa-slot';
                if (isSelected) classes += ' aa-slot--selected';

                html += `<li class="${classes}" data-index="${index}"><span>${formatTime(slot)}</span></li>`;
            });

            html += '</ul>';
            container.innerHTML = html;

            container.querySelector('.aa-slots')?.addEventListener('click', (e) => handleSlotClick(e, slots));
        }

        // =====================================================================
        // API PÃºblica del Adaptador
        // =====================================================================

        return {
            /**
             * Renderiza los slots en el contenedor especificado.
             * @param {string|HTMLElement} containerId - Selector o elemento contenedor.
             * @param {Date[]} validSlots - Array de fechas con horarios vÃ¡lidos.
             * @param {Function} onSelectSlot - Callback al seleccionar un slot.
             */
            render(containerId, validSlots, onSelectSlot) {
                container = containerId instanceof HTMLElement
                    ? containerId
                    : document.querySelector(containerId);

                if (!container) {
                    console.error('[SlotsDefaultAdapter] Contenedor no encontrado');
                    return;
                }

                onSelectCallback = onSelectSlot;
                selectedSlot = null;
                renderSlots(validSlots);
            },

            /**
             * Obtiene el slot seleccionado actualmente.
             * @returns {Date|null}
             */
            getSelectedSlot() {
                return selectedSlot;
            },

            /**
             * Limpia el contenedor y reinicia el estado.
             */
            clear() {
                if (container) {
                    container.innerHTML = '';
                }
                selectedSlot = null;
                onSelectCallback = null;
            }
        };
    }

    // =========================================================================
    // Exportar globalmente
    // =========================================================================

    global.slotsDefaultAdapter = { create };

    console.log('âœ… slotsDefaultAdapter.js cargado');

})(window);



========================================
FILE: assets\js\ui-adapters\WPAgenda.js
========================================
/**
 * WPAgenda - API PÃºblica del Plugin
 * 
 * Este archivo define Ãºnicamente la estructura pÃºblica del namespace WPAgenda.
 * No contiene lÃ³gica de UI ni lÃ³gica de negocio.
 * 
 * Los adaptadores (calendar, slots, modal) serÃ¡n registrados externamente
 * por versiones default o premium del plugin.
 */

(function(global) {
    'use strict';

    // =========================================================================
    // Sistema interno de eventos
    // =========================================================================

    /**
     * Tabla interna de listeners para el sistema de eventos.
     * Estructura: { eventName: [callback1, callback2, ...] }
     * @private
     */
    const _eventListeners = {};

    /**
     * Registra un listener para un evento especÃ­fico.
     * 
     * @param {string} eventName - Nombre del evento a escuchar.
     * @param {Function} callback - FunciÃ³n a ejecutar cuando se emita el evento.
     * @returns {void}
     * 
     * @example
     * WPAgenda.on('dateSelected', function(data) {
     *     console.log('Fecha seleccionada:', data);
     * });
     */
    function on(eventName, callback) {
        if (typeof eventName !== 'string' || !eventName.trim()) {
            console.warn('[WPAgenda] on: eventName debe ser un string vÃ¡lido.');
            return;
        }

        if (typeof callback !== 'function') {
            console.warn('[WPAgenda] on: callback debe ser una funciÃ³n.');
            return;
        }

        if (!_eventListeners[eventName]) {
            _eventListeners[eventName] = [];
        }

        _eventListeners[eventName].push(callback);
    }

    /**
     * Emite un evento, ejecutando todos los listeners registrados.
     * 
     * @param {string} eventName - Nombre del evento a emitir.
     * @param {*} [data] - Datos opcionales a pasar a los listeners.
     * @returns {void}
     * 
     * @example
     * WPAgenda.emit('dateSelected', { date: '2025-12-04' });
     */
    function emit(eventName, data) {
        if (typeof eventName !== 'string' || !eventName.trim()) {
            console.warn('[WPAgenda] emit: eventName debe ser un string vÃ¡lido.');
            return;
        }

        const listeners = _eventListeners[eventName];

        if (!listeners || listeners.length === 0) {
            return;
        }

        listeners.forEach(function(callback) {
            try {
                callback(data);
            } catch (error) {
                console.error('[WPAgenda] Error en listener de "' + eventName + '":', error);
            }
        });
    }

    // =========================================================================
    // Contenedor de adaptadores UI
    // =========================================================================

    /**
     * Objeto que contiene los adaptadores de UI registrados.
     * Los valores serÃ¡n asignados mediante los mÃ©todos register*.
     * 
     * @property {Object|null} calendar - Adaptador para el calendario.
     * @property {Object|null} slots - Adaptador para los slots de horarios.
     * @property {Object|null} modal - Adaptador para el modal de confirmaciÃ³n.
     */
    const ui = {
        calendar: null,
        slots: null,
        modal: null
    };

    // =========================================================================
    // MÃ©todos de registro de adaptadores
    // =========================================================================

    /**
     * Valida que un adaptador tenga la estructura mÃ­nima esperada.
     * 
     * @private
     * @param {*} adapter - Adaptador a validar.
     * @param {string} adapterName - Nombre del adaptador (para mensajes de error).
     * @returns {boolean} - True si el adaptador es vÃ¡lido.
     */
    function _validateAdapter(adapter, adapterName) {
        if (!adapter || typeof adapter !== 'object') {
            console.error('[WPAgenda] ' + adapterName + ': el adaptador debe ser un objeto vÃ¡lido.');
            return false;
        }

        return true;
    }

    /**
     * Registra un adaptador para el componente Calendar.
     * 
     * @param {Object} adapter - Objeto adaptador que implementa la interfaz de calendario.
     * @returns {boolean} - True si el registro fue exitoso.
     * 
     * @example
     * WPAgenda.registerCalendarAdapter({
     *     render: function(container, options) { ... },
     *     destroy: function() { ... }
     * });
     */
    function registerCalendarAdapter(adapter) {
        if (!_validateAdapter(adapter, 'registerCalendarAdapter')) {
            return false;
        }

        ui.calendar = adapter;
        return true;
    }

    /**
     * Registra un adaptador para el componente Slots (horarios disponibles).
     * 
     * @param {Object} adapter - Objeto adaptador que implementa la interfaz de slots.
     * @returns {boolean} - True si el registro fue exitoso.
     * 
     * @example
     * WPAgenda.registerSlotsAdapter({
     *     render: function(container, slots) { ... },
     *     destroy: function() { ... }
     * });
     */
    function registerSlotsAdapter(adapter) {
        if (!_validateAdapter(adapter, 'registerSlotsAdapter')) {
            return false;
        }

        ui.slots = adapter;
        return true;
    }

    /**
     * Registra un adaptador para el componente Modal.
     * 
     * @param {Object} adapter - Objeto adaptador que implementa la interfaz de modal.
     * @returns {boolean} - True si el registro fue exitoso.
     * 
     * @example
     * WPAgenda.registerModalAdapter({
     *     open: function(options) { ... },
     *     close: function() { ... }
     * });
     */
    function registerModalAdapter(adapter) {
        if (!_validateAdapter(adapter, 'registerModalAdapter')) {
            return false;
        }

        ui.modal = adapter;
        return true;
    }

    // =========================================================================
    // Namespace global WPAgenda
    // =========================================================================

    /**
     * Namespace global del plugin WPAgenda.
     * 
     * @namespace WPAgenda
     * @property {Object} ui - Contenedor de adaptadores de UI (calendar, slots, modal).
     * @property {Function} registerCalendarAdapter - Registra un adaptador de calendario.
     * @property {Function} registerSlotsAdapter - Registra un adaptador de slots.
     * @property {Function} registerModalAdapter - Registra un adaptador de modal.
     * @property {Function} on - Registra un listener para un evento.
     * @property {Function} emit - Emite un evento con datos opcionales.
     */
    global.WPAgenda = {
        ui: ui,
        registerCalendarAdapter: registerCalendarAdapter,
        registerSlotsAdapter: registerSlotsAdapter,
        registerModalAdapter: registerModalAdapter,
        on: on,
        emit: emit
    };

})(window);



========================================
FILE: assets\js\utils\dateUtils.js
========================================
// ==============================
// ðŸ”¹ Utilidades de manejo de fechas
// ==============================

// ðŸ”¹ Convertir Date a YYYY-MM-DD en zona horaria LOCAL
const ymd = d => {
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// ðŸ”¹ Convertir Date a HH:MM en zona horaria LOCAL
const hm = (d) => {
  const hh = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  return `${hh}:${mm}`;
};

// Devuelve el nombre del dÃ­a en inglÃ©s en minÃºsculas
function getWeekdayName(date) {
  const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dayIndex = date.getDay();
  console.log(`ðŸ—“ï¸ ${date.toDateString()} -> dÃ­a ${dayIndex} (${days[dayIndex]})`);
  return days[dayIndex];
}

// Convierte "HH:MM" a minutos desde medianoche
function timeStrToMinutes(str) {
  const [h, m] = str.split(':').map(Number);
  return h * 60 + m;
}

// Convierte Date a minutos desde medianoche
function minutesFromDate(d) {
  return d.getHours() * 60 + d.getMinutes();
}

// Obtiene intervalos de un dÃ­a (convertidos a minutos)
function getDayIntervals(aa_schedule, weekday) {
  if (!aa_schedule || !aa_schedule[weekday] || !aa_schedule[weekday].enabled) return [];
  const intervals = aa_schedule[weekday].intervals || [];
  return intervals.map(iv => ({
    start: timeStrToMinutes(iv.start),
    end: timeStrToMinutes(iv.end)
  }));
}

// ==============================
// ðŸ”¹ Calcular lÃ­mites de fecha (minDate/maxDate)
// ==============================
function computeLimits(futureWindow) {
  const minDate = new Date();
  const maxDate = new Date();
  maxDate.setDate(minDate.getDate() + futureWindow);
  return { minDate, maxDate };
}

// ==============================
// ðŸ”¹ Verificar si un slot tiene suficiente espacio libre
// ==============================
function hasEnoughFreeTime(slotStart, durationMinutes, busyRanges) {
  const slotEnd = new Date(slotStart.getTime() + durationMinutes * 60000);
  
  for (const busy of busyRanges) {
    const overlaps = slotStart < busy.end && slotEnd > busy.start;
    
    if (overlaps) {
      console.log(`âŒ Slot ${slotStart.toLocaleTimeString()}-${slotEnd.toLocaleTimeString()} rechazado: intersecta con evento ${busy.start.toLocaleTimeString()}-${busy.end.toLocaleTimeString()}`);
      return false;
    }
  }
  
  return true;
}

// âœ… Verifica si un slot estÃ¡ ocupado (compatibilidad)
function isSlotBusy(slotDate, busyRanges) {
  return busyRanges.some(range => {
    return slotDate >= range.start && slotDate < range.end;
  });
}

// âœ… Genera slots disponibles para un dÃ­a con duraciÃ³n configurable
function generateSlotsForDay(date, intervals, busyRanges, slotDuration = 30) {
  const slots = [];
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();
  
  const minAvailableTime = new Date(now.getTime() + 60 * 60 * 1000); // +1 hora
  
  console.log(`ðŸ•’ Generando slots para ${ymd(date)} con duraciÃ³n de ${slotDuration} min`);
  
  intervals.forEach(iv => {
    for (let min = iv.start; min < iv.end; min += 30) {
      const slot = new Date(date);
      slot.setHours(Math.floor(min / 60), min % 60, 0, 0);
      
      if (isToday && slot < minAvailableTime) {
        continue;
      }
      
      if (hasEnoughFreeTime(slot, slotDuration, busyRanges)) {
        slots.push(slot);
      }
    }
  });
  
  console.log(`âœ… ${slots.length} slots vÃ¡lidos generados para ${ymd(date)}`);
  
  return slots;
}

// âœ… Exponer globalmente
window.DateUtils = {
  ymd,
  hm,
  getWeekdayName,
  timeStrToMinutes,
  minutesFromDate,
  getDayIntervals,
  computeLimits,
  isSlotBusy,
  hasEnoughFreeTime,
  generateSlotsForDay
};

console.log('âœ… dateUtils.js cargado y exportado');


========================================
FILE: includes\admin\iframe-test.php
========================================
<?php
/**
 * Admin UI Gateway - Container for iframe-based admin interface
 * 
 * This file acts as a gateway that:
 * 1. Registers the admin menu page
 * 2. Renders the iframe container
 * 3. Handles admin-post requests and delegates to the UI layer
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');


// ================================
// Render iframe container
// ================================
function aa_render_iframe_test_page() {
    $iframe_url = admin_url('admin-post.php?action=aa_iframe_content');
    ?>
    <div class="wrap">
        <iframe 
            id="aa-isolated-iframe"
            src="<?php echo esc_url($iframe_url); ?>"
            style="width: 100%; height: 800px; border: none;"
        ></iframe>
    </div>
    <?php
}

// ================================
// Handler: Delegate to UI layer
// ================================
add_action('admin_post_aa_iframe_content', 'aa_handle_iframe_content');

function aa_handle_iframe_content() {
    // Permission check
    if (!current_user_can('manage_options')) {
        wp_die('Acceso denegado', 'Error', ['response' => 403]);
    }
    
    // Delegate to UI entry point (module parameter is handled inside ui/index.php)
    $ui_path = plugin_dir_path(__FILE__) . 'ui/index.php';
    
    if (file_exists($ui_path)) {
        require_once $ui_path;
    } else {
        wp_die('UI no encontrada', 'Error', ['response' => 404]);
    }
}



========================================
FILE: includes\admin\ui\assets\css\admin.css
========================================
*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.19 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,fieldset,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.sr-only{width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}.absolute,.sr-only{position:absolute}.relative{position:relative}.sticky{position:sticky}.bottom-0{bottom:0}.left-0\.5{left:.125rem}.left-3{left:.75rem}.top-0\.5{top:.125rem}.top-1\/2{top:50%}.-mx-6{margin-left:-1.5rem;margin-right:-1.5rem}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.ml-auto{margin-left:auto}.mt-0\.5{margin-top:.125rem}.mt-1{margin-top:.25rem}.mt-1\.5{margin-top:.375rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-6{margin-top:1.5rem}.mt-auto{margin-top:auto}.block{display:block}.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}.hidden{display:none}.h-10{height:2.5rem}.h-16{height:4rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-8{height:2rem}.w-10{width:2.5rem}.w-11{width:2.75rem}.w-16{width:4rem}.w-28{width:7rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-8{width:2rem}.w-full{width:100%}.max-w-4xl{max-width:56rem}.max-w-5xl{max-width:64rem}.max-w-6xl{max-width:72rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.-translate-y-1\/2{--tw-translate-y:-50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;-moz-user-select:none;user-select:none}.resize-none{resize:none}.resize{resize:both}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-6{gap:1.5rem}.space-x-2>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.5rem*var(--tw-space-x-reverse));margin-left:calc(.5rem*(1 - var(--tw-space-x-reverse)))}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem*var(--tw-space-x-reverse));margin-left:calc(1rem*(1 - var(--tw-space-x-reverse)))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem*var(--tw-space-y-reverse))}.space-y-3>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.75rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.75rem*var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-5>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.25rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.25rem*var(--tw-space-y-reverse))}.overflow-hidden{overflow:hidden}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-md{border-radius:.375rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-amber-200{--tw-border-opacity:1;border-color:rgb(253 230 138/var(--tw-border-opacity,1))}.border-blue-200{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246/var(--tw-border-opacity,1))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235/var(--tw-border-opacity,1))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219/var(--tw-border-opacity,1))}.border-green-200{--tw-border-opacity:1;border-color:rgb(187 247 208/var(--tw-border-opacity,1))}.bg-amber-100{--tw-bg-opacity:1;background-color:rgb(254 243 199/var(--tw-bg-opacity,1))}.bg-amber-50{--tw-bg-opacity:1;background-color:rgb(255 251 235/var(--tw-bg-opacity,1))}.bg-amber-600{--tw-bg-opacity:1;background-color:rgb(217 119 6/var(--tw-bg-opacity,1))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgb(219 234 254/var(--tw-bg-opacity,1))}.bg-blue-50{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.bg-blue-50\/40{background-color:rgba(239,246,255,.4)}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235/var(--tw-bg-opacity,1))}.bg-emerald-100{--tw-bg-opacity:1;background-color:rgb(209 250 229/var(--tw-bg-opacity,1))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246/var(--tw-bg-opacity,1))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219/var(--tw-bg-opacity,1))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.bg-gray-50\/50{background-color:rgba(249,250,251,.5)}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231/var(--tw-bg-opacity,1))}.bg-green-50{--tw-bg-opacity:1;background-color:rgb(240 253 244/var(--tw-bg-opacity,1))}.bg-purple-100{--tw-bg-opacity:1;background-color:rgb(243 232 255/var(--tw-bg-opacity,1))}.bg-purple-600{--tw-bg-opacity:1;background-color:rgb(147 51 234/var(--tw-bg-opacity,1))}.bg-red-100{--tw-bg-opacity:1;background-color:rgb(254 226 226/var(--tw-bg-opacity,1))}.bg-red-50{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68/var(--tw-bg-opacity,1))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.bg-white\/80{background-color:hsla(0,0%,100%,.8)}.bg-gradient-to-r{background-image:linear-gradient(to right,var(--tw-gradient-stops))}.from-gray-50{--tw-gradient-from:#f9fafb var(--tw-gradient-from-position);--tw-gradient-to:rgba(249,250,251,0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.to-white{--tw-gradient-to:#fff var(--tw-gradient-to-position)}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-1\.5{padding-top:.375rem;padding-bottom:.375rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-2\.5{padding-top:.625rem;padding-bottom:.625rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-5{padding-top:1.25rem;padding-bottom:1.25rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pl-10{padding-left:2.5rem}.pr-4{padding-right:1rem}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-light{font-weight:300}.font-medium{font-weight:500}.font-semibold{font-weight:600}.text-amber-600{--tw-text-opacity:1;color:rgb(217 119 6/var(--tw-text-opacity,1))}.text-amber-700{--tw-text-opacity:1;color:rgb(180 83 9/var(--tw-text-opacity,1))}.text-amber-800{--tw-text-opacity:1;color:rgb(146 64 14/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.text-emerald-600{--tw-text-opacity:1;color:rgb(5 150 105/var(--tw-text-opacity,1))}.text-gray-400{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128/var(--tw-text-opacity,1))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99/var(--tw-text-opacity,1))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81/var(--tw-text-opacity,1))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55/var(--tw-text-opacity,1))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39/var(--tw-text-opacity,1))}.text-green-600{--tw-text-opacity:1;color:rgb(22 163 74/var(--tw-text-opacity,1))}.text-green-800{--tw-text-opacity:1;color:rgb(22 101 52/var(--tw-text-opacity,1))}.text-purple-600{--tw-text-opacity:1;color:rgb(147 51 234/var(--tw-text-opacity,1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.text-red-700{--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color),0 4px 6px -4px var(--tw-shadow-color)}.shadow-lg,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.shadow-blue-500\/25{--tw-shadow-color:rgba(59,130,246,.25);--tw-shadow:var(--tw-shadow-colored)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-shadow{transition-property:box-shadow;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-200{transition-duration:.2s}#aa-admin-app{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}#aa-settings-iframe{display:block;border:none}.placeholder\:text-gray-400::-moz-placeholder{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.placeholder\:text-gray-400::placeholder{--tw-text-opacity:1;color:rgb(156 163 175/var(--tw-text-opacity,1))}.hover\:border-blue-200:hover{--tw-border-opacity:1;border-color:rgb(191 219 254/var(--tw-border-opacity,1))}.hover\:bg-amber-700:hover{--tw-bg-opacity:1;background-color:rgb(180 83 9/var(--tw-bg-opacity,1))}.hover\:bg-blue-50:hover{--tw-bg-opacity:1;background-color:rgb(239 246 255/var(--tw-bg-opacity,1))}.hover\:bg-blue-50\/30:hover{background-color:rgba(239,246,255,.3)}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216/var(--tw-bg-opacity,1))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251/var(--tw-bg-opacity,1))}.hover\:bg-purple-700:hover{--tw-bg-opacity:1;background-color:rgb(126 34 206/var(--tw-bg-opacity,1))}.hover\:bg-red-50:hover{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38/var(--tw-bg-opacity,1))}.hover\:text-blue-700:hover{--tw-text-opacity:1;color:rgb(29 78 216/var(--tw-text-opacity,1))}.hover\:text-red-500:hover{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.hover\:text-red-700:hover{--tw-text-opacity:1;color:rgb(185 28 28/var(--tw-text-opacity,1))}.hover\:shadow-xl:hover{--tw-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color),0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.hover\:shadow-blue-500\/30:hover{--tw-shadow-color:rgba(59,130,246,.3);--tw-shadow:var(--tw-shadow-colored)}.focus\:border-amber-500:focus{--tw-border-opacity:1;border-color:rgb(245 158 11/var(--tw-border-opacity,1))}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246/var(--tw-border-opacity,1))}.focus\:border-emerald-500:focus{--tw-border-opacity:1;border-color:rgb(16 185 129/var(--tw-border-opacity,1))}.focus\:border-purple-500:focus{--tw-border-opacity:1;border-color:rgb(168 85 247/var(--tw-border-opacity,1))}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus\:ring-amber-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(245 158 11/var(--tw-ring-opacity,1))}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246/var(--tw-ring-opacity,1))}.focus\:ring-emerald-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(16 185 129/var(--tw-ring-opacity,1))}.focus\:ring-purple-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(168 85 247/var(--tw-ring-opacity,1))}.peer:checked~.peer-checked\:translate-x-5{--tw-translate-x:1.25rem;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.peer:checked~.peer-checked\:bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246/var(--tw-bg-opacity,1))}.peer:checked~.peer-checked\:bg-emerald-500{--tw-bg-opacity:1;background-color:rgb(16 185 129/var(--tw-bg-opacity,1))}@media (min-width:640px){.sm\:gap-3{gap:.75rem}}@media (min-width:768px){.md\:col-span-2{grid-column:span 2/span 2}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}


========================================
FILE: includes\admin\ui\assets\js\main.js
========================================
/**
 * Admin UI - Shared JavaScript
 * 
 * This file contains:
 * - Shared utilities
 * - Common event handlers
 * - AJAX helpers
 * - UI helpers
 */

(function() {
    'use strict';

    // Admin UI namespace
    window.AAAdmin = window.AAAdmin || {};

    /**
     * AJAX helper for admin requests
     */
    AAAdmin.ajax = function(action, data, callback) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('nonce', window.aaAdminNonce || '');

        if (data) {
            Object.keys(data).forEach(key => {
                formData.append(key, data[key]);
            });
        }

        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(callback)
        .catch(error => {
            console.error('AJAX Error:', error);
        });
    };

    /**
     * Show notification message
     */
    AAAdmin.notify = function(message, type = 'info') {
        // Implementation for notifications
        console.log(`[${type}] ${message}`);
    };

    /**
     * Iframe auto-resize functionality
     * Sends content height to parent window for dynamic iframe sizing
     */
    AAAdmin.iframeResize = function() {
        // Only run if we're inside an iframe
        if (window.self === window.top) return;

        let lastHeight = 0;
        let resizeTimeout = null;

        function sendHeight() {
            // Get the actual content height
            const body = document.body;
            const html = document.documentElement;

            // Use the maximum of various height measurements
            const height = Math.max(
                body.scrollHeight,
                body.offsetHeight,
                html.clientHeight,
                html.scrollHeight,
                html.offsetHeight
            );

            // Only send if height changed (avoid unnecessary updates)
            if (height !== lastHeight) {
                lastHeight = height;

                // Send height to parent window
                window.parent.postMessage({
                    type: 'aa-iframe-resize',
                    height: height,
                    iframeId: 'aa-settings-iframe'
                }, '*');
            }
        }

        // Send height on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', sendHeight);
        } else {
            sendHeight();
        }

        // Send height when content changes (debounced)
        function debouncedSendHeight() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(sendHeight, 100);
        }

        // Watch for content changes
        if (typeof ResizeObserver !== 'undefined') {
            const resizeObserver = new ResizeObserver(debouncedSendHeight);
            resizeObserver.observe(document.body);
        }

        // Also watch for DOM mutations (dynamic content)
        if (typeof MutationObserver !== 'undefined') {
            const mutationObserver = new MutationObserver(debouncedSendHeight);
            mutationObserver.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['style', 'class']
            });
        }

        // Send height on window resize (in case of viewport changes)
        window.addEventListener('resize', debouncedSendHeight);
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin UI initialized');
        
        // Initialize iframe auto-resize
        AAAdmin.iframeResize();
    });

})();




========================================
FILE: includes\admin\ui\index.php
========================================
<?php
/**
 * Admin UI Router
 *
 * Responsibilities:
 * - Validate access
 * - Resolve active UI module
 * - Delegate rendering to shared layout
 *
 * This file contains NO HTML and NO business logic.
 */

defined('ABSPATH') or die('No direct access');

// Permission check
if (!current_user_can('manage_options')) {
    wp_die('Acceso denegado', 'Error', ['response' => 403]);
}

// Allowed UI modules (whitelist)
$allowed_modules = [
    'settings',
    'services',
    'calendar',
];

// Resolve requested module
$requested_module = isset($_GET['module'])
    ? sanitize_key($_GET['module'])
    : 'settings';

// Fallback to default module
$active_module = in_array($requested_module, $allowed_modules, true)
    ? $requested_module
    : 'settings';

// Resolve module path
$module_path = __DIR__ . '/modules/' . $active_module . '/index.php';

// Final safety check
if (!file_exists($module_path)) {
    wp_die('UI module not found', 'Error', ['response' => 404]);
}

// Variables $active_module and $module_path are now available in parent scope
// Delegate rendering to layout (variables will be accessible in layout.php)
require __DIR__ . '/shared/layout.php';



========================================
FILE: includes\admin\ui\modules\calendar\index.php
========================================
<?php
/**
 * Calendar Module - Calendar Management UI
 * 
 * This module handles:
 * - Display of calendar view
 * - UI for managing appointments
 * - No business logic (data operations handled outside)
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');
?>
<div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Calendario</h2>
        
        <div class="space-y-4">
            <!-- Placeholder for calendar view -->
            <div class="p-8 bg-gray-50 rounded-md text-center">
                <p class="text-gray-600">Vista de calendario - En desarrollo</p>
            </div>
        </div>
    </div>
</div>

<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'module.js'); ?>" defer></script>




========================================
FILE: includes\admin\ui\modules\calendar\module.js
========================================
/**
 * Calendar Module - Module-specific JavaScript
 */

(function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Calendar module loaded');
        
        // Module-specific initialization
        // Add event listeners, calendar handlers, etc.
    });

})();




========================================
FILE: includes\admin\ui\modules\services\index.php
========================================
<?php
/**
 * Services Module - Services Management UI
 * 
 * This module handles:
 * - Display of services list
 * - UI for adding/editing services
 * - No business logic (data operations handled outside)
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');
?>
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-gray-800">Servicios</h2>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Agregar Servicio
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Placeholder for services list -->
            <div class="p-4 bg-gray-50 rounded-md">
                <p class="text-gray-600">Lista de servicios - En desarrollo</p>
            </div>
        </div>
    </div>
</div>

<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'module.js'); ?>" defer></script>




========================================
FILE: includes\admin\ui\modules\services\module.js
========================================
/**
 * Services Module - Module-specific JavaScript
 */

(function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Services module loaded');
        
        // Module-specific initialization
        // Add event listeners, form handlers, etc.
    });

})();




========================================
FILE: includes\admin\ui\modules\settings\index.php
========================================
<?php
/**
 * Settings Module - Configuration UI
 * 
 * This module handles:
 * - Display of settings form
 * - UI interactions for settings
 * - No business logic (data saving handled outside via WordPress Settings API)
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');

// Get data for form
$schedule = get_option('aa_schedule', []);
$days = [
    'monday'    => 'Lunes',
    'tuesday'   => 'Martes',
    'wednesday' => 'MiÃ©rcoles',
    'thursday'  => 'Jueves',
    'friday'    => 'Viernes',
    'saturday'  => 'SÃ¡bado',
    'sunday'    => 'Domingo'
];
?>

<div class="max-w-5xl mx-auto py-2">
    
    <form method="post" action="<?php echo esc_url(admin_url('options.php')); ?>">
        <?php settings_fields('agenda_automatizada_settings'); ?>
        <?php do_settings_sections('agenda_automatizada_settings'); ?>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             SECCIÃ“N: Horarios y Disponibilidad
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 overflow-hidden">
            <header class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Horarios y Disponibilidad</h3>
                        <p class="text-sm text-gray-500 mt-0.5">Define los dÃ­as y horarios de atenciÃ³n</p>
                    </div>
                </div>
            </header>
            
            <div class="p-3">
                <div class="grid gap-3">
                    <?php foreach ($days as $key => $label): 
                        $enabled   = !empty($schedule[$key]['enabled']);
                        $intervals = $schedule[$key]['intervals'] ?? [];
                    ?>
                    <div class="aa-day-block group rounded-lg border border-gray-200 bg-gray-50/50 hover:border-blue-200 hover:bg-blue-50/30 transition-all duration-200 overflow-hidden <?php echo $enabled ? 'border-blue-200 bg-blue-50/40' : ''; ?>">
                        <div class="px-4 py-3 flex items-center justify-between">
                            <label class="flex items-center gap-3 cursor-pointer flex-1">
                                <div class="relative">
                                    <input type="checkbox" 
                                           name="aa_schedule[<?php echo esc_attr($key); ?>][enabled]" 
                                           value="1" 
                                           <?php checked($enabled, true); ?> 
                                           class="peer sr-only">
                                    <div class="w-11 h-6 bg-gray-300 peer-checked:bg-blue-500 rounded-full transition-colors duration-200"></div>
                                    <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform duration-200 peer-checked:translate-x-5"></div>
                                </div>
                                <span class="aa-day-name font-medium text-gray-700 select-none"><?php echo esc_html($label); ?></span>
                            </label>
                            
                            <?php if ($enabled && !empty($intervals)): ?>
                            <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded-full border border-gray-200">
                                <?php echo count($intervals); ?> intervalo<?php echo count($intervals) > 1 ? 's' : ''; ?>
                            </span>
                            <?php endif; ?>
                        </div>

                        <div class="day-intervals border-t border-gray-200 bg-white px-3 py-4 rounded-b-lg" 
                             data-day="<?php echo esc_attr($key); ?>" 
                             style="<?php echo $enabled ? '' : 'display:none;'; ?>">
                            
                            <div class="space-y-3">
                                <?php if (!empty($intervals)): ?>
                                    <?php foreach ($intervals as $i => $interval): ?>
                                    <div class="interval flex flex-wrap items-center gap-2 sm:gap-3" data-day="<?php echo esc_attr($key); ?>" data-index="<?php echo $i; ?>">
                                        <div class="aa-time-input-wrapper flex items-center gap-1">
                                            <input type="time" 
                                                   name="aa_schedule[<?php echo esc_attr($key); ?>][intervals][<?php echo $i; ?>][start]" 
                                                   value="<?php echo esc_attr($interval['start']); ?>" 
                                                   step="1800"
                                                   class="aa-timepicker-mobile w-[4.5rem] px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                                        </div>
                                        <span class="text-gray-400 font-light">-</span>
                                        <div class="aa-time-input-wrapper flex items-center gap-1">
                                            <input type="time" 
                                                   name="aa_schedule[<?php echo esc_attr($key); ?>][intervals][<?php echo $i; ?>][end]" 
                                                   value="<?php echo esc_attr($interval['end']); ?>" 
                                                   step="1800"
                                                   class="aa-timepicker-mobile w-[4.5rem] px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                                        </div>
                                        <button type="button" 
                                                class="remove-interval ml-auto p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Eliminar intervalo">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </div>
                            
                            <button type="button" 
                                    class="add-interval mt-3 inline-flex items-center gap-2 px-3 py-1.5 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                AÃ±adir intervalo
                            </button>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             GRID: Servicios + ParÃ¡metros (2 columnas en desktop)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="grid lg:grid-cols-2 gap-6 mb-6">

            <!-- SECCIÃ“N: Tipos de Cita / Servicios -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <header class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-purple-100 text-purple-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                            </svg>
                        </span>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Tipos de Cita</h3>
                            <p class="text-sm text-gray-500 mt-0.5">Servicios que ofreces</p>
                        </div>
                    </div>
                </header>
                
                <div class="p-6" id="aa-motivos-container">
                    <ul id="aa-motivos-list" class="space-y-2 mb-4"></ul>

                    <div class="flex gap-2">
                        <input type="text" 
                               id="aa-motivo-input" 
                               placeholder="Ej: Corte de cabello" 
                               class="flex-1 px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-shadow placeholder:text-gray-400">
                        <button type="button" 
                                id="aa-add-motivo" 
                                class="px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                            Agregar
                        </button>
                    </div>

                    <input type="hidden" name="aa_google_motivo" id="aa-google-motivo-hidden"
                        value='<?php echo esc_attr(get_option("aa_google_motivo", json_encode(["Cita general"]))); ?>'>
                </div>
            </section>

            <!-- SECCIÃ“N: ParÃ¡metros Generales -->
            <section class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <header class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-amber-100 text-amber-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </span>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">ParÃ¡metros</h3>
                            <p class="text-sm text-gray-500 mt-0.5">DuraciÃ³n y ventana de citas</p>
                        </div>
                    </div>
                </header>
                
                <div class="p-6 space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_slot_duration">
                            DuraciÃ³n de cada cita
                        </label>
                        <select name="aa_slot_duration" id="aa_slot_duration" 
                                class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-shadow">
                            <option value="30" <?php selected(get_option('aa_slot_duration', 30), 30); ?>>30 minutos</option>
                            <option value="60" <?php selected(get_option('aa_slot_duration', 30), 60); ?>>60 minutos</option>
                            <option value="90" <?php selected(get_option('aa_slot_duration', 30), 90); ?>>90 minutos</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_future_window">
                            Ventana de disponibilidad
                        </label>
                        <select name="aa_future_window" id="aa_future_window" 
                                class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-shadow">
                            <option value="15" <?php selected(get_option('aa_future_window', 15), 15); ?>>15 dÃ­as</option>
                            <option value="30" <?php selected(get_option('aa_future_window', 15), 30); ?>>30 dÃ­as</option>
                            <option value="45" <?php selected(get_option('aa_future_window', 15), 45); ?>>45 dÃ­as</option>
                            <option value="60" <?php selected(get_option('aa_future_window', 15), 60); ?>>60 dÃ­as</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1.5">LÃ­mite para agendar citas en el futuro</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_timezone">
                            Zona horaria
                        </label>
                        <select name="aa_timezone" id="aa_timezone" 
                                class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-shadow">
                            <?php
                            $saved_tz = get_option('aa_timezone', 'America/Mexico_City');
                            $timezones = [
                                'America/Mexico_City' => 'MÃ©xico (CDMX) - GMT-6',
                                'America/Cancun' => 'CancÃºn - GMT-5',
                                'America/Tijuana' => 'Tijuana - GMT-8',
                                'America/Monterrey' => 'Monterrey - GMT-6',
                                'America/Bogota' => 'Colombia (BogotÃ¡) - GMT-5',
                                'America/Lima' => 'PerÃº (Lima) - GMT-5',
                                'America/Argentina/Buenos_Aires' => 'Argentina - GMT-3',
                                'America/Santiago' => 'Chile (Santiago) - GMT-3',
                                'America/New_York' => 'EE.UU. (Este) - GMT-5',
                                'America/Los_Angeles' => 'EE.UU. (PacÃ­fico) - GMT-8',
                                'Europe/Madrid' => 'EspaÃ±a (Madrid) - GMT+1',
                                'Europe/London' => 'Reino Unido - GMT+0',
                            ];
                            foreach ($timezones as $value => $label) {
                                printf(
                                    '<option value="%s" %s>%s</option>',
                                    esc_attr($value),
                                    selected($saved_tz, $value, false),
                                    esc_html($label)
                                );
                            }
                            ?>
                        </select>
                    </div>
                </div>
            </section>

        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             SECCIÃ“N: Datos del Negocio
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 overflow-hidden">
            <header class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Datos del Negocio</h3>
                        <p class="text-sm text-gray-500 mt-0.5">InformaciÃ³n para confirmaciones y recordatorios</p>
                    </div>
                </div>
            </header>
            
            <div class="p-3">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_business_name">
                            Nombre del negocio
                        </label>
                        <input type="text" name="aa_business_name" id="aa_business_name"
                               value="<?php echo esc_attr(get_option('aa_business_name', '')); ?>" 
                               placeholder="Ej: SalÃ³n de Belleza MarÃ­a"
                               class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow placeholder:text-gray-400">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_whatsapp_number">
                            WhatsApp del negocio
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                            </span>
                            <input type="tel" name="aa_whatsapp_number" id="aa_whatsapp_number"
                                   value="<?php echo esc_attr(get_option('aa_whatsapp_number', '')); ?>" 
                                   placeholder="521234567890"
                                   pattern="[0-9]{10,15}"
                                   class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow placeholder:text-gray-400">
                        </div>
                        <p class="text-xs text-gray-500 mt-1.5">CÃ³digo de paÃ­s + nÃºmero, sin espacios</p>
                    </div>

                    <div class="md:col-span-2">
                        <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="aa_is_virtual" value="1" 
                                       id="aa-is-virtual-checkbox"
                                       <?php checked(get_option('aa_is_virtual', 0), 1); ?>
                                       class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-300 peer-checked:bg-emerald-500 rounded-full transition-colors"></div>
                                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform peer-checked:translate-x-5"></div>
                            </label>
                            <span class="text-sm text-gray-700">Las citas son virtuales (sin direcciÃ³n fÃ­sica)</span>
                        </div>
                    </div>

                    <div class="md:col-span-2" id="aa-address-row">
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa-business-address">
                            DirecciÃ³n fÃ­sica
                        </label>
                        <textarea name="aa_business_address" 
                                  id="aa-business-address" 
                                  rows="2" 
                                  placeholder="Ej: Av. Reforma 123, Col. Centro, CDMX"
                                  class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow placeholder:text-gray-400 resize-none"><?php echo esc_textarea(get_option('aa_business_address', '')); ?></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             SECCIÃ“N: Google Calendar
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 overflow-hidden">
            <header class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-red-100 text-red-600">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Google Calendar</h3>
                        <p class="text-sm text-gray-500 mt-0.5">Sincroniza citas para evitar conflictos</p>
                    </div>
                </div>
            </header>
            
            <div class="p-3">
                <?php 
                $google_email = get_option('aa_google_email', '');
                $is_sync_invalid = SyncService::is_sync_invalid();

                echo '<input type="hidden" name="aa_google_email" value="' . esc_attr($google_email) . '">';
                
                if ($google_email && !$is_sync_invalid): ?>
                    <!-- Estado: Conectado -->
                    <div class="flex flex-wrap items-center justify-between gap-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            <span class="flex items-center justify-center w-10 h-10 rounded-full bg-green-100 flex-shrink-0">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </span>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-medium text-green-800">Sincronizado</p>
                                <p class="text-sm text-green-600 truncate"><?php echo esc_html($google_email); ?></p>
                            </div>
                        </div>
                        <a href="<?php echo esc_url(admin_url('admin-post.php?action=aa_disconnect_google')); ?>" 
                           class="px-4 py-2 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors whitespace-nowrap ml-auto">
                            Desconectar
                        </a>
                    </div>
                <?php elseif ($google_email && $is_sync_invalid): ?>
                    <!-- Estado: Requiere reconexiÃ³n -->
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="flex items-start gap-3">
                            <span class="flex items-center justify-center w-10 h-10 rounded-full bg-amber-100 flex-shrink-0 mt-0.5">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </span>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-amber-800">ReconexiÃ³n requerida</p>
                                <p class="text-sm text-amber-700 mt-1">El token ha caducado. Reconecta para seguir sincronizando.</p>
                                <p class="text-xs text-amber-600 mt-2">Cuenta anterior: <?php echo esc_html($google_email); ?></p>
                                <a href="<?php echo esc_url(SyncService::get_auth_url()); ?>" 
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="inline-flex items-center gap-2 mt-3 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-medium rounded-lg transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    Reconectar con Google
                                </a>
                            </div>
                        </div>
                    </div>
                <?php else: ?>
                    <!-- Estado: No conectado -->
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h4 class="text-base font-medium text-gray-900 mb-1">Sin sincronizaciÃ³n</h4>
                        <p class="text-sm text-gray-500 mb-4 max-w-sm mx-auto">
                            Conecta tu cuenta de Google Calendar para sincronizar tus citas automÃ¡ticamente
                        </p>
                        <a href="<?php echo esc_url(SyncService::get_auth_url()); ?>" 
                           target="_blank"
                           rel="noopener noreferrer"
                           class="inline-flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg transition-colors shadow-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Conectar con Google
                        </a>
                    </div>
                <?php endif; ?>
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             BOTÃ“N GUARDAR (Sticky en mÃ³vil)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="sticky bottom-0 bg-white/80 backdrop-blur-sm border-t border-gray-200 -mx-6 px-6 py-4 mt-6 flex justify-end">
            <button type="submit" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-lg shadow-blue-500/25 transition-all hover:shadow-xl hover:shadow-blue-500/30 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Guardar ConfiguraciÃ³n
            </button>
        </div>

    </form>
</div>

<!-- Time picker logic handled in module.js -->

<!-- Module JS -->
<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'module.js'); ?>"></script>



========================================
FILE: includes\admin\ui\modules\settings\module.js
========================================
/**
 * Settings Module - Module-specific JavaScript
 * 
 * Handles all UI logic for the Settings module:
 * - Motivos (appointment types) management
 * - Virtual address toggle
 * - Schedule intervals (day toggles, interval creation/deletion)
 * - Time input conversion (mobile vs desktop)
 * - Minute normalization (00/30 only)
 */

(function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Settings module loaded');

        // ================================
        // ðŸ”¹ Motivos Management
        // ================================
        initMotivos();

        // ================================
        // ðŸ”¹ Virtual Address Toggle
        // ================================
        initVirtualAddressToggle();

        // ================================
        // ðŸ”¹ Schedule Intervals Management
        // ================================
        initDayToggles();
        initIntervals();
        convertInputsToDesktopSelectors();
        observeResizeChanges();
    });

    // ================================
    // ðŸ”¹ UTILITY FUNCTIONS
    // ================================

    /**
     * Detect if current viewport is mobile
     * Uses media query and device characteristics for reliable detection in iframes
     */
    function isMobile() {
        // Use matchMedia for reliable detection (works in iframes)
        if (window.matchMedia && window.matchMedia('(max-width: 639px)').matches) {
            return true;
        }
        // Fallback: check for touch device characteristics
        if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) {
            // Touch device - check if viewport is small
            return window.innerWidth < 640;
        }
        // Final fallback for older browsers
        return window.innerWidth < 640;
    }

    /**
     * Parse HH:mm string to {hour, minute} object
     */
    function parseTime(timeStr) {
        if (!timeStr) return { hour: 0, minute: 0 };
        const [hour, minute] = timeStr.split(':').map(Number);
        return { hour: hour || 0, minute: minute || 0 };
    }

    /**
     * Format {hour, minute} to HH:mm string
     */
    function formatTime(hour, minute) {
        return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    }

    /**
     * Normalize minute to valid value (00 or 30)
     */
    function normalizeMinutes(minute) {
        if (minute < 15) return 0;
        if (minute >= 15 && minute < 45) return 30;
        return 0;
    }

    // ================================
    // ðŸ”¹ MOTIVOS MANAGEMENT
    // ================================

    function initMotivos() {
        const hiddenInput = document.getElementById("aa-google-motivo-hidden");
        const motivosList = document.getElementById("aa-motivos-list");
        const addButton = document.getElementById("aa-add-motivo");
        const motivoInput = document.getElementById("aa-motivo-input");

        if (!hiddenInput || !motivosList || !addButton || !motivoInput) return;

        // Read saved motivos or use empty array
        let motivos = [];
        try {
            motivos = JSON.parse(hiddenInput.value || "[]");
            if (!Array.isArray(motivos)) motivos = [];
        } catch (e) {
            motivos = [];
        }

        function renderMotivos() {
            motivosList.innerHTML = "";
            motivos.forEach((motivo, index) => {
                const li = document.createElement("li");
                li.style.marginBottom = "5px";
                li.style.display = "flex";
                li.style.alignItems = "center";
                li.style.gap = "10px";

                li.innerHTML = `
                    <span class="flex-1">${motivo}</span>
                    <button type="button" class="remove-motivo ml-auto p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" data-index="${index}" title="Eliminar">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                `;
                motivosList.appendChild(li);
            });
            hiddenInput.value = JSON.stringify(motivos);
        }

        addButton.addEventListener("click", function () {
            const nuevo = motivoInput.value.trim();
            if (!nuevo) return;
            motivos.push(nuevo);
            motivoInput.value = "";
            renderMotivos();
        });

        motivosList.addEventListener("click", function (e) {
            if (e.target.classList.contains("remove-motivo")) {
                const index = parseInt(e.target.dataset.index, 10);
                motivos.splice(index, 1);
                renderMotivos();
            }
        });

        renderMotivos();
    }

    // ================================
    // ðŸ”¹ VIRTUAL ADDRESS TOGGLE
    // ================================

    function initVirtualAddressToggle() {
        const virtualCheckbox = document.getElementById('aa-is-virtual-checkbox');
        const addressField = document.getElementById('aa-business-address');
        const addressRow = document.getElementById('aa-address-row');

        if (!virtualCheckbox || !addressField || !addressRow) return;

        function toggleAddressField() {
            if (virtualCheckbox.checked) {
                addressField.disabled = true;
                addressField.style.opacity = '0.5';
                addressRow.style.opacity = '0.6';
            } else {
                addressField.disabled = false;
                addressField.style.opacity = '1';
                addressRow.style.opacity = '1';
            }
        }

        toggleAddressField();
        virtualCheckbox.addEventListener('change', toggleAddressField);
    }

    // ================================
    // ðŸ”¹ TIME INPUT CREATION
    // ================================

    /**
     * Create time selector (mobile: native input, desktop: select dropdowns)
     */
    function createTimeSelector(name, value) {
        const { hour, minute } = parseTime(value);
        const wrapper = document.createElement('div');
        wrapper.className = 'aa-time-input-wrapper flex items-center gap-1';
        
        if (isMobile()) {
            return createMobileTimeInput(wrapper, name, hour, minute);
        } else {
            return createDesktopTimeSelectors(wrapper, name, hour, minute);
        }
    }

    /**
     * Create mobile native time input
     */
    function createMobileTimeInput(wrapper, name, hour, minute) {
        const input = document.createElement('input');
        input.type = 'time';
        input.name = name;
        input.step = '1800'; // 30 minutes in seconds
        const normalizedM = normalizeMinutes(minute);
        input.value = formatTime(hour, normalizedM) || '00:00';
        input.className = 'aa-timepicker-mobile w-[4.5rem] px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow';
        wrapper.appendChild(input);
        return wrapper;
    }

    /**
     * Create desktop time selectors (hour + minute dropdowns)
     */
    function createDesktopTimeSelectors(wrapper, name, hour, minute) {
        const validMinutes = [0, 30];
        const normalizedMinute = normalizeMinutes(minute);

        // Hour selector
        const hourSelect = document.createElement('select');
        hourSelect.className = 'aa-time-hour w-16 px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white';
        
        for (let h = 0; h < 24; h++) {
            const option = document.createElement('option');
            option.value = h;
            option.textContent = String(h).padStart(2, '0');
            if (h === hour) option.selected = true;
            hourSelect.appendChild(option);
        }

        // Minute selector (only 00 and 30)
        const minuteSelect = document.createElement('select');
        minuteSelect.className = 'aa-time-minute w-16 px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white';
        
        validMinutes.forEach(m => {
            const option = document.createElement('option');
            option.value = m;
            option.textContent = String(m).padStart(2, '0');
            if (m === normalizedMinute) option.selected = true;
            minuteSelect.appendChild(option);
        });

        // Hidden input for form submission (HH:mm format)
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = name;
        hiddenInput.value = formatTime(hour, normalizedMinute);
        hiddenInput.className = 'aa-time-value';

        // Update hidden input when selectors change
        function updateHidden() {
            const h = parseInt(hourSelect.value);
            const m = parseInt(minuteSelect.value);
            const validM = validMinutes.includes(m) ? m : 0;
            hiddenInput.value = formatTime(h, validM);
        }
        hourSelect.addEventListener('change', updateHidden);
        minuteSelect.addEventListener('change', updateHidden);

        // Separator
        const colon = document.createElement('span');
        colon.className = 'text-gray-400';
        colon.textContent = ':';

        // Make wrapper clickable
        bindWrapperClicks(wrapper, hourSelect, colon);

        wrapper.appendChild(hourSelect);
        wrapper.appendChild(colon);
        wrapper.appendChild(minuteSelect);
        wrapper.appendChild(hiddenInput);
        
        return wrapper;
    }

    /**
     * Bind click and keyboard events to time wrapper
     */
    function bindWrapperClicks(wrapper, hourSelect, colon) {
        wrapper.style.cursor = 'pointer';
        wrapper.setAttribute('role', 'button');
        wrapper.setAttribute('tabindex', '0');
        
        wrapper.addEventListener('click', function(e) {
            if (e.target === wrapper || e.target === colon || (!e.target.closest('select'))) {
                e.preventDefault();
                e.stopPropagation();
                hourSelect.focus();
                hourSelect.click();
            }
        });
        
        wrapper.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                hourSelect.focus();
                hourSelect.click();
            }
        });
    }

    // ================================
    // ðŸ”¹ DAY TOGGLES
    // ================================

    /**
     * Initialize day toggle checkboxes to show/hide intervals
     */
    function initDayToggles() {
        document.querySelectorAll(".aa-day-block input[type=checkbox]").forEach(checkbox => {
            checkbox.addEventListener("change", function() {
                const day = this.name.match(/\[(.*?)\]/)[1];
                const container = document.querySelector(`.day-intervals[data-day="${day}"]`);
                if (!container) return;
                
                container.style.display = this.checked ? "block" : "none";
            });
        });
    }

    // ================================
    // ðŸ”¹ INTERVALS MANAGEMENT
    // ================================

    /**
     * Initialize interval containers and bind add/remove handlers
     */
    function initIntervals() {
        document.querySelectorAll(".day-intervals").forEach(container => {
            bindAddInterval(container);
            bindRemoveInterval(container);
        });
    }

    /**
     * Bind add interval button handler
     */
    function bindAddInterval(container) {
        container.addEventListener("click", function(e) {
            if (!e.target.classList.contains("add-interval")) return;
            
            e.preventDefault();
            const day = this.dataset.day;
            // Find the space-y-3 container that holds all intervals
            const intervalsContainer = this.querySelector('.space-y-3');
            if (!intervalsContainer) return;
            
            const index = intervalsContainer.querySelectorAll(".interval").length;

            const intervalDiv = document.createElement("div");
            intervalDiv.classList.add("interval");
            intervalDiv.classList.add("flex", "flex-wrap", "items-center", "gap-2", "sm:gap-3");
            intervalDiv.setAttribute('data-day', day);
            intervalDiv.setAttribute('data-index', index);

            const startWrapper = createTimeSelector(`aa_schedule[${day}][intervals][${index}][start]`, '00:00');
            const endWrapper = createTimeSelector(`aa_schedule[${day}][intervals][${index}][end]`, '23:30');

            const separator = document.createTextNode('-');
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-interval ml-auto p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors';
            removeBtn.title = 'Eliminar intervalo';
            removeBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            `;

            intervalDiv.appendChild(startWrapper);
            intervalDiv.appendChild(separator);
            intervalDiv.appendChild(endWrapper);
            intervalDiv.appendChild(removeBtn);

            // Insert into the space-y-3 container, not directly into day-intervals
            intervalsContainer.appendChild(intervalDiv);
        });
    }

    /**
     * Bind remove interval button handler
     */
    function bindRemoveInterval(container) {
        container.addEventListener("click", function(e) {
            if (!e.target.classList.contains("remove-interval") && !e.target.closest(".remove-interval")) return;
            
            e.preventDefault();
            const interval = e.target.closest(".interval");
            if (interval) interval.remove();
        });
    }

    // ================================
    // ðŸ”¹ INPUT CONVERSION
    // ================================

    /**
     * Convert existing mobile time inputs to desktop selectors if needed
     */
    function convertInputsToDesktopSelectors() {
        document.querySelectorAll('.aa-timepicker-mobile').forEach(input => {
            if (input.dataset.converted) return;
            
            if (!isMobile()) {
                const wrapper = input.closest('.aa-time-input-wrapper');
                if (!wrapper) return;
                
                const name = input.name;
                const value = input.value || '00:00';
                const newWrapper = createTimeSelector(name, value);
                
                if (wrapper.parentNode) {
                    wrapper.parentNode.replaceChild(newWrapper, wrapper);
                }
            } else {
                input.dataset.converted = 'true';
            }
        });
    }

    // ================================
    // ðŸ”¹ RESIZE OBSERVATION
    // ================================

    /**
     * Observe window resize to reconvert inputs when switching mobile/desktop
     */
    function observeResizeChanges() {
        let resizeTimeout;
        let wasMobile = isMobile();
        
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                const nowMobile = isMobile();
                if (wasMobile !== nowMobile) {
                    // Device type changed, reload to re-render
                    location.reload();
                }
                wasMobile = nowMobile;
            }, 300);
        });
    }

})();



========================================
FILE: includes\admin\ui\README.md
========================================
# Admin UI Architecture

## Overview

This directory contains the admin UI layer that renders inside an iframe. This is **UI only** - no business logic.

## Directory Structure

```
ui/
â”œâ”€â”€ index.php              # Entry point & router
â”œâ”€â”€ shared/                # Reusable components
â”‚   â”œâ”€â”€ layout.php         # Main HTML structure
â”‚   â”œâ”€â”€ header.php         # Navigation header
â”‚   â””â”€â”€ footer.php         # Footer
â”œâ”€â”€ modules/               # UI modules
â”‚   â”œâ”€â”€ settings/          # Settings module
â”‚   â”œâ”€â”€ services/          # Services module
â”‚   â””â”€â”€ calendar/          # Calendar module
â””â”€â”€ assets/                # Static assets
    â”œâ”€â”€ css/
    â”‚   â””â”€â”€ admin.css      # Tailwind CSS entry point
    â””â”€â”€ js/
        â””â”€â”€ main.js        # Shared JavaScript
```

## How It Works

1. **Entry Point** (`index.php`): Routes to modules based on `?module=` query parameter
2. **Layout** (`shared/layout.php`): Provides HTML structure, loads CSS/JS
3. **Modules**: Each module has its own `index.php` (view) and `module.js` (module-specific JS)
4. **Assets**: Shared CSS (Tailwind) and JS utilities

## Adding a New Module

1. Create folder: `modules/your-module/`
2. Add `index.php` with your module's HTML
3. Add `module.js` for module-specific JavaScript
4. Add navigation link in `shared/header.php`

## Important Notes

- **No business logic** in this layer
- All data operations happen via AJAX to WordPress endpoints
- Use Tailwind CSS classes for styling
- Keep modules isolated and independent




========================================
FILE: includes\admin\ui\shared\footer.php
========================================
<?php
/**
 * Shared Footer - Footer content
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');
?>
<footer class="mt-12 border-t border-gray-200 bg-gray-50/50 flex-shrink-0">
    <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-center gap-2">
            <p class="text-xs text-gray-500">
                Agenda Automatizada
            </p>
            <span class="text-gray-300">â€¢</span>
            <p class="text-xs text-gray-500">
                v2.0.0
            </p>
        </div>
    </div>
</footer>




========================================
FILE: includes\admin\ui\shared\header.php
========================================
<?php
/**
 * Shared Header - Compact tab navigation with icons
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');
?>
<header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="px-4 py-3">
        <!-- Branding - Compact -->
        <div class="flex items-center gap-2 mb-3">
            <span class="flex items-center justify-center w-7 h-7 rounded-lg bg-blue-100 text-blue-600 flex-shrink-0">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
            </span>
            <h1 class="text-sm font-semibold text-gray-900 truncate">Agenda Automatizada</h1>
        </div>
        
        <!-- Tab Navigation - Icon above, label below -->
        <nav class="flex items-center justify-center gap-2">
            <!-- ConfiguraciÃ³n -->
            <a href="?module=settings" 
               class="flex flex-col items-center justify-center min-w-[60px] px-2 py-2 rounded-lg transition-all <?php echo (isset($active_module) && $active_module === 'settings') ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'; ?>">
                <span class="flex items-center justify-center w-6 h-6 mb-1 <?php echo (isset($active_module) && $active_module === 'settings') ? 'text-blue-600' : 'text-gray-500'; ?>">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </span>
                <span class="text-xs font-medium leading-tight text-center">Config</span>
            </a>
            
            <!-- Calendario -->
            <a href="?module=calendar" 
               class="flex flex-col items-center justify-center min-w-[60px] px-2 py-2 rounded-lg transition-all <?php echo (isset($active_module) && $active_module === 'calendar') ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'; ?>">
                <span class="flex items-center justify-center w-6 h-6 mb-1 <?php echo (isset($active_module) && $active_module === 'calendar') ? 'text-blue-600' : 'text-gray-500'; ?>">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </span>
                <span class="text-xs font-medium leading-tight text-center">Calendario</span>
            </a>
        </nav>
    </div>
</header>




========================================
FILE: includes\admin\ui\shared\layout.php
========================================
<?php
/**
 * Shared Layout - Main HTML structure for admin UI
 * 
 * This file provides:
 * - HTML document structure
 * - Tailwind CSS inclusion
 * - Shared header/navigation
 * - Module content area
 * - Shared footer
 */

defined('ABSPATH') or die('Â¡Sin acceso directo!');

// Get module name and path from parent scope (set in index.php)
$active_module = isset($active_module) ? $active_module : 'settings';
$module_path = isset($module_path) ? $module_path : '';

// Send headers
header('Content-Type: text/html; charset=utf-8');
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Automatizada - Admin</title>
    
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="<?php echo esc_url(plugin_dir_url(__FILE__) . '../assets/css/admin.css'); ?>">
    
    <!-- Shared Admin JS -->
    <script src="<?php echo esc_url(plugin_dir_url(__FILE__) . '../assets/js/main.js'); ?>" defer></script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <div id="aa-admin-app" class="w-full">
        <?php require_once __DIR__ . '/header.php'; ?>
        
        <main id="aa-admin-content" class="flex-1 px-4 py-8">

            <?php
            // Load module content
            if (file_exists($module_path)) {
                require_once $module_path;
            } else {
                echo '<div class="p-4 bg-red-50 text-red-700 rounded">MÃ³dulo no encontrado.</div>';
            }
            ?>
        </main>
        
        <?php require_once __DIR__ . '/footer.php'; ?>
    </div>
</body>
</html>
<?php
// Terminate execution to prevent WordPress output
die();




========================================
FILE: includes\admin\ui\TAILWIND.md
========================================
# Tailwind CSS Setup for Admin UI

## Overview

Tailwind CSS is configured **only** for the iframe-based admin UI located in `includes/admin/ui/`.

The iframe is completely isolated from WordPress admin styles, so Tailwind can safely use its preflight (CSS reset) without affecting WordPress.

## Installation

1. Install dependencies:
```bash
npm install
```

## Build Commands

### Development (Watch Mode)
Watch for changes and automatically rebuild CSS:
```bash
npm run watch:css
```

### Production Build
Build minified CSS for production:
```bash
npm run build:css
```

## Configuration

- **Config file**: `tailwind.config.js` (root of plugin)
- **CSS entry**: `includes/admin/ui/assets/css/admin.css`
- **Content scanning**: Only scans files in `includes/admin/ui/**/*.php` and `includes/admin/ui/**/*.js`

## How It Works

1. Tailwind scans PHP and JS files in the `includes/admin/ui/` directory
2. It extracts all Tailwind utility classes used in those files
3. It generates CSS with only the classes that are actually used
4. The compiled CSS is written back to `admin.css`
5. The iframe loads this CSS file (already configured in `layout.php`)

## Important Notes

- **Scope**: Tailwind ONLY affects the iframe UI. It does NOT affect WordPress admin or frontend.
- **Isolation**: The iframe is a separate HTML document, so Tailwind's preflight is safe to use.
- **Mobile-first**: Tailwind uses mobile-first breakpoints by default.
- **No prefix needed**: Since it's isolated in an iframe, no prefix is required.

## Usage in PHP Files

Use Tailwind classes directly in your PHP templates:

```php
<div class="bg-white rounded-lg shadow-sm p-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Title</h2>
    <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Click me
    </button>
</div>
```

## Usage in JavaScript

You can also use Tailwind classes in dynamically generated HTML:

```javascript
const element = document.createElement('div');
element.className = 'p-4 bg-gray-50 rounded-md';
```

## Custom Styles

Add custom CSS after the Tailwind directives in `admin.css`:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Your custom styles here */
.custom-component {
    /* ... */
}
```




========================================
FILE: includes\auth-helper.php
========================================
<?php
if (!defined('ABSPATH')) exit;

/**
 * Obtiene el dominio limpio para identificar al cliente en el backend.
 * Para localhost, incluye el primer nivel del path para diferenciar instalaciones.
 * 
 * Ejemplos:
 *   http://localhost/wpagenda -> localhost/wpagenda
 *   http://localhost/agendatheme -> localhost/agendatheme
 *   https://www.example.com/ -> example.com
 *   https://sitio.deoia.com -> sitio.deoia.com
 * 
 * @return string Dominio limpio
 */
function aa_get_clean_domain() {
    $site_url = get_site_url();
    $parsed = parse_url($site_url);
    
    $host = $parsed['host'] ?? 'localhost';
    
    // Si tiene puerto no estÃ¡ndar, agregarlo
    if (!empty($parsed['port']) && $parsed['port'] != 80 && $parsed['port'] != 443) {
        $host .= ':' . $parsed['port'];
    }
    
    // Eliminar www.
    $host = preg_replace('/^www\./', '', $host);
    
    // ðŸ”¹ Si es localhost, incluir el primer nivel del path para diferenciar instalaciones
    if ($host === 'localhost' || strpos($host, 'localhost:') === 0 || $host === '127.0.0.1') {
        $path = trim($parsed['path'] ?? '', '/');
        $first_path = explode('/', $path)[0] ?? '';
        
        if (!empty($first_path)) {
            return $host . '/' . $first_path;
        }
    }
    
    return $host;
}

/**
 * EnvÃ­a una peticiÃ³n autenticada con HMAC al backend
 * 
 * @param string $endpoint URL completa del endpoint (ej: 'http://localhost:3000/correo/confirmacion')
 * @param string $method MÃ©todo HTTP ('GET' o 'POST')
 * @param array $data Datos a enviar (opcional para GET, requerido para POST)
 * @return array|WP_Error Respuesta del backend o error
 */
function aa_send_authenticated_request($endpoint, $method = 'POST', $data = []) {
    // ðŸ”¹ Usar la funciÃ³n centralizada para obtener el domain
    $domain = aa_get_clean_domain();
    
    $client_secret = get_option('aa_client_secret');
    
    if (!$client_secret) {
        error_log("âŒ aa_auth: No hay client_secret configurado");
        return new WP_Error('no_secret', 'Client secret no configurado. Conecta con Google primero.');
    }

    // ðŸ”¹ Generar timestamp y nonce
    $timestamp = round(microtime(true) * 1000); // epoch en milisegundos
    $nonce = wp_generate_uuid4(); // UUID Ãºnico
    
    // ðŸ”¹ Preparar el body (vacÃ­o si es GET)
    // âœ… IMPORTANTE: JSON sin espacios para que coincida con el backend
    $body = '';
    if ($method === 'POST' && !empty($data)) {
        $json = json_encode($data, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
        // Eliminar espacios despuÃ©s de : y ,
        $body = preg_replace('/:\s+/', ':', $json);
        $body = preg_replace('/,\s+/', ',', $body);
    }
    
    // ðŸ”¹ Extraer path + query string
    $parsed = parse_url($endpoint);
    $path = $parsed['path'] ?? '/';
    if (!empty($parsed['query'])) {
        $path .= '?' . $parsed['query'];
    }
    
    // ðŸ”¹ Construir mensaje a firmar: METHOD + PATH + BODY + TIMESTAMP + NONCE
    $message = $method . $path . $body . $timestamp . $nonce;
    
    // ðŸ”¹ Calcular firma HMAC-SHA256
    $signature = hash_hmac('sha256', $message, $client_secret);
    
    // ðŸ”¹ Headers de autenticaciÃ³n
    $headers = [
        'Content-Type' => 'application/json',
        'X-Client-Id' => $domain,
        'X-Timestamp' => (string)$timestamp,
        'X-Nonce' => $nonce,
        'X-Signature' => $signature,
        'X-Client-Secret' => $client_secret,
    ];
    
    // ðŸ”¹ Configurar argumentos para wp_remote_request
    $args = [
        'headers' => $headers,
        'method' => $method,
        'timeout' => 30,
    ];
    
    if ($method === 'POST' && $body) {
        $args['body'] = $body;
    }
    
    // ðŸ”¹ Log mejorado
    error_log("ðŸ” aa_auth: Enviando request autenticado");
    error_log("   Domain: $domain");
    error_log("   Client Secret (primeros 10 chars): " . substr($client_secret, 0, 10) . "...");
    error_log("   Method: $method");
    error_log("   Path: $path");
    error_log("   Body length: " . strlen($body));
    error_log("   Body compacto: " . $body);
    error_log("   Timestamp: $timestamp");
    error_log("   Message to sign: " . substr($message, 0, 200) . "...");
    error_log("   Signature: $signature");
    
    return wp_remote_request($endpoint, $args);
}


========================================
FILE: includes\controllers\availability-controller.php
========================================
<?php
/**
 * Controlador: Disponibilidad Local
 */

if (!defined('ABSPATH')) exit;

require_once plugin_dir_path(__FILE__) . '../models/ReservationsModel.php';
require_once plugin_dir_path(__FILE__) . '../services/availability-proxy.php';

/**
 * Hook para encolar datos de disponibilidad local en el FRONTEND
 * Prioridad 20 para ejecutarse DESPUÃ‰S de wpaa_enqueue_frontend_assets (10)
 */
add_action('wp_enqueue_scripts', 'aa_enqueue_local_availability_data', 20);

function aa_enqueue_local_availability_data() {
    global $post;
    if (!is_a($post, 'WP_Post') || !has_shortcode($post->post_content, 'agenda_automatizada')) {
        return;
    }
    
    // âœ… Verificar que el script estÃ© encolado antes de localizarlo
    if (!wp_script_is('wpaa-availability-controller', 'enqueued')) {
        error_log("âš ï¸ [AvailabilityController-Frontend] wpaa-availability-controller NO estÃ¡ encolado");
        return;
    }
    
    $local_busy = ReservationsModel::get_internal_busy_slots();
    
    error_log("ðŸ“Š [AvailabilityController-Frontend] Slots ocupados locales: " . count($local_busy));
    
    $availability_config = [
        'local_busy' => $local_busy,
        'slot_duration' => intval(get_option('aa_slot_duration', 60)),
        'timezone' => get_option('aa_timezone', 'America/Mexico_City'),
        'total_confirmed' => ReservationsModel::count_confirmed(),
    ];
    
    wp_localize_script(
        'wpaa-availability-controller',
        'aa_local_availability',
        $availability_config
    );
    
    error_log("âœ… [AvailabilityController-Frontend] Datos locales enviados");
}

/**
 * Hook para encolar datos de disponibilidad local en el ADMIN
 * Prioridad 20 para ejecutarse DESPUÃ‰S de wpaa_enqueue_admin_assets (10)
 */
add_action('admin_enqueue_scripts', 'aa_enqueue_admin_local_availability_data', 20);

function aa_enqueue_admin_local_availability_data($hook) {
    if ($hook !== 'toplevel_page_aa_asistant_panel' && $hook !== 'agenda-automatizada_page_aa_asistant_panel') {
        return;
    }
    
    // âœ… Verificar que el script estÃ© encolado
    if (!wp_script_is('wpaa-availability-controller-admin', 'enqueued')) {
        error_log("âš ï¸ [AvailabilityController-Admin] wpaa-availability-controller-admin NO estÃ¡ encolado");
        return;
    }
    
    $local_busy = ReservationsModel::get_internal_busy_slots();
    
    error_log("ðŸ“Š [AvailabilityController-Admin] Slots ocupados locales: " . count($local_busy));
    
    $availability_config = [
        'local_busy' => $local_busy,
        'slot_duration' => intval(get_option('aa_slot_duration', 60)),
        'timezone' => get_option('aa_timezone', 'America/Mexico_City'),
        'total_confirmed' => ReservationsModel::count_confirmed(),
    ];
    
    wp_localize_script(
        'wpaa-availability-controller-admin',
        'aa_local_availability',
        $availability_config
    );
    
    error_log("âœ… [AvailabilityController-Admin] Datos locales enviados");
}


========================================
FILE: includes\controllers\confirmController.php
========================================
<?php
/**
 * Controlador: ConfirmaciÃ³n de Citas
 * 
 * Responsable de:
 * - Validar peticiones AJAX para confirmaciÃ³n desde admin
 * - Validar peticiones AJAX para envÃ­o de correos de confirmaciÃ³n
 * - Gestionar endpoint REST API para confirmaciÃ³n desde el backend
 * - Validar nonces y permisos
 * - Sanitizar parÃ¡metros
 * - Delegar a confirm-backend-service.php
 * - Retornar respuestas JSON
 * 
 * NO contiene lÃ³gica de negocio, ni actualizaciones de BD directas.
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Controllers
 */

if (!defined('ABSPATH')) exit;

// ðŸ”¹ Incluir servicios necesarios
require_once plugin_dir_path(__FILE__) . '../services/confirm-backend-service.php';
require_once plugin_dir_path(__FILE__) . '../models/ReservationsModel.php';

// ===============================
// ðŸ”¹ AJAX: Confirmar cita desde admin
// ===============================
add_action('wp_ajax_aa_confirmar_cita', 'aa_ajax_confirmar_cita');

function aa_ajax_confirmar_cita() {
    // âœ… Validar nonce
    check_ajax_referer('aa_confirmar_cita', '_wpnonce');
    
    // âœ… Verificar permisos
    if (!current_user_can('aa_view_panel') && !current_user_can('administrator')) {
        wp_send_json_error(['message' => 'No tienes permisos.']);
    }
    
    // âœ… Validar y sanitizar parÃ¡metros
    if (!isset($_POST['id']) || empty($_POST['id'])) {
        wp_send_json_error(['message' => 'ID de reserva no proporcionado.']);
    }
    
    $reserva_id = intval($_POST['id']);
    
    if ($reserva_id <= 0) {
        wp_send_json_error(['message' => 'ID invÃ¡lido.']);
    }
    
    // âœ… Delegar al servicio de backend
    $result = confirm_backend_service_confirmar($reserva_id);
    
    // âœ… Retornar respuesta
    if (isset($result['success']) && $result['success']) {
        wp_send_json_success($result);
    } else {
        wp_send_json_error($result);
    }
}

// ===============================
// ðŸ”¹ AJAX: Enviar correo de confirmaciÃ³n
// ===============================
add_action('wp_ajax_nopriv_aa_enviar_confirmacion', 'aa_ajax_enviar_confirmacion');
add_action('wp_ajax_aa_enviar_confirmacion', 'aa_ajax_enviar_confirmacion');

function aa_ajax_enviar_confirmacion() {
    error_log("ðŸ”¥ AJAX aa_enviar_confirmacion activado");
    
    // ðŸ”¹ Decodificar JSON del body
    $raw_input = file_get_contents('php://input');
    $datos = json_decode($raw_input, true);

    if (!$datos) {
        wp_send_json_error(['message' => 'JSON invÃ¡lido o vacÃ­o']);
        return;
    }
    
    error_log("ðŸ“¤ JSON COMPLETO QUE SE ENVÃA AL BACKEND:");
    error_log(json_encode($datos, JSON_PRETTY_PRINT));

    // âœ… Delegar al servicio
    $result = confirm_backend_service_enviar_correo($datos);
    
    // âœ… Retornar respuesta
    if ($result['success']) {
        wp_send_json_success($result);
    } else {
        wp_send_json_error($result);
    }
}

// ===============================
// ðŸ”¹ REST API: Confirmar reserva desde backend
// ===============================
add_action('rest_api_init', function () {
    register_rest_route('aa/v1', '/confirmar-reserva', [
        'methods' => 'POST',
        'callback' => 'aa_rest_confirmar_reserva',
        'permission_callback' => '__return_true',
    ]);
});

function aa_rest_confirmar_reserva(WP_REST_Request $request) {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    $id = intval($request['id_reserva']);

    if (!$id) {
        return new WP_REST_Response(['error' => 'id_reserva faltante'], 400);
    }

    // ðŸ”¹ Obtener datos de la reserva antes de actualizar
    $reserva = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE id = %d",
        $id
    ));
    
    if (!$reserva) {
        return new WP_REST_Response(['error' => 'Reserva no encontrada'], 404);
    }

    // ðŸ”¹ Preparar datos a actualizar
    $update_data = ['estado' => 'confirmed'];
    $update_format = ['%s'];
    
    // ðŸ”¹ Si viene calendar_uid, tambiÃ©n lo guardamos
    $calendar_uid = sanitize_text_field($request['calendar_uid']);
    if (!empty($calendar_uid)) {
        $update_data['calendar_uid'] = $calendar_uid;
        $update_format[] = '%s';
        error_log("âœ… calendar_uid recibido para reserva ID $id: $calendar_uid");
    }

    // ðŸ”¹ Actualizar registro
    $updated = $wpdb->update(
        $table,
        $update_data,
        ['id' => $id],
        $update_format,
        ['%d']
    );
    
    if ($updated === false) {
        error_log("âŒ Error al actualizar reserva ID $id: " . $wpdb->last_error);
        return new WP_REST_Response(['error' => 'Error al actualizar'], 500);
    }

    error_log("âœ… Reserva ID $id actualizada: estado=confirmed" . (!empty($calendar_uid) ? ", calendar_uid=$calendar_uid" : ""));
    
    // =========================================================================
    // ðŸ›¡ï¸ LÃ“GICA DE CANCELACIÃ“N EN CASCADA (tambiÃ©n para correos)
    // =========================================================================
    $conflictos = ReservationsModel::get_pending_conflicts($reserva->fecha, $id);

    if (!empty($conflictos)) {
        error_log("âš”ï¸ [REST API] Se encontraron " . count($conflictos) . " citas pendientes en conflicto para la fecha: " . $reserva->fecha);
        
        foreach ($conflictos as $conflicto) {
            $cancelado = $wpdb->update(
                $table, 
                ['estado' => 'cancelled'], 
                ['id' => $conflicto->id]
            );
            
            if ($cancelado !== false) {
                error_log("ðŸš« [Auto-Cancel REST] Cita ID {$conflicto->id} ({$conflicto->nombre}) cancelada automÃ¡ticamente por ocupaciÃ³n de slot.");
            }
        }
    }
    // =========================================================================
    
    $response_data = [
        'success' => true,
        'id' => $id,
        'estado' => 'confirmed'
    ];
    
    if (!empty($calendar_uid)) {
        $response_data['calendar_uid'] = $calendar_uid;
    }

    return new WP_REST_Response($response_data, 200);
}




========================================
FILE: includes\controllers\enqueueController.php
========================================
<?php
defined('ABSPATH') or die('Â¡Sin acceso directo!');

/**
 * Helper para resolver rutas absolutas en plugin_dir_* con paths relativos.
 */
function wpaa_path($relative) {
    return plugin_dir_path(__FILE__) . '../../' . ltrim($relative, '/');
}

function wpaa_url($relative) {
    return plugin_dir_url(__FILE__) . '../../' . ltrim($relative, '/');
}

/**
 * Registrar un script JS con soporte para mÃ³dulos ES6.
 */
function wpaa_register_js($handle, $relative_path, $deps = [], $is_module = false) {
    $url  = wpaa_url($relative_path);
    $path = wpaa_path($relative_path);

    wp_enqueue_script($handle, $url, $deps, filemtime($path), true);

    if ($is_module) {
        add_filter('script_loader_tag', function($tag, $h) use ($handle) {
            if ($h === $handle) {
                return str_replace('<script ', '<script type="module" ', $tag);
            }
            return $tag;
        }, 10, 2);
    }
}

/**
 * LocalizaciÃ³n segura y compacta de variables.
 */
function wpaa_localize($handle, $object_name, $data) {
    wp_localize_script($handle, $object_name, $data);
}

/**
 * Obtener locale segÃºn timezone.
 */
function wpaa_locale_from_timezone($tz) {
    $map = [
        'America/Mexico_City' => 'es-MX', 'America/Cancun' => 'es-MX',
        'America/Tijuana' => 'es-MX', 'America/Monterrey' => 'es-MX',
        'America/Bogota' => 'es-CO', 'America/Lima' => 'es-PE',
        'America/Argentina/Buenos_Aires' => 'es-AR', 'America/Santiago' => 'es-CL',
        'America/New_York' => 'en-US', 'America/Los_Angeles' => 'en-US',
        'Europe/Madrid' => 'es-ES', 'Europe/London' => 'en-GB'
    ];
    return $map[$tz] ?? 'es-MX';
}

/* ============================================================
   FRONTEND
============================================================ */
// ===============================
// ðŸ”¹ FRONTEND: Shortcode [agenda_automatizada]
// ===============================
add_action('wp_enqueue_scripts', 'wpaa_enqueue_frontend_assets');

function wpaa_enqueue_frontend_assets() {
    global $post;
    if (!is_a($post, 'WP_Post') || !has_shortcode($post->post_content, 'agenda_automatizada')) {
        return;
    }

    // CSS
    wp_enqueue_style('flatpickr-css', 'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css');
    wp_enqueue_style('wpaa-calendar-default', wpaa_url('css/calendar-default.css'), [], filemtime(wpaa_path('css/calendar-default.css')));

    // JS externos
    wp_enqueue_script('flatpickr-js', 'https://cdn.jsdelivr.net/npm/flatpickr', [], null, true);
    wp_enqueue_script('flatpickr-es', 'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js', ['flatpickr-js'], null, true);

    // âœ… IMPORTANTE: Cargar datos locales ANTES de cualquier script
    wpaa_localize_local_availability();

    $frontend_scripts = [
        ['wpaa-date-utils',              'assets/js/utils/dateUtils.js',              [], false],
        ['aa-wpagenda-kernel',           'assets/js/ui-adapters/WPAgenda.js',         ['wpaa-date-utils'], false],
        ['aa-calendar-default-adapter',  'assets/js/ui-adapters/calendarDefaultAdapter.js', ['wpaa-date-utils', 'aa-wpagenda-kernel'], false],
        ['aa-slots-default-adapter',     'assets/js/ui-adapters/slotsDefaultAdapter.js', ['wpaa-date-utils', 'aa-wpagenda-kernel'], false],
        ['aa-modal-default-adapter',     'assets/js/ui-adapters/modalDefaultAdapter.js', ['wpaa-date-utils', 'aa-wpagenda-kernel'], false],
        ['wpaa-calendar-ui',             'assets/js/ui/calendarUI.js', ['flatpickr-js', 'flatpickr-es', 'wpaa-date-utils'], false],
        ['wpaa-slot-selector-ui',        'assets/js/ui/slotSelectorUI.js', ['wpaa-date-utils'], false],
        ['wpaa-proxy-fetch',             'assets/js/services/availability/proxyFetch.js', [], false],
        ['wpaa-combine-local-external',  'assets/js/services/availability/combineLocalExternal.js', [], false],
        ['wpaa-busy-ranges',             'assets/js/services/availability/busyRanges.js', [], false],
        ['wpaa-slot-calculator',         'assets/js/services/availability/slotCalculator.js', ['wpaa-date-utils'], false],
        ['wpaa-availability-service',    'assets/js/services/availabilityService.js', ['wpaa-date-utils', 'wpaa-proxy-fetch', 'wpaa-combine-local-external', 'wpaa-busy-ranges', 'wpaa-slot-calculator'], false],
        ['wpaa-reservation-service',     'assets/js/services/reservationService.js', [], false],
        ['wpaa-availability-controller', 'assets/js/controllers/availabilityController.js', ['wpaa-date-utils', 'wpaa-calendar-ui', 'wpaa-slot-selector-ui', 'wpaa-availability-service', 'aa-wpagenda-kernel', 'aa-calendar-default-adapter', 'aa-slots-default-adapter', 'aa-modal-default-adapter'], false],
        ['wpaa-reservation-controller',  'assets/js/controllers/reservationController.js', ['wpaa-reservation-service', 'aa-wpagenda-kernel', 'aa-calendar-default-adapter', 'aa-slots-default-adapter', 'aa-modal-default-adapter'], false],
        ['wpaa-main-frontend',           'assets/js/main-frontend.js', ['wpaa-availability-controller', 'wpaa-reservation-controller'], false],
    ];

    foreach ($frontend_scripts as [$h, $p, $d, $m]) {
        wpaa_register_js($h, $p, $d, $m);
    }

    wpaa_localize('wpaa-availability-controller', 'aa_backend', [
        'ajax_url' => admin_url('admin-ajax.php'),
        'action'   => 'aa_get_availability',
        'email'    => get_option('aa_google_email', ''),
    ]);

    wpaa_localize('wpaa-availability-controller', 'aa_schedule',      get_option('aa_schedule', []));
    wpaa_localize('wpaa-availability-controller', 'aa_future_window', intval(get_option('aa_future_window', 15)));
    wpaa_localize('wpaa-availability-controller', 'aa_slot_duration', intval(get_option('aa_slot_duration', 60)));

    wpaa_localize('wpaa-reservation-service', 'aa_reservation_config', [
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce'    => wp_create_nonce('aa_reservation_nonce'),
    ]);

    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    
    wpaa_localize('wpaa-reservation-controller', 'wpaa_vars', [
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('aa_reservation_nonce'),
        'whatsapp_number' => get_option('aa_whatsapp_number', '5215522992290'),
        'timezone' => $timezone,
        'locale' => wpaa_locale_from_timezone($timezone)
    ]);
}

/**
 * Inyectar disponibilidad local ANTES de scripts JS
 */
function wpaa_localize_local_availability($script_handle = 'wpaa-availability-controller') {
    // AquÃ­ debes cargar las reservas confirmadas de la BD
    // Ejemplo (ajustar segÃºn tu modelo de datos):
    
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservations';
    
    $confirmed = $wpdb->get_results("
        SELECT fecha_inicio as start, fecha_fin as end, nombre as title, email as attendee 
        FROM $table 
        WHERE estado = 'confirmed' 
        AND fecha_inicio >= NOW()
        ORDER BY fecha_inicio ASC
    ");

    $local_busy = [];
    foreach ($confirmed as $row) {
        $local_busy[] = [
            'start' => $row->start,
            'end' => $row->end,
            'title' => $row->title,
            'attendee' => $row->attendee
        ];
    }

    wp_localize_script($script_handle, 'aa_local_availability', [
        'local_busy' => $local_busy,
        'slot_duration' => intval(get_option('aa_slot_duration', 60)),
        'timezone' => get_option('aa_timezone', 'America/Mexico_City'),
        'total_confirmed' => count($local_busy)
    ]);
}

/* ============================================================
   ADMIN
============================================================ */
function wpaa_enqueue_admin_assets($hook) {

    // ðŸ”¹ Encolar Tailwind CSS solo en pÃ¡ginas del plugin
    $plugin_pages = [
        'toplevel_page_agenda-automatizada-settings',
        'agenda-automatizada_page_aa_asistant_panel',
        'toplevel_page_aa_asistant_panel'
    ];
    
    if (in_array($hook, $plugin_pages)) {
        wp_enqueue_style(
            'aa-admin-tailwind',
            wpaa_url('assets/css/admin.css'),
            [],
            filemtime(wpaa_path('assets/css/admin.css'))
        );
    }

    // --- Pantalla principal de ajustes ---
    // Note: Settings page now uses iframe-based UI, so JS is loaded inside the iframe
    // No global enqueue needed here - JS is loaded by the iframe UI module

    // --- Panel del asistente ---
    if ($hook === 'toplevel_page_aa_asistant_panel' || $hook === 'agenda-automatizada_page_aa_asistant_panel') {

        // ðŸ”¹ Encolar CSS del panel del asistente
        wp_enqueue_style('wpaa-asistant-panel-styles', wpaa_url('css/styles.css'), [], filemtime(wpaa_path('css/styles.css')));

        wp_enqueue_style('flatpickr-css-admin', 'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css');
        wp_enqueue_script('flatpickr-js-admin', 'https://cdn.jsdelivr.net/npm/flatpickr', [], null, true);
        wp_enqueue_script('flatpickr-es-admin', 'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js', ['flatpickr-js-admin'], null, true);

        // âœ… IMPORTANTE: Cargar datos locales ANTES de cualquier script admin
        wpaa_localize_local_availability('wpaa-availability-controller-admin');

        // Scripts admin declarados
        $admin_scripts = [
            // ðŸ”¹ Utilidades
            ['wpaa-date-utils-admin',              'assets/js/utils/dateUtils.js',              [], true],
            
            // ðŸ”¹ UI (PRIMERO, antes de controladores)
            ['wpaa-calendar-ui-admin',             'assets/js/ui/calendarUI.js',                
                                                   ['flatpickr-js-admin', 'flatpickr-es-admin'], true],
            ['wpaa-calendar-admin-ui',             'assets/js/ui/calendarAdminUI.js',           
                                                   ['flatpickr-js-admin', 'flatpickr-es-admin'], true],
            ['wpaa-slot-selector-admin-ui',        'assets/js/ui/slotSelectorAdminUI.js',       [], true],
            
            // ðŸ”¹ Servicios (AJAX)
            ['wpaa-proxy-fetch-admin',             'assets/js/services/availability/proxyFetch.js', [], true],
            ['wpaa-combine-local-external-admin',  'assets/js/services/availability/combineLocalExternal.js', [], true],
            ['wpaa-busy-ranges-admin',             'assets/js/services/availability/busyRanges.js', [], true],
            ['wpaa-slot-calculator-admin',         'assets/js/services/availability/slotCalculator.js', 
                                                   ['wpaa-date-utils-admin'], true],
            ['wpaa-availability-service-admin',    'assets/js/services/availabilityService.js',
                                                   ['wpaa-date-utils-admin', 'wpaa-proxy-fetch-admin', 'wpaa-combine-local-external-admin', 'wpaa-busy-ranges-admin', 'wpaa-slot-calculator-admin'], true],
            ['wpaa-reservation-service-admin',     'assets/js/services/reservationService.js',  [], true],
            ['wpaa-confirm-service',               'assets/js/services/confirmService.js',      [], false],
            
            // ðŸ”¹ MÃ³dulos UI (renderizado puro)
            ['aa-proximas-citas-ui',               'assets/js/ui/proximasCitasUI.js',          [], false],
            
            // ðŸ”¹ Controladores (DESPUÃ‰S de UI y Services)
            ['wpaa-availability-controller-admin', 'assets/js/controllers/availabilityController.js',
                                                   ['wpaa-date-utils-admin', 'wpaa-calendar-admin-ui', 'wpaa-slot-selector-admin-ui', 'wpaa-availability-service-admin'], true],
            ['wpaa-admin-reservation-controller',  'assets/js/controllers/adminReservationController.js',
                                                   ['wpaa-reservation-service-admin'], true],
            ['wpaa-admin-confirm-controller',      'assets/js/controllers/adminConfirmController.js',
                                                   ['wpaa-confirm-service'], false],
            ['wpaa-proximas-citas-controller',     'assets/js/controllers/proximasCitasController.js',
                                                   ['aa-proximas-citas-ui', 'wpaa-admin-confirm-controller'], false],
            
            // ðŸ”¹ Punto de entrada (ÃšLTIMO)
            ['wpaa-main-admin',                    'assets/js/main-admin.js',
                                                   ['wpaa-admin-reservation-controller','wpaa-date-utils-admin', 'wpaa-availability-controller-admin'], true],
            
            // ðŸ”¹ Scripts legacy (compatibilidad)
            ['aa-asistant-controls',               'js/asistant-controls.js',                  [], false],
            ['aa-historial-citas',                 'js/historial-citas.js',                    [], false],
            ['aa-proximas-citas',                  'js/proximas-citas.js',                     ['wpaa-proximas-citas-controller'], false],
        ];

        foreach ($admin_scripts as [$h, $p, $d, $m]) {
            wpaa_register_js($h, $p, $d, $m);
        }

        // Localize comunes admin
        wpaa_localize('wpaa-date-utils-admin', 'wpaa_vars', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'timezone' => get_option('aa_timezone', 'America/Mexico_City'),
            'locale'   => get_option('aa_locale', 'es-MX'),
            'nonce'    => wp_create_nonce('aa_reservation_nonce'),
        ]);

        $email = sanitize_email(get_option('aa_google_email', ''));

        wpaa_localize('wpaa-availability-controller-admin', 'aa_backend', [
            'ajax_url' => admin_url('admin-ajax.php'),
            'action'   => 'aa_get_availability',
            'email'    => $email,
        ]);

        wpaa_localize('wpaa-availability-controller-admin', 'aa_schedule',      get_option('aa_schedule', []));
        wpaa_localize('wpaa-availability-controller-admin', 'aa_future_window', intval(get_option('aa_future_window', 15)));
        wpaa_localize('wpaa-availability-controller-admin', 'aa_slot_duration', intval(get_option('aa_slot_duration', 60)));

        wpaa_localize('aa-asistant-controls', 'aa_asistant_vars', [
            'nonce_confirmar' => wp_create_nonce('aa_confirmar_cita'),
            'nonce_cancelar'  => wp_create_nonce('aa_cancelar_cita'),
            'nonce_crear_cliente' => wp_create_nonce('aa_crear_cliente'),
            'nonce_crear_cita' => wp_create_nonce('aa_reservation_nonce'),
            'nonce_crear_cliente_desde_cita' => wp_create_nonce('aa_crear_cliente_desde_cita'),
            'nonce_editar_cliente' => wp_create_nonce('aa_editar_cliente'),
        ]);

        wpaa_localize('aa-historial-citas', 'aa_historial_vars', [
            'nonce' => wp_create_nonce('aa_historial_citas'),
        ]);

        wpaa_localize('aa-proximas-citas', 'aa_proximas_vars', [
            'nonce' => wp_create_nonce('aa_proximas_citas'),
        ]);
    }
}
add_action('admin_enqueue_scripts', 'wpaa_enqueue_admin_assets');



========================================
FILE: includes\controllers\proximasCitasController.php
========================================
<?php
/**
 * Controlador: PrÃ³ximas Citas y GestiÃ³n de Estado
 * 
 * Maneja:
 * - ObtenciÃ³n y filtrado de prÃ³ximas citas (AJAX)
 * - ConfirmaciÃ³n manual de citas
 * - CancelaciÃ³n de citas (con eliminaciÃ³n en Google Calendar)
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Controllers
 */

if (!defined('ABSPATH')) exit;

// ===============================
// ðŸ”¹ AJAX: Obtener prÃ³ximas citas
// ===============================
add_action('wp_ajax_aa_get_proximas_citas', 'aa_ajax_get_proximas_citas');

function aa_ajax_get_proximas_citas() {
    // Verificar nonce
    check_ajax_referer('aa_proximas_citas');
    
    // Verificar permisos
    if (!current_user_can('aa_view_panel') && !current_user_can('administrator')) {
        wp_send_json_error(['message' => 'No tienes permisos.']);
    }
    
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    // ðŸ”¹ Obtener fecha y hora actual segÃºn aa_timezone
    $now = aa_get_current_datetime();
    
    error_log("ðŸ• [ProximasCitas] Hora actual: $now");
    
    // ðŸ”¹ Obtener slot_duration para calcular fecha de fin
    $slot_duration = intval(get_option('aa_slot_duration', 60));
    
    // ðŸ”¹ ParÃ¡metros de bÃºsqueda
    $buscar = isset($_POST['buscar']) ? sanitize_text_field($_POST['buscar']) : '';
    $ordenar = isset($_POST['ordenar']) ? sanitize_text_field($_POST['ordenar']) : 'fecha_asc';
    $pagina = isset($_POST['pagina']) ? intval($_POST['pagina']) : 1;
    $por_pagina = 10;
    $offset = ($pagina - 1) * $por_pagina;
    
    // ðŸ”¹ ConstrucciÃ³n de la consulta base
    // Solo mostrar citas que AÃšN NO TERMINARON (fecha + slot_duration >= ahora)
    $where = "WHERE DATE_ADD(fecha, INTERVAL %d MINUTE) >= %s";
    $params = [$slot_duration, $now];
    
    error_log("ðŸ“‹ [ProximasCitas] Buscando citas que terminan despuÃ©s de: $now (duraciÃ³n: {$slot_duration} min)");
    
    // ðŸ”¹ Filtro de bÃºsqueda
    if (!empty($buscar)) {
        $where .= " AND (nombre LIKE %s OR telefono LIKE %s OR correo LIKE %s OR servicio LIKE %s)";
        $like_buscar = '%' . $wpdb->esc_like($buscar) . '%';
        $params[] = $like_buscar;
        $params[] = $like_buscar;
        $params[] = $like_buscar;
        $params[] = $like_buscar;
    }
    
    // ðŸ”¹ Ordenamiento
    $order_by = match($ordenar) {
        'fecha_asc' => 'ORDER BY fecha ASC',
        'fecha_desc' => 'ORDER BY fecha DESC',
        'cliente_asc' => 'ORDER BY nombre ASC',
        'cliente_desc' => 'ORDER BY nombre DESC',
        'estado_asc' => 'ORDER BY estado ASC',
        'estado_desc' => 'ORDER BY estado DESC',
        default => 'ORDER BY fecha ASC'
    };
    
    // ðŸ”¹ Contar total de registros
    $total_query = "SELECT COUNT(*) FROM $table $where";
    $total = $wpdb->get_var($wpdb->prepare($total_query, $params));
    
    // ðŸ”¹ Obtener registros paginados
    $query = "SELECT *, DATE_ADD(fecha, INTERVAL %d MINUTE) as fecha_fin FROM $table $where $order_by LIMIT %d OFFSET %d";
    $params_query = array_merge([$slot_duration], $params, [$por_pagina, $offset]);
    
    $citas = $wpdb->get_results($wpdb->prepare($query, $params_query));
    
    // ðŸ”¹ Calcular paginaciÃ³n
    $total_paginas = ceil($total / $por_pagina);
    
    error_log("âœ… [ProximasCitas] Encontradas {$total} citas, mostrando pÃ¡gina {$pagina} de {$total_paginas}");
    
    wp_send_json_success([
        'citas' => $citas,
        'pagina_actual' => $pagina,
        'total_paginas' => $total_paginas,
        'total_registros' => $total
    ]);
}



// ===============================
// ðŸ”¹ AJAX: Cancelar cita (con eliminaciÃ³n en Google Calendar)
// ===============================
add_action('wp_ajax_aa_cancelar_cita', 'aa_ajax_cancelar_cita');

function aa_ajax_cancelar_cita() {
    check_ajax_referer('aa_cancelar_cita');
    
    if (!current_user_can('aa_view_panel') && !current_user_can('administrator')) {
        wp_send_json_error(['message' => 'No tienes permisos.']);
    }
    
    $id = intval($_POST['id']);
    if (!$id) {
        wp_send_json_error(['message' => 'ID invÃ¡lido.']);
    }
    
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    // ðŸ”¹ Obtener datos de la reserva (especialmente calendar_uid)
    $reserva = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE id = %d",
        $id
    ));
    
    if (!$reserva) {
        wp_send_json_error(['message' => 'Reserva no encontrada.']);
    }
    
    // ðŸ”¹ PASO 1: Actualizar estado en WordPress
    $updated = $wpdb->update($table, ['estado' => 'cancelled'], ['id' => $id]);
    
    if ($updated === false) {
        wp_send_json_error(['message' => 'Error al actualizar en BD.']);
    }
    
    error_log("âœ… Cita ID $id marcada como 'cancelled' en WordPress");
    
    // ðŸ”¹ PASO 2: Eliminar evento de Google Calendar (si existe calendar_uid Y hay email configurado)
    $calendar_deleted = false;
    $google_email = get_option('aa_google_email', ''); // âœ… Obtener email configurado
    
    // âœ… CONDICIÃ“N AGREGADA: !empty($google_email)
    if (!empty($reserva->calendar_uid) && !empty($google_email)) {
        error_log("ðŸ—“ï¸ Intentando eliminar evento de Google Calendar: {$reserva->calendar_uid}");
        
        // ðŸ”¹ Usar la funciÃ³n centralizada para obtener el domain
        $domain = aa_get_clean_domain();
        
        // Determinar URL del backend
        $site_url = get_site_url();
        $backend_url = (strpos($site_url, 'localhost') !== false)
            ? 'http://localhost:3000/cancelaciones/cancelar-cita'
            : 'https://deoia-oauth-backend.onrender.com/cancelaciones/cancelar-cita';
        
        // Datos para enviar al backend
        $backend_data = [
            'domain' => $domain,
            'calendar_uid' => $reserva->calendar_uid,
        ];
        
        error_log("ðŸ“¤ Enviando solicitud de cancelaciÃ³n a: $backend_url");
        
        // Enviar peticiÃ³n autenticada con HMAC
        $response = aa_send_authenticated_request($backend_url, 'POST', $backend_data);
        
        if (is_wp_error($response)) {
            error_log("âš ï¸ Error al contactar backend para cancelar: " . $response->get_error_message());
            // No fallar aquÃ­, la cita ya fue cancelada en WordPress
        } else {
            $status = wp_remote_retrieve_response_code($response);
            $body = wp_remote_retrieve_body($response);
            $decoded = json_decode($body, true);
            
            error_log("ðŸ“¥ Respuesta del backend (HTTP $status): " . print_r($decoded, true));
            
            if ($status >= 200 && $status < 300 && isset($decoded['success']) && $decoded['success']) {
                error_log("âœ… Evento eliminado de Google Calendar exitosamente");
                $calendar_deleted = true;
            } elseif ($status === 404 || $status === 410) {
                error_log("â„¹ï¸ El evento ya no existe en Google Calendar (puede haber sido eliminado antes)");
                $calendar_deleted = true; // Consideramos exitoso si ya no existe
            } else {
                error_log("âš ï¸ El backend respondiÃ³ con error al intentar cancelar en Google Calendar");
            }
        }
    } else {
        // Log especÃ­fico para saber por quÃ© no se ejecutÃ³
        if (empty($google_email)) {
            error_log("â„¹ï¸ CancelaciÃ³n LOCAL solamente: No hay 'aa_google_email' configurado.");
        } else {
            error_log("â„¹ï¸ La cita ID $id no tiene 'calendar_uid' asociado, no se eliminarÃ¡ de Google Calendar");
        }
    }
    
    wp_send_json_success([
        'message' => 'Cita cancelada correctamente.',
        'calendar_deleted' => $calendar_deleted
    ]);
}


========================================
FILE: includes\controllers\WebhooksController.php
========================================
<?php
/**
 * Webhooks Controller
 * 
 * Maneja webhooks entrantes del backend de OAuth.
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Api
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

/**
 * Class Webhooks_Controller
 * 
 * Controlador REST para procesar webhooks entrantes.
 */
class Webhooks_Controller extends WP_REST_Controller {

    /**
     * Constructor.
     */
    public function __construct() {
        $this->namespace = 'aa/v1';
        $this->rest_base = 'webhooks';
    }

    /**
     * Registra las rutas del controlador.
     */
    public function register_routes() {
        register_rest_route($this->namespace, '/' . $this->rest_base . '/sync-status', array(
            array(
                'methods'             => WP_REST_Server::CREATABLE,
                'callback'            => array($this, 'handle_sync_status'),
                'permission_callback' => '__return_true', // PÃºblico - validaremos el payload
                'args'                => $this->get_sync_status_params(),
            ),
        ));
    }

    /**
     * Define los parÃ¡metros esperados para el endpoint sync-status.
     *
     * @return array ParÃ¡metros de validaciÃ³n.
     */
    protected function get_sync_status_params() {
        return array(
            'status' => array(
                'required'          => true,
                'type'              => 'string',
                'description'       => 'Estado de sincronizaciÃ³n (invalid o valid)',
                'sanitize_callback' => 'sanitize_text_field',
                'validate_callback' => function($param, $request, $key) {
                    return in_array($param, array('invalid', 'valid'), true);
                },
            ),
        );
    }

    /**
     * Maneja el webhook de cambio de estado de sincronizaciÃ³n.
     *
     * @param WP_REST_Request $request Objeto de solicitud REST.
     * @return WP_REST_Response|WP_Error Respuesta de la API.
     */
    public function handle_sync_status($request) {
        // Obtener el parÃ¡metro de estado
        $status = $request->get_param('status');

        // Delegar la lÃ³gica de negocio al servicio
        $result = SyncService::update_sync_status($status);

        // Verificar si el servicio reportÃ³ un fallo
        if (!$result['success']) {
            return new WP_Error(
                'sync_update_failed',
                $result['message'],
                array('status' => 400)
            );
        }

        // Respuesta exitosa
        return new WP_REST_Response($result, 200);
    }
}



========================================
FILE: includes\models\ReservationsModel.php
========================================
<?php
/**
 * Modelo: Reservaciones
 * 
 * Responsable de:
 * - Consultas a la tabla wp_aa_reservas
 * - ObtenciÃ³n de slots ocupados localmente
 * - Formateo de datos para disponibilidad
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Models
 */

if (!defined('ABSPATH')) exit;

class ReservationsModel {

    /**
     * Obtener slots ocupados desde la base de datos local
     * 
     * @return array Array de slots ocupados con formato [start, end]
     */
    public static function get_internal_busy_slots() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        // ðŸ”¹ Obtener slot_duration configurado
        $slot_duration = intval(get_option('aa_slot_duration', 60));
        
        // ðŸ”¹ Consultar solo citas confirmadas que NO han terminado
        $now = aa_get_current_datetime();
        
        $rows = $wpdb->get_results($wpdb->prepare("
            SELECT 
                fecha as start,
                DATE_ADD(fecha, INTERVAL %d MINUTE) as end,
                servicio,
                nombre
            FROM $table 
            WHERE estado = 'confirmed'
            AND DATE_ADD(fecha, INTERVAL %d MINUTE) >= %s
            ORDER BY fecha ASC
        ", $slot_duration, $slot_duration, $now));
        
        if ($wpdb->last_error) {
            error_log("âŒ [ReservationsModel] Error en consulta: " . $wpdb->last_error);
            return [];
        }
        
        error_log("âœ… [ReservationsModel] Encontradas " . count($rows) . " citas confirmadas");
        
        // ðŸ”¹ Formatear resultados en estructura compatible con Google Calendar
        return array_map(function($row) {
            return [
                'start' => $row->start,
                'end'   => $row->end,
                'title' => $row->servicio ?? 'Cita',
                'attendee' => $row->nombre ?? 'Sin nombre'
            ];
        }, $rows);
    }
    
    /**
     * Obtener todas las citas confirmadas (para debug)
     * 
     * @return array
     */
    public static function get_all_confirmed() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        $rows = $wpdb->get_results("
            SELECT * 
            FROM $table 
            WHERE estado = 'confirmed'
            ORDER BY fecha DESC
            LIMIT 50
        ");
        
        return $rows ?? [];
    }
    
    /**
     * Contar citas confirmadas
     * 
     * @return int
     */
    public static function count_confirmed() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        $count = $wpdb->get_var("
            SELECT COUNT(*) 
            FROM $table 
            WHERE estado = 'confirmed'
        ");
        
        return intval($count);
    }

    /**
     * Obtener citas pendientes que coinciden en fecha/hora (para cancelaciÃ³n automÃ¡tica)
     * 
     * @param string $fecha DateTime string (Y-m-d H:i:s)
     * @param int $exclude_id ID de la cita que estamos confirmando (para no cancelarla a ella misma)
     * @return array
     */
    public static function get_pending_conflicts($fecha, $exclude_id) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        // Buscamos citas PENDIENTES que tengan EXACTAMENTE la misma fecha de inicio
        // y que no sean la cita actual.
        $rows = $wpdb->get_results($wpdb->prepare("
            SELECT id, nombre, correo, fecha 
            FROM $table 
            WHERE estado = 'pending' 
            AND fecha = %s 
            AND id != %d
        ", $fecha, $exclude_id));
        
        return $rows ?? [];
    }
}


========================================
FILE: includes\services\availability-proxy.php
========================================
<?php
if (!defined('ABSPATH')) exit;

function aa_build_availability_url_for($email) {
    $backend_url = AA_API_BASE_URL . "/calendar/availability";

    $now = new DateTime('now', new DateTimeZone('UTC'));
    $future = new DateTime('+1 month', new DateTimeZone('UTC'));

    // ðŸ”¹ Usar la funciÃ³n centralizada para obtener el domain
    $domain = aa_get_clean_domain();

    $params = [
        'domain'  => $domain,
        'email'   => $email,
        'timeMin' => $now->format(DateTime::ATOM),
        'timeMax' => $future->format(DateTime::ATOM),
    ];

    return $backend_url . '?' . http_build_query($params);
}

// Endpoint AJAX (pÃºblico y autenticado) que actÃºa como proxy al backend
add_action('wp_ajax_nopriv_aa_get_availability', 'aa_ajax_get_availability');
add_action('wp_ajax_aa_get_availability', 'aa_ajax_get_availability');

function aa_ajax_get_availability() {
    $email = isset($_REQUEST['email']) ? sanitize_email(wp_unslash($_REQUEST['email'])) : sanitize_email(get_option('aa_google_email', ''));

    if (empty($email)) {
        error_log("âŒ aa_availability: No hay email configurado");
        wp_send_json_error(['message' => 'No email configured'], 400);
    }

    $backend_url = aa_build_availability_url_for($email);
    
    error_log("ðŸ“¤ aa_availability: Consultando disponibilidad");
    error_log("   Email: $email");
    error_log("   URL: $backend_url");

    $response = aa_send_authenticated_request($backend_url, 'GET');

    if (is_wp_error($response)) {
        error_log("âŒ aa_availability: Error WP - " . $response->get_error_message());
        wp_send_json_error(['message' => 'request_failed', 'error' => $response->get_error_message()], 500);
    }

    $code = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    
    error_log("ðŸ“¥ aa_availability: Respuesta recibida (status $code)");

    if ($code === 401 || $code === 403) {
        $decoded = json_decode($body, true);
        error_log("ðŸ”’ Error de autenticaciÃ³n en availability: " . ($decoded['error'] ?? 'Sin detalles'));
        wp_send_json_error([
            'message' => 'authentication_failed',
            'error' => $decoded['error'] ?? 'Unauthorized'
        ], $code);
    }

    if ($code >= 500) {
        $decoded = json_decode($body, true);
        error_log("ðŸ”¥ Error 500 del backend: " . print_r($decoded, true));
        wp_send_json_error([
            'message' => 'backend_error',
            'error' => $decoded['error'] ?? 'Internal server error'
        ], $code);
    }

    status_header($code);
    header('Content-Type: application/json; charset=utf-8');
    echo $body;
    wp_die();
}


========================================
FILE: includes\services\confirm-backend-service.php
========================================
<?php
/**
 * Servicio: ConfirmaciÃ³n de Citas con Backend
 * 
 * Responsable de:
 * - Obtener datos de la reserva desde WordPress
 * - Construir payload para el backend
 * - Enviar peticiÃ³n autenticada con HMAC
 * - Actualizar estado de la reserva en WordPress
 * - Ejecutar cancelaciÃ³n en cascada de citas conflictivas
 * - Enviar correos de confirmaciÃ³n al backend
 * 
 * NO contiene validaciones de AJAX ni permisos (eso es del controlador).
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Services
 */

if (!defined('ABSPATH')) exit;

/**
 * Confirmar una cita enviando solicitud al backend
 * 
 * @param int $reserva_id ID de la reserva
 * @return array ['success' => bool, 'message' => string, 'data' => array]
 */
function confirm_backend_service_confirmar($reserva_id) {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    // 1ï¸âƒ£ Obtener datos de la reserva
    $reserva = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE id = %d",
        $reserva_id
    ));
    
    if (!$reserva) {
        return [
            'success' => false,
            'message' => 'Reserva no encontrada.'
        ];
    }
    
    // ðŸ”¹ PASO 1: Actualizar estado en WordPress PRIMERO
    $updated = $wpdb->update($table, ['estado' => 'confirmed'], ['id' => $reserva_id]);
    
    if ($updated === false) {
        error_log("âŒ [ConfirmService] Error al actualizar estado en WordPress");
        return [
            'success' => false,
            'message' => 'Error al actualizar el estado en la base de datos.'
        ];
    }
    
    error_log("âœ… [ConfirmService] Cita ID $reserva_id marcada como 'confirmed' en WordPress");
    
    // =========================================================================
    // ðŸ›¡ï¸ LÃ“GICA DE CANCELACIÃ“N EN CASCADA
    // =========================================================================
    require_once plugin_dir_path(__FILE__) . '../models/ReservationsModel.php';

    $conflictos = ReservationsModel::get_pending_conflicts($reserva->fecha, $reserva_id);

    if (!empty($conflictos)) {
        error_log("âš”ï¸ [ConfirmService] Se encontraron " . count($conflictos) . " citas pendientes en conflicto para la fecha: " . $reserva->fecha);
        
        foreach ($conflictos as $conflicto) {
            $cancelado = $wpdb->update(
                $table, 
                ['estado' => 'cancelled'], 
                ['id' => $conflicto->id]
            );
            
            if ($cancelado !== false) {
                error_log("ðŸš« [Auto-Cancel] Cita ID {$conflicto->id} ({$conflicto->nombre}) cancelada automÃ¡ticamente por ocupaciÃ³n de slot.");
            }
        }
    }
    // =========================================================================

     // ---------------------------------------------------------
    // ðŸ›‘ Validar si existe email antes de seguir
    // ---------------------------------------------------------
    $google_email = get_option('aa_google_email', '');

    if (empty($google_email)) {
        error_log("â„¹ï¸ [ConfirmService] Modo Local: Sin email configurado.");
        return [
            'success' => true,
            'message' => 'Cita confirmada localmente (Sin sincronizaciÃ³n con Google Calendar).',
            'data' => [
                'existed' => false,
                'calendar_sync' => false
            ]
        ];
    }
    // ---------------------------------------------------------

    // 2ï¸âƒ£ Obtener configuraciÃ³n
    $slot_duration = intval(get_option('aa_slot_duration', 60));
    $business_name = get_option('aa_business_name', get_bloginfo('name'));
    $business_address = get_option('aa_business_address', 'No especificada');
    
    // 3ï¸âƒ£ Obtener dominio limpio usando la funciÃ³n centralizada
    $domain = aa_get_clean_domain();
    
    // 4ï¸âƒ£ Determinar URL del backend
    $backend_url = (strpos(get_site_url(), 'localhost') !== false)
        ? 'http://localhost:3000/calendar/crear-reserva-directa'
        : 'https://deoia-oauth-backend.onrender.com/calendar/crear-reserva-directa';
    
    // 5ï¸âƒ£ Formatear fecha segÃºn el backend espera (ISO 8601 con timezone)
    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    
    try {
        $fecha_obj = new DateTime($reserva->fecha, new DateTimeZone($timezone));
        $fecha_iso = $fecha_obj->format('c'); // Formato: 2025-11-17T09:30:00-06:00
    } catch (Exception $e) {
        error_log("âŒ [ConfirmService] Error al formatear fecha: " . $e->getMessage());
        return [
            'success' => false,
            'message' => 'Error al formatear la fecha de la reserva.'
        ];
    }
    
    // 6ï¸âƒ£ Construir payload para el backend
    $payload = [
        'domain' => $domain,
        'nombre' => $reserva->nombre,
        'servicio' => $reserva->servicio,
        'fecha' => $fecha_iso,
        'telefono' => $reserva->telefono,
        'email' => $reserva->correo,
        'slot_duration' => $slot_duration,
        'businessName' => $business_name,
        'businessAddress' => $business_address,
        'id_reserva' => $reserva_id
    ];
    
    error_log("ðŸ“¤ [ConfirmService] Enviando confirmaciÃ³n al backend:");
    error_log("   URL: $backend_url");
    error_log("   Payload: " . json_encode($payload, JSON_PRETTY_PRINT));
    
    // 7ï¸âƒ£ Enviar peticiÃ³n autenticada con HMAC
    $response = aa_send_authenticated_request($backend_url, 'POST', $payload);
    
    if (is_wp_error($response)) {
        error_log("âš ï¸ [ConfirmService] Error al contactar backend: " . $response->get_error_message());
        return [
            'success' => true,
            'message' => 'Cita confirmada en WordPress, pero no se pudo sincronizar con Google Calendar: ' . $response->get_error_message(),
            'calendar_sync' => false
        ];
    }
    
    // 8ï¸âƒ£ Procesar respuesta
    $status = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    $decoded = json_decode($body, true);
    
    error_log("ðŸ“¥ [ConfirmService] Respuesta del backend (HTTP $status):");
    error_log("   " . print_r($decoded, true));
    
    if ($status >= 200 && $status < 300 && isset($decoded['success']) && $decoded['success']) {
        // âœ… Backend confirmÃ³ exitosamente
        
        // 9ï¸âƒ£ Actualizar calendar_uid en WordPress
        $calendar_uid = $decoded['data']['event_id'] ?? null;
        
        if ($calendar_uid) {
            $wpdb->update($table, ['calendar_uid' => $calendar_uid], ['id' => $reserva_id]);
            error_log("âœ… [ConfirmService] calendar_uid actualizado: $calendar_uid");
        }
        
        return [
            'success' => true,
            'message' => $decoded['data']['existed'] 
                ? 'Cita confirmada. El evento ya existÃ­a en Google Calendar.' 
                : 'Cita confirmada y agregada a Google Calendar.',
            'data' => [
                'event_id' => $calendar_uid,
                'event_link' => $decoded['data']['event_link'] ?? null,
                'existed' => $decoded['data']['existed'] ?? false,
                'calendar_sync' => true
            ]
        ];
        
    } else {
        // âŒ Backend respondiÃ³ con error
        $error_message = $decoded['message'] ?? 'Error desconocido del backend.';
        
        error_log("âš ï¸ [ConfirmService] Backend respondiÃ³ con error: $error_message");
        
        return [
            'success' => true,
            'message' => "Cita confirmada en WordPress, pero fallÃ³ la sincronizaciÃ³n con Google Calendar: $error_message",
            'calendar_sync' => false
        ];
    }
}

/**
 * Enviar correo de confirmaciÃ³n al backend
 * 
 * @param array $datos Datos de la reserva desde AJAX
 * @return array ['success' => bool, 'message' => string, 'data' => array]
 */
function confirm_backend_service_enviar_correo($datos) {
    // ðŸ”¹ Usar la funciÃ³n centralizada para obtener el domain
    $domain = aa_get_clean_domain();

    error_log("ðŸ§© [EmailService] Dominio detectado: $domain");

    // ðŸ”¹ Reorganizar datos para enviar al backend
    $backend_data = [
        'domain' => $domain,
        'nombre' => $datos['nombre'] ?? '',
        'servicio' => $datos['servicio'] ?? '',
        'fecha' => $datos['fecha'] ?? '',
        'telefono' => $datos['telefono'] ?? '',
        'email' => $datos['correo'] ?? '',
        'id_reserva' => $datos['id_reserva'] ?? null,
        'businessName' => get_option('aa_business_name', 'Nuestro negocio'),
        'businessAddress' => get_option('aa_business_address', 'No especificada'),
        'whatsapp' => get_option('aa_whatsapp_number', ''),
        'slot_duration' => intval(get_option('aa_slot_duration', 60)),
    ];

    error_log("ðŸ“¦ [EmailService] Datos reorganizados para backend:");
    error_log(print_r($backend_data, true));

    // ðŸ”¹ Determinar URL del backend segÃºn entorno
    $site_url = get_site_url();
    $backend_url = (strpos($site_url, 'localhost') !== false)
        ? 'http://localhost:3000/correos/confirmacion'
        : 'https://deoia-oauth-backend.onrender.com/correos/confirmacion';

    // ðŸ”¹ Enviar peticiÃ³n autenticada con HMAC
    $response = aa_send_authenticated_request($backend_url, 'POST', $backend_data);

    if (is_wp_error($response)) {
        error_log("âŒ [EmailService] Error al contactar backend: " . $response->get_error_message());
        return [
            'success' => false,
            'message' => 'Error de conexiÃ³n con el backend',
            'error' => $response->get_error_message()
        ];
    }

    $status = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    $decoded = json_decode($body, true);

    error_log("ðŸ“¥ [EmailService] Respuesta del backend (status $status): " . print_r($decoded, true));

    if ($status >= 200 && $status < 300 && isset($decoded['success']) && $decoded['success']) {
        return [
            'success' => true,
            'message' => 'Correos enviados correctamente',
            'backend_response' => $decoded
        ];
    } else {
        return [
            'success' => false,
            'message' => 'El backend respondiÃ³ con error',
            'backend_response' => $decoded
        ];
    }
}


========================================
FILE: includes\services\SyncService.php
========================================
<?php
/**
 * Sync Service
 * 
 * Servicio para gestionar el estado de sincronizaciÃ³n con Google Calendar.
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Services
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

/**
 * Class SyncService
 * 
 * Maneja la lÃ³gica de negocio relacionada con el estado de sincronizaciÃ³n.
 */
class SyncService {

    /**
     * Actualiza el estado de sincronizaciÃ³n de Google Calendar.
     *
     * @param string $status Estado de sincronizaciÃ³n ('invalid' o 'valid')
     * @return array Array con 'success' (bool) y 'message' (string)
     * @throws Exception Si el estado no es vÃ¡lido o la actualizaciÃ³n falla
     */
    public static function update_sync_status($status) {
        // ValidaciÃ³n estricta: solo se acepta 'invalid' en este momento
        if ($status !== 'invalid') {
            return array(
                'success' => false,
                'message' => 'Solo se acepta el estado "invalid" en este momento'
            );
        }

        // Intentar actualizar la opciÃ³n de estado de sincronizaciÃ³n
        $updated = update_option('aa_estado_gsync', 'invalid');

        // Verificar si la actualizaciÃ³n fue exitosa
        if (!$updated && get_option('aa_estado_gsync') !== 'invalid') {
            return array(
                'success' => false,
                'message' => 'No se pudo actualizar el estado de sincronizaciÃ³n'
            );
        }

        // Registrar el evento en logs
        if (function_exists('error_log')) {
            error_log(sprintf(
                '[WP Agenda] Estado de sincronizaciÃ³n actualizado a: %s en %s',
                $status,
                current_time('mysql')
            ));
        }

        // Retornar Ã©xito
        return array(
            'success' => true,
            'message' => 'Estado de sincronizaciÃ³n actualizado correctamente',
            'status'  => $status
        );
    }

    /**
     * Obtiene el estado actual de sincronizaciÃ³n.
     *
     * @return string Estado actual ('valid' o 'invalid')
     */
    public static function get_sync_status() {
        return get_option('aa_estado_gsync', 'valid');
    }

    /**
     * Restablece el estado de sincronizaciÃ³n a vÃ¡lido.
     *
     * @return bool True si se actualizÃ³ correctamente, false en caso contrario
     */
    public static function reset_sync_status() {
        $updated = update_option('aa_estado_gsync', 'valid');
        
        if ($updated || get_option('aa_estado_gsync') === 'valid') {
            if (function_exists('error_log')) {
                error_log(sprintf(
                    '[WP Agenda] Estado de sincronizaciÃ³n restablecido a: valid en %s',
                    current_time('mysql')
                ));
            }
            return true;
        }
        
        return false;
    }

    /**
     * Verifica si el estado de sincronizaciÃ³n es invÃ¡lido.
     *
     * @return bool True si el estado es 'invalid', false en caso contrario
     */
    public static function is_sync_invalid() {
        return self::get_sync_status() === 'invalid';
    }

    /**
     * Genera la URL de autorizaciÃ³n OAuth de Google.
     *
     * @return string URL completa para iniciar el flujo OAuth
     */
    public static function get_auth_url() {
        $backend_url = AA_API_BASE_URL . '/oauth/authorize';
        $state = home_url();
        $redirect_uri = admin_url('admin-post.php?action=aa_connect_google');
        
        // ðŸ”¹ Obtener el email del administrador de WordPress para usarlo como contact_email
        $contact_email = get_option('admin_email', '');
        
        return $backend_url 
            . '?state=' . urlencode($state) 
            . '&redirect_uri=' . urlencode($redirect_uri)
            . '&contact_email=' . urlencode($contact_email);
    }

    /**
     * Maneja el Ã©xito de la autenticaciÃ³n OAuth.
     * Actualiza el email y secret del cliente, y resetea el estado de sincronizaciÃ³n a vÃ¡lido.
     *
     * @param string $email Email de la cuenta de Google conectada
     * @param string $secret Secret del cliente OAuth
     * @return bool True si se actualizÃ³ correctamente
     */
    public static function handle_oauth_success($email, $secret) {
        // Actualizar opciones de WordPress
        update_option('aa_google_email', sanitize_email($email));
        update_option('aa_client_secret', sanitize_text_field($secret));
        
        // Resetear el estado de sincronizaciÃ³n a vÃ¡lido
        $reset_success = self::reset_sync_status();
        
        // Registrar en logs
        if (function_exists('error_log')) {
            error_log(sprintf(
                '[WP Agenda] OAuth exitoso - Email: %s, Estado sync: valid en %s',
                $email,
                current_time('mysql')
            ));
        }
        
        return $reset_success;
    }
}



========================================
FILE: views\admin-controls.php
========================================
<?php
if (!defined('ABSPATH')) exit;

// ðŸ”¹ Banner de notificaciÃ³n global cuando la sincronizaciÃ³n estÃ¡ invÃ¡lida
add_action('admin_notices', function() {
    // Solo mostrar en pÃ¡ginas del plugin para administradores
    if (!current_user_can('manage_options')) return;
    
    if (SyncService::is_sync_invalid()) {
        ?>
        <div class="notice notice-error">
            <p>
                <strong>âš ï¸ SincronizaciÃ³n de Google Calendar detenida</strong><br>
                El token de autenticaciÃ³n ha caducado o fue rechazado. 
                <a href="<?php echo esc_url(admin_url('admin.php?page=agenda-automatizada-settings')); ?>">
                    DirÃ­gete a la configuraciÃ³n para reconectar tu cuenta de Google.
                </a>
            </p>
        </div>
        <?php
    }
});

// Crear pÃ¡gina de configuraciÃ³n en el menÃº de WordPress
add_action('admin_menu', function() {
    add_menu_page(
        'Agenda Automatizada',
        'Agenda Automatizada',
        'manage_options',
        'agenda-automatizada-settings',
        'aa_render_settings_iframe_page',
        'dashicons-calendar-alt'
    );
});

// Render iframe container for settings page
function aa_render_settings_iframe_page() {
    $iframe_url = admin_url('admin-post.php?action=aa_iframe_content&module=settings');
    ?>
    <style>
        /* Neutralizar padding de WordPress para esta pÃ¡gina especÃ­fica */
        body.auto-fold #wpcontent,
        body.folded #wpcontent {
            padding-left: 0 !important;
        }
        .wrap.aa-iframe-wrapper {
            margin: 0 !important;
            padding: 0 !important;
        }
    </style>
    <div class="wrap aa-iframe-wrapper" style="margin: 0; padding: 0;">
        <iframe 
            id="aa-settings-iframe"
            src="<?php echo esc_url($iframe_url); ?>"
            style="width: 100%; border: none; display: block;"
            scrolling="no"
        ></iframe>
    </div>
    <?php
}

// ðŸ”¹ SubmenÃº visible para el admin: Panel del Asistente
add_action('admin_menu', function () {
    // Si es administrador, agregar pestaÃ±a del asistente debajo del menÃº principal
    if (current_user_can('administrator')) {
        add_submenu_page(
            'agenda-automatizada-settings',
            'Panel del Asistente',
            'Panel del Asistente',
            'administrator',
            'aa_asistant_panel',
            'aa_render_asistant_panel'
        );
    }

    // ðŸ”¹ MenÃº principal exclusivo para el rol aa_asistente
    if (current_user_can('aa_asistente')) {
        add_menu_page(
            'Panel del Asistente',
            'Panel del Asistente',
            'read', // âœ… Cambiar de 'aa_asistente' a 'read' para que WordPress lo permita
            'aa_asistant_panel',
            'aa_render_asistant_panel',
            'dashicons-calendar-alt',
            30
        );
    }
});


// Registrar settings
add_action('admin_init', function() {
    register_setting('agenda_automatizada_settings', 'aa_schedule');
    register_setting('agenda_automatizada_settings', 'aa_slot_duration');
    register_setting('agenda_automatizada_settings', 'aa_future_window');
    register_setting('agenda_automatizada_settings', 'aa_google_email');
    register_setting('agenda_automatizada_settings', 'aa_google_motivo');
    register_setting('agenda_automatizada_settings', 'aa_timezone');
    register_setting('agenda_automatizada_settings', 'aa_business_name');
    register_setting('agenda_automatizada_settings', 'aa_business_address');
    register_setting('agenda_automatizada_settings', 'aa_is_virtual');
    register_setting('agenda_automatizada_settings', 'aa_whatsapp_number');
});

// Note: Settings page UI has been moved to includes/admin/ui/modules/settings/
// This file now only contains backend logic (register_setting, admin_post handlers, etc.)

// Guardar el email de Google al volver del backend
add_action('admin_post_aa_connect_google', function() {
    if (!current_user_can('manage_options')) return;

    $email = !empty($_GET['email']) ? $_GET['email'] : '';
    $secret = !empty($_GET['client_secret']) ? $_GET['client_secret'] : '';

    if ($email && $secret) {
        // Usar el servicio para manejar el Ã©xito del OAuth
        SyncService::handle_oauth_success($email, $secret);
    }

    wp_redirect(admin_url('admin.php?page=agenda-automatizada-settings'));
    exit;
});

// Desconectar Google
add_action('admin_post_aa_disconnect_google', function() {
    if (!current_user_can('manage_options')) return;

    delete_option('aa_google_email');
    wp_redirect(admin_url('admin.php?page=agenda-automatizada-settings'));
    exit;
});


// creacion de asistentes 
// ------------------------------------------------
// --------------------------------

// ðŸ”¹ SecciÃ³n para gestiÃ³n de asistentes
function aa_render_asistentes_section() {
    if (!current_user_can('administrator')) return;

    if (isset($_POST['aa_crear_asistente'])) {
        // Verificar nonce de seguridad
        check_admin_referer('aa_crear_asistente_nonce');

        $nombre = sanitize_text_field($_POST['aa_nombre']);
        $email = sanitize_email($_POST['aa_email']);
        $password = sanitize_text_field($_POST['aa_password']);

        // Crear usuario de WordPress
        $user_id = wp_create_user($email, $password, $email);
        if (!is_wp_error($user_id)) {
            wp_update_user([
                'ID' => $user_id,
                'display_name' => $nombre,
                'role' => 'aa_asistente'
            ]);

            // Enviar correo de bienvenida
            $subject = 'Acceso a tu panel de asistente';
            $message = "Hola $nombre,\n\n".
                       "Se te ha creado una cuenta para acceder al panel de asistente.\n\n".
                       "Usuario: $email\n".
                       "ContraseÃ±a: $password\n".
                       "Accede aquÃ­: " . wp_login_url() . "\n\n".
                       "Por seguridad, cambia tu contraseÃ±a al iniciar sesiÃ³n.";
            wp_mail($email, $subject, $message);

            echo '<div class="updated"><p>âœ… Asistente creado y notificado por correo.</p></div>';
        } else {
            echo '<div class="error"><p>âŒ Error: '.$user_id->get_error_message().'</p></div>';
        }
    }

    if (isset($_POST['aa_inhabilitar_asistente'])) {
        // Verificar nonce de seguridad
        check_admin_referer('aa_inhabilitar_asistente_nonce');

        $id = intval($_POST['aa_user_id']);
        if ($id) {
            wp_update_user(['ID' => $id, 'role' => '']); // sin rol = inhabilitado
            echo '<div class="updated"><p>âœ… Asistente inhabilitado correctamente.</p></div>';
        }
    }

    // Obtener lista de asistentes
    $asistentes = get_users(['role' => 'aa_asistente']);
    ?>
    
    <header class="aa-section-header">
        <h2>ðŸ‘¥ GestiÃ³n de Asistentes</h2>
        <p>Crea y administra las cuentas de los asistentes que pueden gestionar citas.</p>
    </header>

    <div class="aa-section-body">
        <!-- Formulario crear asistente -->
        <div class="aa-subsection aa-create-assistant">
            <h3 class="aa-subsection-title">Crear nuevo asistente</h3>
            <form method="post" class="aa-assistant-form">
                <?php wp_nonce_field('aa_crear_asistente_nonce'); ?>
                
                <div class="aa-field-group">
                    <label class="aa-field-label" for="aa_nombre">Nombre completo</label>
                    <div class="aa-field-control">
                        <input type="text" id="aa_nombre" name="aa_nombre" required placeholder="Ej: MarÃ­a GarcÃ­a">
                    </div>
                </div>

                <div class="aa-field-group">
                    <label class="aa-field-label" for="aa_email">Correo electrÃ³nico</label>
                    <div class="aa-field-control">
                        <input type="email" id="aa_email" name="aa_email" required placeholder="correo@ejemplo.com">
                    </div>
                </div>

                <div class="aa-field-group">
                    <label class="aa-field-label" for="aa_password">ContraseÃ±a</label>
                    <div class="aa-field-control">
                        <input type="text" id="aa_password" name="aa_password" required placeholder="ContraseÃ±a inicial">
                        <p class="aa-field-hint">El asistente recibirÃ¡ esta contraseÃ±a por correo.</p>
                    </div>
                </div>

                <div class="aa-form-actions">
                    <input type="submit" name="aa_crear_asistente" class="button button-primary" value="Crear Asistente">
                </div>
            </form>
        </div>

        <!-- Lista de asistentes activos -->
        <div class="aa-subsection aa-assistant-list">
            <h3 class="aa-subsection-title">Asistentes activos</h3>
            
            <?php if (empty($asistentes)): ?>
                <p class="aa-empty-state">No hay asistentes registrados.</p>
            <?php else: ?>
                <div class="aa-assistants-grid">
                    <?php foreach ($asistentes as $user): ?>
                        <div class="aa-assistant-card">
                            <div class="aa-assistant-info">
                                <span class="aa-assistant-name"><?php echo esc_html($user->display_name); ?></span>
                                <span class="aa-assistant-email"><?php echo esc_html($user->user_email); ?></span>
                                <span class="aa-assistant-date">Creado: <?php echo esc_html(date('d/m/Y', strtotime($user->user_registered))); ?></span>
                            </div>
                            <div class="aa-assistant-actions">
                                <form method="post">
                                    <?php wp_nonce_field('aa_inhabilitar_asistente_nonce'); ?>
                                    <input type="hidden" name="aa_user_id" value="<?php echo esc_attr($user->ID); ?>">
                                    <input type="submit" name="aa_inhabilitar_asistente" class="button aa-btn-disable" value="Inhabilitar" 
                                           onclick="return confirm('Â¿EstÃ¡s seguro de inhabilitar este asistente?');">
                                </form>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
        </div>
    </div>
    
    <?php
}

// Iframe auto-resize handler (parent window)
add_action('admin_footer', function () {
    $screen = get_current_screen();
    if (!$screen || $screen->id !== 'toplevel_page_agenda-automatizada-settings') {
        return;
    }
    ?>
    <script>
        (function () {
            'use strict';
            
            const iframe = document.getElementById('aa-settings-iframe');
            if (!iframe) return;

            window.addEventListener('message', function (event) {
                // Security: Only accept messages from same origin
                if (event.origin !== window.location.origin) return;

                if (event.data && event.data.type === 'aa-iframe-resize') {
                    const newHeight = event.data.height;
                    
                    // Only update if height actually changed (avoid unnecessary reflows)
                    if (iframe.style.height !== newHeight + 'px') {
                        iframe.style.height = newHeight + 'px';
                    }
                }
            });
        })();
    </script>
    <?php
});



========================================
FILE: views\asistant-controls.php
========================================
<?php
if (!defined('ABSPATH')) exit;

// ðŸ”¹ PestaÃ±a del asistente (visible solo para admin y asistentes)
function aa_render_asistant_panel() {
    $user = wp_get_current_user();
    
    if (!in_array('aa_asistente', $user->roles) && !current_user_can('administrator')) {
        wp_die('No tienes permisos para acceder a esta secciÃ³n.');
    }

    echo '<div class="wrap aa-asistant-panel">';
    echo '<h1>ðŸ—“ï¸ Panel del Asistente</h1>';
    echo '<p>Bienvenido, <strong>' . esc_html($user->display_name) . '</strong>.</p>';

    // ===============================
    // ðŸ”¹ FORMULARIO DE NUEVA CITA
    // ===============================
    echo '<button class="aa-btn-nueva-cita" id="btn-toggle-form-nueva-cita">+ Crear nueva cita</button>';
    
    echo '<div class="aa-form-nueva-cita" id="form-nueva-cita">';
    echo '<h3>ðŸ“… Nueva Cita</h3>';
    echo '<form id="form-crear-cita-admin">';
    
    // Campo de Cliente
    echo '<div class="aa-form-cita-group">';
    echo '<label for="cita-cliente">Cliente *</label>';
    echo '<select id="cita-cliente" name="cliente_id" required>';
    echo '<option value="">-- Selecciona un cliente --</option>';
    
    $clientes = aa_get_all_clientes(200);
    foreach ($clientes as $cliente) {
        echo '<option value="' . esc_attr($cliente->id) . '" 
                data-nombre="' . esc_attr($cliente->nombre) . '"
                data-telefono="' . esc_attr($cliente->telefono) . '"
                data-correo="' . esc_attr($cliente->correo) . '">';
        echo esc_html($cliente->nombre) . ' (' . esc_html($cliente->telefono) . ')';
        echo '</option>';
    }
    echo '</select>';
    echo '</div>';
    
    // Campo de Servicio
    echo '<div class="aa-form-cita-group">';
    echo '<label for="cita-servicio">Motivo de la cita *</label>';
    echo '<select id="cita-servicio" name="servicio" required>';
    
    $motivos_json = get_option('aa_google_motivo', json_encode(['Cita general']));
    $motivos = json_decode($motivos_json, true);
    
    if (is_array($motivos) && !empty($motivos)) {
        foreach ($motivos as $motivo) {
            echo '<option value="' . esc_attr($motivo) . '">' . esc_html($motivo) . '</option>';
        }
    } else {
        echo '<option value="Cita general">Cita general</option>';
    }
    echo '</select>';
    echo '</div>';
    
    // Campo de Fecha
    echo '<div class="aa-form-cita-group">';
    echo '<label for="cita-fecha">Fecha y hora *</label>';
    echo '<input type="text" id="cita-fecha" name="fecha" required readonly>';
    echo '<div id="slot-container-admin"></div>';
    echo '</div>';
    
    echo '<button type="submit" class="aa-btn-agendar-cita">âœ“ Agendar Cita</button>';
    echo '<button type="button" class="aa-btn-cancelar-cita-form" id="btn-cancelar-cita-form">Cancelar</button>';
    echo '</form>';
    echo '</div>';

    // ===============================
    // ðŸ”¹ TABLA DE PRÃ“XIMAS CITAS (MODULARIZADA)
    // ===============================
    require_once plugin_dir_path(__FILE__) . 'templates/proximas-citas-template.php';

    // ===============================
    // ðŸ”¹ SECCIÃ“N DE CLIENTES
    // ===============================
    echo '<hr style="margin: 40px 0;">';
    echo '<h2>ðŸ‘¥ Clientes</h2>';
    
    echo '<button class="aa-btn-nuevo-cliente" id="btn-toggle-form-cliente">+ Crear nuevo cliente</button>';
    
    echo '<div class="aa-form-nuevo-cliente" id="form-nuevo-cliente">';
    echo '<h3>Nuevo Cliente</h3>';
    echo '<form id="form-crear-cliente">';
    
    echo '<div class="aa-form-group">';
    echo '<label for="cliente-nombre">Nombre completo *</label>';
    echo '<input type="text" id="cliente-nombre" name="nombre" required>';
    echo '</div>';
    
    echo '<div class="aa-form-group">';
    echo '<label for="cliente-telefono">TelÃ©fono *</label>';
    echo '<input type="tel" id="cliente-telefono" name="telefono" required>';
    echo '</div>';
    
    echo '<div class="aa-form-group">';
    echo '<label for="cliente-correo">Correo electrÃ³nico *</label>';
    echo '<input type="email" id="cliente-correo" name="correo" required>';
    echo '</div>';
    
    echo '<button type="submit" class="aa-btn-guardar-cliente">Guardar Cliente</button>';
    echo '<button type="button" class="aa-btn-cancelar-form" id="btn-cancelar-form">Cancelar</button>';
    echo '</form>';
    echo '</div>';
    
    // Lista de clientes
    $clientes = aa_get_all_clientes(20);
    
    if ($clientes) {
        echo '<h3 style="margin-top: 30px;">Lista de clientes</h3>';
        
        // ðŸ”¹ Wrapper para scroll horizontal
        echo '<div class="aa-clientes-table-wrapper">';
        echo '<table class="widefat aa-clientes-table">';
        echo '<thead><tr><th>Nombre</th><th>TelÃ©fono</th><th>Correo</th><th>Fecha de registro</th><th>Total de citas</th><th>Acciones</th></tr></thead>';
        echo '<tbody>';
        
        foreach ($clientes as $cliente) {
            $total_citas = count(aa_get_cliente_reservas($cliente->id, 100));
            
            echo '<tr>';
            echo '<td>' . esc_html($cliente->nombre) . '</td>';
            echo '<td>' . esc_html($cliente->telefono) . '</td>';
            echo '<td>' . esc_html($cliente->correo) . '</td>';
            echo '<td>' . esc_html(date('d/m/Y', strtotime($cliente->created_at))) . '</td>';
            echo '<td>' . $total_citas . '</td>';
            echo '<td>';
            echo '<button class="aa-btn-editar-cliente" 
                    data-id="' . $cliente->id . '"
                    data-nombre="' . esc_attr($cliente->nombre) . '"
                    data-telefono="' . esc_attr($cliente->telefono) . '"
                    data-correo="' . esc_attr($cliente->correo) . '">
                âœï¸ Editar
            </button>';
            echo '</td>';
            echo '</tr>';
        }
        
        echo '</tbody></table>';
        echo '</div>'; // ðŸ”¹ Cerrar wrapper
        
        // Modal de ediciÃ³n
        echo '<div class="aa-modal-overlay" id="modal-editar-cliente">';
        echo '<div class="aa-modal-content">';
        echo '<div class="aa-modal-header">';
        echo '<h3>âœï¸ Editar Cliente</h3>';
        echo '<button class="aa-modal-close" id="btn-cerrar-modal">&times;</button>';
        echo '</div>';
        echo '<form id="form-editar-cliente">';
        echo '<input type="hidden" id="editar-cliente-id" name="cliente_id">';
        
        echo '<div class="aa-form-group">';
        echo '<label for="editar-cliente-nombre">Nombre completo *</label>';
        echo '<input type="text" id="editar-cliente-nombre" name="nombre" required>';
        echo '</div>';
        
        echo '<div class="aa-form-group">';
        echo '<label for="editar-cliente-telefono">TelÃ©fono *</label>';
        echo '<input type="tel" id="editar-cliente-telefono" name="telefono" required>';
        echo '</div>';
        
        echo '<div class="aa-form-group">';
        echo '<label for="editar-cliente-correo">Correo electrÃ³nico *</label>';
        echo '<input type="email" id="editar-cliente-correo" name="correo" required>';
        echo '</div>';
        
        echo '<button type="submit" class="aa-btn-guardar-cliente">ðŸ’¾ Guardar Cambios</button>';
        echo '<button type="button" class="aa-btn-cancelar-form" id="btn-cancelar-edicion">Cancelar</button>';
        echo '</form>';
        echo '</div>';
        echo '</div>';
    } else {
        echo '<p>No hay clientes registrados.</p>';
    }

    // ===============================
    // ðŸ”¹ HISTORIAL DE CITAS
    // ===============================
    echo '<hr style="margin: 40px 0;">';
    echo '<h2>ðŸ“… Historial de Citas</h2>';
    
    // Filtros de bÃºsqueda
    echo '<div class="aa-historial-filtros">';
    
    echo '<input type="text" id="aa-buscar-historial" placeholder="Buscar por nombre, telÃ©fono o correo...">';
    
    echo '<select id="aa-ordenar-historial">';
    echo '<option value="fecha_desc">MÃ¡s recientes primero</option>';
    echo '<option value="fecha_asc">MÃ¡s antiguas primero</option>';
    echo '<option value="cliente_asc">Cliente (A-Z)</option>';
    echo '<option value="cliente_desc">Cliente (Z-A)</option>';
    echo '</select>';
    
    echo '<button id="aa-btn-buscar-historial" class="aa-btn-nuevo-cliente">ðŸ” Buscar</button>';
    echo '<button id="aa-btn-limpiar-historial" class="aa-btn-cancelar-form">âœ• Limpiar</button>';
    
    echo '</div>';
    
    // Tabla de resultados
    echo '<div id="aa-historial-container">';
    echo '<p style="text-align: center; color: #999;">Cargando historial...</p>';
    echo '</div>';
    
    // PaginaciÃ³n
    echo '<div class="aa-paginacion" id="aa-historial-paginacion"></div>';

    echo '</div>';
}


========================================
FILE: views\templates\proximas-citas-template.php
========================================
<?php
/**
 * Template: Tabla de prÃ³ximas citas (AJAX)
 * 
 * Este template renderiza la secciÃ³n de prÃ³ximas citas con:
 * - Filtros de bÃºsqueda y ordenamiento
 * - Contenedor para carga dinÃ¡mica con AJAX
 * - PaginaciÃ³n
 * 
 * JavaScript responsable: assets/js/ui/proximasCitasUI.js

 */

if (!defined('ABSPATH')) exit;
?>

<h2>PrÃ³ximas citas</h2>

<!-- ===============================
     ðŸ”¹ FILTROS DE BÃšSQUEDA
     =============================== -->
<div class="aa-historial-filtros">
    <input 
        type="text" 
        id="aa-buscar-proximas" 
        placeholder="Buscar por nombre, telÃ©fono, correo o servicio..."
    >
    
    <select id="aa-ordenar-proximas">
        <option value="fecha_asc">MÃ¡s prÃ³ximas primero</option>
        <option value="fecha_desc">MÃ¡s lejanas primero</option>
        <option value="cliente_asc">Cliente (A-Z)</option>
        <option value="cliente_desc">Cliente (Z-A)</option>
        <option value="estado_asc">Estado (A-Z)</option>
        <option value="estado_desc">Estado (Z-A)</option>
    </select>
    
    <button id="aa-btn-buscar-proximas" class="aa-btn-nuevo-cliente">
        ðŸ” Buscar
    </button>
    
    <button id="aa-btn-limpiar-proximas" class="aa-btn-cancelar-form">
        âœ• Limpiar
    </button>
</div>

<!-- ===============================
     ðŸ”¹ CONTENEDOR DE TABLA (Carga AJAX)
     =============================== -->
<div id="aa-proximas-container">
    <p style="text-align: center; color: #999;">
        â³ Cargando prÃ³ximas citas...
    </p>
</div>

<!-- ===============================
     ðŸ”¹ PAGINACIÃ“N (Generada dinÃ¡micamente)
     =============================== -->
<div class="aa-paginacion" id="aa-proximas-paginacion"></div>

