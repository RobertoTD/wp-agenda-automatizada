ARQUITECTURA DEL PLUGIN WORDPRESS:


========================================
FILE: wp-agenda-automatizada.php
========================================
<?php
/**
 * Plugin Name: WP Agenda Automatizada
 * Description: Sistema de gesti√≥n de citas con integraci√≥n a Google Calendar
 * Version: 2.0.0
 * Author: Tu Nombre
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

// ===============================
// üîπ CONSTANTES DEL PLUGIN
// ===============================
define('AA_PLUGIN_PATH', plugin_dir_path(__FILE__));
define('AA_PLUGIN_URL', plugin_dir_url(__FILE__));

// Detectar entorno autom√°ticamente
$site_url = get_site_url();

if (strpos($site_url, 'localhost') !== false || strpos($site_url, '127.0.0.1') !== false) {
    define('AA_API_BASE_URL', 'http://localhost:3000');
} else {
    define('AA_API_BASE_URL', 'https://deoia-oauth-backend.onrender.com');
}

// ===============================
// üîπ ORDEN CORRECTO DE INCLUSI√ìN
// ===============================

// 1Ô∏è‚É£ Helpers y utilidades base
require_once plugin_dir_path(__FILE__) . 'includes/auth-helper.php';

// 2Ô∏è‚É£ Modelos (acceso a datos)
require_once plugin_dir_path(__FILE__) . 'clientes.php';
require_once plugin_dir_path(__FILE__) . 'includes/models/AssignmentsModel.php';

// 3Ô∏è‚É£ Servicios
require_once plugin_dir_path(__FILE__) . 'includes/services/availability-proxy.php';
require_once plugin_dir_path(__FILE__) . 'includes/services/SyncService.php';
require_once plugin_dir_path(__FILE__) . 'includes/services/ClienteService.php';
require_once plugin_dir_path(__FILE__) . 'includes/services/notificationsService.php';
require_once plugin_dir_path(__FILE__) . 'includes/services/appointmentsService.php';
require_once plugin_dir_path(__FILE__) . 'includes/services/assignmentsService.php';

// 4Ô∏è‚É£ Controladores (l√≥gica de negocio)
require_once plugin_dir_path(__FILE__) . 'includes/controllers/availability-controller.php';
require_once plugin_dir_path(__FILE__) . 'includes/controllers/proximasCitasController.php';
require_once plugin_dir_path(__FILE__) . 'includes/controllers/confirmController.php';
require_once plugin_dir_path(__FILE__) . 'includes/controllers/WebhooksController.php';

// 5Ô∏è‚É£ Controlador de encolado (DEBE IR DESPU√âS de availability-controller)
require_once plugin_dir_path(__FILE__) . 'includes/controllers/enqueueController.php';

// 6Ô∏è‚É£ Vistas
require_once plugin_dir_path(__FILE__) . 'views/admin-controls.php';

// 7Ô∏è‚É£ M√≥dulos adicionales
require_once plugin_dir_path(__FILE__) . 'asistant-user.php';
require_once plugin_dir_path(__FILE__) . 'historial-citas.php';

// 8Ô∏è‚É£ Admin: Iframe Test (UI aislada)
require_once plugin_dir_path(__FILE__) . 'includes/admin/iframe-test.php';

// ================================
// üîπ REGISTRO DE WEBHOOKS REST API
// ================================
add_action('rest_api_init', function() {
    $webhooks_controller = new Webhooks_Controller();
    $webhooks_controller->register_routes();
});

// ================================
// üîπ Endpoint AJAX: Guardar cita desde el frontend
// ================================
add_action('wp_ajax_nopriv_aa_save_reservation', 'aa_save_reservation');
add_action('wp_ajax_aa_save_reservation', 'aa_save_reservation');

function aa_save_reservation() {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';

    // Leer cuerpo JSON enviado desde JS
    $data = json_decode(file_get_contents('php://input'), true);

    // ‚úÖ Validar nonce de seguridad
    if (empty($data['nonce']) || !wp_verify_nonce($data['nonce'], 'aa_reservation_nonce')) {
        wp_send_json_error(['message' => 'Error de validaci√≥n de seguridad (nonce inv√°lido).']);
    }

    // ‚úÖ Validar honeypot (campo invisible anti-bot)
    if (!empty($data['extra_field'])) {
        wp_send_json_error(['message' => 'Detecci√≥n de bot: env√≠o no permitido.']);
    }

    // ‚úÖ Validaci√≥n b√°sica de datos requeridos
    if (empty($data['servicio']) || empty($data['fecha']) || empty($data['nombre'])) {
        wp_send_json_error(['message' => 'Datos incompletos.']);
    }

    // üîπ Obtener la zona horaria configurada
    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    
    // ‚úÖ Sanitizaci√≥n y conversi√≥n de fecha a la zona horaria del negocio
    $servicio = sanitize_text_field($data['servicio']);
    
    // üîπ Convertir ISO UTC a DateTime en zona horaria local
    try {
        $fechaObj = new DateTime($data['fecha'], new DateTimeZone('UTC'));
        $fechaObj->setTimezone(new DateTimeZone($timezone));
        $fecha = $fechaObj->format('Y-m-d H:i:s');
    } catch (Exception $e) {
        wp_send_json_error(['message' => 'Formato de fecha inv√°lido.']);
    }
    
    $nombre   = sanitize_text_field($data['nombre']);
    $telefono = sanitize_text_field($data['telefono']);
    $correo   = sanitize_email($data['correo']);
    
    // üîπ Obtener duraci√≥n (validar que sea 30, 60 o 90, por defecto 60)
    $duracion = isset($data['duracion']) ? intval($data['duracion']) : 60;
    if (!in_array($duracion, [30, 60, 90])) {
        $duracion = 60; // Valor por defecto si no es v√°lido
    }

    // üîπ Buscar o crear cliente usando ClienteService
    try {
        $cliente_id = ClienteService::getOrCreate([
            'nombre' => $nombre,
            'telefono' => $telefono,
            'correo' => $correo
        ]);
    } catch (Exception $e) {
        error_log("‚ùå Error al obtener/crear cliente: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al procesar los datos del cliente: ' . $e->getMessage()
        ]);
    }

    // ‚úÖ Preparar datos para inserci√≥n
    $insert_data = [
        'servicio'   => $servicio,
        'fecha'      => $fecha,
        'duracion'   => $duracion,
        'nombre'     => $nombre,
        'telefono'   => $telefono,
        'correo'     => $correo,
        'id_cliente' => $cliente_id,
        'estado'     => 'pending',
        'created_at' => current_time('mysql')
    ];

    // ‚úÖ Agregar assignment_id si viene en los datos (opcional)
    if (isset($data['assignment_id']) && !empty($data['assignment_id'])) {
        $assignment_id = intval($data['assignment_id']);
        if ($assignment_id > 0) {
            $insert_data['assignment_id'] = $assignment_id;
        }
    }

    // ‚úÖ Inserci√≥n en la tabla
    $result = $wpdb->insert($table, $insert_data);

    // ‚úÖ Control de error
    if ($result === false) {
        error_log("‚ùå Error al insertar reserva: " . $wpdb->last_error);
        wp_send_json_error([
            'message' => 'Error al guardar en la base de datos.',
            'error'   => $wpdb->last_error
        ]);
    }

    // ‚úÖ Retornar ID de la reserva creada
    $reserva_id = $wpdb->insert_id;
    
    if (!$reserva_id) {
        error_log("‚ö†Ô∏è Reserva guardada pero no se obtuvo insert_id");
        wp_send_json_error(['message' => 'Reserva guardada pero ID no disponible.']);
    }

    error_log("‚úÖ Reserva guardada correctamente con ID: $reserva_id (Cliente: $cliente_id)");
    
    // üîπ Crear notificaci√≥n para la nueva reserva
    $notifications_table = $wpdb->prefix . 'aa_notifications';
    
    // ‚úÖ Verificar si ya existe una notificaci√≥n para evitar duplicados
    $existing_notification = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $notifications_table 
        WHERE entity_type = %s AND entity_id = %d AND type = %s",
        'reservation',
        $reserva_id,
        'pending'
    ));
    
    // ‚úÖ Insertar notificaci√≥n solo si no existe
    if (!$existing_notification) {
        $notification_result = $wpdb->insert($notifications_table, [
            'entity_type' => 'reservation',
            'entity_id'   => $reserva_id,
            'type'        => 'pending',
            'is_read'     => 0
        ]);
        
        if ($notification_result === false) {
            error_log("‚ö†Ô∏è Error al insertar notificaci√≥n para reserva $reserva_id: " . $wpdb->last_error);
        } else {
            error_log("‚úÖ Notificaci√≥n creada para reserva $reserva_id");
        }
    } else {
        error_log("‚ÑπÔ∏è Notificaci√≥n ya existe para reserva $reserva_id, omitiendo inserci√≥n");
    }
    
    wp_send_json_success([
        'message' => 'Reserva almacenada correctamente.',
        'id' => $reserva_id,
        'cliente_id' => $cliente_id
    ]);
}

// üîπ Crear tablas al activar el plugin
register_activation_hook(__FILE__, function() {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    $charset = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE $table (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        servicio varchar(255) NOT NULL,
        fecha datetime NOT NULL,
        duracion smallint unsigned NOT NULL DEFAULT 60,
        assignment_id bigint(20) unsigned NULL,
        nombre varchar(255) NOT NULL,
        telefono varchar(50) NOT NULL,
        correo varchar(255),
        estado varchar(50) DEFAULT 'pending',
        calendar_uid varchar(255) DEFAULT NULL,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY calendar_uid (calendar_uid),
        KEY idx_assignment_id (assignment_id)
    ) $charset;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
    
    aa_create_clientes_table();
    aa_add_cliente_column_to_reservas();
    aa_add_calendar_uid_column();
    
    // üîπ Crear tabla de notificaciones
    $notifications_table = $wpdb->prefix . 'aa_notifications';
    $notifications_sql = "CREATE TABLE $notifications_table (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        entity_type varchar(50) NOT NULL,
        entity_id bigint(20) unsigned NOT NULL,
        type varchar(50) NOT NULL,
        is_read tinyint(1) DEFAULT 0,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY entity (entity_type, entity_id),
        KEY is_read (is_read),
        KEY type (type)
    ) $charset;";
    
    dbDelta($notifications_sql);
    
    // üîπ Crear tabla de personal (staff)
    $staff_table = $wpdb->prefix . 'aa_staff';
    $staff_sql = "CREATE TABLE $staff_table (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        name varchar(191) NOT NULL,
        active tinyint(1) DEFAULT 1,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id)
    ) $charset;";
    
    dbDelta($staff_sql);
    
    // üîπ Crear tabla de zonas de atenci√≥n (service areas)
    $service_areas_table = $wpdb->prefix . 'aa_service_areas';
    $service_areas_sql = "CREATE TABLE $service_areas_table (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        name varchar(191) NOT NULL,
        description text,
        active tinyint(1) DEFAULT 1,
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id)
    ) $charset;";
    
    dbDelta($service_areas_sql);
    
    // üîπ Crear tabla de asignaciones (assignments)
    $assignments_table = $wpdb->prefix . 'aa_assignments';
    $assignments_sql = "CREATE TABLE $assignments_table (
        id bigint(20) unsigned NOT NULL AUTO_INCREMENT,
        assignment_date date NOT NULL,
        start_time time NOT NULL,
        end_time time NOT NULL,
        staff_id bigint(20) unsigned NOT NULL,
        service_area_id bigint(20) unsigned NOT NULL,
        service_key varchar(191) NOT NULL,
        capacity int DEFAULT 1,
        repeat_weekly tinyint(1) DEFAULT 0,
        repeat_until date DEFAULT NULL,
        status varchar(50) DEFAULT 'active',
        created_at datetime DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY  (id),
        KEY staff_id (staff_id),
        KEY service_area_id (service_area_id),
        KEY assignment_date (assignment_date),
        KEY status (status)
    ) $charset;";
    
    dbDelta($assignments_sql);
    
    // üîπ Inicializar estado de sincronizaci√≥n como v√°lido
    if (get_option('aa_estado_gsync') === false) {
        add_option('aa_estado_gsync', 'valid');
    }
});

// ===============================
// üîπ Funci√≥n para agregar columna calendar_uid
// ===============================
function aa_add_calendar_uid_column() {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    $column_exists = $wpdb->get_results(
        $wpdb->prepare(
            "SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = %s AND TABLE_NAME = %s AND COLUMN_NAME = 'calendar_uid'",
            DB_NAME,
            $table
        )
    );
    
    if (empty($column_exists)) {
        $wpdb->query("ALTER TABLE $table ADD COLUMN calendar_uid varchar(255) DEFAULT NULL AFTER estado");
        $wpdb->query("ALTER TABLE $table ADD INDEX idx_calendar_uid (calendar_uid)");
        error_log("‚úÖ Columna calendar_uid agregada a aa_reservas");
    }
}

// üîπ Funci√≥n helper para obtener la hora actual seg√∫n aa_timezone
function aa_get_current_datetime() {
    $timezone_string = get_option('aa_timezone', 'America/Mexico_City');
    
    try {
        $timezone = new DateTimeZone($timezone_string);
        $now = new DateTime('now', $timezone);
        return $now->format('Y-m-d H:i:s');
    } catch (Exception $e) {
        error_log("‚ùå Error al obtener zona horaria: " . $e->getMessage());
        return current_time('mysql');
    }
}

// ===============================
// üü† SHORTCODE: Formulario de agenda
// ===============================
function wpaa_render_form() {
    ob_start(); ?>

    <form id="agenda-form">

        <!-- Servicio -->
        <select id="servicio" name="servicio" required>
    <option value="">Motivo de la cita</option>
    <?php
    $motivos_json = get_option('aa_google_motivo', json_encode(['Cita general']));
    $motivos = json_decode($motivos_json, true);

    if (is_array($motivos) && !empty($motivos)) {
        foreach ($motivos as $motivo) {
            $motivo = esc_html($motivo);
            echo "<option value='{$motivo}'>{$motivo}</option>";
        }
    }
    ?>
    </select>

        <!-- Calendario -->
        <div id="wpagenda-calendar"></div>
        <input type="hidden" id="fecha" name="fecha" required>

        <!-- Slots -->
        <div id="aa-slot-title" class="aa-slots-title" style="display:none;"></div>
        <div id="slot-container"></div>
        <input type="hidden" id="slot-selector" name="slot" required>

        <!-- Datos del cliente -->
        <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
        <input type="tel" id="telefono" name="telefono" placeholder="Tel√©fono" required>
        <input type="email" id="correo" name="correo" placeholder="Correo" required>

        <!-- Bot√≥n enviar -->
        <button type="submit">Agendar</button>

    </form>

    <div id="respuesta-agenda"></div>

    <?php
    return ob_get_clean();
}
add_shortcode('agenda_automatizada', 'wpaa_render_form');




========================================
FILE: assets\js\controllers\adminCalendarController.js
========================================
/**
 * Controlador: Calendario Admin
 * 
 * Responsable de:
 * - Coordinaci√≥n entre UI y servicios del calendario
 * - Callbacks y manejo de eventos
 * - Actualizaci√≥n de la vista del calendario
 * - Orquestaci√≥n de acciones (confirmar, cancelar, asistencia)
 * 
 * NO contiene llamadas AJAX directas.
 */

window.AdminCalendarController = (function() {
    'use strict';
    
    let recargarCallback = null;
    let currentDate = null;
    let cargarCitasCallback = null;
    
    /**
     * Inicializar controlador
     * @param {Function} onRecargar - Callback para recargar el calendario
     * @param {Function} onCargarCitas - Callback para cargar citas de un d√≠a espec√≠fico
     */
    function init(onRecargar, onCargarCitas) {
        recargarCallback = onRecargar;
        cargarCitasCallback = onCargarCitas;
        
        // Establecer fecha inicial (hoy)
        if (window.DateUtils) {
            const today = new Date();
            currentDate = window.DateUtils.ymd(today);
        }
    }
    
    /**
     * Establecer fecha actual y cargar citas
     * @param {string} fecha - Fecha en formato YYYY-MM-DD
     */
    function setDate(fecha) {
        if (!fecha || !/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
            console.error('‚ùå AdminCalendarController.setDate: Formato de fecha inv√°lido:', fecha);
            return;
        }
        
        currentDate = fecha;
        
        // Cargar citas del d√≠a seleccionado
        if (cargarCitasCallback) {
            cargarCitasCallback(fecha);
        }
    }
    
    /**
     * Obtener fecha actual
     * @returns {string|null} - Fecha en formato YYYY-MM-DD o null
     */
    function getCurrentDate() {
        return currentDate;
    }
    
    /**
     * Cargar citas del d√≠a
     * @param {string} fecha - Fecha en formato YYYY-MM-DD
     */
    function cargarCitasDelDia(fecha) {
        setDate(fecha);
    }
    
    /**
     * Handler √∫nico de acciones de citas
     * @param {string} action - Acci√≥n a ejecutar
     * @param {string|number} citaId - ID de la cita
     */
    function handleCitaAction(action, citaId) {
        switch (action) {
            case 'confirmar':
                if (window.AdminConfirmController?.onConfirmar) {
                    // AdminConfirmController ya maneja el callback de recarga internamente
                    window.AdminConfirmController.onConfirmar(citaId);
                }
                break;
                
            case 'cancelar':
                if (window.AdminConfirmController?.onCancelar) {
                    if (confirm('¬øCancelar esta cita?')) {
                        // AdminConfirmController ya maneja el callback de recarga internamente
                        window.AdminConfirmController.onCancelar(citaId);
                    }
                }
                break;
                
            case 'asistio':
                marcarAsistencia(citaId);
                break;
                
            case 'no-asistio':
                marcarNoAsistencia(citaId);
                break;
        }
    }
    
    /**
     * Marcar cita como "asisti√≥"
     * @param {string|number} citaId - ID de la cita
     */
    function marcarAsistencia(citaId) {
        if (!confirm('¬øConfirmar que el cliente asisti√≥?')) return;
        
        const formData = new FormData();
        formData.append('action', 'aa_marcar_asistencia');
        formData.append('cita_id', citaId);
        
        const nonce = window.AA_CALENDAR_DATA?.historialNonce;
        if (nonce) {
            formData.append('_wpnonce', nonce);
        }
        
        const ajaxurl = window.AA_CALENDAR_DATA?.ajaxurl || (typeof ajaxurl !== 'undefined' ? ajaxurl : '/wp-admin/admin-ajax.php');
        
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Asistencia registrada');
                if (recargarCallback) {
                    recargarCallback();
                }
            } else {
                alert(data.data?.message || 'Error al registrar asistencia');
            }
        })
        .catch(err => {
            console.error('Error al marcar asistencia:', err);
            alert('Error de conexi√≥n');
        });
    }
    
    /**
     * Marcar cita como "no asisti√≥"
     * @param {string|number} citaId - ID de la cita
     */
    function marcarNoAsistencia(citaId) {
        if (!confirm('¬øConfirmar que el cliente NO asisti√≥?')) return;
        
        const formData = new FormData();
        formData.append('action', 'aa_marcar_no_asistencia');
        formData.append('cita_id', citaId);
        
        const nonce = window.AA_CALENDAR_DATA?.historialNonce;
        if (nonce) {
            formData.append('_wpnonce', nonce);
        }
        
        const ajaxurl = window.AA_CALENDAR_DATA?.ajaxurl || (typeof ajaxurl !== 'undefined' ? ajaxurl : '/wp-admin/admin-ajax.php');
        
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚ùå No asistencia registrada');
                if (recargarCallback) {
                    recargarCallback();
                }
            } else {
                alert(data.data?.message || 'Error al registrar no asistencia');
            }
        })
        .catch(err => {
            console.error('Error al marcar no asistencia:', err);
            alert('Error de conexi√≥n');
        });
    }
    
    // API p√∫blica
    return {
        init: init,
        setDate: setDate,
        getCurrentDate: getCurrentDate,
        cargarCitasDelDia: cargarCitasDelDia,
        handleCitaAction: handleCitaAction
    };
})();




========================================
FILE: assets\js\controllers\adminConfirmController.js
========================================
/**
 * Controlador: Confirmaci√≥n de Citas (Admin)
 * 
 * Responsable de:
 * - Callbacks para confirmar/cancelar/crear cliente
 * - Delegaci√≥n a ConfirmService
 * - Mostrar alertas y recargar tabla
 * 
 * NO contiene llamadas AJAX directas.
 */

window.AdminConfirmController = (function() {
    'use strict';
    
    let recargarCallback = null;
    
    /**
     * Inicializar controlador
     * @param {Function} onRecargar - Callback para recargar la tabla
     */
    function init(onRecargar) {
        recargarCallback = onRecargar;
    }
    
    /**
     * Confirmar una cita
     * @param {number} id - ID de la cita
     */
    function onConfirmar(id) {
        if (!window.ConfirmService) {
            console.error('‚ùå ConfirmService no est√° cargado');
            alert('‚ùå Error: Servicio de confirmaci√≥n no disponible.');
            return;
        }
        
        window.ConfirmService.confirmar(id)
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Cita confirmada. Se envi√≥ correo de confirmaci√≥n.');
                    if (recargarCallback) {
                        recargarCallback();
                    }
                } else {
                    alert('‚ùå Error: ' + (data.data?.message || 'No se pudo confirmar la cita.'));
                }
            })
            .catch(err => {
                console.error('Error al confirmar cita:', err);
                alert('‚ùå Error de conexi√≥n: ' + err.message);
            });
    }
    
    /**
     * Cancelar una cita
     * @param {number} id - ID de la cita
     */
    function onCancelar(id) {
        if (!window.ConfirmService) {
            console.error('‚ùå ConfirmService no est√° cargado');
            alert('‚ùå Error: Servicio de cancelaci√≥n no disponible.');
            return;
        }
        
        window.ConfirmService.cancelar(id)
            .then(data => {
                if (data.success) {
                    let mensaje = '‚úÖ Cita cancelada correctamente.';
                    
                    if (data.data?.calendar_deleted) {
                        mensaje += '\nüóìÔ∏è El evento tambi√©n fue eliminado de Google Calendar.';
                    }
                    
                    alert(mensaje);
                    if (recargarCallback) {
                        recargarCallback();
                    }
                } else {
                    alert('‚ùå Error: ' + (data.data?.message || 'No se pudo cancelar la cita.'));
                }
            })
            .catch(err => {
                console.error('Error al cancelar cita:', err);
                alert('‚ùå Error de conexi√≥n: ' + err.message);
            });
    }
    
    /**
     * Crear cliente desde una cita
     * @param {number} reservaId - ID de la reserva
     * @param {string} nombre - Nombre del cliente
     * @param {string} telefono - Tel√©fono del cliente
     * @param {string} correo - Correo del cliente
     */
    function onCrearCliente(reservaId, nombre, telefono, correo) {
        if (!window.ConfirmService) {
            console.error('‚ùå ConfirmService no est√° cargado');
            alert('‚ùå Error: Servicio de clientes no disponible.');
            return;
        }
        
        window.ConfirmService.crearClienteDesdeCita(reservaId, nombre, telefono, correo)
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.data.message);
                    if (recargarCallback) {
                        recargarCallback();
                    }
                } else {
                    alert('‚ùå Error: ' + (data.data?.message || 'No se pudo crear el cliente.'));
                }
            })
            .catch(err => {
                console.error('Error al crear cliente desde cita:', err);
                alert('‚ùå Error de conexi√≥n: ' + err.message);
            });
    }
    
    // ===============================
    // üîπ API P√∫blica
    // ===============================
    return {
        init,
        onConfirmar,
        onCancelar,
        onCrearCliente
    };
})();



========================================
FILE: assets\js\controllers\adminReservationController.js
========================================
// ==============================
// üîπ Admin Reservation Controller
// ==============================

(function() {
  'use strict';

  /**
   * Inicializar controlador de reservaciones admin
   * @param {Object} config - Configuraci√≥n del controlador
   */
  function initAdminReservationController(config) {
    const {
      btnToggle,
      formNuevaCita,
      btnCancelar,
      form
    } = config;

    // En modal, btnToggle puede ser null
    if (!formNuevaCita || !form) {
      console.error('‚ùå No se encontraron los elementos del formulario de admin');
      return;
    }

    // Toggle formulario (solo si btnToggle existe)
    if (btnToggle) {
      btnToggle.addEventListener('click', function() {
        formNuevaCita.classList.toggle('visible');
        if (formNuevaCita.classList.contains('visible')) {
          btnToggle.textContent = '‚àí Ocultar formulario';
        } else {
          btnToggle.textContent = '+ Crear nueva cita';
        }
      });
    }

    // Cancelar formulario
    if (btnCancelar) {
      btnCancelar.addEventListener('click', function() {
        if (btnToggle) {
          formNuevaCita.classList.remove('visible');
          btnToggle.textContent = '+ Crear nueva cita';
        }
        form.reset();
        const slotContainer = document.getElementById('slot-container-admin');
        if (slotContainer) {
          slotContainer.innerHTML = '';
        }
      });
    }

    // ==============================
    // üîπ Env√≠o del formulario (USANDO ReservationService)
    // ==============================
    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const clienteSelect = document.getElementById('cita-cliente');
      const slotSelector = document.getElementById('slot-selector-admin');
      const selectedSlotISO = slotSelector ? slotSelector.value : null;

      if (!selectedSlotISO) {
        alert('‚ùå Por favor, selecciona una fecha y hora v√°lidas.');
        return;
      }

      const clienteOption = clienteSelect.options[clienteSelect.selectedIndex];

      // Leer assignment_id si existe (opcional, para reservas basadas en assignments)
      const assignmentIdInput = document.getElementById('assignment-id');
      const assignmentId = assignmentIdInput ? assignmentIdInput.value : null;

      const datos = {
        servicio: document.getElementById('cita-servicio').value,
        fecha: selectedSlotISO,
        nombre: clienteOption.dataset.nombre,
        telefono: clienteOption.dataset.telefono,
        correo: clienteOption.dataset.correo,
        duracion: parseInt(document.getElementById('cita-duracion').value, 10) || 60,
        nonce: window.aa_asistant_vars.nonce_crear_cita || ''
      };

      // Agregar assignment_id solo si existe (opcional)
      if (assignmentId) {
        datos.assignment_id = parseInt(assignmentId, 10);
        console.log('üÜî Assignment ID incluido en reserva:', datos.assignment_id);
      }

      try {
        // üîπ PASO 1: Guardar la reserva usando ReservationService
        const data = await window.ReservationService.saveReservation(datos);

        // üîπ PASO 2: A√±adir ID de la reserva
        if (data.data && data.data.id) {
          datos.id_reserva = data.data.id;
          console.log('üÜî ID de reserva asignado:', datos.id_reserva);
        } else if (data.id) {
          datos.id_reserva = data.id;
          console.warn('‚ö†Ô∏è ID de reserva recibido en formato alternativo:', datos.id_reserva);
        } else {
          console.warn('‚ö†Ô∏è No se recibi√≥ ID de reserva en la respuesta del backend.');
        }

        // üîπ PASO 3: Enviar confirmaci√≥n usando ReservationService (sin bloquear)
        window.ReservationService.sendConfirmation(datos).catch(emailError => {
          console.warn('‚ö†Ô∏è Error al enviar correo (no cr√≠tico):', emailError);
        });

        // üîπ PASO 4: Mostrar mensaje de √©xito
        // NOTA: En modal, el cierre se maneja en reservation.js
        alert('‚úÖ Cita agendada correctamente. Se ha enviado correo de confirmaci√≥n.');
        
        // Solo recargar si NO estamos en modal (legacy behavior)
        if (btnToggle) {
          location.reload();
        }

      } catch (err) {
        console.error('‚ùå Error al agendar:', err);
        alert('‚ùå Error al agendar: ' + err.message);
      }
    });

    console.log('‚úÖ AdminReservationController inicializado');
  }

  // ==============================
  // üîπ Exponer en window
  // ==============================
  window.AdminReservationController = {
    init: initAdminReservationController
  };

  console.log('‚úÖ AdminReservationController cargado y expuesto globalmente');
})();



========================================
FILE: assets\js\controllers\appointmentsController.js
========================================
/**
 * Appointments Controller
 * 
 * Handles fetching, rendering, and pagination of appointments
 * in the Appointments Explorer modal.
 * 
 * @package AgendaAutomatizada
 * @since 1.0.0
 */
(function() {
    'use strict';

    /**
     * Estado badge colors mapping
     */
    const ESTADO_BADGES = {
        'pending': {
            label: 'Pendiente',
            classes: 'bg-yellow-100 text-yellow-800'
        },
        'confirmed': {
            label: 'Confirmada',
            classes: 'bg-green-100 text-green-800'
        },
        'cancelled': {
            label: 'Cancelada',
            classes: 'bg-red-100 text-red-800'
        }
    };

    /**
     * AppointmentsController namespace
     */
    const AppointmentsController = {
        /**
         * Current state
         */
        state: {
            filters: {},
            page: 1,
            totalPages: 1,
            isLoading: false,
            source: null, // Origin of modal opening ('notifications' or null)
            originType: null, // Type filter when opened from notifications
            // Panel filters (in-memory only)
            panelFilters: {
                time: [],
                status: [],
                notification: []
            }
        },

        /**
         * Container selectors
         */
        selectors: {
            list: '.aa-appointments-list',
            filters: '.aa-appointments-filters',
            pagination: '.aa-appointments-pagination',
            loading: '.aa-appointments-loading',
            empty: '.aa-appointments-empty'
        },

        /**
         * Initialize controller with filters
         * @param {Object} filters - Initial filters { type, unread, source }
         */
        init: function(filters = {}) {
            console.log('[AppointmentsController] Inicializando con filtros:', filters);
            
            this.state.filters = filters;
            this.state.page = 1;
            
            // Reset panel filters
            this.state.panelFilters = {
                time: [],
                status: [],
                notification: []
            };
            
            // Store origin information for bulk marking on close
            this.state.source = filters.source || null;
            this.state.originType = filters.type || null;
            
            // Setup modal close observer if opened from notifications
            if (this.state.source === 'notifications') {
                this.setupModalCloseObserver();
            }
            
            // Setup filter toggle and checkboxes
            this.setupFiltersToggle();
            this.setupFilterCheckboxes();
            
            // Pre-select checkboxes based on initial filters
            this.applyInitialFiltersToPanel(filters);
            
            // Load appointments
            this.loadAppointments();
        },

        /**
         * Fetch appointments from server
         */
        loadAppointments: function() {
            if (this.state.isLoading) return;
            
            this.state.isLoading = true;
            this.showLoading();
            
            const ajaxurl = window.ajaxurl || '/wp-admin/admin-ajax.php';
            const params = new URLSearchParams({
                action: 'aa_get_appointments',
                page: this.state.page
            });
            
            // Add legacy filters (for backwards compatibility)
            if (this.state.filters.type && this.state.panelFilters.status.length === 0) {
                params.append('type', this.state.filters.type);
            }
            if (this.state.filters.unread && this.state.panelFilters.notification.length === 0) {
                params.append('unread', 'true');
            }
            
            // Add panel filters
            const pf = this.state.panelFilters;
            
            // Time filter
            if (pf.time.length > 0) {
                pf.time.forEach(function(val) {
                    params.append('time[]', val);
                });
            }
            
            // Status filter
            if (pf.status.length > 0) {
                pf.status.forEach(function(val) {
                    params.append('status[]', val);
                });
            }
            
            // Notification filter
            if (pf.notification.length > 0) {
                pf.notification.forEach(function(val) {
                    params.append('notification[]', val);
                });
            }
            
            const url = ajaxurl + '?' + params.toString();
            
            console.log('[AppointmentsController] Fetching:', url);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    this.state.isLoading = false;
                    
                    if (data.success && data.data) {
                        this.state.totalPages = data.data.pagination.total_pages;
                        this.state.page = data.data.pagination.page;
                        
                        this.renderAppointments(data.data.items);
                        this.renderPagination(data.data.pagination);
                        
                        console.log('[AppointmentsController] ‚úÖ Cargadas', data.data.items.length, 'citas');
                    } else {
                        console.error('[AppointmentsController] Error en respuesta:', data);
                        this.showError('Error al cargar las citas');
                    }
                })
                .catch(error => {
                    this.state.isLoading = false;
                    console.error('[AppointmentsController] Error:', error);
                    this.showError('Error de conexi√≥n');
                });
        },

        /**
         * Render appointments as cards
         * @param {Array} items - Array of appointment objects
         */
        renderAppointments: function(items) {
            const container = document.querySelector(this.selectors.list);
            if (!container) {
                console.error('[AppointmentsController] Container not found');
                return;
            }
            
            // Clear container
            container.innerHTML = '';
            
            // Handle empty state
            if (!items || items.length === 0) {
                this.showEmpty();
                return;
            }
            
            // Render each card
            items.forEach(item => {
                const card = this.createCard(item);
                container.appendChild(card);
            });
        },

        /**
         * Create a single appointment card
         * @param {Object} item - Appointment data
         * @returns {HTMLElement} Card element
         */
        createCard: function(item) {
            const card = document.createElement('div');
            card.className = 'aa-appointment-card relative';
            card.setAttribute('data-aa-card', '');
            card.setAttribute('data-appointment-id', item.id);
            
            // Store unread state
            const isUnread = item.unread === true;
            card.setAttribute('data-unread', isUnread ? 'true' : 'false');
            
            // Get estado badge
            const badge = ESTADO_BADGES[item.estado] || ESTADO_BADGES['pending'];
            
            // Unread bell icon (only if unread)
            const bellIcon = isUnread ? `
                <div class="aa-unread-bell absolute top-2 right-2 z-10">
                    <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                    </svg>
                </div>
            ` : '';
            
            // Header (clickable toggle)
            const header = document.createElement('div');
            header.className = 'aa-appointment-header';
            header.setAttribute('data-aa-card-toggle', '');
            header.innerHTML = `
                ${bellIcon}
                <div class="flex items-center justify-between w-full">
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-900">${this.escapeHtml(item.cliente_nombre)}</span>
                        <span class="text-sm text-gray-500">${this.escapeHtml(item.servicio)}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600">${item.fecha} ${item.hora}</span>
                        <span class="px-2 py-1 text-xs font-medium rounded ${badge.classes}">${badge.label}</span>
                    </div>
                </div>
            `;
            
            // Overlay wrapper
            const overlay = document.createElement('div');
            overlay.className = 'aa-card-overlay';
            
            // Body (expanded content)
            const body = document.createElement('div');
            body.className = 'aa-card-body';
            body.innerHTML = `
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Servicio:</span>
                        <span class="text-gray-900">${this.escapeHtml(item.servicio)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Fecha:</span>
                        <span class="text-gray-900">${item.fecha}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Hora:</span>
                        <span class="text-gray-900">${item.hora}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Duraci√≥n:</span>
                        <span class="text-gray-900">${item.duracion} min</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Cliente:</span>
                        <span class="text-gray-900">${this.escapeHtml(item.cliente_nombre)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Tel√©fono:</span>
                        <span class="text-gray-900">${this.escapeHtml(item.telefono || 'N/A')}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Estado:</span>
                        <span class="px-2 py-1 text-xs font-medium rounded ${badge.classes}">${badge.label}</span>
                    </div>
                </div>
            `;
            
            overlay.appendChild(body);
            card.appendChild(header);
            card.appendChild(overlay);
            
            // Setup card open listener to mark as read
            this.setupCardOpenListener(card, item.id);
            
            return card;
        },

        /**
         * Render pagination controls
         * @param {Object} pagination - Pagination data
         */
        renderPagination: function(pagination) {
            let paginationContainer = document.querySelector(this.selectors.pagination);
            
            // Create pagination container if doesn't exist
            if (!paginationContainer) {
                const listContainer = document.querySelector(this.selectors.list);
                if (listContainer && listContainer.parentNode) {
                    paginationContainer = document.createElement('div');
                    paginationContainer.className = 'aa-appointments-pagination flex items-center justify-between mt-4 pt-4 border-t border-gray-200';
                    listContainer.parentNode.appendChild(paginationContainer);
                }
            }
            
            if (!paginationContainer) return;
            
            // Hide if only one page
            if (pagination.total_pages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            const self = this;
            
            paginationContainer.innerHTML = `
                <button 
                    type="button" 
                    class="aa-pagination-prev px-3 py-1 text-sm rounded border ${pagination.has_prev ? 'border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer' : 'border-gray-200 text-gray-400 cursor-not-allowed'}"
                    ${!pagination.has_prev ? 'disabled' : ''}
                >
                    ‚Üê Anterior
                </button>
                <span class="text-sm text-gray-600">
                    P√°gina ${pagination.page} de ${pagination.total_pages}
                </span>
                <button 
                    type="button" 
                    class="aa-pagination-next px-3 py-1 text-sm rounded border ${pagination.has_next ? 'border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer' : 'border-gray-200 text-gray-400 cursor-not-allowed'}"
                    ${!pagination.has_next ? 'disabled' : ''}
                >
                    Siguiente ‚Üí
                </button>
            `;
            
            // Attach event handlers
            const prevBtn = paginationContainer.querySelector('.aa-pagination-prev');
            const nextBtn = paginationContainer.querySelector('.aa-pagination-next');
            
            if (prevBtn && pagination.has_prev) {
                prevBtn.addEventListener('click', function() {
                    self.goToPage(self.state.page - 1);
                });
            }
            
            if (nextBtn && pagination.has_next) {
                nextBtn.addEventListener('click', function() {
                    self.goToPage(self.state.page + 1);
                });
            }
        },

        /**
         * Navigate to a specific page
         * @param {number} page - Page number
         */
        goToPage: function(page) {
            if (page < 1 || page > this.state.totalPages) return;
            
            this.state.page = page;
            this.loadAppointments();
        },

        /**
         * Show loading state
         */
        showLoading: function() {
            const container = document.querySelector(this.selectors.list);
            if (!container) return;
            
            container.innerHTML = `
                <div class="aa-appointments-loading flex items-center justify-center py-8">
                    <div class="text-gray-500">Cargando citas...</div>
                </div>
            `;
        },

        /**
         * Show empty state
         */
        showEmpty: function() {
            const container = document.querySelector(this.selectors.list);
            if (!container) return;
            
            container.innerHTML = `
                <div class="aa-appointments-empty flex flex-col items-center justify-center py-8 text-center">
                    <div class="text-gray-400 text-4xl mb-2">üìã</div>
                    <div class="text-gray-500">No hay citas que mostrar</div>
                </div>
            `;
        },

        /**
         * Show error state
         * @param {string} message - Error message
         */
        showError: function(message) {
            const container = document.querySelector(this.selectors.list);
            if (!container) return;
            
            container.innerHTML = `
                <div class="aa-appointments-error flex flex-col items-center justify-center py-8 text-center">
                    <div class="text-red-400 text-4xl mb-2">‚ö†Ô∏è</div>
                    <div class="text-red-600">${this.escapeHtml(message)}</div>
                </div>
            `;
        },

        /**
         * Escape HTML to prevent XSS
         * @param {string} str - String to escape
         * @returns {string} Escaped string
         */
        escapeHtml: function(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        },

        /**
         * Setup listener for card open to mark notification as read
         * @param {HTMLElement} card - Card element
         * @param {number} appointmentId - Appointment ID
         */
        setupCardOpenListener: function(card, appointmentId) {
            const self = this;
            const toggle = card.querySelector('[data-aa-card-toggle]');
            
            if (!toggle) return;
            
            // Track if we've already marked this as read
            let isMarking = false;
            
            // Listen for card open (when is-open class is added)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const isOpen = card.classList.contains('is-open');
                        const isUnread = card.getAttribute('data-unread') === 'true';
                        
                        // If card was just opened and has unread notification
                        if (isOpen && isUnread && !isMarking) {
                            isMarking = true;
                            self.markAppointmentNotificationAsRead(card, appointmentId);
                        }
                    }
                });
            });
            
            // Start observing
            observer.observe(card, {
                attributes: true,
                attributeFilter: ['class']
            });
        },

        /**
         * Mark notification as read for a specific appointment
         * @param {HTMLElement} card - Card element
         * @param {number} appointmentId - Appointment ID
         */
        markAppointmentNotificationAsRead: function(card, appointmentId) {
            const ajaxurl = window.ajaxurl || '/wp-admin/admin-ajax.php';
            const params = new URLSearchParams({
                action: 'aa_mark_appointment_notification_read',
                appointment_id: appointmentId
            });
            
            const url = ajaxurl + '?' + params.toString();
            
            console.log('[AppointmentsController] Marcando notificaci√≥n como le√≠da para appointment:', appointmentId);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove bell icon
                        const bell = card.querySelector('.aa-unread-bell');
                        if (bell) {
                            bell.remove();
                        }
                        
                        // Update data attribute
                        card.setAttribute('data-unread', 'false');
                        
                        // Update notifications badge if function exists
                        if (typeof window.updateNotificationsBadge === 'function') {
                            window.updateNotificationsBadge();
                        }
                        
                        console.log('[AppointmentsController] ‚úÖ Notificaci√≥n marcada como le√≠da');
                    } else {
                        console.error('[AppointmentsController] Error marcando notificaci√≥n:', data);
                    }
                })
                .catch(error => {
                    console.error('[AppointmentsController] Error marcando notificaci√≥n:', error);
                });
        },

        /**
         * Setup filter toggle button
         */
        setupFiltersToggle: function() {
            const toggleBtn = document.querySelector('.aa-btn-toggle-filters');
            const filtersPanel = document.querySelector(this.selectors.filters);
            
            if (!toggleBtn || !filtersPanel) {
                console.warn('[AppointmentsController] Filter toggle elements not found');
                return;
            }
            
            toggleBtn.addEventListener('click', function() {
                filtersPanel.classList.toggle('hidden');
            });
            
            console.log('[AppointmentsController] ‚úÖ Toggle de filtros configurado');
        },

        /**
         * Setup filter checkbox event listeners
         */
        setupFilterCheckboxes: function() {
            const self = this;
            const filtersPanel = document.querySelector(this.selectors.filters);
            
            if (!filtersPanel) return;
            
            const checkboxes = filtersPanel.querySelectorAll('input[data-filter]');
            
            checkboxes.forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    self.handleFilterChange(this);
                });
            });
            
            console.log('[AppointmentsController] ‚úÖ Checkboxes de filtros configurados:', checkboxes.length);
        },

        /**
         * Handle filter checkbox change
         * @param {HTMLInputElement} checkbox - Changed checkbox
         */
        handleFilterChange: function(checkbox) {
            const filterAttr = checkbox.getAttribute('data-filter');
            if (!filterAttr) return;
            
            const [group, value] = filterAttr.split(':');
            const isChecked = checkbox.checked;
            const filtersPanel = document.querySelector(this.selectors.filters);
            
            if (!filtersPanel) return;
            
            // Handle "all" checkbox logic
            if (value === 'all') {
                if (isChecked) {
                    // Uncheck all other checkboxes in this group
                    const groupCheckboxes = filtersPanel.querySelectorAll(`[data-filter^="${group}:"]`);
                    groupCheckboxes.forEach(function(cb) {
                        if (cb.getAttribute('data-filter') !== `${group}:all`) {
                            cb.checked = false;
                        }
                    });
                    // Clear the group filter (all means no filter)
                    this.state.panelFilters[group] = [];
                }
            } else {
                // Uncheck "all" if selecting a specific value
                const allCheckbox = filtersPanel.querySelector(`[data-filter="${group}:all"]`);
                if (allCheckbox) {
                    allCheckbox.checked = false;
                }
                
                // Update the state array
                if (isChecked) {
                    if (!this.state.panelFilters[group].includes(value)) {
                        this.state.panelFilters[group].push(value);
                    }
                } else {
                    this.state.panelFilters[group] = this.state.panelFilters[group].filter(v => v !== value);
                }
                
                // Check if all specific values are selected, then mark "all" and clear
                const groupFieldset = filtersPanel.querySelector(`[data-filter-group="${group}"]`);
                if (groupFieldset) {
                    const specificCheckboxes = groupFieldset.querySelectorAll(`[data-filter^="${group}:"]:not([data-filter="${group}:all"])`);
                    const allSpecificChecked = Array.from(specificCheckboxes).every(cb => cb.checked);
                    
                    if (allSpecificChecked && specificCheckboxes.length > 0) {
                        // All specific ones checked = mark "all" and uncheck others
                        if (allCheckbox) {
                            allCheckbox.checked = true;
                        }
                        specificCheckboxes.forEach(cb => cb.checked = false);
                        this.state.panelFilters[group] = [];
                    }
                }
            }
            
            console.log('[AppointmentsController] Filtros actualizados:', this.state.panelFilters);
            
            // Reset to page 1 and reload
            this.state.page = 1;
            this.loadAppointments();
        },

        /**
         * Apply initial filters to panel checkboxes
         * @param {Object} filters - Initial filters from modal open
         */
        applyInitialFiltersToPanel: function(filters) {
            const filtersPanel = document.querySelector(this.selectors.filters);
            if (!filtersPanel) return;
            
            // Apply type filter to status group
            if (filters.type) {
                const statusCheckbox = filtersPanel.querySelector(`[data-filter="status:${filters.type}"]`);
                if (statusCheckbox) {
                    statusCheckbox.checked = true;
                    this.state.panelFilters.status = [filters.type];
                }
            }
            
            // Apply unread filter to notification group
            if (filters.unread) {
                const unreadCheckbox = filtersPanel.querySelector('[data-filter="notification:unread"]');
                if (unreadCheckbox) {
                    unreadCheckbox.checked = true;
                    this.state.panelFilters.notification = ['unread'];
                }
            }
        },

        /**
         * Setup observer to detect when modal closes
         * Marks all notifications of the type as read when modal closes (only if opened from notifications)
         */
        setupModalCloseObserver: function() {
            const self = this;
            const modalRoot = document.getElementById('aa-modal-root');
            
            if (!modalRoot) {
                console.warn('[AppointmentsController] Modal root not found, cannot setup close observer');
                return;
            }
            
            // Track previous state to detect transition from open to closed
            let wasOpen = !modalRoot.classList.contains('hidden');
            
            // Create observer to watch for modal close (when 'hidden' class is added)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const isHidden = modalRoot.classList.contains('hidden');
                        
                        // Detect transition from open to closed
                        if (wasOpen && isHidden) {
                            // Modal was just closed
                            // If opened from notifications, mark all notifications of that type as read
                            if (
                                self.state.source === 'notifications' &&
                                self.state.originType &&
                                typeof window.aaMarkNotificationsAsRead === 'function'
                            ) {
                                console.log('[AppointmentsController] Modal cerrado desde notificaciones, marcando todas como le√≠das:', self.state.originType);
                                window.aaMarkNotificationsAsRead(self.state.originType);
                            }
                            
                            // Clean up observer
                            observer.disconnect();
                        }
                        
                        // Update previous state
                        wasOpen = !isHidden;
                    }
                });
            });
            
            // Start observing
            observer.observe(modalRoot, {
                attributes: true,
                attributeFilter: ['class']
            });
            
            console.log('[AppointmentsController] ‚úÖ Observer de cierre de modal configurado');
        }
    };

    // Expose to global scope
    window.AAAppointmentsController = AppointmentsController;

})();





========================================
FILE: assets\js\controllers\availabilityController.js
========================================
/**
 * Controlador de Disponibilidad
 */
(function() {
  'use strict';

  // ==============================
  // üîπ Referencias locales (dentro del IIFE)
  // ==============================
  const AvailabilityService = window.AvailabilityService;
  const ymd = window.DateUtils.ymd;
  const hm = window.DateUtils.hm;

  // ==============================
  // üîπ Variables del m√≥dulo
  // ==============================
  let availabilityProxyInstance = null;
  let calendarInstance = null;
  let slotsInstance = null;

  // ==============================
  // üîπ PASO 3: Renderizar UI con datos iniciales
  // ==============================
  function renderInitialUI(fechaInputSelector, slotContainerSelector, isAdmin, initialData) {
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üé® RENDERIZANDO UI INICIAL');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    const fechaInput = document.querySelector(fechaInputSelector);
    if (!fechaInput) {
      console.warn(`‚ö†Ô∏è No se encontr√≥ ${fechaInputSelector}`);
      return null;
    }

    const { availableSlotsPerDay, minDate, maxDate } = initialData;

    // Funci√≥n helper para determinar si una fecha tiene slots
    const isDateAvailable = (date) => {
      return (availableSlotsPerDay[ymd(date)]?.length || 0) > 0;
    };

    const disableDateFn = (date) => !isDateAvailable(date);

    if (isAdmin) {
      if (typeof window.CalendarAdminUI !== 'undefined') {
        const picker = window.CalendarAdminUI.render({
          fechaInput,
          slotContainerSelector,
          slotsMap: availableSlotsPerDay,
          minDate,
          maxDate,
          disableDateFn
        });
        
        console.log('‚úÖ Calendario ADMIN renderizado con datos locales');
        
        // ‚úÖ RENDERIZAR SLOTS INICIALES para la primera fecha disponible
        if (picker) {
          const firstAvailableDate = AvailabilityService.findFirstAvailable(
            minDate, 
            maxDate, 
            availableSlotsPerDay
          );
          
          if (firstAvailableDate) {
            const validSlots = availableSlotsPerDay[ymd(firstAvailableDate)] || [];
            
            console.log(`üìÖ Admin: Renderizando slots iniciales para ${ymd(firstAvailableDate)}`);
            console.log(`üìÖ Admin: ${validSlots.length} slots disponibles`);
            console.log(`üìÖ Admin: Slots:`, validSlots.map(s => s.toLocaleTimeString('es-MX')));
            
            // ‚úÖ Esperar un tick para asegurar que el listener est√© registrado
            setTimeout(() => {
              // Disparar evento para que SlotSelectorAdminUI renderice los slots
              document.dispatchEvent(new CustomEvent('aa:admin:date-selected', {
                detail: {
                  containerId: slotContainerSelector,
                  validSlots,
                  selectedDate: firstAvailableDate,
                  fechaInput
                }
              }));
            }, 0);
            
            // Establecer fecha en Flatpickr (sin disparar onChange)
            picker.setDate(firstAvailableDate, false);
          }
        }
        
        return picker;
      } else {
        console.error('‚ùå CalendarAdminUI no disponible');
      }
    } else {
      // ========== FRONTEND: Usar WPAgenda adaptadores ==========
      const calendarAdapterInstance = WPAgenda?.ui?.calendar || window.calendarDefaultAdapter.create();
      const slotsAdapterInstance = WPAgenda?.ui?.slots || window.slotsDefaultAdapter.create();

      calendarInstance = calendarAdapterInstance;
      slotsInstance = slotsAdapterInstance;

      calendarInstance.render({
        container: '#wpagenda-calendar',
        minDate,
        maxDate,
        disableDateFn,
        onDateSelected: (selectedDate) => {
          const slots = availableSlotsPerDay[ymd(selectedDate)] || [];

          // Mostrar t√≠tulo solo si hay slots
          const titleEl = document.getElementById('aa-slot-title');
          if (slots.length > 0) {
            titleEl.innerText = 'Horarios disponibles';
            titleEl.style.display = 'block';
          } else {
            titleEl.style.display = 'none';
          }

          slotsInstance.render('#slot-container', slots, (chosenSlot) => {
            const fechaStr = ymd(selectedDate);
            const horaStr = hm(chosenSlot);
            fechaInput.value = `${fechaStr} ${horaStr}`;
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = chosenSlot.toISOString();
            }
          });

          if (slots[0]) {
            const fechaStr = ymd(selectedDate);
            const horaStr = hm(slots[0]);
            fechaInput.value = `${fechaStr} ${horaStr}`;
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = slots[0].toISOString();
            }
          }
        }
      });
      console.log('‚úÖ Calendario FRONTEND renderizado con WPAgenda adaptadores');
      return calendarInstance;
    }

    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
  }

  // ==============================
  // üîπ PASO 4: Iniciar consulta a Google Calendar (async)
  // ==============================
  function startGoogleCalendarSync(fechaInputSelector, slotContainerSelector, isAdmin, initialData) {
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üîÑ INICIANDO SINCRONIZACI√ìN CON GOOGLE CALENDAR');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

    if (typeof window.AvailabilityProxy === 'undefined') {
      console.error("‚ùå AvailabilityProxy no est√° disponible");
      return;
    }

    // Validar si existe email configurado
    const email = (typeof aa_backend !== 'undefined' && aa_backend.email) 
      ? aa_backend.email 
      : '';

    // üÜï Obtener estado de sincronizaci√≥n con Google Calendar
    const gsyncStatus = (typeof aa_backend !== 'undefined' && aa_backend.gsync_status)
      ? aa_backend.gsync_status
      : 'active';

    const config = {
      ajaxUrl: (typeof aa_backend !== 'undefined' && aa_backend.ajax_url) 
        ? aa_backend.ajax_url 
        : '/wp-admin/admin-ajax.php',
      action: (typeof aa_backend !== 'undefined' && aa_backend.action) 
        ? aa_backend.action 
        : 'aa_get_availability',
      email: email,
      maxAttempts: 20,
      retryInterval: 15000
    };

    // ‚úÖ Instanciar siempre para evitar errores en UI
    availabilityProxyInstance = new window.AvailabilityProxy(config);
    window.availabilityProxyInstance = availabilityProxyInstance;
    
    // ‚úÖ IMPORTANTE: Siempre inyectar datos locales al proxy para que onChange funcione
    const localBusyRanges = window.AvailabilityService.loadLocal();
    availabilityProxyInstance.busyRanges = localBusyRanges;
    availabilityProxyInstance.availableSlotsPerDay = initialData.availableSlotsPerDay || {};
    
    console.log(`üìä Proxy inicializado con ${Object.keys(availabilityProxyInstance.availableSlotsPerDay).length} d√≠as locales`);
    
    // üõë CL√ÅUSULA DE GUARDA EXTENDIDA: Sin email O gsync desconectado = MODO LOCAL
    if (!email || gsyncStatus === 'disconnected') {
      const reason = !email 
        ? 'aa_google_email no configurado'
        : 'Google Calendar desconectado (gsync_status = disconnected)';
      console.warn(`‚ö†Ô∏è ${reason}. Operando en modo LOCAL SOLAMENTE.`);
      return;
    }

    console.log('‚úÖ Email detectado y gsync activo. Iniciando sincronizaci√≥n con Google Calendar...');

    // ‚úÖ IMPORTANTE: Registrar listener ANTES de iniciar
    const handleAvailabilityLoaded = (event) => {
      if (!event.detail || !event.detail.proxy) {
        console.warn('‚ö†Ô∏è Evento recibido sin proxy, ignorando...');
        return;
      }
      
      const proxy = event.detail.proxy;
      const { schedule, futureWindow, slotDuration } = initialData;
      const updatedSlotsMap = proxy.calculateAvailableSlots(schedule, futureWindow, slotDuration);
      
      refreshUI(fechaInputSelector, slotContainerSelector, isAdmin, {
        ...initialData,
        availableSlotsPerDay: updatedSlotsMap,
        proxy
      });
      
      console.log('‚úÖ UI refrescada, listener permanece activo para futuras actualizaciones');
    };

    document.addEventListener('aa:availability:loaded', handleAvailabilityLoaded);
    availabilityProxyInstance.start();
  }

  // ==============================
  // üîπ PASO 5: Refrescar UI con datos externos
  // ==============================
  function refreshUI(fechaInputSelector, slotContainerSelector, isAdmin, updatedData) {
    console.log('üîÑ Refrescando UI con datos actualizados...');
    
    const fechaInput = document.querySelector(fechaInputSelector);
    
    const hasCalendar = isAdmin ? (fechaInput && fechaInput._flatpickr) : (calendarInstance !== null);
    if (!hasCalendar) {
      console.warn('‚ö†Ô∏è No se puede refrescar: calendario no encontrado');
      return;
    }

    const { availableSlotsPerDay, minDate, maxDate, proxy } = updatedData;
    const disableDateFn = (date) => !proxy.isDateAvailable(date);

    const currentSelectedDate = isAdmin 
      ? fechaInput._flatpickr.selectedDates[0]
      : calendarInstance.getSelectedDate();

    if (isAdmin) {
      if (typeof window.CalendarAdminUI !== 'undefined') {
        const picker = window.CalendarAdminUI.render({
          fechaInput,
          slotContainerSelector,
          slotsMap: availableSlotsPerDay,
          minDate,
          maxDate,
          disableDateFn: (date) => window.AvailabilityService.disable(proxy, date)
        });
        
        console.log('‚úÖ Calendario ADMIN actualizado con datos de Google');
        
        const dateToSelect = currentSelectedDate && proxy.isDateAvailable(currentSelectedDate)
          ? currentSelectedDate
          : AvailabilityService.findFirstAvailable(minDate, maxDate, availableSlotsPerDay);
        
        if (dateToSelect && picker) {
          const validSlots = window.AvailabilityService.slotsForDate(proxy, dateToSelect);
          
          console.log(`üìÖ Admin: Actualizando slots para ${ymd(dateToSelect)}`);
          console.log(`üìÖ Admin: ${validSlots.length} slots disponibles (con Google)`);
          
          document.dispatchEvent(new CustomEvent('aa:admin:date-selected', {
            detail: {
              containerId: slotContainerSelector,
              validSlots,
              selectedDate: dateToSelect,
              fechaInput
            }
          }));
          
          picker.setDate(dateToSelect, false);
        }
      }
    } else {
      if (calendarInstance) {
        calendarInstance.destroy();
      }
      
      const calendarAdapterInstance = WPAgenda?.ui?.calendar || window.calendarDefaultAdapter.create();
      calendarInstance = calendarAdapterInstance;
      
      calendarInstance.render({
        container: '#wpagenda-calendar',
        minDate,
        maxDate,
        disableDateFn: (date) => window.AvailabilityService.disable(proxy, date),
        onDateSelected: (selectedDate) => {
          const slots = window.AvailabilityService.slotsForDate(proxy, selectedDate);

          // Mostrar t√≠tulo solo si hay slots
          const titleEl = document.getElementById('aa-slot-title');
          if (slots.length > 0) {
            titleEl.innerText = 'Horarios disponibles';
            titleEl.style.display = 'block';
          } else {
            titleEl.style.display = 'none';
          }

          slotsInstance.render('#slot-container', slots, (chosenSlot) => {
            const input = document.querySelector(fechaInputSelector);
            if (input) {
              const fechaStr = ymd(selectedDate);
              const horaStr = hm(chosenSlot);
              input.value = `${fechaStr} ${horaStr}`;
            }
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = chosenSlot.toISOString();
            }
          });

          if (slots[0]) {
            const input = document.querySelector(fechaInputSelector);
            if (input) {
              const fechaStr = ymd(selectedDate);
              const horaStr = hm(slots[0]);
              input.value = `${fechaStr} ${horaStr}`;
            }
            
            const slotInput = document.getElementById('slot-selector');
            if (slotInput) {
              slotInput.value = slots[0].toISOString();
            }
          }
        }
      });
      
      if (currentSelectedDate && proxy.isDateAvailable(currentSelectedDate)) {
        calendarInstance.setDate(currentSelectedDate, true);
      }
      
      console.log('‚úÖ Calendario FRONTEND actualizado con WPAgenda adaptadores');
    }
  }

  // ==============================
  // üîπ FUNCI√ìN PRINCIPAL
  // ==============================
  function initAvailabilityController(config) {
    const {
      fechaInputSelector,
      slotContainerSelector = '#slot-container',
      isAdmin = false
    } = config;

    console.log('\nüöÄ INICIANDO AVAILABILITY CONTROLLER');
    console.log(`üöÄ Modo: ${isAdmin ? 'ADMIN' : 'FRONTEND'}\n`);

    const localBusyRanges = AvailabilityService.loadLocal();
    const initialData = AvailabilityService.calculateInitial(localBusyRanges);

    renderInitialUI(fechaInputSelector, slotContainerSelector, isAdmin, initialData);
    startGoogleCalendarSync(fechaInputSelector, slotContainerSelector, isAdmin, initialData);
  }

  // ==============================
  // üîπ Exponer en window
  // ==============================
  window.AvailabilityController = {
    init: initAvailabilityController
  };

  console.log('‚úÖ AvailabilityController cargado (flujo corregido)');
})();


========================================
FILE: assets\js\controllers\reservationController.js
========================================
// ==============================
// üîπ Controlador de reservas
// ==============================

/**
 * Inicializa el controlador de reservas
 */
function initReservationController(formSelector) {
  const form = document.querySelector(formSelector);
  
  if (!form) {
    console.error(`‚ùå No se encontr√≥ el formulario: ${formSelector}`);
    return;
  }

  // ‚úÖ Crear campo honeypot invisible anti-bot
  const honeypot = document.createElement('input');
  honeypot.type = 'text';
  honeypot.name = 'extra_field';
  honeypot.style.display = 'none';
  form.appendChild(honeypot);

  // ==============================
  // üîπ Manejar env√≠o del formulario
  // ==============================
  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const respuestaDiv = document.getElementById('respuesta-agenda');
    
    if (!respuestaDiv) {
      console.error('‚ùå No se encontr√≥ el div de respuesta');
      return;
    }

    respuestaDiv.innerText = 'Procesando solicitud...';

    // üîπ Obtener el slot seleccionado del selector
    const slotSelector = document.getElementById('slot-selector');
    const selectedSlotISO = slotSelector ? slotSelector.value : null;
    
    // üîπ Validar que se haya seleccionado un horario
    if (!selectedSlotISO) {
      respuestaDiv.innerText = '‚ùå Por favor, selecciona una fecha y hora v√°lidas.';
      console.warn('‚ö†Ô∏è No se ha seleccionado ning√∫n horario');
      return;
    }

    // üîπ Construir objeto de datos
    const datos = {
      servicio: form.servicio.value,
      fecha: selectedSlotISO,
      nombre: form.nombre.value,
      telefono: form.telefono.value,
      correo: form.correo.value || '',
      nonce: wpaa_vars.nonce,
      extra_field: honeypot.value || ''
    };

    try {
      // üîπ PASO 1: Guardar la reserva
      const data = await window.ReservationService.saveReservation(datos);

      // üîπ PASO 2: A√±adir ID de la reserva
      if (data.data && data.data.id) {
        datos.id_reserva = data.data.id;
        console.log('üÜî ID de reserva asignado:', datos.id_reserva);
      } else if (data.id) {
        datos.id_reserva = data.id;
        console.warn('‚ö†Ô∏è ID de reserva recibido en formato alternativo:', datos.id_reserva);
      } else {
        console.warn('‚ö†Ô∏è No se recibi√≥ ID de reserva en la respuesta del backend.');
      }

      // üîπ PASO 3: Enviar confirmaci√≥n por correo (sin bloquear el flujo)
      window.ReservationService.sendConfirmation(datos).catch(emailError => {
        console.warn('‚ö†Ô∏è Error al enviar correo (no cr√≠tico):', emailError);
      });

      // üîπ PASO 4: Formatear la fecha para WhatsApp
      const fechaObj = new Date(selectedSlotISO);
      const userLocale = (typeof wpaa_vars !== 'undefined' && wpaa_vars.locale) 
        ? wpaa_vars.locale 
        : 'es-MX';
      
      const fechaLegible = fechaObj.toLocaleString(userLocale, {
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: wpaa_vars.timezone || 'America/Mexico_City'
      });

      respuestaDiv.innerText = '‚úÖ Cita agendada correctamente. Redirigiendo a WhatsApp...';

      // üîπ PASO 5: Redirigir a WhatsApp despu√©s de 2 segundos
      setTimeout(() => {
        redirectToWhatsApp(datos.nombre, datos.servicio, fechaLegible, datos.telefono);
      }, 2000);

    } catch (err) {
      console.error('‚ùå Error al agendar:', err);
      respuestaDiv.innerText = `‚ùå Error al agendar: ${err.message}`;
    }
  });

  console.log('‚úÖ ReservationController inicializado');
}

/**
 * Redirige a WhatsApp con mensaje prellenado
 */
function redirectToWhatsApp(nombre, servicio, fechaLegible, telefono) {
  const whatsappNumber = (typeof wpaa_vars !== 'undefined' && wpaa_vars.whatsapp_number) 
    ? wpaa_vars.whatsapp_number 
    : '5215522992290';

  const mensaje = `Hola, soy ${nombre}. Me gustar√≠a agendar una cita para: ${servicio} el d√≠a ${fechaLegible}. Mi tel√©fono es ${telefono}.`;
  
  window.location.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(mensaje)}`;
}

// ==============================
// üîπ Exponer en window
// ==============================
window.ReservationController = {
  init: initReservationController
};

console.log('‚úÖ ReservationController cargado y expuesto globalmente');


========================================
FILE: assets\js\main-admin.js
========================================
// ==============================
// üîπ Punto de entrada principal del admin
// ==============================

document.addEventListener('DOMContentLoaded', function () {
  console.log('üöÄ Inicializando aplicaci√≥n admin...');

  // ‚úÖ Inicializar controlador de disponibilidad PRIMERO
  if (typeof window.AvailabilityController !== 'undefined') {
    window.AvailabilityController.init({
      fechaInputSelector: '#cita-fecha',
      slotContainerSelector: 'slot-container-admin',
      isAdmin: true
    });
  } else {
    console.error('‚ùå AvailabilityController no est√° cargado');
  }

  // ‚úÖ Inicializar controlador de reservas
  const btnToggle = document.getElementById('btn-toggle-form-nueva-cita');
  const formNuevaCita = document.getElementById('form-nueva-cita');
  const btnCancelar = document.getElementById('btn-cancelar-cita-form');
  const form = document.getElementById('form-crear-cita-admin');

  if (typeof window.AdminReservationController !== 'undefined') {
    window.AdminReservationController.init({
      btnToggle,
      formNuevaCita,
      btnCancelar,
      form
    });
  } else {
    console.error('‚ùå AdminReservationController no est√° cargado');
  }

  console.log('‚úÖ Aplicaci√≥n admin inicializada correctamente');
});


========================================
FILE: assets\js\main-frontend.js
========================================
// ==============================
// üîπ Punto de entrada principal del frontend
// ==============================

document.addEventListener('DOMContentLoaded', function () {
  console.log('üöÄ Inicializando aplicaci√≥n frontend...');

  // ==============================
  // üîπ FASE 1: Validar input de fecha y configuraci√≥n
  // ==============================
  if (typeof window.CalendarUI !== 'undefined') {
    const fechaInput = window.CalendarUI.findDateInput();
    
    if (!fechaInput) {
      console.error('‚ùå No se encontr√≥ input de fecha, abortando inicializaci√≥n');
      return;
    }

    // Leer duraci√≥n de slot
    const slotDuration = window.CalendarUI.getSlotDuration();
    console.log(`‚úÖ Input encontrado: #${fechaInput.id}`);
    console.log(`‚úÖ Slot duration: ${slotDuration} min`);

    // ==============================
    // üîπ FASE 2: Inicializar calendario b√°sico INMEDIATAMENTE
    // ==============================
    console.log('üìÖ Inicializando calendario b√°sico...');
    

  } else {
    console.error('‚ùå CalendarUI no est√° disponible');
  }

  // ==============================
  // üîπ FASE 3: Inicializar controlador de disponibilidad
  // (Iniciar√° el proxy y se activar√° cuando lleguen los datos)
  // ==============================
  if (typeof window.AvailabilityController !== 'undefined') {
    window.AvailabilityController.init({
      fechaInputSelector: '#fecha',
      slotContainerSelector: 'slot-container',
      isAdmin: false
    });
  } else {
    console.error('‚ùå AvailabilityController no est√° cargado');
  }

  // ==============================
  // üîπ FASE 4: Inicializar controlador de reservas
  // ==============================
  if (typeof window.ReservationController !== 'undefined') {
    window.ReservationController.init('#agenda-form');
  } else {
    console.error('‚ùå ReservationController no est√° cargado');
  }

  console.log('‚úÖ Aplicaci√≥n frontend inicializada correctamente');
});


========================================
FILE: assets\js\services\adminCalendarService.js
========================================
/**
 * Servicio: Calendario Admin
 * 
 * Responsable de:
 * - Llamadas AJAX para obtener citas del calendario
 * - Gesti√≥n de datos del calendario
 * - L√≥gica de dominio (c√°lculos, decisiones)
 * 
 * NO contiene l√≥gica de UI ni callbacks.
 */

window.AdminCalendarService = (function() {
    'use strict';
    
    /**
     * Obtener citas por d√≠a
     * @param {string} fecha - Fecha en formato YYYY-MM-DD
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function getCitasPorDia(fecha) {
        // TODO: Implementar
        return Promise.resolve({ success: false, data: { citas: [] } });
    }
    
    /**
     * Determinar si una cita es pr√≥xima o pasada
     * @param {Object} cita - Objeto de cita con fecha y fecha_fin
     * @returns {boolean} - true si es pr√≥xima, false si es pasada
     */
    function esCitaProxima(cita) {
        if (!cita.fecha) return false;
        
        const ahora = new Date();
        const fechaInicio = new Date(cita.fecha);
        
        // PR√ìXIMA: fecha_inicio > ahora
        if (fechaInicio > ahora) {
            return true;
        }
        
        // PASADA: fecha_fin < ahora
        if (cita.fecha_fin) {
            const fechaFin = new Date(cita.fecha_fin);
            if (fechaFin < ahora) {
                return false;
            }
        }
        
        // Si no hay fecha_fin y fecha_inicio <= ahora, considerar pasada
        return false;
    }
    
    /**
     * Calcular datos de posici√≥n de una cita en el timeline
     * @param {Object} cita - Objeto de cita con fecha, fecha_fin, duracion
     * @returns {Object|null} - { minutosInicio, minutosFin, slotInicio, bloquesOcupados } o null si no v√°lida
     */
    function calcularPosicionCita(cita) {
        if (!cita.fecha) return null;
        
        // Convertir fecha de inicio a minutos desde medianoche
        const fechaInicio = new Date(cita.fecha);
        const minutosInicio = window.DateUtils.minutesFromDate(fechaInicio);
        
        // Calcular minutos de fin usando fecha_fin o duracion
        let minutosFin;
        if (cita.fecha_fin) {
            const fechaFin = new Date(cita.fecha_fin);
            minutosFin = window.DateUtils.minutesFromDate(fechaFin);
        } else if (cita.duracion) {
            minutosFin = minutosInicio + parseInt(cita.duracion);
        } else {
            // Fallback: 60 minutos por defecto
            minutosFin = minutosInicio + 60;
        }
        
        // Encontrar el slot inicial (redondear hacia abajo al slot de 30 min m√°s cercano)
        const slotInicio = Math.floor(minutosInicio / 30) * 30;
        
        // Calcular cu√°ntos bloques de 30 min ocupa
        const duracionMinutos = minutosFin - minutosInicio;
        const bloquesOcupados = Math.ceil(duracionMinutos / 30);
        
        return {
            minutosInicio: minutosInicio,
            minutosFin: minutosFin,
            slotInicio: slotInicio,
            bloquesOcupados: bloquesOcupados
        };
    }
    
    // API p√∫blica
    return {
        getCitasPorDia: getCitasPorDia,
        esCitaProxima: esCitaProxima,
        calcularPosicionCita: calcularPosicionCita
    };
})();




========================================
FILE: assets\js\services\availability\availabilityAssignments.js
========================================
/**
 * Availability Assignments Service
 * 
 * Provides methods to query assignment-based availability.
 * This is a PARALLEL service - does NOT replace legacy AvailabilityService.
 * 
 * Exposes:
 * - window.AAAssignmentsAvailability
 * 
 * Methods:
 * - getAssignmentDates()
 * - getAssignmentDatesByService(serviceKey, startDate, endDate)
 * - getAssignmentsByServiceAndDate(serviceKey, date)
 * 
 * @package AgendaAutomatizada
 * @since 2.0.0
 */

(function() {
    'use strict';

    console.log('üîÑ [AAAssignmentsAvailability] Cargando m√≥dulo...');

    /**
     * Get AJAX URL
     * @returns {string}
     */
    function getAjaxUrl() {
        return window.ajaxurl || '/wp-admin/admin-ajax.php';
    }

    /**
     * Make AJAX request
     * @param {string} action - AJAX action name
     * @param {Object} data - Additional data to send
     * @returns {Promise<Object>}
     */
    async function ajaxRequest(action, data = {}) {
        const formData = new FormData();
        formData.append('action', action);
        
        Object.keys(data).forEach(key => {
            formData.append(key, data[key]);
        });

        console.log(`üì§ [AAAssignmentsAvailability] Enviando request: ${action}`, data);

        try {
            const response = await fetch(getAjaxUrl(), {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            console.log(`üì• [AAAssignmentsAvailability] Respuesta de ${action}:`, result);

            return result;
        } catch (error) {
            console.error(`‚ùå [AAAssignmentsAvailability] Error en ${action}:`, error);
            throw error;
        }
    }

    /**
     * Get all assignment dates
     * Returns all unique dates that have active assignments
     * 
     * @returns {Promise<Object>} Response with dates array
     */
    async function getAssignmentDates() {
        console.log('üîç [AAAssignmentsAvailability] getAssignmentDates() llamado');
        
        const result = await ajaxRequest('aa_get_assignment_dates');
        
        if (result.success) {
            console.log(`‚úÖ [AAAssignmentsAvailability] ${result.data.dates?.length || 0} fechas encontradas`);
        }
        
        return result;
    }

    /**
     * Get assignment dates by service
     * Returns dates that have assignments for a specific service
     * 
     * @param {string} serviceKey - Service identifier (e.g., 'consulta_general')
     * @param {string} startDate - Start date (YYYY-MM-DD), optional
     * @param {string} endDate - End date (YYYY-MM-DD), optional
     * @returns {Promise<Object>} Response with dates array
     */
    async function getAssignmentDatesByService(serviceKey, startDate = null, endDate = null) {
        console.log(`üîç [AAAssignmentsAvailability] getAssignmentDatesByService("${serviceKey}", "${startDate}", "${endDate}") llamado`);
        
        const data = { service_key: serviceKey };
        
        if (startDate) {
            data.start_date = startDate;
        }
        if (endDate) {
            data.end_date = endDate;
        }
        
        const result = await ajaxRequest('aa_get_assignment_dates_by_service', data);
        
        if (result.success) {
            console.log(`‚úÖ [AAAssignmentsAvailability] ${result.data.dates?.length || 0} fechas encontradas para servicio "${serviceKey}"`);
        }
        
        return result;
    }

    /**
     * Get assignments by service and date
     * Returns all assignments for a specific service on a specific date
     * 
     * @param {string} serviceKey - Service identifier
     * @param {string} date - Date (YYYY-MM-DD)
     * @returns {Promise<Object>} Response with assignments array
     */
    async function getAssignmentsByServiceAndDate(serviceKey, date) {
        console.log(`üîç [AAAssignmentsAvailability] getAssignmentsByServiceAndDate("${serviceKey}", "${date}") llamado`);
        
        const result = await ajaxRequest('aa_get_assignments_by_service_and_date', {
            service_key: serviceKey,
            date: date
        });
        
        if (result.success) {
            console.log(`‚úÖ [AAAssignmentsAvailability] ${result.data.assignments?.length || 0} asignaciones encontradas`);
        }
        
        return result;
    }

    /**
     * Get slots for staff and date from assignments
     * Calculates available time slots based on assignment intervals
     * 
     * @param {Array} assignments - Array of assignment objects with start_time and end_time
     * @param {string} date - Date in YYYY-MM-DD format
     * @param {number} slotDuration - Slot duration in minutes (default: 30)
     * @returns {Array<Date>|null} Array of slot Date objects, or null if error
     */
    function getSlotsForStaffAndDate(assignments, date, slotDuration = 30) {
        console.log('üîç [AAAssignmentsAvailability] getSlotsForStaffAndDate() llamado', {
            assignmentsCount: assignments?.length || 0,
            date: date,
            slotDuration: slotDuration
        });

        // Validar inputs
        if (!assignments || !Array.isArray(assignments) || assignments.length === 0) {
            console.warn('[AAAssignmentsAvailability] No hay asignaciones para calcular slots');
            return null;
        }

        if (!date) {
            console.warn('[AAAssignmentsAvailability] No hay fecha para calcular slots');
            return null;
        }

        // Verificar que DateUtils est√© disponible
        if (typeof window.DateUtils === 'undefined') {
            console.error('[AAAssignmentsAvailability] DateUtils no disponible');
            return null;
        }

        try {
            // 1Ô∏è‚É£ Construir intervalos desde assignments y normalizarlos a grilla de slots
            const normalizedIntervals = assignments.map(function(a) {
                if (!a.start_time || !a.end_time) {
                    console.warn('[AAAssignmentsAvailability] Asignaci√≥n sin start_time o end_time:', a);
                    return null;
                }

                // Convertir a minutos
                const startMin = window.DateUtils.timeStrToMinutes(a.start_time);
                const endMin = window.DateUtils.timeStrToMinutes(a.end_time);

                // Normalizar a grilla de slots
                const normalized = window.DateUtils.normalizeIntervalToSlotGrid(
                    startMin,
                    endMin,
                    slotDuration
                );

                if (!normalized) {
                    console.warn('[AAAssignmentsAvailability] Asignaci√≥n sin slots v√°lidos despu√©s de normalizar:', {
                        start_time: a.start_time,
                        end_time: a.end_time,
                        startMin: startMin,
                        endMin: endMin
                    });
                }

                return normalized;
            }).filter(function(iv) {
                return iv !== null;
            });

            if (normalizedIntervals.length === 0) {
                console.warn('[AAAssignmentsAvailability] No se pudieron construir intervalos normalizados v√°lidos');
                return null;
            }

            console.log('[AAAssignmentsAvailability] Intervalos normalizados:', normalizedIntervals);

            // 2Ô∏è‚É£ Crear objeto Date para la fecha
            const dateObj = new Date(date + 'T00:00:00');
            
            if (isNaN(dateObj.getTime())) {
                console.error('[AAAssignmentsAvailability] Fecha inv√°lida:', date);
                return null;
            }

            // 3Ô∏è‚É£ Generar slots usando DateUtils.generateSlotsForDay con intervalos normalizados
            const slots = window.DateUtils.generateSlotsForDay(
                dateObj,
                normalizedIntervals,
                [],        // busyRanges vac√≠o por ahora
                slotDuration
            );

            console.log('[AAAssignmentsAvailability] ‚úÖ Slots generados:', slots.length);
            console.log('[AAAssignmentsAvailability] üßÆ Slots calculados:', 
                slots.map(function(s) {
                    return window.DateUtils.hm(s);
                })
            );

            return slots;

        } catch (error) {
            console.error('[AAAssignmentsAvailability] Error al calcular slots:', error);
            return null;
        }
    }

    // ============================================
    // Expose to global namespace
    // ============================================
    window.AAAssignmentsAvailability = {
        getAssignmentDates: getAssignmentDates,
        getAssignmentDatesByService: getAssignmentDatesByService,
        getAssignmentsByServiceAndDate: getAssignmentsByServiceAndDate,
        getSlotsForStaffAndDate: getSlotsForStaffAndDate
    };

    console.log('‚úÖ [AAAssignmentsAvailability] M√≥dulo cargado y expuesto en window.AAAssignmentsAvailability');
    console.log('üìã M√©todos disponibles:');
    console.log('   - AAAssignmentsAvailability.getAssignmentDates()');
    console.log('   - AAAssignmentsAvailability.getAssignmentDatesByService(serviceKey, startDate?, endDate?)');
    console.log('   - AAAssignmentsAvailability.getAssignmentsByServiceAndDate(serviceKey, date)');
    console.log('   - AAAssignmentsAvailability.getSlotsForStaffAndDate(assignments, date, slotDuration?)');

})();




========================================
FILE: assets\js\services\availability\busyRanges.js
========================================
/**
 * M√≥dulo de Busy Ranges
 */

/**
 * Generar busyRanges desde eventos ocupados
 */
function generateBusyRanges(busyEvents) {
  if (!busyEvents || !Array.isArray(busyEvents)) {
    console.warn('‚ö†Ô∏è generateBusyRanges: No se recibieron eventos v√°lidos');
    return [];
  }

  console.log(`üîç Generando busyRanges desde ${busyEvents.length} eventos ocupados`);
  
  const busyRanges = busyEvents.map(ev => ({
    start: new Date(ev.start),
    end: new Date(ev.end)
  }));
  
  console.log(`‚úÖ ${busyRanges.length} busyRanges generados`);
  
  return busyRanges;
}

/**
 * Cargar disponibilidad local desde window
 */
function loadLocalBusyRanges() {
  const localBusyRanges = [];

  if (typeof window.aa_local_availability !== 'undefined' && window.aa_local_availability.local_busy) {
    console.log('‚úÖ Datos locales encontrados:', window.aa_local_availability);
    
    window.aa_local_availability.local_busy.forEach((slot) => {
      const start = new Date(slot.start);
      const end = new Date(slot.end);
      
      if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
        localBusyRanges.push({ start, end });
      }
    });
    
    console.log(`üìä Total eventos locales: ${localBusyRanges.length}`);
  } else {
    console.log('‚ÑπÔ∏è No hay datos locales de disponibilidad');
  }
  
  return localBusyRanges;
}

// ‚úÖ Exponer globalmente
window.BusyRanges = {
  generateBusyRanges,
  loadLocalBusyRanges
};

console.log('‚úÖ busyRanges.js cargado');


========================================
FILE: assets\js\services\availability\busyRangesAssignments.js
========================================
/**
 * Busy Ranges Assignments Service
 * 
 * Provides methods to get busy ranges from assignments.
 * This is a PARALLEL service - does NOT replace legacy BusyRanges.
 * 
 * Exposes:
 * - window.AABusyRangesAssignments
 * 
 * Methods:
 * - getBusyRangesByAssignments(assignmentIds, date)
 * 
 * @package AgendaAutomatizada
 * @since 2.0.0
 */

(function() {
    'use strict';

    console.log('üîÑ [AABusyRangesAssignments] Cargando m√≥dulo...');

    /**
     * Get AJAX URL
     * @returns {string}
     */
    function getAjaxUrl() {
        return window.ajaxurl || '/wp-admin/admin-ajax.php';
    }

    /**
     * Make AJAX request
     * @param {string} action - AJAX action name
     * @param {Object} data - Additional data to send
     * @returns {Promise<Object>}
     */
    async function ajaxRequest(action, data = {}) {
        const formData = new FormData();
        formData.append('action', action);
        
        Object.keys(data).forEach(key => {
            const value = data[key];
            // Handle arrays
            if (Array.isArray(value)) {
                formData.append(key, JSON.stringify(value));
            } else {
                formData.append(key, value);
            }
        });

        console.log(`üì§ [AABusyRangesAssignments] Enviando request: ${action}`, data);

        try {
            const response = await fetch(getAjaxUrl(), {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            console.log(`üì• [AABusyRangesAssignments] Respuesta de ${action}:`, result);

            return result;
        } catch (error) {
            console.error(`‚ùå [AABusyRangesAssignments] Error en ${action}:`, error);
            throw error;
        }
    }

    /**
     * Get busy ranges by assignment IDs
     * Returns busy time ranges for specific assignments on a date
     * 
     * @param {Array<number>} assignmentIds - Array of assignment IDs
     * @param {string} date - Date (YYYY-MM-DD)
     * @returns {Promise<Object>} Response with busy_ranges array
     */
    async function getBusyRangesByAssignments(assignmentIds, date) {
        console.log(`üîç [AABusyRangesAssignments] getBusyRangesByAssignments([${assignmentIds.join(', ')}], "${date}") llamado`);
        
        if (!Array.isArray(assignmentIds) || assignmentIds.length === 0) {
            console.warn('‚ö†Ô∏è [AABusyRangesAssignments] assignmentIds debe ser un array no vac√≠o');
            return {
                success: false,
                data: { message: 'assignmentIds debe ser un array no vac√≠o' }
            };
        }

        const result = await ajaxRequest('aa_get_busy_ranges_by_assignments', {
            assignment_ids: assignmentIds,
            date: date
        });
        
        if (result.success) {
            console.log(`‚úÖ [AABusyRangesAssignments] ${result.data.busy_ranges?.length || 0} rangos ocupados encontrados`);
        }
        
        return result;
    }

    // ============================================
    // Expose to global namespace
    // ============================================
    window.AABusyRangesAssignments = {
        getBusyRangesByAssignments: getBusyRangesByAssignments
    };

    console.log('‚úÖ [AABusyRangesAssignments] M√≥dulo cargado y expuesto en window.AABusyRangesAssignments');
    console.log('üìã M√©todos disponibles:');
    console.log('   - AABusyRangesAssignments.getBusyRangesByAssignments(assignmentIds, date)');

})();




========================================
FILE: assets\js\services\availability\combineLocalExternal.js
========================================
/**
 * M√≥dulo de Combinaci√≥n de Disponibilidad Local y Externa
 */

/**
 * Combinar disponibilidad local y externa
 */
function combineLocalExternal(externalAvailability, localAvailability) {
  if (!localAvailability || !localAvailability.local_busy) {
    console.log('‚ÑπÔ∏è No hay datos locales para combinar');
    return;
  }

  console.log("üìä Combinando disponibilidad local con datos externos");
  
  if (!externalAvailability) {
    console.warn('‚ö†Ô∏è No hay disponibilidad externa para combinar');
    return;
  }

  const externalBusy = externalAvailability.busy || [];
  const localBusy = localAvailability.local_busy.map(slot => ({
    start: new Date(slot.start),
    end: new Date(slot.end)
  }));
  
  // ‚úÖ COMBINAR sin duplicar
  externalAvailability.busy = [...externalBusy, ...localBusy];
  
  console.log(`‚úÖ Total combinado: ${externalAvailability.busy.length}`);
  console.log(`   - Google Calendar: ${externalBusy.length}`);
  console.log(`   - Local: ${localBusy.length}`);
}

// ‚úÖ Exponer globalmente
window.CombineLocalExternal = {
  combineLocalExternal
};

console.log('‚úÖ combineLocalExternal.js cargado');


========================================
FILE: assets\js\services\availability\proxyFetch.js
========================================
/**
 * M√≥dulo de Fetch con Reintentos
 */

/**
 * Construir URL de consulta
 */
function buildUrl(config) {
  const { ajaxUrl, action, email } = config;
  return `${ajaxUrl}?action=${encodeURIComponent(action)}&email=${encodeURIComponent(email)}`;
}

/**
 * Estado interno del loop de reintentos
 */
let attempts = 0;
let intervalId = null;
let dataReceived = false;

/**
 * Realizar fetch de disponibilidad (single attempt)
 */
async function fetchAvailability(config, onSuccess, onError) {
  if (dataReceived) return;

  attempts++;
  console.log(`üîÑ Intento #${attempts} de consultar disponibilidad...`);

  const url = buildUrl(config);
  console.log("üì° Consultando disponibilidad:", url);

  try {
    const start = Date.now();
    const response = await fetch(url, { 
      method: 'GET', 
      credentials: 'same-origin' 
    });
    const duration = Date.now() - start;
    
    console.log(`üì• Respuesta recibida (HTTP ${response.status}) en ${duration}ms`);

    const text = await response.text();
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${text}`);
    }

    const data = JSON.parse(text);
    console.log("‚úÖ Datos recibidos:", data);

    // ‚úÖ Procesar y normalizar data.busy (eventos ocupados)
    if (data.busy && Array.isArray(data.busy)) {
      console.log(`üîç Procesando ${data.busy.length} eventos ocupados`);
      
      data.busy = data.busy.map(ev => {
        const start = new Date(ev.start);
        const end = new Date(ev.end);
        
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
          console.warn('‚ö†Ô∏è Evento con fechas inv√°lidas:', ev);
          return null;
        }
        
        return { start, end };
      }).filter(Boolean);
      
      console.log(`‚úÖ ${data.busy.length} eventos v√°lidos procesados`);
    }

    // Guardar en window para compatibilidad
    window.aa_availability = data;
    dataReceived = true;

    // Detener reintentos
    stopFetchLoop();

    // Callback de √©xito
    if (onSuccess) {
      onSuccess(data);
    }

    // Emitir evento de √©xito
    console.log("üîî Disparando evento 'aa:availability:loaded'");
    document.dispatchEvent(new CustomEvent('aa:availability:loaded', { 
      detail: data
    }));

  } catch (err) {
    console.warn(`‚ö†Ô∏è Error en intento #${attempts}:`, err.message);
    
    if (attempts >= config.maxAttempts) {
      console.error("‚ùå M√°ximo de intentos alcanzado");
      stopFetchLoop();
      
      // Callback de error
      if (onError) {
        onError(err);
      }
      
      // Emitir evento de error
      document.dispatchEvent(new CustomEvent('aa:availability:error', { 
        detail: { error: err } 
      }));
    }
  }
}

/**
 * Iniciar loop de reintentos autom√°ticos
 */
function startFetchLoop(config, onSuccess, onError) {
  console.log("üöÄ Iniciando loop de fetch con reintentos");
  
  // Reset estado
  attempts = 0;
  dataReceived = false;
  
  // Primer intento inmediato
  fetchAvailability(config, onSuccess, onError);
  
  // Reintentos peri√≥dicos
  intervalId = setInterval(() => {
    fetchAvailability(config, onSuccess, onError);
  }, config.retryInterval);
}

/**
 * Detener reintentos
 */
function stopFetchLoop() {
  if (intervalId) {
    clearInterval(intervalId);
    intervalId = null;
    console.log("‚èπÔ∏è Loop de fetch detenido");
  }
}

/**
 * Reset estado (√∫til para testing o re-inicializaci√≥n)
 */
function resetFetchState() {
  attempts = 0;
  dataReceived = false;
  stopFetchLoop();
}

// ‚úÖ Exponer globalmente
window.ProxyFetch = {
  buildUrl,
  fetchAvailability,
  startFetchLoop,
  stopFetchLoop,
  resetFetchState
};

console.log('‚úÖ proxyFetch.js cargado');


========================================
FILE: assets\js\services\availability\slotCalculator.js
========================================
/**
 * M√≥dulo de C√°lculo de Slots
 */
(function() {
  'use strict';

  // ‚úÖ Referencias locales (dentro del IIFE, no hay conflicto)
  const { ymd, getWeekdayName, getDayIntervals, generateSlotsForDay } = window.DateUtils;

  /**
   * Calcular slots disponibles para una fecha espec√≠fica
   */
  function calculateSlotsForDate(date, schedule, busyRanges, slotDuration) {
    const weekday = getWeekdayName(date);
    const intervals = getDayIntervals(schedule, weekday);
    const slots = generateSlotsForDay(date, intervals, busyRanges, slotDuration);
    
    return slots;
  }

  /**
   * Calcular slots disponibles para un rango de fechas
   */
  function calculateSlotsRange(minDate, maxDate, schedule, busyRanges, slotDuration) {
    const availableSlotsPerDay = {};
    
    console.log(`üóìÔ∏è Calculando slots disponibles del ${ymd(minDate)} al ${ymd(maxDate)}`);
    console.log(`‚öôÔ∏è Configuraci√≥n: duraci√≥n=${slotDuration}min, eventos ocupados=${busyRanges.length}`);
    
    for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
      const day = new Date(d);
      const slots = calculateSlotsForDate(day, schedule, busyRanges, slotDuration);
      
      availableSlotsPerDay[ymd(day)] = slots;
      
      if (slots.length > 0) {
        console.log(`üìÖ ${ymd(day)}: ${slots.length} slots disponibles`);
      }
    }
    
    console.log(`‚úÖ C√°lculo completado para ${Object.keys(availableSlotsPerDay).length} d√≠as`);
    
    return availableSlotsPerDay;
  }

  // ‚úÖ Exponer globalmente
  window.SlotCalculator = {
    calculateSlotsForDate,
    calculateSlotsRange
  };

  console.log('‚úÖ slotCalculator.js cargado');
})();


========================================
FILE: assets\js\services\availabilityService.js
========================================
/**
 * Servicio Proxy de Disponibilidad
 */
(function() {
  'use strict';

  // ‚úÖ Referencias locales (dentro del IIFE)
  const { startFetchLoop, stopFetchLoop } = window.ProxyFetch;
  const { combineLocalExternal } = window.CombineLocalExternal;
  const { generateBusyRanges, loadLocalBusyRanges } = window.BusyRanges;
  const { calculateSlotsRange } = window.SlotCalculator;

  class AvailabilityProxy {
    constructor(config = {}) {
      this.ajaxUrl = config.ajaxUrl || '/wp-admin/admin-ajax.php';
      this.action = config.action || 'aa_get_availability';
      this.email = config.email || '';
      this.maxAttempts = config.maxAttempts || 20;
      this.retryInterval = config.retryInterval || 15000;
      
      this.availableSlotsPerDay = {};
      this.busyRanges = [];
    }

    calculateAvailableSlots(schedule, futureWindow, slotDuration) {
      const minDate = new Date();
      const maxDate = new Date();
      maxDate.setDate(minDate.getDate() + futureWindow);

      this.availableSlotsPerDay = calculateSlotsRange(
        minDate, 
        maxDate, 
        schedule, 
        this.busyRanges, 
        slotDuration
      );
      
      return this.availableSlotsPerDay;
    }

    isDateAvailable(date) {
      return (this.availableSlotsPerDay[window.DateUtils.ymd(date)]?.length || 0) > 0;
    }

    disableDate(date) {
      return !this.isDateAvailable(date);
    }

    getSlotsForDate(date) {
      const key = window.DateUtils.ymd(date);
      const slots = this.availableSlotsPerDay[key] || [];
      
      console.log(`üîç getSlotsForDate(${key}): ${slots.length} slots disponibles`);
      
      return slots;
    }

    start() {
      console.log("üöÄ Iniciando AvailabilityProxy");
      
      const config = {
        ajaxUrl: this.ajaxUrl,
        action: this.action,
        email: this.email,
        maxAttempts: this.maxAttempts,
        retryInterval: this.retryInterval
      };

      const onSuccess = (data) => {
        combineLocalExternal(window.aa_availability, window.aa_local_availability);
        this.busyRanges = generateBusyRanges(window.aa_availability?.busy || []);

        console.log("üîî Disparando evento 'aa:availability:loaded' con proxy");
        document.dispatchEvent(new CustomEvent('aa:availability:loaded', { 
          detail: {
            ...data,
            busyRanges: this.busyRanges,
            proxy: this
          }
        }));
      };

      const onError = (err) => {
        console.error("‚ùå Error al cargar disponibilidad:", err);
      };

      startFetchLoop(config, onSuccess, onError);
    }

    stop() {
      stopFetchLoop();
    }
  }

  // ‚úÖ Exponer clase globalmente
  window.AvailabilityProxy = AvailabilityProxy;

  // ==============================
  // üîπ Capa de Servicio
  // ==============================
  const AvailabilityService = {

    loadLocal() {
      return loadLocalBusyRanges();
    },

    calculateInitial(busyRanges) {
      const schedule = window.aa_schedule || {};
      const futureWindow = window.aa_future_window || 14;
      const slotDuration = parseInt(window.aa_slot_duration, 10) || 60;

      const minDate = new Date();
      const maxDate = new Date();
      maxDate.setDate(minDate.getDate() + futureWindow);

      const availableSlotsPerDay = calculateSlotsRange(
        minDate,
        maxDate,
        schedule,
        busyRanges,
        slotDuration
      );

      return {
        availableSlotsPerDay,
        schedule,
        futureWindow,
        slotDuration,
        minDate,
        maxDate
      };
    },

    findFirstAvailable(minDate, maxDate, availableSlotsPerDay) {
      for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
        const day = new Date(d);
        const slots = availableSlotsPerDay[window.DateUtils.ymd(day)] || [];
        
        if (slots.length > 0) {
          return day;
        }
      }
      
      return null;
    },

    calculate(proxy, { schedule, futureWindow, slotDuration }) {
      return proxy.calculateAvailableSlots(schedule, futureWindow, slotDuration);
    },

    disable(proxy, date) {
      return proxy.disableDate(date);
    },

    slotsForDate(proxy, date) {
      return proxy.getSlotsForDate(date);
    }
  };

  // ‚úÖ Exponer servicio globalmente
  window.AvailabilityService = AvailabilityService;

  console.log('‚úÖ AvailabilityProxy cargado');
  console.log('‚úÖ AvailabilityService cargado');
})();


========================================
FILE: assets\js\services\confirmService.js
========================================
/**
 * Servicio: Confirmaci√≥n de Citas
 * 
 * Responsable de:
 * - Llamadas AJAX para confirmar citas
 * - Llamadas AJAX para cancelar citas
 * - Llamadas AJAX para crear clientes desde citas
 * 
 * NO contiene l√≥gica de UI ni callbacks.
 */

window.ConfirmService = (function() {
    'use strict';
    
    /**
     * Confirmar una cita
     * @param {number} id - ID de la cita
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function confirmar(id) {
        const formData = new FormData();
        formData.append('action', 'aa_confirmar_cita');
        formData.append('id', id);
        formData.append('_wpnonce', aa_asistant_vars.nonce_confirmar);
        
        return fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json());
    }
    
    /**
     * Cancelar una cita
     * @param {number} id - ID de la cita
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function cancelar(id) {
        const formData = new FormData();
        formData.append('action', 'aa_cancelar_cita');
        formData.append('id', id);
        formData.append('_wpnonce', aa_asistant_vars.nonce_cancelar);
        
        return fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json());
    }
    
    /**
     * Crear cliente desde una cita
     * @param {number} reservaId - ID de la reserva
     * @param {string} nombre - Nombre del cliente
     * @param {string} telefono - Tel√©fono del cliente
     * @param {string} correo - Correo del cliente
     * @returns {Promise<Object>} Respuesta del servidor
     */
    function crearClienteDesdeCita(reservaId, nombre, telefono, correo) {
        const formData = new FormData();
        formData.append('action', 'aa_crear_cliente_desde_cita');
        formData.append('reserva_id', reservaId);
        formData.append('nombre', nombre);
        formData.append('telefono', telefono);
        formData.append('correo', correo);
        formData.append('_wpnonce', aa_asistant_vars.nonce_crear_cliente_desde_cita);
        
        return fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json());
    }
    
    // ===============================
    // üîπ API P√∫blica
    // ===============================
    return {
        confirmar,
        cancelar,
        crearClienteDesdeCita
    };
})();



========================================
FILE: assets\js\services\reservationService.js
========================================
// ==============================
// üîπ Servicio de reservas
// ==============================

/**
 * Guarda una reserva en el backend
 */
async function saveReservation(datos) {
  if (typeof wpaa_vars === 'undefined' || !wpaa_vars.ajax_url) {
    throw new Error('Variables de configuraci√≥n no disponibles (wpaa_vars)');
  }

  console.group('üß© saveReservation: datos que se enviar√°n al backend');
  console.log('Tipo de datos:', typeof datos);
  console.log('Contenido del objeto:', datos);
  console.log('Fecha ISO final enviada:', datos.fecha);
  console.groupEnd();

  // Validar estructura antes del fetch
  ['servicio', 'fecha', 'nombre', 'telefono'].forEach(campo => {
    if (!datos[campo]) {
      console.warn(`‚ö†Ô∏è El campo "${campo}" est√° vac√≠o o indefinido`);
    }
  });

  try {
    const response = await fetch(wpaa_vars.ajax_url + '?action=aa_save_reservation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(datos)
    });

    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }

    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.data?.message || 'Error desconocido al guardar.');
    }

    console.log('‚úÖ Reserva guardada correctamente:', data);

    return data;
  } catch (error) {
    console.error('‚ùå Error al guardar reserva:', error);
    throw error;
  }
}

/**
 * Env√≠a correo de confirmaci√≥n de reserva
 */
async function sendConfirmation(datos) {
  if (typeof wpaa_vars === 'undefined' || !wpaa_vars.ajax_url) {
    throw new Error('Variables de configuraci√≥n no disponibles (wpaa_vars)');
  }

  console.log("üìß sendConfirmation: Enviando correo de confirmaci√≥n...");
  console.log("üì¶ Datos:", datos);

  try {
    const response = await fetch(wpaa_vars.ajax_url + '?action=aa_enviar_confirmacion', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(datos)
    });

    const emailData = await response.json();
    
    console.log('üìß Resultado del env√≠o de correo:', emailData);
    
    return emailData;
  } catch (error) {
    console.warn('‚ö†Ô∏è Error al enviar correo (no cr√≠tico):', error);
    throw error;
  }
}

// ==============================
// üîπ Exponer en window
// ==============================
window.ReservationService = {
  saveReservation,
  sendConfirmation
};

console.log('‚úÖ ReservationService cargado y expuesto globalmente');


========================================
FILE: assets\js\ui\calendarAdminUI.js
========================================
// ==============================
// üîπ UI de Calendario para Admin
// ==============================

console.log('üîÑ Cargando calendarAdminUI.js...');

(function() {
  'use strict';

  /**
   * Renderiza el calendario admin con Flatpickr
   * @param {Object} config - Configuraci√≥n del calendario admin
   */
  function render(config) {
    const {
      fechaInput,
      slotContainerSelector,
      slotsMap,
      minDate,
      maxDate,
      disableDateFn
    } = config;

    console.log('üîÑ CalendarAdminUI.render() llamado con config:', config);
    
    if (!fechaInput) {
      console.error('‚ùå calendarAdminUI: fechaInput no proporcionado');
      return null;
    }

    if (typeof flatpickr === "undefined") {
      console.error('‚ùå calendarAdminUI: Flatpickr no est√° disponible');
      return null;
    }
    
    // Destruir instancia previa si existe
    if (fechaInput._flatpickr) {
      console.log('üóëÔ∏è Destruyendo instancia anterior de Flatpickr (admin)');
      fechaInput._flatpickr.destroy();
    }
    
    // Crear nueva instancia de Flatpickr
    const picker = flatpickr(fechaInput, {
      disableMobile: true,
      dateFormat: "d-m-Y",
      minDate,
      maxDate,
      locale: "es",
      disable: [disableDateFn],
      onChange: function(selectedDates) {
        if (!selectedDates.length) return;
        
        const selectedDate = selectedDates[0];
        
        console.log('üîç DEBUG onChange:', {
          proxyExists: !!window.availabilityProxyInstance,
          proxyHasSlots: window.availabilityProxyInstance ? Object.keys(window.availabilityProxyInstance.availableSlotsPerDay || {}).length : 0,
          selectedDateKey: window.DateUtils.ymd(selectedDate)
        });
        
        const validSlots = window.AvailabilityService.slotsForDate(
          window.availabilityProxyInstance || {}, 
          selectedDate
        );
        
        console.log(`üìÖ Admin: Fecha seleccionada: ${selectedDate.toLocaleDateString()}`);
        console.log(`üìÖ Admin: Slots disponibles: ${validSlots.length}`);
        
        // Disparar evento personalizado para que SlotSelectorAdminUI lo maneje
        document.dispatchEvent(new CustomEvent('aa:admin:date-selected', {
          detail: {
            containerId: slotContainerSelector,
            validSlots,
            selectedDate,
            fechaInput
          }
        }));
      },
      onReady: function() {
        console.log('‚úÖ Flatpickr admin inicializado correctamente');
      }
    });
    
    console.log('‚úÖ Calendario admin renderizado');
    
    return picker;
  }

  /**
   * LEGACY: Mantener compatibilidad con c√≥digo antiguo
   */
  function renderAdminCalendar(fechaInput, slotContainerSelector, proxy, config) {
    console.warn('‚ö†Ô∏è renderAdminCalendar() es legacy, usa render() en su lugar');
    
    return render({
      fechaInput,
      slotContainerSelector,
      slotsMap: proxy.availableSlotsPerDay,
      minDate: config.minDate,
      maxDate: config.maxDate,
      disableDateFn: (date) => window.AvailabilityService.disable(proxy, date)
    });
  }

  // ==============================
  // üîπ Exponer en window
  // ==============================
  window.CalendarAdminUI = {
    render,
    renderAdminCalendar
  };

  console.log('‚úÖ CalendarAdminUI cargado y expuesto globalmente');
})();



========================================
FILE: assets\js\ui\calendarUI.js
========================================
// ==============================
// üîπ Funciones UI de Flatpickr
// ==============================

console.log('üîÑ Cargando calendarUI.js...');

/**
 * Buscar y validar input de fecha
 */
function findDateInput() {
  const fechaInput = document.getElementById("fecha") || document.getElementById("cita-fecha");
  
  console.log('aa_debug: fechaInput =>', !!fechaInput);
  console.log('aa_debug: fechaInput ID =>', fechaInput ? fechaInput.id : 'null');

  if (!fechaInput) {
    console.warn('‚ö†Ô∏è aa_debug: No se encontr√≥ input #fecha ni #cita-fecha');
    return null;
  }

  return fechaInput;
}

/**
 * Leer duraci√≥n de slot desde configuraci√≥n global
 */
function getSlotDuration() {
  const slotDuration = (typeof window.aa_slot_duration !== 'undefined') 
    ? window.aa_slot_duration 
    : 60;
  
  console.log(`‚öôÔ∏è Duraci√≥n de slot configurada: ${slotDuration} minutos`);
  
  return slotDuration;
}

/**
 * Inicializa Flatpickr en modo b√°sico (sin reglas de disponibilidad)
 */
function initBasicCalendar(fechaSelector) {
  console.log('üìÖ initBasicCalendar llamado con selector:', fechaSelector);
  
  if (typeof flatpickr === "undefined" || typeof flatpickr.l10ns === "undefined") {
    console.error('‚ùå Flatpickr no est√° cargado correctamente.');
    return null;
  }

  flatpickr.localize(flatpickr.l10ns.es);
  
  const instance = flatpickr(fechaSelector, {
    disableMobile: true,
    dateFormat: "d-m-Y",
    minDate: "today",
    locale: "es",
    maxDate: new Date().fp_incr(14),
    onReady: function () {
      console.log("üìÖ Flatpickr inicializado correctamente (modo b√°sico).");
    }
  });

  return instance;
}

/**
 * Renderiza el calendario frontend con reglas de disponibilidad
 */
function render(config) {
  const {
    fechaInput,
    minDate,
    maxDate,
    disableDateFn,
    onDateSelected
  } = config;

  console.log('üîÑ CalendarUI.render() llamado con config:', config);

  if (!fechaInput || typeof flatpickr === "undefined") {
    console.error('‚ùå No se puede renderizar el calendario: input o Flatpickr no disponibles');
    return null;
  }

  if (fechaInput._flatpickr) {
    console.log('üóëÔ∏è Destruyendo instancia anterior de Flatpickr');
    fechaInput._flatpickr.destroy();
  }

  const picker = flatpickr(fechaInput, {
    disableMobile: true,
    dateFormat: "d-m-Y",
    minDate: minDate,
    maxDate: maxDate,
    locale: "es",
    disable: [disableDateFn],
    onChange: function(selectedDates) {
      if (!selectedDates.length) return;
      
      const selectedDate = selectedDates[0];
      
      if (onDateSelected && typeof onDateSelected === 'function') {
        onDateSelected(selectedDate, this);
      }
    }
  });

  console.log('‚úÖ Flatpickr frontend renderizado con reglas de disponibilidad');

  return picker;
}

/**
 * Reconstruye el calendario con reglas de disponibilidad (LEGACY)
 */
function rebuildCalendar(options) {
  console.warn('‚ö†Ô∏è rebuildCalendar() es legacy, usa render() en su lugar');
  return render(options);
}

// ==============================
// üîπ Exponer en window
// ==============================
window.CalendarUI = {
  findDateInput,
  getSlotDuration,
  initBasicCalendar,
  rebuildCalendar,
  render
};

console.log('‚úÖ CalendarUI cargado y expuesto globalmente');
console.log('   - window.CalendarUI:', window.CalendarUI);
console.log('   - Funciones disponibles:', Object.keys(window.CalendarUI));


========================================
FILE: assets\js\ui\slotSelectorAdminUI.js
========================================
// ==============================
// üîπ UI de Selector de Slots para Admin
// ==============================

console.log('üîÑ Cargando slotSelectorAdminUI.js...');

(function() {
  'use strict';

  /**
   * Renderiza los slots disponibles en un select para admin
   * @param {string} containerId - ID del contenedor
   * @param {Array<Date>} validSlots - Array de fechas disponibles
   * @param {Date} selectedDate - Fecha seleccionada
   * @param {HTMLElement} fechaInput - Input donde se escribe la fecha+hora final
   */
  function renderAdminSlots(containerId, validSlots, selectedDate, fechaInput) {
    const container = document.getElementById(containerId);
    
    if (!container) {
      console.warn(`‚ö†Ô∏è slotSelectorAdminUI: No se encontr√≥ contenedor #${containerId}`);
      return;
    }
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    // Caso: No hay slots disponibles
    if (!validSlots || validSlots.length === 0) {
      container.textContent = 'No hay horarios disponibles para esta fecha.';
      console.log('‚ÑπÔ∏è slotSelectorAdminUI: Sin slots disponibles');
      return;
    }
    
    console.log(`üìã slotSelectorAdminUI: Renderizando ${validSlots.length} slots`);
    
    // Crear select
    const select = document.createElement('select');
    select.id = 'slot-selector-admin';
    select.className = 'slot-selector-admin';
    select.style.width = '100%';
    select.style.padding = '8px';
    select.style.marginTop = '10px';
    select.style.fontSize = '14px';
    select.style.border = '1px solid #ddd';
    select.style.borderRadius = '4px';
    
    // Agregar opciones
    validSlots.forEach((slotDate, index) => {
      const option = document.createElement('option');
      option.value = slotDate.toISOString();
      option.textContent = slotDate.toLocaleTimeString('es-MX', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      select.appendChild(option);
      
      if (index === 0) {
        option.selected = true;
      }
    });
    
    // Evento de cambio
    select.addEventListener('change', () => {
      const chosenSlot = new Date(select.value);
      const formattedDate = selectedDate.toLocaleDateString('es-MX', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      const formattedTime = chosenSlot.toLocaleTimeString('es-MX', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      fechaInput.value = `${formattedDate} ${formattedTime}`;
      
      console.log(`üïí Slot seleccionado: ${fechaInput.value}`);
    });
    
    // Agregar al contenedor
    container.appendChild(select);
    
    // ‚úÖ NO setear valor inicial autom√°ticamente
    // El valor solo debe cambiar cuando el usuario seleccione expl√≠citamente
    console.log(`‚úÖ Select renderizado con ${validSlots.length} opciones`);
  }

  /**
   * Inicializar escucha de eventos de selecci√≥n de fecha
   */
  function initEventListeners() {
    document.addEventListener('aa:admin:date-selected', (event) => {
      console.log('üì® slotSelectorAdminUI: Evento aa:admin:date-selected recibido');
      const { containerId, validSlots, selectedDate, fechaInput } = event.detail;
      renderAdminSlots(containerId, validSlots, selectedDate, fechaInput);
    });
    
    console.log('üëÇ slotSelectorAdminUI: Escuchando eventos aa:admin:date-selected');
  }

  // ‚úÖ IMPORTANTE: Inicializar INMEDIATAMENTE (no esperar DOMContentLoaded)
  // porque availabilityController.js dispara eventos durante DOMContentLoaded
  initEventListeners();

  // ==============================
  // üîπ Exponer en window
  // ==============================
  window.SlotSelectorAdminUI = {
    renderAdminSlots
  };

  console.log('‚úÖ SlotSelectorAdminUI cargado y expuesto globalmente');
})();



========================================
FILE: assets\js\ui\slotSelectorUI.js
========================================
// ==============================
// üîπ Funciones UI de selector de slots
// ==============================

/**
 * Renderiza selector de slots para frontend
 */
function render(containerId, validSlots, onSelectSlot) {
  const container = document.getElementById(containerId);
  
  if (!container) {
    console.warn(`‚ö†Ô∏è SlotSelectorUI: No se encontr√≥ contenedor #${containerId}`);
    return;
  }
  
  container.innerHTML = ''; // limpiar

  if (!validSlots.length) {
    container.textContent = 'No hay horarios disponibles para este d√≠a.';
    return;
  }

  const label = document.createElement('label');
  label.textContent = 'Horarios disponibles:';
  label.style.display = 'block';
  label.style.marginTop = '8px';

  const select = document.createElement('select');
  select.id = 'slot-selector';
  select.style.marginTop = '4px';
  select.style.width = '100%';
  select.style.padding = '4px';

  validSlots.forEach(date => {
    const option = document.createElement('option');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    option.value = date.toISOString();
    option.textContent = `${hours}:${minutes}`;
    select.appendChild(option);
  });

  select.addEventListener('change', () => {
    const chosen = new Date(select.value);
    onSelectSlot(chosen);
  });

  container.appendChild(label);
  container.appendChild(select);
}

/**
 * LEGACY: Mantener compatibilidad
 */
function renderAvailableSlots(containerId, validSlots, onSelectSlot) {
  console.warn('‚ö†Ô∏è renderAvailableSlots() es legacy, usa render() en su lugar');
  return render(containerId, validSlots, onSelectSlot);
}

// ==============================
// üîπ Exponer en window
// ==============================
window.SlotSelectorUI = {
  render,
  renderAvailableSlots
};

console.log('‚úÖ SlotSelectorUI cargado y expuesto globalmente');


========================================
FILE: assets\js\ui-adapters\calendarDefaultAdapter.js
========================================
/**
 * CalendarDefaultAdapter - Adaptador de calendario nativo para WPAgenda
 * 
 * Calendario HTML puro sin dependencias externas.
 * Compatible con WPAgenda.registerCalendarAdapter().
 */

(function(global) {
    'use strict';

    const { ymd } = global.DateUtils || {};

    /**
     * Crea una instancia del adaptador de calendario.
     * @returns {Object} Adaptador con m√©todos render, setDate, getSelectedDate, destroy.
     */
    function create() {
        let container = null;
        let selectedDate = null;
        let viewDate = new Date();
        let config = {};

        const DAYS_ES = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        const MONTHS_ES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        /**
         * Verifica si una fecha est√° deshabilitada.
         */
        function isDateDisabled(date) {
            if (config.minDate && date < new Date(config.minDate.setHours(0,0,0,0))) return true;
            if (config.maxDate && date > new Date(config.maxDate.setHours(23,59,59,999))) return true;
            if (config.disableDateFn && typeof config.disableDateFn === 'function') {
                return config.disableDateFn(date);
            }
            return false;
        }

        /**
         * Genera el HTML del encabezado con navegaci√≥n.
         */
        function renderHeader() {
            return `
                <div class="aa-calendar-header">
                    <span class="aa-calendar-nav aa-calendar-prev">&lt;</span>
                    <span class="aa-calendar-title">${MONTHS_ES[viewDate.getMonth()]} ${viewDate.getFullYear()}</span>
                    <span class="aa-calendar-nav aa-calendar-next">&gt;</span>
                </div>
            `;
        }

        /**
         * Genera el HTML del grid de d√≠as.
         */
        function renderDays() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = ymd ? ymd(new Date()) : '';

            let html = '<div class="aa-calendar-weekdays">';
            DAYS_ES.forEach(d => html += `<span>${d}</span>`);
            html += '</div><div class="aa-calendar-grid">';

            // Espacios vac√≠os antes del primer d√≠a
            for (let i = 0; i < firstDay; i++) {
                html += '<span class="aa-day aa-day--empty"></span>';
            }

            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = ymd ? ymd(date) : '';
                const isSelected = selectedDate && ymd && ymd(selectedDate) === dateStr;
                const isToday = dateStr === today;
                const isDisabled = isDateDisabled(date);

                let classes = 'aa-day';
                if (isSelected) classes += ' aa-day--selected';
                if (isToday) classes += ' aa-day--today';
                if (isDisabled) classes += ' aa-day--disabled';

                html += `<span class="${classes}" data-date="${dateStr}">${day}</span>`;
            }

            html += '</div>';
            return html;
        }

        /**
         * Maneja el click en un d√≠a.
         */
        function handleDayClick(e) {
            const target = e.target;
            if (!target.classList.contains('aa-day') || target.classList.contains('aa-day--disabled')) return;

            const dateStr = target.dataset.date;
            if (!dateStr) return;

            const [year, month, day] = dateStr.split('-').map(Number);
            selectedDate = new Date(year, month - 1, day);

            renderCalendar();

            if (config.onDateSelected && typeof config.onDateSelected === 'function') {
                config.onDateSelected(selectedDate);
            }
        }

        /**
         * Navega al mes anterior.
         */
        function prevMonth() {
            viewDate.setMonth(viewDate.getMonth() - 1);
            renderCalendar();
        }

        /**
         * Navega al mes siguiente.
         */
        function nextMonth() {
            viewDate.setMonth(viewDate.getMonth() + 1);
            renderCalendar();
        }

        /**
         * Renderiza el calendario completo.
         */
        function renderCalendar() {
            if (!container) return;
            container.innerHTML = `
                <div class="aa-calendar">
                    ${renderHeader()}
                    ${renderDays()}
                </div>
            `;

            container.querySelector('.aa-calendar-prev')?.addEventListener('click', prevMonth);
            container.querySelector('.aa-calendar-next')?.addEventListener('click', nextMonth);
            container.querySelector('.aa-calendar-grid')?.addEventListener('click', handleDayClick);
        }

        // =====================================================================
        // API P√∫blica del Adaptador
        // =====================================================================

        return {
            /**
             * Renderiza el calendario en el contenedor especificado.
             * @param {Object} cfg - Configuraci√≥n: { container, minDate, maxDate, disableDateFn, onDateSelected }
             */
            render(cfg) {
                config = cfg || {};
                container = cfg.container instanceof HTMLElement 
                    ? cfg.container 
                    : document.querySelector(cfg.container);

                if (!container) {
                    console.error('[CalendarDefaultAdapter] Contenedor no encontrado');
                    return;
                }

                viewDate = config.minDate ? new Date(config.minDate) : new Date();
                renderCalendar();
            },

            /**
             * Establece la fecha seleccionada.
             * @param {Date} date - Fecha a seleccionar.
             * @param {boolean} triggerChange - Si true, dispara onDateSelected.
             */
            setDate(date, triggerChange = false) {
                if (!(date instanceof Date)) return;
                selectedDate = date;
                viewDate = new Date(date);
                renderCalendar();

                if (triggerChange && config.onDateSelected) {
                    config.onDateSelected(selectedDate);
                }
            },

            /**
             * Obtiene la fecha seleccionada actualmente.
             * @returns {Date|null}
             */
            getSelectedDate() {
                return selectedDate;
            },

            /**
             * Destruye el calendario y limpia el DOM.
             */
            destroy() {
                if (container) {
                    container.innerHTML = '';
                    container = null;
                }
                selectedDate = null;
                config = {};
            }
        };
    }

    // =========================================================================
    // Exportar globalmente
    // =========================================================================

    global.calendarDefaultAdapter = { create };

    console.log('‚úÖ calendarDefaultAdapter.js cargado');

})(window);



========================================
FILE: assets\js\ui-adapters\datePickerAdapter.js
========================================
/**
 * DatePicker Adapter - Flatpickr wrapper
 * 
 * Responsable de:
 * - Inicializar y configurar Flatpickr
 * - Emitir fechas en formato YYYY-MM-DD
 * - M√©todos de navegaci√≥n (nextDay, prevDay)
 * - Callback onDateChange para notificar cambios
 * 
 * NO contiene l√≥gica de negocio ni llamadas AJAX.
 */

window.DatePickerAdapter = (function() {
    'use strict';
    
    let flatpickrInstance = null;
    let onDateChangeCallback = null;
    
    /**
     * Inicializar el date picker
     * @param {string} inputId - ID del input HTML
     * @param {Function} onDateChange - Callback cuando cambia la fecha (recibe YYYY-MM-DD)
     * @param {string} initialDate - Fecha inicial en formato YYYY-MM-DD (opcional)
     */
    function init(inputId, onDateChange, initialDate) {
        const input = document.getElementById(inputId);
        if (!input) {
            console.error('‚ùå DatePickerAdapter: No se encontr√≥ el input con ID:', inputId);
            return;
        }
        
        // Verificar que Flatpickr est√© disponible
        if (typeof flatpickr === 'undefined') {
            console.error('‚ùå DatePickerAdapter: Flatpickr no est√° disponible');
            return;
        }
        
        onDateChangeCallback = onDateChange;
        
        // Configurar Flatpickr
        const options = {
            dateFormat: 'Y-m-d',
            locale: 'es',
            allowInput: false,
            clickOpens: true,
            onChange: function(selectedDates, dateStr) {
                if (onDateChangeCallback && dateStr) {
                    onDateChangeCallback(dateStr);
                }
            }
        };
        
        flatpickrInstance = flatpickr(input, options);
        
        // Establecer fecha inicial si se proporciona
        if (initialDate) {
            setDate(initialDate);
        }
        
        console.log('‚úÖ DatePickerAdapter inicializado');
    }
    
    /**
     * Establecer fecha program√°ticamente
     * @param {string} date - Fecha en formato YYYY-MM-DD
     */
    function setDate(date) {
        if (!flatpickrInstance) {
            console.error('‚ùå DatePickerAdapter: No inicializado');
            return;
        }
        
        if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
            console.error('‚ùå DatePickerAdapter: Formato de fecha inv√°lido:', date);
            return;
        }
        
        flatpickrInstance.setDate(date, false); // false = no disparar onChange
    }
    
    /**
     * Obtener fecha actual seleccionada
     * @returns {string|null} - Fecha en formato YYYY-MM-DD o null
     */
    function getDate() {
        if (!flatpickrInstance) {
            return null;
        }
        
        const selectedDates = flatpickrInstance.selectedDates;
        if (selectedDates.length === 0) {
            return null;
        }
        
        const date = selectedDates[0];
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    /**
     * Avanzar un d√≠a
     */
    function nextDay() {
        const currentDate = getDate();
        if (!currentDate) return;
        
        const date = new Date(currentDate + 'T00:00:00');
        date.setDate(date.getDate() + 1);
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const nextDate = `${year}-${month}-${day}`;
        
        setDate(nextDate);
        // Disparar onChange manualmente
        if (onDateChangeCallback) {
            onDateChangeCallback(nextDate);
        }
    }
    
    /**
     * Retroceder un d√≠a
     */
    function prevDay() {
        const currentDate = getDate();
        if (!currentDate) return;
        
        const date = new Date(currentDate + 'T00:00:00');
        date.setDate(date.getDate() - 1);
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const prevDate = `${year}-${month}-${day}`;
        
        setDate(prevDate);
        // Disparar onChange manualmente
        if (onDateChangeCallback) {
            onDateChangeCallback(prevDate);
        }
    }
    
    // API p√∫blica
    return {
        init: init,
        setDate: setDate,
        getDate: getDate,
        nextDay: nextDay,
        prevDay: prevDay
    };
})();




========================================
FILE: assets\js\ui-adapters\modalDefaultAdapter.js
========================================
/**
 * ModalDefaultAdapter - Adaptador de modal nativo para WPAgenda
 * 
 * Modal HTML puro para confirmaci√≥n de reservas.
 * Compatible con WPAgenda.registerModalAdapter().
 */

(function(global) {
    'use strict';

    /**
     * Crea una instancia del adaptador de modal.
     * @returns {Object} Adaptador con m√©todos open, close, setLoading.
     */
    function create() {
        let overlayEl = null;
        let modalEl = null;
        let submitBtn = null;
        let onSubmitCallback = null;
        const originalBtnText = 'Confirmar';

        /**
         * Genera el HTML del modal.
         * @param {Object} options - { servicio, fecha, hora }
         * @returns {string}
         */
        function buildModalHTML(options) {
            const { servicio, fecha, hora } = options;

            return `
                <div class="aa-modal-overlay"></div>
                <div class="aa-modal">
                    <button type="button" class="aa-modal-close">&times;</button>
                    <h3 class="aa-modal-title">Confirmar reserva</h3>

                    <div class="aa-modal-summary">
                        <p><strong>Servicio:</strong> ${servicio || 'No especificado'}</p>
                        <p><strong>Fecha:</strong> ${fecha || ''}</p>
                        <p><strong>Hora:</strong> ${hora || ''}</p>
                    </div>

                    <form class="aa-modal-form">
                        <label for="aa-nombre">Nombre</label>
                        <input type="text" id="aa-nombre" class="aa-input" required>

                        <label for="aa-telefono">Tel√©fono</label>
                        <input type="tel" id="aa-telefono" class="aa-input" required>

                        <label for="aa-correo">Correo</label>
                        <input type="email" id="aa-correo" class="aa-input" required>

                        <button type="submit" class="aa-btn">${originalBtnText}</button>
                    </form>
                </div>
            `;
        }

        /**
         * Maneja el env√≠o del formulario.
         * @param {Event} e
         */
        function handleSubmit(e) {
            e.preventDefault();

            const nombre = modalEl.querySelector('#aa-nombre').value.trim();
            const telefono = modalEl.querySelector('#aa-telefono').value.trim();
            const correo = modalEl.querySelector('#aa-correo').value.trim();

            // Validaci√≥n simple
            if (!nombre || !telefono || !correo) {
                console.warn('[ModalDefaultAdapter] Todos los campos son obligatorios');
                return;
            }

            if (onSubmitCallback && typeof onSubmitCallback === 'function') {
                onSubmitCallback({ nombre, telefono, correo });
            }
        }

        /**
         * Remueve el modal del DOM.
         */
        function removeFromDOM() {
            if (overlayEl && overlayEl.parentNode) {
                overlayEl.parentNode.removeChild(overlayEl);
            }
            if (modalEl && modalEl.parentNode) {
                modalEl.parentNode.removeChild(modalEl);
            }
            overlayEl = null;
            modalEl = null;
            submitBtn = null;
            onSubmitCallback = null;
        }

        // =====================================================================
        // API P√∫blica del Adaptador
        // =====================================================================

        return {
            /**
             * Abre el modal con la informaci√≥n de la reserva.
             * @param {Object} options - { servicio, fecha, hora, onSubmit }
             */
            open(options) {
                // Cerrar modal previo si existe
                this.close();

                const { onSubmit } = options || {};
                onSubmitCallback = onSubmit;

                // Crear contenedor temporal para parsear HTML
                const wrapper = document.createElement('div');
                wrapper.innerHTML = buildModalHTML(options);

                overlayEl = wrapper.querySelector('.aa-modal-overlay');
                modalEl = wrapper.querySelector('.aa-modal');
                submitBtn = modalEl.querySelector('.aa-btn');

                // Insertar en el DOM
                document.body.appendChild(overlayEl);
                document.body.appendChild(modalEl);

                // Event listeners
                overlayEl.addEventListener('click', () => this.close());
                modalEl.querySelector('.aa-modal-close')?.addEventListener('click', () => this.close());
                modalEl.querySelector('.aa-modal-form')?.addEventListener('submit', handleSubmit);
            },

            /**
             * Cierra el modal y limpia el DOM.
             */
            close() {
                removeFromDOM();
            },

            /**
             * Establece el estado de carga del bot√≥n submit.
             * @param {boolean} isLoading
             */
            setLoading(isLoading) {
                if (!submitBtn) return;

                if (isLoading) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Procesando‚Ä¶';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            }
        };
    }

    // =========================================================================
    // Exportar globalmente
    // =========================================================================

    global.modalDefaultAdapter = { create };

    console.log('‚úÖ modalDefaultAdapter.js cargado');

})(window);



========================================
FILE: assets\js\ui-adapters\slotsDefaultAdapter.js
========================================
/**
 * SlotsDefaultAdapter - Adaptador de slots nativo para WPAgenda
 * 
 * Renderiza lista de horarios disponibles en HTML puro.
 * Compatible con WPAgenda.registerSlotsAdapter().
 */

(function(global) {
    'use strict';

    /**
     * Crea una instancia del adaptador de slots.
     * @returns {Object} Adaptador con m√©todos render, getSelectedSlot, clear.
     */
    function create() {
        let container = null;
        let selectedSlot = null;
        let onSelectCallback = null;

        /**
         * Formatea un Date a string HH:MM.
         * @param {Date} date
         * @returns {string}
         */
        function formatTime(date) {
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        }

        /**
         * Compara dos fechas por valor de tiempo.
         * @param {Date} a
         * @param {Date} b
         * @returns {boolean}
         */
        function isSameSlot(a, b) {
            if (!a || !b) return false;
            return a.getTime() === b.getTime();
        }

        /**
         * Maneja el click en un slot.
         * @param {Event} e
         * @param {Date[]} slots
         */
        function handleSlotClick(e, slots) {
            let target = e.target;
            
            // Si se hizo click en el span, subir al li
            if (target.tagName === 'SPAN' && target.parentElement.classList.contains('aa-slot')) {
                target = target.parentElement;
            }
            
            if (!target.classList.contains('aa-slot') || target.classList.contains('aa-slot--disabled')) return;

            const index = parseInt(target.dataset.index, 10);
            if (isNaN(index) || !slots[index]) return;

            selectedSlot = slots[index];

            // Actualizar clases visuales
            container.querySelectorAll('.aa-slot').forEach(el => {
                el.classList.remove('aa-slot--selected');
            });
            target.classList.add('aa-slot--selected');

            if (onSelectCallback && typeof onSelectCallback === 'function') {
                onSelectCallback(selectedSlot);
            }
        }

        /**
         * Renderiza el HTML de los slots.
         * @param {Date[]} slots
         */
        function renderSlots(slots) {
            if (!container) return;

            if (!slots || slots.length === 0) {
                container.innerHTML = '<p class="aa-slots-empty">No hay horarios disponibles</p>';
                return;
            }

            let html = '<ul class="aa-slots">';

            slots.forEach((slot, index) => {
                const isSelected = isSameSlot(slot, selectedSlot);
                let classes = 'aa-slot';
                if (isSelected) classes += ' aa-slot--selected';

                html += `<li class="${classes}" data-index="${index}"><span>${formatTime(slot)}</span></li>`;
            });

            html += '</ul>';
            container.innerHTML = html;

            container.querySelector('.aa-slots')?.addEventListener('click', (e) => handleSlotClick(e, slots));
        }

        // =====================================================================
        // API P√∫blica del Adaptador
        // =====================================================================

        return {
            /**
             * Renderiza los slots en el contenedor especificado.
             * @param {string|HTMLElement} containerId - Selector o elemento contenedor.
             * @param {Date[]} validSlots - Array de fechas con horarios v√°lidos.
             * @param {Function} onSelectSlot - Callback al seleccionar un slot.
             */
            render(containerId, validSlots, onSelectSlot) {
                container = containerId instanceof HTMLElement
                    ? containerId
                    : document.querySelector(containerId);

                if (!container) {
                    console.error('[SlotsDefaultAdapter] Contenedor no encontrado');
                    return;
                }

                onSelectCallback = onSelectSlot;
                selectedSlot = null;
                renderSlots(validSlots);
            },

            /**
             * Obtiene el slot seleccionado actualmente.
             * @returns {Date|null}
             */
            getSelectedSlot() {
                return selectedSlot;
            },

            /**
             * Limpia el contenedor y reinicia el estado.
             */
            clear() {
                if (container) {
                    container.innerHTML = '';
                }
                selectedSlot = null;
                onSelectCallback = null;
            }
        };
    }

    // =========================================================================
    // Exportar globalmente
    // =========================================================================

    global.slotsDefaultAdapter = { create };

    console.log('‚úÖ slotsDefaultAdapter.js cargado');

})(window);



========================================
FILE: assets\js\ui-adapters\WPAgenda.js
========================================
/**
 * WPAgenda - API P√∫blica del Plugin
 * 
 * Este archivo define √∫nicamente la estructura p√∫blica del namespace WPAgenda.
 * No contiene l√≥gica de UI ni l√≥gica de negocio.
 * 
 * Los adaptadores (calendar, slots, modal) ser√°n registrados externamente
 * por versiones default o premium del plugin.
 */

(function(global) {
    'use strict';

    // =========================================================================
    // Sistema interno de eventos
    // =========================================================================

    /**
     * Tabla interna de listeners para el sistema de eventos.
     * Estructura: { eventName: [callback1, callback2, ...] }
     * @private
     */
    const _eventListeners = {};

    /**
     * Registra un listener para un evento espec√≠fico.
     * 
     * @param {string} eventName - Nombre del evento a escuchar.
     * @param {Function} callback - Funci√≥n a ejecutar cuando se emita el evento.
     * @returns {void}
     * 
     * @example
     * WPAgenda.on('dateSelected', function(data) {
     *     console.log('Fecha seleccionada:', data);
     * });
     */
    function on(eventName, callback) {
        if (typeof eventName !== 'string' || !eventName.trim()) {
            console.warn('[WPAgenda] on: eventName debe ser un string v√°lido.');
            return;
        }

        if (typeof callback !== 'function') {
            console.warn('[WPAgenda] on: callback debe ser una funci√≥n.');
            return;
        }

        if (!_eventListeners[eventName]) {
            _eventListeners[eventName] = [];
        }

        _eventListeners[eventName].push(callback);
    }

    /**
     * Emite un evento, ejecutando todos los listeners registrados.
     * 
     * @param {string} eventName - Nombre del evento a emitir.
     * @param {*} [data] - Datos opcionales a pasar a los listeners.
     * @returns {void}
     * 
     * @example
     * WPAgenda.emit('dateSelected', { date: '2025-12-04' });
     */
    function emit(eventName, data) {
        if (typeof eventName !== 'string' || !eventName.trim()) {
            console.warn('[WPAgenda] emit: eventName debe ser un string v√°lido.');
            return;
        }

        const listeners = _eventListeners[eventName];

        if (!listeners || listeners.length === 0) {
            return;
        }

        listeners.forEach(function(callback) {
            try {
                callback(data);
            } catch (error) {
                console.error('[WPAgenda] Error en listener de "' + eventName + '":', error);
            }
        });
    }

    // =========================================================================
    // Contenedor de adaptadores UI
    // =========================================================================

    /**
     * Objeto que contiene los adaptadores de UI registrados.
     * Los valores ser√°n asignados mediante los m√©todos register*.
     * 
     * @property {Object|null} calendar - Adaptador para el calendario.
     * @property {Object|null} slots - Adaptador para los slots de horarios.
     * @property {Object|null} modal - Adaptador para el modal de confirmaci√≥n.
     */
    const ui = {
        calendar: null,
        slots: null,
        modal: null
    };

    // =========================================================================
    // M√©todos de registro de adaptadores
    // =========================================================================

    /**
     * Valida que un adaptador tenga la estructura m√≠nima esperada.
     * 
     * @private
     * @param {*} adapter - Adaptador a validar.
     * @param {string} adapterName - Nombre del adaptador (para mensajes de error).
     * @returns {boolean} - True si el adaptador es v√°lido.
     */
    function _validateAdapter(adapter, adapterName) {
        if (!adapter || typeof adapter !== 'object') {
            console.error('[WPAgenda] ' + adapterName + ': el adaptador debe ser un objeto v√°lido.');
            return false;
        }

        return true;
    }

    /**
     * Registra un adaptador para el componente Calendar.
     * 
     * @param {Object} adapter - Objeto adaptador que implementa la interfaz de calendario.
     * @returns {boolean} - True si el registro fue exitoso.
     * 
     * @example
     * WPAgenda.registerCalendarAdapter({
     *     render: function(container, options) { ... },
     *     destroy: function() { ... }
     * });
     */
    function registerCalendarAdapter(adapter) {
        if (!_validateAdapter(adapter, 'registerCalendarAdapter')) {
            return false;
        }

        ui.calendar = adapter;
        return true;
    }

    /**
     * Registra un adaptador para el componente Slots (horarios disponibles).
     * 
     * @param {Object} adapter - Objeto adaptador que implementa la interfaz de slots.
     * @returns {boolean} - True si el registro fue exitoso.
     * 
     * @example
     * WPAgenda.registerSlotsAdapter({
     *     render: function(container, slots) { ... },
     *     destroy: function() { ... }
     * });
     */
    function registerSlotsAdapter(adapter) {
        if (!_validateAdapter(adapter, 'registerSlotsAdapter')) {
            return false;
        }

        ui.slots = adapter;
        return true;
    }

    /**
     * Registra un adaptador para el componente Modal.
     * 
     * @param {Object} adapter - Objeto adaptador que implementa la interfaz de modal.
     * @returns {boolean} - True si el registro fue exitoso.
     * 
     * @example
     * WPAgenda.registerModalAdapter({
     *     open: function(options) { ... },
     *     close: function() { ... }
     * });
     */
    function registerModalAdapter(adapter) {
        if (!_validateAdapter(adapter, 'registerModalAdapter')) {
            return false;
        }

        ui.modal = adapter;
        return true;
    }

    // =========================================================================
    // Namespace global WPAgenda
    // =========================================================================

    /**
     * Namespace global del plugin WPAgenda.
     * 
     * @namespace WPAgenda
     * @property {Object} ui - Contenedor de adaptadores de UI (calendar, slots, modal).
     * @property {Function} registerCalendarAdapter - Registra un adaptador de calendario.
     * @property {Function} registerSlotsAdapter - Registra un adaptador de slots.
     * @property {Function} registerModalAdapter - Registra un adaptador de modal.
     * @property {Function} on - Registra un listener para un evento.
     * @property {Function} emit - Emite un evento con datos opcionales.
     */
    global.WPAgenda = {
        ui: ui,
        registerCalendarAdapter: registerCalendarAdapter,
        registerSlotsAdapter: registerSlotsAdapter,
        registerModalAdapter: registerModalAdapter,
        on: on,
        emit: emit
    };

})(window);



========================================
FILE: assets\js\utils\dateUtils.js
========================================
// ==============================
// üîπ Utilidades de manejo de fechas
// ==============================

// üîπ Convertir Date a YYYY-MM-DD en zona horaria LOCAL
const ymd = d => {
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// üîπ Convertir Date a HH:MM en zona horaria LOCAL
const hm = (d) => {
  const hh = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  return `${hh}:${mm}`;
};

// Devuelve el nombre del d√≠a en ingl√©s en min√∫sculas
function getWeekdayName(date) {
  const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const dayIndex = date.getDay();
  console.log(`üóìÔ∏è ${date.toDateString()} -> d√≠a ${dayIndex} (${days[dayIndex]})`);
  return days[dayIndex];
}

// Convierte "HH:MM" a minutos desde medianoche
function timeStrToMinutes(str) {
  const [h, m] = str.split(':').map(Number);
  return h * 60 + m;
}

// Convierte Date a minutos desde medianoche
function minutesFromDate(d) {
  return d.getHours() * 60 + d.getMinutes();
}

// Obtiene intervalos de un d√≠a (convertidos a minutos)
function getDayIntervals(aa_schedule, weekday) {
  if (!aa_schedule || !aa_schedule[weekday]) return [];

  const day = aa_schedule[weekday];

  // üîí enabled legacy-safe
  if (day.enabled === '0' || day.enabled === 0) return [];

  let intervals = day.intervals;

  // üî• NORMALIZACI√ìN CR√çTICA
  if (!Array.isArray(intervals)) {
    intervals = Object.values(intervals || {});
  }

  return intervals.map(iv => ({
    start: timeStrToMinutes(iv.start),
    end: timeStrToMinutes(iv.end)
  }));
}

// ==============================
// üîπ Calcular l√≠mites de fecha (minDate/maxDate)
// ==============================
function computeLimits(futureWindow) {
  const minDate = new Date();
  const maxDate = new Date();
  maxDate.setDate(minDate.getDate() + futureWindow);
  return { minDate, maxDate };
}

// ==============================
// üîπ Verificar si un slot tiene suficiente espacio libre
// ==============================
function hasEnoughFreeTime(slotStart, durationMinutes, busyRanges) {
  const slotEnd = new Date(slotStart.getTime() + durationMinutes * 60000);
  
  for (const busy of busyRanges) {
    const overlaps = slotStart < busy.end && slotEnd > busy.start;
    
    if (overlaps) {
      console.log(`‚ùå Slot ${slotStart.toLocaleTimeString()}-${slotEnd.toLocaleTimeString()} rechazado: intersecta con evento ${busy.start.toLocaleTimeString()}-${busy.end.toLocaleTimeString()}`);
      return false;
    }
  }
  
  return true;
}

// ‚úÖ Verifica si un slot est√° ocupado (compatibilidad)
function isSlotBusy(slotDate, busyRanges) {
  return busyRanges.some(range => {
    return slotDate >= range.start && slotDate < range.end;
  });
}

// ‚úÖ Normaliza un intervalo a una grilla fija de slots
// Redondea el inicio hacia arriba y el fin hacia abajo al m√∫ltiplo m√°s cercano de slotDuration
function normalizeIntervalToSlotGrid(startMin, endMin, slotDuration) {
  const normalizedStart = Math.ceil(startMin / slotDuration) * slotDuration;
  const normalizedEnd = Math.floor((endMin - slotDuration) / slotDuration) * slotDuration;

  if (normalizedStart > normalizedEnd) {
    return null;
  }

  return {
    start: normalizedStart,
    end: normalizedEnd
  };
}

// ‚úÖ Genera slots desde hora de inicio y duraci√≥n
// Genera slots de 30 minutos a partir de una hora de inicio y duraci√≥n total
// @param {string} startTime - Hora de inicio en formato "HH:MM" o "HH:MM:SS"
// @param {number} durationMinutes - Duraci√≥n total en minutos
// @param {number} slotDuration - Duraci√≥n de cada slot en minutos (default: 30)
// @returns {Array<string>} Array de slots en formato "HH:MM"
function generateSlotsFromStartTime(startTime, durationMinutes, slotDuration = 30) {
  if (!startTime || !durationMinutes || durationMinutes <= 0) {
    return [];
  }
  
  // Convertir hora de inicio a minutos desde medianoche
  const startMinutes = timeStrToMinutes(startTime);
  
  // Calcular hora de fin
  const endMinutes = startMinutes + durationMinutes;
  
  // Generar slots cada slotDuration minutos
  const slots = [];
  for (let min = startMinutes; min < endMinutes; min += slotDuration) {
    const hours = Math.floor(min / 60);
    const minutes = min % 60;
    slots.push(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`);
  }
  
  return slots;
}

// ‚úÖ Genera slots disponibles para un d√≠a con duraci√≥n configurable
function generateSlotsForDay(date, intervals, busyRanges, slotDuration = 30) {
  const slots = [];
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();
  
  const minAvailableTime = new Date(now.getTime() + 60 * 60 * 1000); // +1 hora
  
  console.log(`üïí Generando slots para ${ymd(date)} con duraci√≥n de ${slotDuration} min`);
  
  intervals.forEach(iv => {
    for (let min = iv.start; min < iv.end; min += 30) {
      const slot = new Date(date);
      slot.setHours(Math.floor(min / 60), min % 60, 0, 0);
      
      if (isToday && slot < minAvailableTime) {
        continue;
      }
      
      if (hasEnoughFreeTime(slot, slotDuration, busyRanges)) {
        slots.push(slot);
      }
    }
  });
  
  console.log(`‚úÖ ${slots.length} slots v√°lidos generados para ${ymd(date)}`);
  
  return slots;
}

// ‚úÖ Exponer globalmente
window.DateUtils = {
  ymd,
  hm,
  getWeekdayName,
  timeStrToMinutes,
  minutesFromDate,
  getDayIntervals,
  computeLimits,
  isSlotBusy,
  hasEnoughFreeTime,
  normalizeIntervalToSlotGrid,
  generateSlotsFromStartTime,
  generateSlotsForDay
};

console.log('‚úÖ dateUtils.js cargado y exportado');


========================================
FILE: includes\admin\iframe-test.php
========================================
<?php
/**
 * Admin UI Gateway - Container for iframe-based admin interface
 * 
 * This file acts as a gateway that:
 * 1. Registers the admin menu page
 * 2. Renders the iframe container
 * 3. Handles admin-post requests and delegates to the UI layer
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');


// ================================
// Render iframe container
// ================================
function aa_render_iframe_test_page() {
    $iframe_url = admin_url('admin-post.php?action=aa_iframe_content');
    ?>
    <div class="wrap">
        <iframe 
            id="aa-isolated-iframe"
            src="<?php echo esc_url($iframe_url); ?>"
            style="width: 100%; height: 800px; border: none;"
        ></iframe>
    </div>
    <?php
}

// ================================
// Handler: Delegate to UI layer
// ================================
add_action('admin_post_aa_iframe_content', 'aa_handle_iframe_content');

function aa_handle_iframe_content() {
    // Permission check
    if (!current_user_can('manage_options')) {
        wp_die('Acceso denegado', 'Error', ['response' => 403]);
    }
    
    // Delegate to UI entry point (module parameter is handled inside ui/index.php)
    $ui_path = plugin_dir_path(__FILE__) . 'ui/index.php';

    if (file_exists($ui_path)) {
        require_once $ui_path;
    } else {
        wp_die('UI no encontrada', 'Error', ['response' => 404]);
    }
}



========================================
FILE: includes\admin\ui\assets\css\admin.css
========================================
*, ::before, ::after {
  --tw-border-spacing-x: 0;
  --tw-border-spacing-y: 0;
  --tw-translate-x: 0;
  --tw-translate-y: 0;
  --tw-rotate: 0;
  --tw-skew-x: 0;
  --tw-skew-y: 0;
  --tw-scale-x: 1;
  --tw-scale-y: 1;
  --tw-pan-x:  ;
  --tw-pan-y:  ;
  --tw-pinch-zoom:  ;
  --tw-scroll-snap-strictness: proximity;
  --tw-gradient-from-position:  ;
  --tw-gradient-via-position:  ;
  --tw-gradient-to-position:  ;
  --tw-ordinal:  ;
  --tw-slashed-zero:  ;
  --tw-numeric-figure:  ;
  --tw-numeric-spacing:  ;
  --tw-numeric-fraction:  ;
  --tw-ring-inset:  ;
  --tw-ring-offset-width: 0px;
  --tw-ring-offset-color: #fff;
  --tw-ring-color: rgb(59 130 246 / 0.5);
  --tw-ring-offset-shadow: 0 0 #0000;
  --tw-ring-shadow: 0 0 #0000;
  --tw-shadow: 0 0 #0000;
  --tw-shadow-colored: 0 0 #0000;
  --tw-blur:  ;
  --tw-brightness:  ;
  --tw-contrast:  ;
  --tw-grayscale:  ;
  --tw-hue-rotate:  ;
  --tw-invert:  ;
  --tw-saturate:  ;
  --tw-sepia:  ;
  --tw-drop-shadow:  ;
  --tw-backdrop-blur:  ;
  --tw-backdrop-brightness:  ;
  --tw-backdrop-contrast:  ;
  --tw-backdrop-grayscale:  ;
  --tw-backdrop-hue-rotate:  ;
  --tw-backdrop-invert:  ;
  --tw-backdrop-opacity:  ;
  --tw-backdrop-saturate:  ;
  --tw-backdrop-sepia:  ;
  --tw-contain-size:  ;
  --tw-contain-layout:  ;
  --tw-contain-paint:  ;
  --tw-contain-style:  ;
}

::backdrop {
  --tw-border-spacing-x: 0;
  --tw-border-spacing-y: 0;
  --tw-translate-x: 0;
  --tw-translate-y: 0;
  --tw-rotate: 0;
  --tw-skew-x: 0;
  --tw-skew-y: 0;
  --tw-scale-x: 1;
  --tw-scale-y: 1;
  --tw-pan-x:  ;
  --tw-pan-y:  ;
  --tw-pinch-zoom:  ;
  --tw-scroll-snap-strictness: proximity;
  --tw-gradient-from-position:  ;
  --tw-gradient-via-position:  ;
  --tw-gradient-to-position:  ;
  --tw-ordinal:  ;
  --tw-slashed-zero:  ;
  --tw-numeric-figure:  ;
  --tw-numeric-spacing:  ;
  --tw-numeric-fraction:  ;
  --tw-ring-inset:  ;
  --tw-ring-offset-width: 0px;
  --tw-ring-offset-color: #fff;
  --tw-ring-color: rgb(59 130 246 / 0.5);
  --tw-ring-offset-shadow: 0 0 #0000;
  --tw-ring-shadow: 0 0 #0000;
  --tw-shadow: 0 0 #0000;
  --tw-shadow-colored: 0 0 #0000;
  --tw-blur:  ;
  --tw-brightness:  ;
  --tw-contrast:  ;
  --tw-grayscale:  ;
  --tw-hue-rotate:  ;
  --tw-invert:  ;
  --tw-saturate:  ;
  --tw-sepia:  ;
  --tw-drop-shadow:  ;
  --tw-backdrop-blur:  ;
  --tw-backdrop-brightness:  ;
  --tw-backdrop-contrast:  ;
  --tw-backdrop-grayscale:  ;
  --tw-backdrop-hue-rotate:  ;
  --tw-backdrop-invert:  ;
  --tw-backdrop-opacity:  ;
  --tw-backdrop-saturate:  ;
  --tw-backdrop-sepia:  ;
  --tw-contain-size:  ;
  --tw-contain-layout:  ;
  --tw-contain-paint:  ;
  --tw-contain-style:  ;
}

/*
! tailwindcss v3.4.19 | MIT License | https://tailwindcss.com
*/

/*
1. Prevent padding and border from affecting element width. (https://github.com/mozdevs/cssremedy/issues/4)
2. Allow adding a border to an element by just adding a border-width. (https://github.com/tailwindcss/tailwindcss/pull/116)
*/

*,
::before,
::after {
  box-sizing: border-box;
  /* 1 */
  border-width: 0;
  /* 2 */
  border-style: solid;
  /* 2 */
  border-color: #e5e7eb;
  /* 2 */
}

::before,
::after {
  --tw-content: '';
}

/*
1. Use a consistent sensible line-height in all browsers.
2. Prevent adjustments of font size after orientation changes in iOS.
3. Use a more readable tab size.
4. Use the user's configured `sans` font-family by default.
5. Use the user's configured `sans` font-feature-settings by default.
6. Use the user's configured `sans` font-variation-settings by default.
7. Disable tap highlights on iOS
*/

html,
:host {
  line-height: 1.5;
  /* 1 */
  -webkit-text-size-adjust: 100%;
  /* 2 */
  -moz-tab-size: 4;
  /* 3 */
  -o-tab-size: 4;
     tab-size: 4;
  /* 3 */
  font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  /* 4 */
  font-feature-settings: normal;
  /* 5 */
  font-variation-settings: normal;
  /* 6 */
  -webkit-tap-highlight-color: transparent;
  /* 7 */
}

/*
1. Remove the margin in all browsers.
2. Inherit line-height from `html` so users can set them as a class directly on the `html` element.
*/

body {
  margin: 0;
  /* 1 */
  line-height: inherit;
  /* 2 */
}

/*
1. Add the correct height in Firefox.
2. Correct the inheritance of border color in Firefox. (https://bugzilla.mozilla.org/show_bug.cgi?id=190655)
3. Ensure horizontal rules are visible by default.
*/

hr {
  height: 0;
  /* 1 */
  color: inherit;
  /* 2 */
  border-top-width: 1px;
  /* 3 */
}

/*
Add the correct text decoration in Chrome, Edge, and Safari.
*/

abbr:where([title]) {
  -webkit-text-decoration: underline dotted;
          text-decoration: underline dotted;
}

/*
Remove the default font size and weight for headings.
*/

h1,
h2,
h3,
h4,
h5,
h6 {
  font-size: inherit;
  font-weight: inherit;
}

/*
Reset links to optimize for opt-in styling instead of opt-out.
*/

a {
  color: inherit;
  text-decoration: inherit;
}

/*
Add the correct font weight in Edge and Safari.
*/

b,
strong {
  font-weight: bolder;
}

/*
1. Use the user's configured `mono` font-family by default.
2. Use the user's configured `mono` font-feature-settings by default.
3. Use the user's configured `mono` font-variation-settings by default.
4. Correct the odd `em` font sizing in all browsers.
*/

code,
kbd,
samp,
pre {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  /* 1 */
  font-feature-settings: normal;
  /* 2 */
  font-variation-settings: normal;
  /* 3 */
  font-size: 1em;
  /* 4 */
}

/*
Add the correct font size in all browsers.
*/

small {
  font-size: 80%;
}

/*
Prevent `sub` and `sup` elements from affecting the line height in all browsers.
*/

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sub {
  bottom: -0.25em;
}

sup {
  top: -0.5em;
}

/*
1. Remove text indentation from table contents in Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=999088, https://bugs.webkit.org/show_bug.cgi?id=201297)
2. Correct table border color inheritance in all Chrome and Safari. (https://bugs.chromium.org/p/chromium/issues/detail?id=935729, https://bugs.webkit.org/show_bug.cgi?id=195016)
3. Remove gaps between table borders by default.
*/

table {
  text-indent: 0;
  /* 1 */
  border-color: inherit;
  /* 2 */
  border-collapse: collapse;
  /* 3 */
}

/*
1. Change the font styles in all browsers.
2. Remove the margin in Firefox and Safari.
3. Remove default padding in all browsers.
*/

button,
input,
optgroup,
select,
textarea {
  font-family: inherit;
  /* 1 */
  font-feature-settings: inherit;
  /* 1 */
  font-variation-settings: inherit;
  /* 1 */
  font-size: 100%;
  /* 1 */
  font-weight: inherit;
  /* 1 */
  line-height: inherit;
  /* 1 */
  letter-spacing: inherit;
  /* 1 */
  color: inherit;
  /* 1 */
  margin: 0;
  /* 2 */
  padding: 0;
  /* 3 */
}

/*
Remove the inheritance of text transform in Edge and Firefox.
*/

button,
select {
  text-transform: none;
}

/*
1. Correct the inability to style clickable types in iOS and Safari.
2. Remove default button styles.
*/

button,
input:where([type='button']),
input:where([type='reset']),
input:where([type='submit']) {
  -webkit-appearance: button;
  /* 1 */
  background-color: transparent;
  /* 2 */
  background-image: none;
  /* 2 */
}

/*
Use the modern Firefox focus style for all focusable elements.
*/

:-moz-focusring {
  outline: auto;
}

/*
Remove the additional `:invalid` styles in Firefox. (https://github.com/mozilla/gecko-dev/blob/2f9eacd9d3d995c937b4251a5557d95d494c9be1/layout/style/res/forms.css#L728-L737)
*/

:-moz-ui-invalid {
  box-shadow: none;
}

/*
Add the correct vertical alignment in Chrome and Firefox.
*/

progress {
  vertical-align: baseline;
}

/*
Correct the cursor style of increment and decrement buttons in Safari.
*/

::-webkit-inner-spin-button,
::-webkit-outer-spin-button {
  height: auto;
}

/*
1. Correct the odd appearance in Chrome and Safari.
2. Correct the outline style in Safari.
*/

[type='search'] {
  -webkit-appearance: textfield;
  /* 1 */
  outline-offset: -2px;
  /* 2 */
}

/*
Remove the inner padding in Chrome and Safari on macOS.
*/

::-webkit-search-decoration {
  -webkit-appearance: none;
}

/*
1. Correct the inability to style clickable types in iOS and Safari.
2. Change font properties to `inherit` in Safari.
*/

::-webkit-file-upload-button {
  -webkit-appearance: button;
  /* 1 */
  font: inherit;
  /* 2 */
}

/*
Add the correct display in Chrome and Safari.
*/

summary {
  display: list-item;
}

/*
Removes the default spacing and border for appropriate elements.
*/

blockquote,
dl,
dd,
h1,
h2,
h3,
h4,
h5,
h6,
hr,
figure,
p,
pre {
  margin: 0;
}

fieldset {
  margin: 0;
  padding: 0;
}

legend {
  padding: 0;
}

ol,
ul,
menu {
  list-style: none;
  margin: 0;
  padding: 0;
}

/*
Reset default styling for dialogs.
*/

dialog {
  padding: 0;
}

/*
Prevent resizing textareas horizontally by default.
*/

textarea {
  resize: vertical;
}

/*
1. Reset the default placeholder opacity in Firefox. (https://github.com/tailwindlabs/tailwindcss/issues/3300)
2. Set the default placeholder color to the user's configured gray 400 color.
*/

input::-moz-placeholder, textarea::-moz-placeholder {
  opacity: 1;
  /* 1 */
  color: #9ca3af;
  /* 2 */
}

input::placeholder,
textarea::placeholder {
  opacity: 1;
  /* 1 */
  color: #9ca3af;
  /* 2 */
}

/*
Set the default cursor for buttons.
*/

button,
[role="button"] {
  cursor: pointer;
}

/*
Make sure disabled buttons don't get the pointer cursor.
*/

:disabled {
  cursor: default;
}

/*
1. Make replaced elements `display: block` by default. (https://github.com/mozdevs/cssremedy/issues/14)
2. Add `vertical-align: middle` to align replaced elements more sensibly by default. (https://github.com/jensimmons/cssremedy/issues/14#issuecomment-634934210)
   This can trigger a poorly considered lint error in some tools but is included by design.
*/

img,
svg,
video,
canvas,
audio,
iframe,
embed,
object {
  display: block;
  /* 1 */
  vertical-align: middle;
  /* 2 */
}

/*
Constrain images and videos to the parent width and preserve their intrinsic aspect ratio. (https://github.com/mozdevs/cssremedy/issues/14)
*/

img,
video {
  max-width: 100%;
  height: auto;
}

/* Make elements with the HTML hidden attribute stay hidden by default */

[hidden]:where(:not([hidden="until-found"])) {
  display: none;
}

.\!container {
  width: 100% !important;
}

.container {
  width: 100%;
}

@media (min-width: 640px) {
  .\!container {
    max-width: 640px !important;
  }

  .container {
    max-width: 640px;
  }
}

@media (min-width: 768px) {
  .\!container {
    max-width: 768px !important;
  }

  .container {
    max-width: 768px;
  }
}

@media (min-width: 1024px) {
  .\!container {
    max-width: 1024px !important;
  }

  .container {
    max-width: 1024px;
  }
}

@media (min-width: 1280px) {
  .\!container {
    max-width: 1280px !important;
  }

  .container {
    max-width: 1280px;
  }
}

@media (min-width: 1536px) {
  .\!container {
    max-width: 1536px !important;
  }

  .container {
    max-width: 1536px;
  }
}

/* Accordion styles */

/* Hide default summary marker */

details summary::-webkit-details-marker {
  display: none;
}

details summary::marker {
  display: none;
}

/* Rotate chevron when open */

details[open] summary .aa-chevron {
  transform: rotate(180deg);
}

/* Smooth transition for content */

details > div {
  transition: opacity 0.2s ease-in-out;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CARD SYSTEM - Collapsible cards with overlay
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Card container - relative for overlay positioning */

[data-aa-card] {
  position: relative;
  margin-bottom: 0.5rem;
  border-radius: 0.5rem;
  border-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(229 231 235 / var(--tw-border-opacity, 1));
  --tw-bg-opacity: 1;
  background-color: rgb(255 255 255 / var(--tw-bg-opacity, 1));
}

/* Card header - clickable toggle */

[data-aa-card-toggle] {
  cursor: pointer;
  -webkit-user-select: none;
     -moz-user-select: none;
          user-select: none;
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
  font-weight: 500;
  --tw-text-opacity: 1;
  color: rgb(17 24 39 / var(--tw-text-opacity, 1));
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

[data-aa-card-toggle]:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(249 250 251 / var(--tw-bg-opacity, 1));
}

[data-aa-card-toggle] {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Chevron indicator for card toggle */

[data-aa-card-toggle]::after {
  content: '';
  height: 0.5rem;
  width: 0.5rem;
  border-right-width: 2px;
  border-bottom-width: 2px;
  --tw-border-opacity: 1;
  border-color: rgb(156 163 175 / var(--tw-border-opacity, 1));
  --tw-rotate: 45deg;
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
  transition-property: transform;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 200ms;
}

[data-aa-card].is-open [data-aa-card-toggle]::after {
  --tw-rotate: -135deg;
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

/* Overlay - hidden by default, positioned absolutely */

.aa-modal-root.aa-card-overlay {
  display: none;
}

.aa-card-overlay {
  position: absolute;
  left: 0px;
  right: 0px;
  top: 100%;
  z-index: 50;
  display: none;
  border-bottom-right-radius: 0.5rem;
  border-bottom-left-radius: 0.5rem;
  border-width: 1px;
  border-top-width: 0px;
  --tw-border-opacity: 1;
  border-color: rgb(229 231 235 / var(--tw-border-opacity, 1));
  --tw-bg-opacity: 1;
  background-color: rgb(255 255 255 / var(--tw-bg-opacity, 1));
  --tw-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

/* Show overlay when card is open */

[data-aa-card].is-open .aa-card-overlay {
  display: block;
}

/* Card body inside overlay */

.aa-card-body {
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  --tw-text-opacity: 1;
  color: rgb(75 85 99 / var(--tw-text-opacity, 1));
}

.aa-card-body > div {
  padding-top: 0.25rem;
  padding-bottom: 0.25rem;
}

/* Grid container for cards - allow overflow for overlays */

.aa-clients-grid {
  position: relative;
  overflow: visible !important;
}

/* Action bar for clients module */

.aa-clients-action-bar {
  margin-bottom: 1rem;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.75rem;
}

.aa-clients-search-input {
  min-width: 200px;
  flex: 1 1 0%;
  padding-left: 0.75rem;
  padding-right: 0.75rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  border-radius: 0.5rem;
  border-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(209 213 219 / var(--tw-border-opacity, 1));
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.aa-clients-search-input:focus {
  --tw-border-opacity: 1;
  border-color: rgb(59 130 246 / var(--tw-border-opacity, 1));
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(59 130 246 / var(--tw-ring-opacity, 1));
}

.aa-clients-new-button {
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  font-weight: 500;
  --tw-bg-opacity: 1;
  background-color: rgb(37 99 235 / var(--tw-bg-opacity, 1));
  --tw-text-opacity: 1;
  color: rgb(255 255 255 / var(--tw-text-opacity, 1));
}

.aa-clients-new-button:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(29 78 216 / var(--tw-bg-opacity, 1));
}

.aa-clients-new-button {
  border-radius: 0.5rem;
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.aa-clients-pagination {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.aa-clients-pagination-button {
  display: flex;
  height: 2rem;
  width: 2rem;
  align-items: center;
  justify-content: center;
  border-radius: 0.25rem;
  --tw-text-opacity: 1;
  color: rgb(75 85 99 / var(--tw-text-opacity, 1));
}

.aa-clients-pagination-button:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(243 244 246 / var(--tw-bg-opacity, 1));
}

.aa-clients-pagination-button:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.aa-clients-pagination-button:hover:disabled {
  background-color: transparent;
}

/* Edit button inside client cards */

.aa-btn-editar-cliente {
  margin-top: 0.75rem;
  padding-left: 0.75rem;
  padding-right: 0.75rem;
  padding-top: 0.375rem;
  padding-bottom: 0.375rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  --tw-text-opacity: 1;
  color: rgb(37 99 235 / var(--tw-text-opacity, 1));
}

.aa-btn-editar-cliente:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(239 246 255 / var(--tw-bg-opacity, 1));
  --tw-text-opacity: 1;
  color: rgb(29 78 216 / var(--tw-text-opacity, 1));
}

.aa-btn-editar-cliente {
  border-radius: 0.375rem;
  border-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(191 219 254 / var(--tw-border-opacity, 1));
  cursor: pointer;
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.aa-btn-editar-cliente svg {
  height: 1rem;
  width: 1rem;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODAL SYSTEM - Basic functional styles
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Modal root - fullscreen overlay container */

.aa-modal-root {
  position: fixed;
  inset: 0px;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.aa-modal-root.hidden {
  display: none;
}

/* Overlay backdrop */

.aa-modal-overlay {
  position: absolute;
  inset: 0px;
  background-color: rgb(0 0 0 / 0.5);
}

/* Modal container */

.aa-modal {
  position: relative;
  margin-left: 1rem;
  margin-right: 1rem;
  max-height: 90vh;
  width: 100%;
  max-width: 28rem;
  overflow: auto;
  border-radius: 0.5rem;
  --tw-bg-opacity: 1;
  background-color: rgb(255 255 255 / var(--tw-bg-opacity, 1));
  --tw-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

/* Modal header */

.aa-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(229 231 235 / var(--tw-border-opacity, 1));
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.aa-modal-title {
  margin: 0px;
  font-size: 1.125rem;
  line-height: 1.75rem;
  font-weight: 600;
  --tw-text-opacity: 1;
  color: rgb(17 24 39 / var(--tw-text-opacity, 1));
}

.aa-modal-close {
  border-radius: 0.25rem;
  padding: 0.25rem;
  --tw-text-opacity: 1;
  color: rgb(156 163 175 / var(--tw-text-opacity, 1));
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.aa-modal-close:hover {
  --tw-text-opacity: 1;
  color: rgb(75 85 99 / var(--tw-text-opacity, 1));
}

/* Modal body */

.aa-modal-body {
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 1rem;
  padding-bottom: 1rem;
}

/* Modal footer */

.aa-modal-footer {
  border-top-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(229 231 235 / var(--tw-border-opacity, 1));
  --tw-bg-opacity: 1;
  background-color: rgb(249 250 251 / var(--tw-bg-opacity, 1));
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.aa-modal-root.aa-modal-footer:empty {
  display: none;
}

.aa-modal-footer:empty {
  display: none;
}

/* Block body scroll when modal is open */

body.aa-modal-open {
  overflow: hidden;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       FORM STYLES - Basic form elements for modals
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

.aa-form-group {
  margin-bottom: 1rem;
}

.aa-form-group label {
  margin-bottom: 0.25rem;
  display: block;
  font-size: 0.875rem;
  line-height: 1.25rem;
  font-weight: 500;
  --tw-text-opacity: 1;
  color: rgb(55 65 81 / var(--tw-text-opacity, 1));
}

.aa-form-group input {
  width: 100%;
  border-radius: 0.375rem;
  border-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(209 213 219 / var(--tw-border-opacity, 1));
  padding-left: 0.75rem;
  padding-right: 0.75rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.aa-form-group input:focus {
  --tw-border-opacity: 1;
  border-color: rgb(59 130 246 / var(--tw-border-opacity, 1));
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(59 130 246 / var(--tw-ring-opacity, 1));
}

.aa-modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.aa-btn-cancelar {
  border-radius: 0.375rem;
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  --tw-text-opacity: 1;
  color: rgb(75 85 99 / var(--tw-text-opacity, 1));
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.aa-btn-cancelar:hover {
  --tw-text-opacity: 1;
  color: rgb(31 41 55 / var(--tw-text-opacity, 1));
}

.aa-btn-guardar {
  border-radius: 0.375rem;
  --tw-bg-opacity: 1;
  background-color: rgb(37 99 235 / var(--tw-bg-opacity, 1));
  padding-left: 1rem;
  padding-right: 1rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  --tw-text-opacity: 1;
  color: rgb(255 255 255 / var(--tw-text-opacity, 1));
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.aa-btn-guardar:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(29 78 216 / var(--tw-bg-opacity, 1));
}

.aa-btn-guardar:disabled {
  cursor: not-allowed;
  --tw-bg-opacity: 1;
  background-color: rgb(96 165 250 / var(--tw-bg-opacity, 1));
}

/* Form status messages */

.aa-form-status {
  margin-top: 0.5rem;
  border-radius: 0.25rem;
  padding: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.aa-form-error {
  border-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(254 202 202 / var(--tw-border-opacity, 1));
  --tw-bg-opacity: 1;
  background-color: rgb(254 242 242 / var(--tw-bg-opacity, 1));
  --tw-text-opacity: 1;
  color: rgb(185 28 28 / var(--tw-text-opacity, 1));
}

.aa-form-success {
  border-width: 1px;
  --tw-border-opacity: 1;
  border-color: rgb(187 247 208 / var(--tw-border-opacity, 1));
  --tw-bg-opacity: 1;
  background-color: rgb(240 253 244 / var(--tw-bg-opacity, 1));
  --tw-text-opacity: 1;
  color: rgb(21 128 61 / var(--tw-text-opacity, 1));
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.pointer-events-none {
  pointer-events: none;
}

.visible {
  visibility: visible;
}

.absolute {
  position: absolute;
}

.relative {
  position: relative;
}

.left-0 {
  left: 0px;
}

.left-0\.5 {
  left: 0.125rem;
}

.left-3 {
  left: 0.75rem;
}

.right-0 {
  right: 0px;
}

.right-2 {
  right: 0.5rem;
}

.top-0 {
  top: 0px;
}

.top-0\.5 {
  top: 0.125rem;
}

.top-1\/2 {
  top: 50%;
}

.top-full {
  top: 100%;
}

.z-10 {
  z-index: 10;
}

.z-50 {
  z-index: 50;
}

.-mx-4 {
  margin-left: -1rem;
  margin-right: -1rem;
}

.mx-auto {
  margin-left: auto;
  margin-right: auto;
}

.mb-1 {
  margin-bottom: 0.25rem;
}

.mb-2 {
  margin-bottom: 0.5rem;
}

.mb-3 {
  margin-bottom: 0.75rem;
}

.mb-4 {
  margin-bottom: 1rem;
}

.mb-6 {
  margin-bottom: 1.5rem;
}

.ml-2 {
  margin-left: 0.5rem;
}

.ml-auto {
  margin-left: auto;
}

.mr-1 {
  margin-right: 0.25rem;
}

.mt-0\.5 {
  margin-top: 0.125rem;
}

.mt-1 {
  margin-top: 0.25rem;
}

.mt-1\.5 {
  margin-top: 0.375rem;
}

.mt-2 {
  margin-top: 0.5rem;
}

.mt-3 {
  margin-top: 0.75rem;
}

.mt-4 {
  margin-top: 1rem;
}

.mt-6 {
  margin-top: 1.5rem;
}

.block {
  display: block;
}

.inline-block {
  display: inline-block;
}

.flex {
  display: flex;
}

.inline-flex {
  display: inline-flex;
}

.table {
  display: table;
}

.\!grid {
  display: grid !important;
}

.grid {
  display: grid;
}

.hidden {
  display: none;
}

.h-10 {
  height: 2.5rem;
}

.h-16 {
  height: 4rem;
}

.h-4 {
  height: 1rem;
}

.h-5 {
  height: 1.25rem;
}

.h-6 {
  height: 1.5rem;
}

.h-7 {
  height: 1.75rem;
}

.h-8 {
  height: 2rem;
}

.h-9 {
  height: 2.25rem;
}

.min-h-screen {
  min-height: 100vh;
}

.w-10 {
  width: 2.5rem;
}

.w-11 {
  width: 2.75rem;
}

.w-16 {
  width: 4rem;
}

.w-4 {
  width: 1rem;
}

.w-5 {
  width: 1.25rem;
}

.w-6 {
  width: 1.5rem;
}

.w-7 {
  width: 1.75rem;
}

.w-8 {
  width: 2rem;
}

.w-80 {
  width: 20rem;
}

.w-9 {
  width: 2.25rem;
}

.w-\[7rem\] {
  width: 7rem;
}

.w-full {
  width: 100%;
}

.min-w-0 {
  min-width: 0px;
}

.min-w-\[60px\] {
  min-width: 60px;
}

.max-w-5xl {
  max-width: 64rem;
}

.max-w-7xl {
  max-width: 80rem;
}

.max-w-sm {
  max-width: 24rem;
}

.flex-1 {
  flex: 1 1 0%;
}

.flex-shrink-0 {
  flex-shrink: 0;
}

.-translate-y-1\/2 {
  --tw-translate-y: -50%;
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.rotate-180 {
  --tw-rotate: 180deg;
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.transform {
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.cursor-pointer {
  cursor: pointer;
}

.select-none {
  -webkit-user-select: none;
     -moz-user-select: none;
          user-select: none;
}

.resize-none {
  resize: none;
}

.resize {
  resize: both;
}

.list-none {
  list-style-type: none;
}

.grid-cols-2 {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.flex-col {
  flex-direction: column;
}

.flex-wrap {
  flex-wrap: wrap;
}

.items-start {
  align-items: flex-start;
}

.items-center {
  align-items: center;
}

.justify-end {
  justify-content: flex-end;
}

.justify-center {
  justify-content: center;
}

.justify-between {
  justify-content: space-between;
}

.gap-0 {
  gap: 0px;
}

.gap-1 {
  gap: 0.25rem;
}

.gap-1\.5 {
  gap: 0.375rem;
}

.gap-2 {
  gap: 0.5rem;
}

.gap-3 {
  gap: 0.75rem;
}

.gap-4 {
  gap: 1rem;
}

.gap-6 {
  gap: 1.5rem;
}

.space-y-1 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(0.25rem * var(--tw-space-y-reverse));
}

.space-y-2 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(0.5rem * var(--tw-space-y-reverse));
}

.space-y-3 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(0.75rem * var(--tw-space-y-reverse));
}

.space-y-4 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(1rem * var(--tw-space-y-reverse));
}

.space-y-5 > :not([hidden]) ~ :not([hidden]) {
  --tw-space-y-reverse: 0;
  margin-top: calc(1.25rem * calc(1 - var(--tw-space-y-reverse)));
  margin-bottom: calc(1.25rem * var(--tw-space-y-reverse));
}

.overflow-hidden {
  overflow: hidden;
}

.truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.whitespace-nowrap {
  white-space: nowrap;
}

.rounded {
  border-radius: 0.25rem;
}

.rounded-full {
  border-radius: 9999px;
}

.rounded-lg {
  border-radius: 0.5rem;
}

.rounded-xl {
  border-radius: 0.75rem;
}

.rounded-b-lg {
  border-bottom-right-radius: 0.5rem;
  border-bottom-left-radius: 0.5rem;
}

.border {
  border-width: 1px;
}

.border-b {
  border-bottom-width: 1px;
}

.border-t {
  border-top-width: 1px;
}

.border-amber-200 {
  --tw-border-opacity: 1;
  border-color: rgb(253 230 138 / var(--tw-border-opacity, 1));
}

.border-blue-200 {
  --tw-border-opacity: 1;
  border-color: rgb(191 219 254 / var(--tw-border-opacity, 1));
}

.border-emerald-200 {
  --tw-border-opacity: 1;
  border-color: rgb(167 243 208 / var(--tw-border-opacity, 1));
}

.border-gray-100 {
  --tw-border-opacity: 1;
  border-color: rgb(243 244 246 / var(--tw-border-opacity, 1));
}

.border-gray-200 {
  --tw-border-opacity: 1;
  border-color: rgb(229 231 235 / var(--tw-border-opacity, 1));
}

.border-gray-300 {
  --tw-border-opacity: 1;
  border-color: rgb(209 213 219 / var(--tw-border-opacity, 1));
}

.border-red-200 {
  --tw-border-opacity: 1;
  border-color: rgb(254 202 202 / var(--tw-border-opacity, 1));
}

.bg-amber-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(254 243 199 / var(--tw-bg-opacity, 1));
}

.bg-amber-50 {
  --tw-bg-opacity: 1;
  background-color: rgb(255 251 235 / var(--tw-bg-opacity, 1));
}

.bg-amber-600 {
  --tw-bg-opacity: 1;
  background-color: rgb(217 119 6 / var(--tw-bg-opacity, 1));
}

.bg-blue-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(219 234 254 / var(--tw-bg-opacity, 1));
}

.bg-blue-50 {
  --tw-bg-opacity: 1;
  background-color: rgb(239 246 255 / var(--tw-bg-opacity, 1));
}

.bg-blue-50\/40 {
  background-color: rgb(239 246 255 / 0.4);
}

.bg-blue-600 {
  --tw-bg-opacity: 1;
  background-color: rgb(37 99 235 / var(--tw-bg-opacity, 1));
}

.bg-emerald-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(209 250 229 / var(--tw-bg-opacity, 1));
}

.bg-emerald-50 {
  --tw-bg-opacity: 1;
  background-color: rgb(236 253 245 / var(--tw-bg-opacity, 1));
}

.bg-gray-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(243 244 246 / var(--tw-bg-opacity, 1));
}

.bg-gray-300 {
  --tw-bg-opacity: 1;
  background-color: rgb(209 213 219 / var(--tw-bg-opacity, 1));
}

.bg-gray-50 {
  --tw-bg-opacity: 1;
  background-color: rgb(249 250 251 / var(--tw-bg-opacity, 1));
}

.bg-gray-50\/50 {
  background-color: rgb(249 250 251 / 0.5);
}

.bg-green-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(220 252 231 / var(--tw-bg-opacity, 1));
}

.bg-indigo-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(224 231 255 / var(--tw-bg-opacity, 1));
}

.bg-indigo-600 {
  --tw-bg-opacity: 1;
  background-color: rgb(79 70 229 / var(--tw-bg-opacity, 1));
}

.bg-purple-100 {
  --tw-bg-opacity: 1;
  background-color: rgb(243 232 255 / var(--tw-bg-opacity, 1));
}

.bg-red-50 {
  --tw-bg-opacity: 1;
  background-color: rgb(254 242 242 / var(--tw-bg-opacity, 1));
}

.bg-white {
  --tw-bg-opacity: 1;
  background-color: rgb(255 255 255 / var(--tw-bg-opacity, 1));
}

.bg-gradient-to-r {
  background-image: linear-gradient(to right, var(--tw-gradient-stops));
}

.from-gray-50 {
  --tw-gradient-from: #f9fafb var(--tw-gradient-from-position);
  --tw-gradient-to: rgb(249 250 251 / 0) var(--tw-gradient-to-position);
  --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
}

.to-white {
  --tw-gradient-to: #fff var(--tw-gradient-to-position);
}

.p-2 {
  padding: 0.5rem;
}

.p-3 {
  padding: 0.75rem;
}

.p-4 {
  padding: 1rem;
}

.p-6 {
  padding: 1.5rem;
}

.px-2 {
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}

.px-3 {
  padding-left: 0.75rem;
  padding-right: 0.75rem;
}

.px-4 {
  padding-left: 1rem;
  padding-right: 1rem;
}

.px-5 {
  padding-left: 1.25rem;
  padding-right: 1.25rem;
}

.px-6 {
  padding-left: 1.5rem;
  padding-right: 1.5rem;
}

.py-1 {
  padding-top: 0.25rem;
  padding-bottom: 0.25rem;
}

.py-1\.5 {
  padding-top: 0.375rem;
  padding-bottom: 0.375rem;
}

.py-2 {
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
}

.py-2\.5 {
  padding-top: 0.625rem;
  padding-bottom: 0.625rem;
}

.py-3 {
  padding-top: 0.75rem;
  padding-bottom: 0.75rem;
}

.py-4 {
  padding-top: 1rem;
  padding-bottom: 1rem;
}

.py-5 {
  padding-top: 1.25rem;
  padding-bottom: 1.25rem;
}

.py-8 {
  padding-top: 2rem;
  padding-bottom: 2rem;
}

.pl-10 {
  padding-left: 2.5rem;
}

.pr-4 {
  padding-right: 1rem;
}

.pt-3 {
  padding-top: 0.75rem;
}

.text-left {
  text-align: left;
}

.text-center {
  text-align: center;
}

.text-base {
  font-size: 1rem;
  line-height: 1.5rem;
}

.text-lg {
  font-size: 1.125rem;
  line-height: 1.75rem;
}

.text-sm {
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.text-xs {
  font-size: 0.75rem;
  line-height: 1rem;
}

.font-light {
  font-weight: 300;
}

.font-medium {
  font-weight: 500;
}

.font-semibold {
  font-weight: 600;
}

.leading-none {
  line-height: 1;
}

.leading-tight {
  line-height: 1.25;
}

.text-amber-600 {
  --tw-text-opacity: 1;
  color: rgb(217 119 6 / var(--tw-text-opacity, 1));
}

.text-amber-700 {
  --tw-text-opacity: 1;
  color: rgb(180 83 9 / var(--tw-text-opacity, 1));
}

.text-amber-800 {
  --tw-text-opacity: 1;
  color: rgb(146 64 14 / var(--tw-text-opacity, 1));
}

.text-blue-600 {
  --tw-text-opacity: 1;
  color: rgb(37 99 235 / var(--tw-text-opacity, 1));
}

.text-blue-700 {
  --tw-text-opacity: 1;
  color: rgb(29 78 216 / var(--tw-text-opacity, 1));
}

.text-emerald-600 {
  --tw-text-opacity: 1;
  color: rgb(5 150 105 / var(--tw-text-opacity, 1));
}

.text-emerald-700 {
  --tw-text-opacity: 1;
  color: rgb(4 120 87 / var(--tw-text-opacity, 1));
}

.text-gray-300 {
  --tw-text-opacity: 1;
  color: rgb(209 213 219 / var(--tw-text-opacity, 1));
}

.text-gray-400 {
  --tw-text-opacity: 1;
  color: rgb(156 163 175 / var(--tw-text-opacity, 1));
}

.text-gray-500 {
  --tw-text-opacity: 1;
  color: rgb(107 114 128 / var(--tw-text-opacity, 1));
}

.text-gray-600 {
  --tw-text-opacity: 1;
  color: rgb(75 85 99 / var(--tw-text-opacity, 1));
}

.text-gray-700 {
  --tw-text-opacity: 1;
  color: rgb(55 65 81 / var(--tw-text-opacity, 1));
}

.text-gray-900 {
  --tw-text-opacity: 1;
  color: rgb(17 24 39 / var(--tw-text-opacity, 1));
}

.text-green-600 {
  --tw-text-opacity: 1;
  color: rgb(22 163 74 / var(--tw-text-opacity, 1));
}

.text-indigo-600 {
  --tw-text-opacity: 1;
  color: rgb(79 70 229 / var(--tw-text-opacity, 1));
}

.text-purple-600 {
  --tw-text-opacity: 1;
  color: rgb(147 51 234 / var(--tw-text-opacity, 1));
}

.text-red-500 {
  --tw-text-opacity: 1;
  color: rgb(239 68 68 / var(--tw-text-opacity, 1));
}

.text-red-600 {
  --tw-text-opacity: 1;
  color: rgb(220 38 38 / var(--tw-text-opacity, 1));
}

.text-red-700 {
  --tw-text-opacity: 1;
  color: rgb(185 28 28 / var(--tw-text-opacity, 1));
}

.text-white {
  --tw-text-opacity: 1;
  color: rgb(255 255 255 / var(--tw-text-opacity, 1));
}

.shadow {
  --tw-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-lg {
  --tw-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-sm {
  --tw-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --tw-shadow-colored: 0 1px 2px 0 var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.shadow-blue-500\/25 {
  --tw-shadow-color: rgb(59 130 246 / 0.25);
  --tw-shadow: var(--tw-shadow-colored);
}

.filter {
  filter: var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow);
}

.transition {
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.transition-all {
  transition-property: all;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.transition-colors {
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.transition-shadow {
  transition-property: box-shadow;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.transition-transform {
  transition-property: transform;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

.duration-200 {
  transition-duration: 200ms;
}

.placeholder\:text-gray-400::-moz-placeholder {
  --tw-text-opacity: 1;
  color: rgb(156 163 175 / var(--tw-text-opacity, 1));
}

.placeholder\:text-gray-400::placeholder {
  --tw-text-opacity: 1;
  color: rgb(156 163 175 / var(--tw-text-opacity, 1));
}

.hover\:border-blue-200:hover {
  --tw-border-opacity: 1;
  border-color: rgb(191 219 254 / var(--tw-border-opacity, 1));
}

.hover\:bg-amber-700:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(180 83 9 / var(--tw-bg-opacity, 1));
}

.hover\:bg-blue-50:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(239 246 255 / var(--tw-bg-opacity, 1));
}

.hover\:bg-blue-50\/30:hover {
  background-color: rgb(239 246 255 / 0.3);
}

.hover\:bg-blue-700:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(29 78 216 / var(--tw-bg-opacity, 1));
}

.hover\:bg-gray-200:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(229 231 235 / var(--tw-bg-opacity, 1));
}

.hover\:bg-gray-50:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(249 250 251 / var(--tw-bg-opacity, 1));
}

.hover\:bg-indigo-700:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(67 56 202 / var(--tw-bg-opacity, 1));
}

.hover\:bg-red-100:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(254 226 226 / var(--tw-bg-opacity, 1));
}

.hover\:bg-red-50:hover {
  --tw-bg-opacity: 1;
  background-color: rgb(254 242 242 / var(--tw-bg-opacity, 1));
}

.hover\:text-blue-700:hover {
  --tw-text-opacity: 1;
  color: rgb(29 78 216 / var(--tw-text-opacity, 1));
}

.hover\:text-gray-600:hover {
  --tw-text-opacity: 1;
  color: rgb(75 85 99 / var(--tw-text-opacity, 1));
}

.hover\:text-gray-900:hover {
  --tw-text-opacity: 1;
  color: rgb(17 24 39 / var(--tw-text-opacity, 1));
}

.hover\:text-red-500:hover {
  --tw-text-opacity: 1;
  color: rgb(239 68 68 / var(--tw-text-opacity, 1));
}

.hover\:text-red-700:hover {
  --tw-text-opacity: 1;
  color: rgb(185 28 28 / var(--tw-text-opacity, 1));
}

.hover\:shadow-xl:hover {
  --tw-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  --tw-shadow-colored: 0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);
  box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
}

.hover\:shadow-blue-500\/30:hover {
  --tw-shadow-color: rgb(59 130 246 / 0.3);
  --tw-shadow: var(--tw-shadow-colored);
}

.focus\:border-amber-500:focus {
  --tw-border-opacity: 1;
  border-color: rgb(245 158 11 / var(--tw-border-opacity, 1));
}

.focus\:border-blue-500:focus {
  --tw-border-opacity: 1;
  border-color: rgb(59 130 246 / var(--tw-border-opacity, 1));
}

.focus\:border-emerald-500:focus {
  --tw-border-opacity: 1;
  border-color: rgb(16 185 129 / var(--tw-border-opacity, 1));
}

.focus\:border-indigo-500:focus {
  --tw-border-opacity: 1;
  border-color: rgb(99 102 241 / var(--tw-border-opacity, 1));
}

.focus\:outline-none:focus {
  outline: 2px solid transparent;
  outline-offset: 2px;
}

.focus\:ring-2:focus {
  --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
  --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
  box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus\:ring-amber-500:focus {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(245 158 11 / var(--tw-ring-opacity, 1));
}

.focus\:ring-blue-500:focus {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(59 130 246 / var(--tw-ring-opacity, 1));
}

.focus\:ring-emerald-500:focus {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(16 185 129 / var(--tw-ring-opacity, 1));
}

.focus\:ring-indigo-500:focus {
  --tw-ring-opacity: 1;
  --tw-ring-color: rgb(99 102 241 / var(--tw-ring-opacity, 1));
}

.focus\:ring-offset-1:focus {
  --tw-ring-offset-width: 1px;
}

.group[open] .group-open\:rotate-180 {
  --tw-rotate: 180deg;
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.peer:checked ~ .peer-checked\:translate-x-5 {
  --tw-translate-x: 1.25rem;
  transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
}

.peer:checked ~ .peer-checked\:bg-blue-500 {
  --tw-bg-opacity: 1;
  background-color: rgb(59 130 246 / var(--tw-bg-opacity, 1));
}

.peer:checked ~ .peer-checked\:bg-emerald-500 {
  --tw-bg-opacity: 1;
  background-color: rgb(16 185 129 / var(--tw-bg-opacity, 1));
}

@media (min-width: 640px) {
  .sm\:gap-3 {
    gap: 0.75rem;
  }
}

@media (min-width: 768px) {
  .md\:col-span-2 {
    grid-column: span 2 / span 2;
  }

  .md\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (min-width: 1024px) {
  .lg\:relative {
    position: relative;
  }

  .lg\:left-1\/2 {
    left: 50%;
  }

  .lg\:mx-0 {
    margin-left: 0px;
    margin-right: 0px;
  }

  .lg\:w-screen {
    width: 100vw;
  }

  .lg\:-translate-x-1\/2 {
    --tw-translate-x: -50%;
    transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
  }

  .lg\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .lg\:px-\[calc\(\(100vw-80rem\)\/2\+1rem\)\] {
    padding-left: calc((100vw - 80rem) / 2 + 1rem);
    padding-right: calc((100vw - 80rem) / 2 + 1rem);
  }
}




========================================
FILE: includes\admin\ui\assets\css\admin.source.css
========================================
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer components {
    /* Accordion styles */
    /* Hide default summary marker */
    details summary::-webkit-details-marker {
        display: none;
    }
    details summary::marker {
        display: none;
    }
    /* Rotate chevron when open */
    details[open] summary .aa-chevron {
        transform: rotate(180deg);
    }
    /* Smooth transition for content */
    details > div {
        transition: opacity 0.2s ease-in-out;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CARD SYSTEM - Collapsible cards with overlay
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    /* Card container - relative for overlay positioning */
    [data-aa-card] {
        @apply relative bg-white border border-gray-200 rounded-lg mb-2;
    }

    /* Card header - clickable toggle */
    [data-aa-card-toggle] {
        @apply px-4 py-3 cursor-pointer select-none;
        @apply text-gray-900 font-medium;
        @apply hover:bg-gray-50 transition-colors;
        @apply flex items-center justify-between;
    }

    /* Chevron indicator for card toggle */
    [data-aa-card-toggle]::after {
        content: '';
        @apply w-2 h-2 border-r-2 border-b-2 border-gray-400;
        @apply transform rotate-45 transition-transform duration-200;
    }

    [data-aa-card].is-open [data-aa-card-toggle]::after {
        @apply -rotate-[135deg];
    }

    /* Overlay - hidden by default, positioned absolutely */
    .aa-card-overlay {
        @apply hidden absolute left-0 right-0 top-full z-50;
        @apply bg-white border border-gray-200 border-t-0 rounded-b-lg shadow-lg;
    }

    /* Show overlay when card is open */
    [data-aa-card].is-open .aa-card-overlay {
        @apply block;
    }

    /* Card body inside overlay */
    .aa-card-body {
        @apply px-4 py-3 text-sm text-gray-600;
    }

    .aa-card-body > div {
        @apply py-1;
    }

    /* Grid container for cards - allow overflow for overlays */
    .aa-clients-grid {
        @apply relative;
        overflow: visible !important;
    }

    /* Action bar for clients module */
    .aa-clients-action-bar {
        @apply flex flex-wrap items-center gap-3 mb-4;
    }

    .aa-clients-search-input {
        @apply flex-1 min-w-[200px] px-3 py-2 text-sm;
        @apply border border-gray-300 rounded-lg;
        @apply focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none;
    }

    .aa-clients-new-button {
        @apply px-4 py-2 text-sm font-medium;
        @apply bg-blue-600 hover:bg-blue-700 text-white;
        @apply rounded-lg transition-colors;
    }

    .aa-clients-pagination {
        @apply flex items-center gap-1;
    }

    .aa-clients-pagination-button {
        @apply w-8 h-8 flex items-center justify-center;
        @apply text-gray-600 hover:bg-gray-100 rounded;
        @apply disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-transparent;
    }

    /* Edit button inside client cards */
    .aa-btn-editar-cliente {
        @apply mt-3 px-3 py-1.5 text-sm;
        @apply inline-flex items-center gap-1.5;
        @apply text-blue-600 hover:text-blue-700 hover:bg-blue-50;
        @apply border border-blue-200 rounded-md;
        @apply transition-colors cursor-pointer;
    }

    .aa-btn-editar-cliente svg {
        @apply w-4 h-4;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MODAL SYSTEM - Basic functional styles
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    /* Modal root - fullscreen overlay container */
    .aa-modal-root {
        @apply fixed inset-0 z-[9999] flex items-center justify-center;
    }

    .aa-modal-root.hidden {
        display: none;
    }

    /* Overlay backdrop */
    .aa-modal-overlay {
        @apply absolute inset-0 bg-black/50;
    }

    /* Modal container */
    .aa-modal {
        @apply relative bg-white rounded-lg shadow-xl w-full max-w-md mx-4 max-h-[90vh] overflow-auto;
    }

    /* Modal header */
    .aa-modal-header {
        @apply flex items-center justify-between px-4 py-3 border-b border-gray-200;
    }

    .aa-modal-title {
        @apply text-lg font-semibold text-gray-900 m-0;
    }

    .aa-modal-close {
        @apply p-1 text-gray-400 hover:text-gray-600 rounded transition-colors;
    }

    /* Modal body */
    .aa-modal-body {
        @apply px-4 py-4;
    }

    /* Modal footer */
    .aa-modal-footer {
        @apply px-4 py-3 border-t border-gray-200 bg-gray-50;
    }

    .aa-modal-footer:empty {
        @apply hidden;
    }

    /* Block body scroll when modal is open */
    body.aa-modal-open {
        @apply overflow-hidden;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       FORM STYLES - Basic form elements for modals
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    
    .aa-form-group {
        @apply mb-4;
    }

    .aa-form-group label {
        @apply block text-sm font-medium text-gray-700 mb-1;
    }

    .aa-form-group input {
        @apply w-full px-3 py-2 border border-gray-300 rounded-md text-sm;
        @apply focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none;
    }

    .aa-modal-actions {
        @apply flex justify-end gap-2;
    }

    .aa-btn-cancelar {
        @apply px-4 py-2 text-sm text-gray-600 hover:text-gray-800 rounded-md transition-colors;
    }

    .aa-btn-guardar {
        @apply px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors;
    }

    .aa-btn-guardar:disabled {
        @apply bg-blue-400 cursor-not-allowed;
    }

    /* Form status messages */
    .aa-form-status {
        @apply p-2 rounded text-sm mt-2;
    }

    .aa-form-error {
        @apply bg-red-50 text-red-700 border border-red-200;
    }

    .aa-form-success {
        @apply bg-green-50 text-green-700 border border-green-200;
    }
}




========================================
FILE: includes\admin\ui\assets\js\main.js
========================================
/**
 * Admin UI - Shared JavaScript
 * 
 * This file contains:
 * - Shared utilities
 * - Common event handlers
 * - AJAX helpers
 * - UI helpers
 */

// Asegurar que el namespace exista ANTES del IIFE
// Esto garantiza que AAAdmin est√© disponible incluso si hay errores
window.AAAdmin = window.AAAdmin || {};

(function() {
    'use strict';

    // Admin UI namespace (reafirmar que existe)
    window.AAAdmin = window.AAAdmin || {};

    /**
     * AJAX helper for admin requests
     */
    AAAdmin.ajax = function(action, data, callback) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('nonce', window.aaAdminNonce || '');

        if (data) {
            Object.keys(data).forEach(key => {
                formData.append(key, data[key]);
            });
        }

        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(callback)
        .catch(error => {
            console.error('AJAX Error:', error);
        });
    };

    /**
     * Show notification message
     */
    AAAdmin.notify = function(message, type = 'info') {
        // Implementation for notifications
        console.log(`[${type}] ${message}`);
    };

    /**
     * Iframe auto-resize functionality
     * Sends content height to parent window for dynamic iframe sizing
     */
    AAAdmin.iframeResize = function() {
        // Only run if we're inside an iframe
        if (window.self === window.top) return;

        let lastHeight = 0;
        let resizeTimeout = null;

        function sendHeight(source = 'unknown') {
            // Get the actual content container instead of body
            // The body has min-h-screen which forces minimum height
            const appContainer = document.getElementById('aa-admin-app');
            const body = document.body;
            const html = document.documentElement;

            let height;

            if (appContainer) {
                // Measure the actual content container
                // Use getBoundingClientRect for accurate measurement
                const rect = appContainer.getBoundingClientRect();
                height = Math.ceil(rect.height);
                
                // Fallback: use scrollHeight if getBoundingClientRect doesn't work
                if (height === 0 || isNaN(height)) {
                    height = appContainer.scrollHeight;
                }
            } else {
                // Fallback to body measurement if container not found
                height = Math.max(
                    body.scrollHeight,
                    body.offsetHeight,
                    html.clientHeight,
                    html.scrollHeight,
                    html.offsetHeight
                );
            }

            // Debug logging
            console.log(`[iframe-resize] Source: ${source}, Height: ${height}px, Last: ${lastHeight}px, Container: ${appContainer ? 'found' : 'not found'}`);

            // Only send if height changed (avoid unnecessary updates)
            if (height !== lastHeight) {
                lastHeight = height;

                console.log(`[iframe-resize] Sending new height: ${height}px to parent window`);

                // Send height to parent window
                window.parent.postMessage({
                    type: 'aa-iframe-resize',
                    height: height,
                    iframeId: 'aa-settings-iframe'
                }, '*');
            } else {
                console.log(`[iframe-resize] Height unchanged (${height}px), skipping update`);
            }
        }

        // Send height on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                sendHeight('DOMContentLoaded');
            });
        } else {
            sendHeight('initial');
        }

        // Send height when content changes (debounced)
        function debouncedSendHeight(source = 'debounced') {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                sendHeight(source);
            }, 100);
        }

        // Watch for content changes - observe the app container instead of body
        const appContainer = document.getElementById('aa-admin-app');
        const targetElement = appContainer || document.body;

        if (typeof ResizeObserver !== 'undefined') {
            const resizeObserver = new ResizeObserver(function(entries) {
                debouncedSendHeight('ResizeObserver');
            });
            resizeObserver.observe(targetElement);
        }

        // Also watch for DOM mutations (dynamic content)
        if (typeof MutationObserver !== 'undefined') {
            const mutationObserver = new MutationObserver(function(mutations) {
                debouncedSendHeight('MutationObserver');
            });
            mutationObserver.observe(targetElement, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['style', 'class', 'open'] // Include 'open' attribute for details elements
            });
        }

        // Send height on window resize (in case of viewport changes)
        window.addEventListener('resize', function() {
            debouncedSendHeight('window-resize');
        });

        // Watch for accordion (details) toggle events
        // This ensures height updates when accordions are opened/closed
        function observeAccordions() {
            const detailsElements = document.querySelectorAll('details');
            
            console.log(`[accordion-observer] Found ${detailsElements.length} accordion(s)`);
            
            detailsElements.forEach((details, index) => {
                details.addEventListener('toggle', function(event) {
                    const isOpen = this.open;
                    const accordionTitle = this.querySelector('h3')?.textContent || `Accordion ${index + 1}`;
                    
                    console.log(`[accordion-toggle] ${accordionTitle} - ${isOpen ? 'OPENED' : 'CLOSED'}`);
                    
                    // Use a longer delay to allow the browser to finish the transition
                    // and recalculate layout
                    setTimeout(function() {
                        sendHeight(`accordion-${isOpen ? 'opened' : 'closed'}`);
                    }, 200);
                });
            });
        }

        // Observe accordions on load and when DOM changes
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', observeAccordions);
        } else {
            observeAccordions();
        }

        // Also watch for new accordions added dynamically
        if (typeof MutationObserver !== 'undefined') {
            const accordionObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            // Check if the added node is a details element
                            if (node.tagName === 'DETAILS') {
                                console.log('[accordion-observer] New accordion detected, adding listener');
                                node.addEventListener('toggle', function() {
                                    const isOpen = this.open;
                                    console.log(`[accordion-toggle] Dynamic accordion - ${isOpen ? 'OPENED' : 'CLOSED'}`);
                                    setTimeout(function() {
                                        sendHeight(`dynamic-accordion-${isOpen ? 'opened' : 'closed'}`);
                                    }, 200);
                                });
                            }
                            // Check for details elements inside the added node
                            const detailsInside = node.querySelectorAll && node.querySelectorAll('details');
                            if (detailsInside && detailsInside.length > 0) {
                                console.log(`[accordion-observer] Found ${detailsInside.length} accordion(s) inside new node`);
                                detailsInside.forEach(function(details) {
                                    details.addEventListener('toggle', function() {
                                        const isOpen = this.open;
                                        console.log(`[accordion-toggle] Nested accordion - ${isOpen ? 'OPENED' : 'CLOSED'}`);
                                        setTimeout(function() {
                                            sendHeight(`nested-accordion-${isOpen ? 'opened' : 'closed'}`);
                                        }, 200);
                                    });
                                });
                            }
                        }
                    });
                });
            });

            accordionObserver.observe(targetElement, {
                childList: true,
                subtree: true
            });
        }
    };

    /**
     * Modal System - Global modal management
     * Provides reusable modal functionality for all modules
     */
    AAAdmin.modal = (function() {
        let isModalOpen = false;
        const modalRoot = null; // Will be set on init

        /**
         * Get modal root element
         * @returns {HTMLElement|null}
         */
        function getModalRoot() {
            return document.getElementById('aa-modal-root');
        }

        /**
         * Get modal elements
         * @returns {Object|null}
         */
        function getModalElements() {
            const root = getModalRoot();
            if (!root) return null;

            return {
                root: root,
                overlay: root.querySelector('.aa-modal-overlay'),
                modal: root.querySelector('.aa-modal'),
                title: root.querySelector('.aa-modal-title'),
                body: root.querySelector('.aa-modal-body'),
                footer: root.querySelector('.aa-modal-footer')
            };
        }

        /**
         * Insert content into element (supports string or HTMLElement)
         * @param {HTMLElement} container - Container element
         * @param {string|HTMLElement} content - Content to insert
         */
        function insertContent(container, content) {
            if (!container) return;

            // Clear existing content
            container.innerHTML = '';

            if (typeof content === 'string') {
                container.innerHTML = content;
            } else if (content instanceof HTMLElement) {
                container.appendChild(content);
            } else if (content instanceof Node) {
                container.appendChild(content);
            }
        }

        /**
         * Block body scroll
         */
        function blockBodyScroll() {
            document.body.classList.add('aa-modal-open');
        }

        /**
         * Restore body scroll
         */
        function restoreBodyScroll() {
            document.body.classList.remove('aa-modal-open');
        }

        /**
         * Open modal
         * @param {Object} options - Modal options
         * @param {string|HTMLElement} options.title - Modal title
         * @param {string|HTMLElement} options.body - Modal body content
         * @param {string|HTMLElement} [options.footer] - Optional modal footer
         */
        function openModal(options) {
            if (!options || (!options.title && !options.body)) {
                console.warn('AAAdmin.openModal: title or body is required');
                return;
            }

            const elements = getModalElements();
            if (!elements) {
                console.error('AAAdmin.openModal: Modal root not found');
                return;
            }

            // Close any existing modal first
            if (isModalOpen) {
                closeModal();
            }

            // Insert content
            if (options.title) {
                insertContent(elements.title, options.title);
            }

            if (options.body) {
                insertContent(elements.body, options.body);
            }

            if (options.footer) {
                insertContent(elements.footer, options.footer);
            } else {
                // Clear footer if not provided
                elements.footer.innerHTML = '';
            }

            // Show modal
            elements.root.classList.remove('hidden');
            blockBodyScroll();
            isModalOpen = true;
        }

        /**
         * Close modal
         */
        function closeModal() {
            const elements = getModalElements();
            if (!elements) return;

            // Hide modal
            elements.root.classList.add('hidden');
            restoreBodyScroll();

            // Clear content
            elements.title.innerHTML = '';
            elements.body.innerHTML = '';
            elements.footer.innerHTML = '';

            isModalOpen = false;
        }

        /**
         * Initialize modal system
         * Sets up event delegation for close actions
         */
        function init() {
            // Event delegation for close actions
            document.addEventListener('click', function(event) {
                if (!isModalOpen) return;

                // Check if click is on a close trigger
                const closeTrigger = event.target.closest('[data-aa-modal-close]');
                if (!closeTrigger) return;

                // If clicking on overlay, close modal
                if (closeTrigger.classList.contains('aa-modal-overlay')) {
                    closeModal();
                    return;
                }

                // If clicking on close button, close modal
                if (closeTrigger.classList.contains('aa-modal-close') || 
                    closeTrigger.closest('.aa-modal-close')) {
                    closeModal();
                    return;
                }

                // Any other element with data-aa-modal-close should close
                closeModal();
            });

            // ESC key to close
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && isModalOpen) {
                    closeModal();
                }
            });
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Public API
        return {
            open: openModal,
            close: closeModal,
            isOpen: function() {
                return isModalOpen;
            }
        };
    })();

    /**
     * Alias for backward compatibility and convenience
     */
    AAAdmin.openModal = function(options) {
        AAAdmin.modal.open(options);
    };

    AAAdmin.closeModal = function() {
        AAAdmin.modal.close();
    };

    /**
     * Collapsible card overlay system
     * Handles cards with [data-aa-card] attribute and toggles via [data-aa-card-toggle]
     */
    AAAdmin.initCardOverlays = function() {
        /**
         * Close all open cards
         */
        function closeAllCards() {
            const openCards = document.querySelectorAll('[data-aa-card].is-open');
            openCards.forEach(function(card) {
                card.classList.remove('is-open');
            });
        }

        /**
         * Open a specific card
         * @param {HTMLElement} card - The card element with [data-aa-card]
         */
        function openCard(card) {
            if (!card || !card.hasAttribute('data-aa-card')) {
                return;
            }
            closeAllCards();
            card.classList.add('is-open');
        }

        /**
         * Check if click target is inside a card or its overlay
         * @param {HTMLElement} target - The clicked element
         * @param {HTMLElement} card - The card element to check against
         * @returns {boolean} - True if target is inside the card
         */
        function isClickInsideCard(target, card) {
            if (!card || !target) {
                return false;
            }
            return card.contains(target);
        }

        // Event delegation: handle clicks on toggle elements
        document.addEventListener('click', function(event) {
            const toggle = event.target.closest('[data-aa-card-toggle]');
            
            if (toggle) {
                // Find the parent card
                const card = toggle.closest('[data-aa-card]');
                
                if (card) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Toggle: if already open, close it; otherwise open it
                    if (card.classList.contains('is-open')) {
                        card.classList.remove('is-open');
                    } else {
                        openCard(card);
                    }
                    return;
                }
            }

            // Handle clicks outside cards
            const openCards = document.querySelectorAll('[data-aa-card].is-open');
            if (openCards.length > 0) {
                let clickedInsideAnyCard = false;
                
                openCards.forEach(function(card) {
                    if (isClickInsideCard(event.target, card)) {
                        clickedInsideAnyCard = true;
                    }
                });
                
                // If clicked outside all open cards, close them
                if (!clickedInsideAnyCard) {
                    closeAllCards();
                }
            }
        });
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin UI initialized');
        
        // Initialize iframe auto-resize
        AAAdmin.iframeResize();
        
        // Initialize card overlay system
        AAAdmin.initCardOverlays();
    });

})();




========================================
FILE: includes\admin\ui\assets\js\notifications.js
========================================
/**
 * Notifications Popover Handler
 * 
 * Manages the notifications bell button and popover display.
 * Handles fetching, rendering, and marking notifications as read.
 */

(function() {
    'use strict';

    // Type labels mapping
    const TYPE_LABELS = {
        'pending': 'Pendientes de confirmaci√≥n',
        'confirmed': 'Confirmaciones',
        'cancelled': 'Cancelaciones'
    };

    /**
     * Fetch unread notifications data
     * @returns {Promise<Object|null>} Notification data or null on error
     */
    function fetchNotificationsData() {
        const ajaxurl = window.ajaxurl || '/wp-admin/admin-ajax.php';
        const url = ajaxurl + '?action=aa_get_unread_notifications';

        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    return data.data;
                }
                return null;
            })
            .catch(error => {
                console.error('[Notifications] Error fetching notifications:', error);
                return null;
            });
    }

    /**
     * Update badge with notification count
     * Exposed globally for use by appointmentsController
     */
    function updateNotificationsBadge() {
        const badge = document.getElementById('aa-notifications-badge');
        if (!badge) {
            console.warn('[Notifications] Badge element not found');
            return;
        }

        fetchNotificationsData().then(data => {
            if (!data) {
                badge.style.display = 'none';
                return;
            }

            const total = data.total || 0;
            
            if (total === 0) {
                badge.style.display = 'none';
            } else {
                badge.style.display = 'block';
                badge.textContent = total.toString();
            }
        });
    }

    /**
     * Render notifications list in popover
     */
    function renderNotificationsList() {
        const popover = document.getElementById('aa-notifications-popover');
        if (!popover) {
            console.warn('[Notifications] Popover element not found');
            return;
        }

        // Find the content container (the div inside popover that contains the list)
        const contentContainer = popover.querySelector('.aa-notifications-content');
        if (!contentContainer) {
            console.warn('[Notifications] Content container not found');
            return;
        }

        fetchNotificationsData().then(data => {
            if (!data || data.total === 0 || !data.by_type || Object.keys(data.by_type).length === 0) {
                // No notifications - show empty state
                contentContainer.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">No hay notificaciones por ahora</div>';
                return;
            }

            // Build list HTML
            let listHTML = '<div class="space-y-1">';
            
            // Iterate through types in order: pending, confirmed, cancelled
            const typeOrder = ['pending', 'confirmed', 'cancelled'];
            
            typeOrder.forEach(type => {
                const count = data.by_type[type] || 0;
                if (count > 0) {
                    const label = TYPE_LABELS[type] || type;
                    listHTML += `
                        <button 
                            type="button"
                            class="aa-notification-item w-full text-left px-3 py-2 rounded hover:bg-gray-50 transition-colors cursor-pointer text-sm text-gray-700 hover:text-gray-900"
                            data-type="${type}"
                            role="button"
                            aria-label="${label} (${count})"
                        >
                            ${label} (${count})
                        </button>
                    `;
                }
            });
            
            listHTML += '</div>';
            contentContainer.innerHTML = listHTML;

            // Attach click handlers to notification items
            const items = contentContainer.querySelectorAll('.aa-notification-item');
            items.forEach(item => {
                item.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    if (type) {
                        // Close popover immediately for better UX
                        const popover = document.getElementById('aa-notifications-popover');
                        if (popover) {
                            popover.classList.add('hidden');
                        }
                        
                        // Open appointments modal filtered by type and unread
                        // NOTE: Notifications will be marked as read when modal closes
                        if (typeof window.AAAppointmentsModal !== 'undefined') {
                            window.AAAppointmentsModal.open({ 
                                type: type, 
                                unread: true,
                                source: 'notifications'
                            });
                        } else {
                            console.error('[Notifications] AAAppointmentsModal no disponible');
                        }
                    }
                });
            });
        });
    }

    /**
     * Mark notifications as read by type
     * Called when appointments modal closes (from appointmentsController)
     * @param {string} type - Notification type (pending, confirmed, cancelled)
     */
    function markNotificationsAsRead(type) {
        const ajaxurl = window.ajaxurl || '/wp-admin/admin-ajax.php';
        const url = ajaxurl + '?action=aa_mark_notifications_as_read&type=' + encodeURIComponent(type);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh badge and list
                    updateNotificationsBadge();
                    renderNotificationsList();
                } else {
                    console.error('[Notifications] Error marking as read:', data.data?.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('[Notifications] Error marking notifications as read:', error);
            });
    }

    // Expose functions globally so appointmentsController can call them
    window.aaMarkNotificationsAsRead = markNotificationsAsRead;
    window.updateNotificationsBadge = updateNotificationsBadge;

    /**
     * Initialize notifications popover
     */
    function initNotifications() {
        const btnNotifications = document.getElementById('aa-btn-notifications');
        const popover = document.getElementById('aa-notifications-popover');
        const btnClose = document.getElementById('aa-btn-close-notifications');

        if (!btnNotifications || !popover || !btnClose) {
            console.warn('[Notifications] Required elements not found');
            return;
        }

        // Load initial badge count
        updateNotificationsBadge();

        /**
         * Toggle popover visibility
         */
        function togglePopover() {
            const isHidden = popover.classList.contains('hidden');
            popover.classList.toggle('hidden');
            
            // When opening, refresh the list
            if (isHidden) {
                renderNotificationsList();
            }
        }

        /**
         * Close popover
         */
        function closePopover() {
            popover.classList.add('hidden');
        }

        /**
         * Handle click on notifications button
         */
        btnNotifications.addEventListener('click', function(e) {
            e.stopPropagation();
            togglePopover();
        });

        /**
         * Handle click on close button
         */
        btnClose.addEventListener('click', function(e) {
            e.stopPropagation();
            closePopover();
        });

        /**
         * Close popover when clicking outside
         */
        document.addEventListener('click', function(e) {
            if (!popover.contains(e.target) && !btnNotifications.contains(e.target)) {
                closePopover();
            }
        });
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotifications);
    } else {
        initNotifications();
    }
})();




========================================
FILE: includes\admin\ui\index.php
========================================
<?php
/**
 * Admin UI Router
 *
 * Responsibilities:
 * - Validate access
 * - Resolve active UI module
 * - Delegate rendering to shared layout
 *
 * This file contains NO HTML and NO business logic.
 */

defined('ABSPATH') or die('No direct access');

// Permission check
if (!current_user_can('manage_options')) {
    wp_die('Acceso denegado', 'Error', ['response' => 403]);
}

// Allowed UI modules (whitelist)
$allowed_modules = [
    'settings',
    'calendar',
    'clients',
    'assignments',
];

// Resolve requested module
$requested_module = isset($_GET['module'])
    ? sanitize_key($_GET['module'])
    : 'settings';

// Fallback to default module
$active_module = in_array($requested_module, $allowed_modules, true)
    ? $requested_module
    : 'settings';

// Resolve module path
$module_path = __DIR__ . '/modules/' . $active_module . '/index.php';

// Final safety check
if (!file_exists($module_path)) {
    wp_die('UI module not found', 'Error', ['response' => 404]);
}

// Variables $active_module and $module_path are now available in parent scope
// Delegate rendering to layout (variables will be accessible in layout.php)
require __DIR__ . '/shared/layout.php';



========================================
FILE: includes\admin\ui\modals\appointments\appointments-modal.js
========================================
/**
 * Appointments Modal Controller
 * 
 * Manages the opening of the appointments modal and coordinates
 * with AppointmentsController for data fetching and rendering.
 * 
 * @package AgendaAutomatizada
 * @since 1.0.0
 */
(function() {
    'use strict';

    /**
     * AppointmentsModal namespace
     */
    const AppointmentsModal = {
        /**
         * Modal configuration
         */
        config: {
            templateId: 'aa-appointments-modal-template',
            title: 'Citas'
        },

        /**
         * Current filters
         */
        currentFilters: {},

        /**
         * Get the modal body content from template
         * Uses <template> tag to avoid duplicate IDs
         * @returns {string} HTML content for modal body
         */
        getBodyContent: function() {
            const template = document.getElementById(this.config.templateId);
            if (template && template.content) {
                // Clone the template content
                const clone = template.content.cloneNode(true);
                // Create a temporary container to get HTML string
                const container = document.createElement('div');
                container.appendChild(clone);
                return container.innerHTML;
            }

            // Fallback if template not found
            console.error('[AppointmentsModal] Template not found: #' + this.config.templateId);
            return '<div class="p-4 text-red-600">Error: Template de citas no encontrado.</div>';
        },

        /**
         * Get modal title based on filters
         * @param {Object} filters - Current filters
         * @returns {string} Modal title
         */
        getTitle: function(filters) {
            const titles = {
                'pending': 'Citas Pendientes',
                'confirmed': 'Citas Confirmadas',
                'cancelled': 'Citas Canceladas'
            };
            
            if (filters.type && titles[filters.type]) {
                return titles[filters.type];
            }
            
            return this.config.title;
        },

        /**
         * Open the appointments modal
         * @param {Object} [filters={}] - Optional filters { type, unread }
         */
        open: function(filters = {}) {
            if (typeof AAAdmin === 'undefined' || typeof AAAdmin.openModal !== 'function') {
                console.error('[AppointmentsModal] AAAdmin.openModal no disponible');
                return;
            }

            console.log('[AppointmentsModal] Abriendo modal con filtros:', filters);

            // Store current filters
            this.currentFilters = filters;

            // Open modal with dynamic title
            AAAdmin.openModal({
                title: this.getTitle(filters),
                body: this.getBodyContent()
            });

            // Initialize controller after modal content is rendered
            this.initController(filters);

            console.log('[AppointmentsModal] ‚úÖ Modal abierto');
        },

        /**
         * Initialize the appointments controller
         * @param {Object} filters - Filters to pass to controller
         */
        initController: function(filters) {
            // Small delay to ensure DOM is ready
            setTimeout(function() {
                if (typeof window.AAAppointmentsController !== 'undefined') {
                    console.log('[AppointmentsModal] Inicializando AppointmentsController...');
                    window.AAAppointmentsController.init(filters);
                } else {
                    console.error('[AppointmentsModal] ‚ùå AAAppointmentsController no disponible');
                }
            }, 50);
        }
    };

    /**
     * Initialize event listeners
     */
    function init() {
        const btnOpenModal = document.getElementById('aa-btn-open-appointments-modal');
        
        if (btnOpenModal) {
            btnOpenModal.addEventListener('click', function(event) {
                event.preventDefault();
                AppointmentsModal.open();
            });
            
            console.log('[AppointmentsModal] ‚úÖ Listener registrado para bot√≥n header');
        }
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Expose to global scope
    window.AAAppointmentsModal = AppointmentsModal;

})();



========================================
FILE: includes\admin\ui\modals\appointments\index.php
========================================
<?php
/**
 * Appointments Modal - HTML Content Template
 * 
 * This file provides the body content for the appointments modal.
 * Uses the existing card system with [data-aa-card] and [data-aa-card-toggle]
 * 
 * Structure:
 * - Filter toggle button
 * - Collapsible filters panel
 * - Cards stack (dynamically rendered by JS)
 * - Pagination controls (dynamically rendered by JS)
 * 
 * NOTE: This template uses <template> tag to avoid duplicate IDs in DOM.
 * The JS will clone and insert content when modal opens.
 * 
 * @package AgendaAutomatizada
 * @since 1.0.0
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');
?>

<!-- Template for Appointments Modal (content not rendered until cloned by JS) -->
<template id="aa-appointments-modal-template">
    <div class="aa-appointments-modal">
        
        <!-- Filter Toggle Button -->
        <div class="aa-appointments-filter-toggle mb-3">
            <button type="button" class="aa-btn-toggle-filters inline-flex items-center gap-1.5 px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg border border-gray-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                </svg>
                <span>B√∫squeda</span>
            </button>
        </div>
        
        <!-- Filters Panel (hidden by default) -->
        <div class="aa-appointments-filters hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            
            <!-- Time filter -->
            <fieldset class="mb-3" data-filter-group="time">
                <legend class="text-sm font-medium text-gray-700 mb-2">Por tiempo</legend>
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="time:all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Todas</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="time:future" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Futuras</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="time:past" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Pasadas</span>
                    </label>
                </div>
            </fieldset>
            
            <!-- Status filter -->
            <fieldset class="mb-3" data-filter-group="status">
                <legend class="text-sm font-medium text-gray-700 mb-2">Por estado</legend>
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="status:all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Todas</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="status:cancelled" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Canceladas</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="status:pending" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Por confirmar</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="status:confirmed" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Confirmadas</span>
                    </label>
                </div>
            </fieldset>
            
            <!-- Notification filter -->
            <fieldset data-filter-group="notification">
                <legend class="text-sm font-medium text-gray-700 mb-2">Por notificaci√≥n</legend>
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="notification:all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Todas</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="notification:unread" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Nuevas</span>
                    </label>
                    <label class="inline-flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" data-filter="notification:read" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>Vistas</span>
                    </label>
                </div>
            </fieldset>
            
        </div>
        
        <!-- Cards Stack (dynamically populated by AppointmentsController) -->
        <div class="aa-appointments-list space-y-2">
            <!-- Cards se renderizan din√°micamente -->
            <div class="aa-appointments-loading flex items-center justify-center py-8">
                <div class="text-gray-500">Cargando citas...</div>
            </div>
        </div>
        
        <!-- Pagination (dynamically populated by AppointmentsController) -->
        <div class="aa-appointments-pagination"></div>
        
    </div>
</template>



========================================
FILE: includes\admin\ui\modals\assignment\assignment-modal.js
========================================
/**
 * Assignment Modal - Logic Controller
 * 
 * Handles:
 * - Open/close modal
 * - Initialize flatpickr on date input
 * - Load staff via AJAX
 * - Load service areas via AJAX
 * - Load services from aa_google_motivo
 * - Submit form via AJAX
 * - Display backend errors
 */

(function() {
    'use strict';

    // Flatpickr instance reference
    let datePicker = null;

    /**
     * Get AJAX URL
     * @returns {string}
     */
    function getAjaxUrl() {
        return (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';
    }

    /**
     * Open the assignment modal
     */
    function openModal() {
        // Check if modal system exists
        if (!window.AAAdmin || !window.AAAdmin.modal) {
            console.error('[Assignment Modal] Modal system not found');
            return;
        }

        // Check if HTML generator exists
        if (!window.AAAssignmentModalHTML) {
            console.error('[Assignment Modal] Modal HTML generator not found');
            return;
        }

        // Open modal with content
        AAAdmin.modal.open({
            title: 'Abrir horario',
            body: AAAssignmentModalHTML.getBody(),
            footer: AAAssignmentModalHTML.getFooter()
        });

        // Initialize modal after opening
        setTimeout(function() {
            initializeDatePicker();
            loadStaffOptions();
            loadServiceAreaOptions();
            loadServiceOptions();
            setupEventListeners();
        }, 100);
    }

    /**
     * Initialize date picker
     * Uses native HTML5 date input (flatpickr not available in iframe)
     */
    function initializeDatePicker() {
        const dateInput = document.getElementById('aa-assignment-date');
        if (!dateInput) return;

        // Set min date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.setAttribute('min', today);
    }

    /**
     * Load active staff into select
     */
    function loadStaffOptions() {
        const staffSelect = document.getElementById('aa-assignment-staff');
        if (!staffSelect) return;

        const formData = new FormData();
        formData.append('action', 'aa_get_staff');

        fetch(getAjaxUrl() + '?only_active=true', {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.data && data.data.staff) {
                let html = '<option value="">-- Selecciona personal --</option>';
                
                data.data.staff.forEach(function(member) {
                    // Only show active staff
                    if (parseInt(member.active) === 1) {
                        html += '<option value="' + escapeHtml(member.id) + '">' + escapeHtml(member.name) + '</option>';
                    }
                });
                
                staffSelect.innerHTML = html;
            } else {
                staffSelect.innerHTML = '<option value="">No hay personal disponible</option>';
            }
        })
        .catch(function(error) {
            console.error('[Assignment Modal] Error loading staff:', error);
            staffSelect.innerHTML = '<option value="">Error al cargar</option>';
        });
    }

    /**
     * Load active service areas into select
     */
    function loadServiceAreaOptions() {
        const areaSelect = document.getElementById('aa-assignment-area');
        if (!areaSelect) return;

        const formData = new FormData();
        formData.append('action', 'aa_get_service_areas');

        fetch(getAjaxUrl() + '?only_active=true', {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.data && data.data.service_areas) {
                let html = '<option value="">-- Selecciona zona --</option>';
                
                data.data.service_areas.forEach(function(area) {
                    // Only show active areas
                    if (parseInt(area.active) === 1) {
                        html += '<option value="' + escapeHtml(area.id) + '">' + escapeHtml(area.name) + '</option>';
                    }
                });
                
                areaSelect.innerHTML = html;
            } else {
                areaSelect.innerHTML = '<option value="">No hay zonas disponibles</option>';
            }
        })
        .catch(function(error) {
            console.error('[Assignment Modal] Error loading areas:', error);
            areaSelect.innerHTML = '<option value="">Error al cargar</option>';
        });
    }

    /**
     * Load services into select
     */
    function loadServiceOptions() {
        const serviceSelect = document.getElementById('aa-assignment-service');
        if (!serviceSelect) return;

        const formData = new FormData();
        formData.append('action', 'aa_get_services');

        fetch(getAjaxUrl(), {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.data && data.data.services) {
                let html = '<option value="">-- Selecciona servicio --</option>';
                
                data.data.services.forEach(function(service) {
                    html += '<option value="' + escapeHtml(service) + '">' + escapeHtml(service) + '</option>';
                });
                
                serviceSelect.innerHTML = html;
            } else {
                serviceSelect.innerHTML = '<option value="">No hay servicios configurados</option>';
            }
        })
        .catch(function(error) {
            console.error('[Assignment Modal] Error loading services:', error);
            serviceSelect.innerHTML = '<option value="">Error al cargar</option>';
        });
    }

    /**
     * Setup event listeners for modal
     */
    function setupEventListeners() {
        // Save button
        const saveBtn = document.getElementById('aa-assignment-save');
        if (saveBtn) {
            saveBtn.addEventListener('click', handleSave);
        }

        // Cancel button - handled by data-aa-modal-close attribute
    }

    /**
     * Handle save button click
     */
    function handleSave() {
        // Get form values
        const form = document.getElementById('aa-assignment-form');
        if (!form) return;

        const dateInput = document.getElementById('aa-assignment-date');
        const startInput = document.getElementById('aa-assignment-start');
        const endInput = document.getElementById('aa-assignment-end');
        const staffSelect = document.getElementById('aa-assignment-staff');
        const areaSelect = document.getElementById('aa-assignment-area');
        const serviceSelect = document.getElementById('aa-assignment-service');
        const capacityInput = document.getElementById('aa-assignment-capacity');

        // Validate required fields
        if (!dateInput.value || !startInput.value || !endInput.value || 
            !staffSelect.value || !areaSelect.value || !serviceSelect.value) {
            showError('Por favor completa todos los campos requeridos');
            return;
        }

        // Validate time range
        if (startInput.value >= endInput.value) {
            showError('La hora de fin debe ser posterior a la hora de inicio');
            return;
        }

        // Disable save button
        const saveBtn = document.getElementById('aa-assignment-save');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
        }

        // Prepare form data
        const formData = new FormData();
        formData.append('action', 'aa_create_assignment');
        formData.append('assignment_date', dateInput.value);
        formData.append('start_time', startInput.value);
        formData.append('end_time', endInput.value);
        formData.append('staff_id', staffSelect.value);
        formData.append('service_area_id', areaSelect.value);
        formData.append('service_key', serviceSelect.value);
        formData.append('capacity', capacityInput.value || 1);

        // Send AJAX request
        fetch(getAjaxUrl(), {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Close modal
                if (window.AAAdmin && window.AAAdmin.modal) {
                    AAAdmin.modal.close();
                }
                
                // Reload assignments list if function exists
                if (window.reloadAssignmentsList) {
                    window.reloadAssignmentsList();
                } else {
                    // Fallback: trigger custom event
                    document.dispatchEvent(new CustomEvent('aa-assignment-created'));
                }
            } else {
                const message = data.data && data.data.message 
                    ? data.data.message 
                    : 'Error al guardar la asignaci√≥n';
                showError(message);
            }
        })
        .catch(function(error) {
            console.error('[Assignment Modal] Error saving:', error);
            showError('Error de conexi√≥n al guardar');
        })
        .finally(function() {
            // Re-enable save button
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar asignaci√≥n';
            }
        });
    }

    /**
     * Show error message in modal
     * @param {string} message
     */
    function showError(message) {
        const errorDiv = document.getElementById('aa-assignment-error');
        if (!errorDiv) return;

        const errorText = errorDiv.querySelector('p');
        if (errorText) {
            errorText.textContent = message;
        }
        
        errorDiv.classList.remove('hidden');
    }

    /**
     * Hide error message
     */
    function hideError() {
        const errorDiv = document.getElementById('aa-assignment-error');
        if (errorDiv) {
            errorDiv.classList.add('hidden');
        }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text
     * @returns {string}
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Initialize modal trigger
     */
    function init() {
        const openButton = document.getElementById('aa-open-assignment-modal');
        if (openButton) {
            openButton.addEventListener('click', openModal);
        }

        // Listen for assignment created event to reload list
        document.addEventListener('aa-assignment-created', function() {
            // Try to reload assignments section
            const assignmentsRoot = document.getElementById('aa-assignments-root');
            if (assignmentsRoot && window.loadAssignments) {
                window.loadAssignments(assignmentsRoot);
            }
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Expose open function globally for other modules
    window.openAssignmentModal = openModal;

})();



========================================
FILE: includes\admin\ui\modals\assignment\index.js
========================================
/**
 * Assignment Modal - HTML Content Generator
 * 
 * Provides the HTML markup for the assignment creation modal.
 * This is a pure function that returns HTML string.
 */

(function() {
    'use strict';

    /**
     * Get the HTML content for the assignment modal body
     * @returns {string} HTML string for modal body
     */
    function getAssignmentModalBody() {
        return `
            <form id="aa-assignment-form" class="space-y-4">
                <!-- Fecha -->
                <div>
                    <label for="aa-assignment-date" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha <span class="text-red-500">*</span>
                    </label>
                    <input type="date" 
                           id="aa-assignment-date" 
                           name="assignment_date"
                           required
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                </div>

                <!-- Hora inicio y fin -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="aa-assignment-start" class="block text-sm font-medium text-gray-700 mb-1">
                            Hora inicio <span class="text-red-500">*</span>
                        </label>
                        <input type="time" 
                               id="aa-assignment-start" 
                               name="start_time"
                               required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="aa-assignment-end" class="block text-sm font-medium text-gray-700 mb-1">
                            Hora fin <span class="text-red-500">*</span>
                        </label>
                        <input type="time" 
                               id="aa-assignment-end" 
                               name="end_time"
                               required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Personal -->
                <div>
                    <label for="aa-assignment-staff" class="block text-sm font-medium text-gray-700 mb-1">
                        Personal <span class="text-red-500">*</span>
                    </label>
                    <select id="aa-assignment-staff" 
                            name="staff_id"
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">Cargando personal...</option>
                    </select>
                </div>

                <!-- Zona de atenci√≥n -->
                <div>
                    <label for="aa-assignment-area" class="block text-sm font-medium text-gray-700 mb-1">
                        Zona de atenci√≥n <span class="text-red-500">*</span>
                    </label>
                    <select id="aa-assignment-area" 
                            name="service_area_id"
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">Cargando zonas...</option>
                    </select>
                </div>

                <!-- Servicio -->
                <div>
                    <label for="aa-assignment-service" class="block text-sm font-medium text-gray-700 mb-1">
                        Servicio <span class="text-red-500">*</span>
                    </label>
                    <select id="aa-assignment-service" 
                            name="service_key"
                            required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">Cargando servicios...</option>
                    </select>
                </div>

                <!-- Capacidad -->
                <div>
                    <label for="aa-assignment-capacity" class="block text-sm font-medium text-gray-700 mb-1">
                        Capacidad
                    </label>
                    <input type="number" 
                           id="aa-assignment-capacity" 
                           name="capacity"
                           value="1"
                           min="1"
                           max="100"
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-xs text-gray-500">N√∫mero de citas simult√°neas permitidas</p>
                </div>

                <!-- Mensaje de error -->
                <div id="aa-assignment-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600"></p>
                </div>
            </form>
        `;
    }

    /**
     * Get the HTML content for the assignment modal footer
     * @returns {string} HTML string for modal footer
     */
    function getAssignmentModalFooter() {
        return `
            <div class="flex justify-end gap-3">
                <button type="button" 
                        id="aa-assignment-cancel"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                        data-aa-modal-close>
                    Cancelar
                </button>
                <button type="button" 
                        id="aa-assignment-save"
                        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors">
                    Guardar asignaci√≥n
                </button>
            </div>
        `;
    }

    // Expose to global namespace
    window.AAAssignmentModalHTML = {
        getBody: getAssignmentModalBody,
        getFooter: getAssignmentModalFooter
    };

})();




========================================
FILE: includes\admin\ui\modals\reservation\index.php
========================================
<?php
/**
 * Reservation Modal - HTML Content Template
 * 
 * This file provides the body content for the reservation modal.
 * Uses EXACT same IDs as legacy admin form (asistant-controls.php)
 * 
 * Required IDs (NO CAMBIAR):
 * - form-crear-cita-admin
 * - cita-cliente
 * - cita-servicio
 * - cita-duracion
 * - cita-fecha
 * - slot-container-admin
 * - btn-cancelar-cita-form
 * 
 * NOTE: This template uses <template> tag to avoid duplicate IDs in DOM.
 * The JS will clone and insert content when modal opens.
 * 
 * @package AgendaAutomatizada
 * @since 1.0.0
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

// Obtener datos necesarios para los selects
$clientes = function_exists('aa_get_all_clientes') ? aa_get_all_clientes(200) : [];
$motivos_json = get_option('aa_google_motivo', json_encode(['Cita general']));
$motivos = json_decode($motivos_json, true);
if (!is_array($motivos) || empty($motivos)) {
    $motivos = ['Cita general'];
}
$duracion_default = intval(get_option('aa_slot_duration', 60));
$duraciones = [30, 60, 90];
?>

<!-- Template for Reservation Modal (content not rendered until cloned by JS) -->
<template id="aa-reservation-modal-template">
    <div class="aa-reservation-modal">
        <form id="form-crear-cita-admin">
            
            <!-- Campo: Cliente -->
            <div class="aa-form-cita-group">
                <label for="cita-cliente">Cliente *</label>
                <select id="cita-cliente" name="cliente_id" required>
                    <option value="">-- Selecciona un cliente --</option>
                    <?php foreach ($clientes as $cliente): ?>
                    <option 
                        value="<?php echo esc_attr($cliente->id); ?>"
                        data-nombre="<?php echo esc_attr($cliente->nombre); ?>"
                        data-telefono="<?php echo esc_attr($cliente->telefono); ?>"
                        data-correo="<?php echo esc_attr($cliente->correo); ?>"
                    >
                        <?php echo esc_html($cliente->nombre); ?> (<?php echo esc_html($cliente->telefono); ?>)
                    </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <!-- Campo: Servicio/Motivo -->
            <div class="aa-form-cita-group">
                <label for="cita-servicio">Motivo de la cita *</label>
                <select id="cita-servicio" name="servicio" required>
                    <?php foreach ($motivos as $motivo): ?>
                    <option value="<?php echo esc_attr($motivo); ?>">
                        <?php echo esc_html($motivo); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <!-- Campo: Duraci√≥n -->
            <div class="aa-form-cita-group">
                <label for="cita-duracion">Duraci√≥n *</label>
                <select id="cita-duracion" name="duracion" required>
                    <?php foreach ($duraciones as $duracion): ?>
                    <option 
                        value="<?php echo esc_attr($duracion); ?>"
                        <?php echo ($duracion === $duracion_default) ? 'selected' : ''; ?>
                    >
                        <?php echo esc_html($duracion); ?> min
                    </option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <!-- Campo: Fecha y Hora -->
            <div class="aa-form-cita-group">
                <label for="cita-fecha">Fecha y hora *</label>
                <input 
                    type="text" 
                    id="cita-fecha" 
                    name="fecha" 
                    required 
                    readonly 
                    placeholder="Selecciona fecha..."
                >
            </div>
            
            <!-- Campo: Personal disponible (nuevo - basado en assignments) -->
            <div class="aa-form-cita-group">
                <label for="aa-reservation-staff">Personal disponible</label>
                <select id="aa-reservation-staff" name="staff_id" disabled>
                    <option value="">Seleccione primero un servicio y una fecha</option>
                </select>
            </div>
            
            <!-- Contenedor de slots -->
            <div class="aa-form-cita-group">
                <div id="slot-container-admin"></div>
            </div>
            
            <!-- Botones -->
            <div class="aa-form-cita-actions">
                <button type="submit" class="aa-btn-agendar-cita">
                    ‚úì Agendar Cita
                </button>
                <button type="button" class="aa-btn-cancelar-cita-form" id="btn-cancelar-cita-form">
                    Cancelar
                </button>
            </div>
            
        </form>
    </div>
</template>



========================================
FILE: includes\admin\ui\modals\reservation\reservation.js
========================================
/**
 * Reservation Modal Controller
 * 
 * Orquesta la apertura del modal y la inicializaci√≥n de los controladores
 * existentes (AvailabilityController, AdminReservationController).
 * 
 * NO duplica l√≥gica de negocio - solo coordina.
 * 
 * @package AgendaAutomatizada
 * @since 1.0.0
 */
(function() {
    'use strict';

    /**
     * ReservationModal namespace
     */
    const ReservationModal = {
        /**
         * Modal configuration
         */
        config: {
            buttonId: 'aa-btn-open-reservation-modal',
            title: 'Agendar cita',
            templateId: 'aa-reservation-modal-template'
        },

        /**
         * Track if controllers are initialized
         */
        initialized: false,

        /**
         * State for new assignment-based flow
         */
        state: {
            selectedService: null,
            selectedDate: null,
            selectedStaff: null,
            currentAssignments: [],
            selectedAssignmentId: null
        },

        /**
         * Get the modal body content from template
         * Uses <template> tag to avoid duplicate IDs
         * @returns {string} HTML content for modal body
         */
        getBodyContent: function() {
            const template = document.getElementById(this.config.templateId);
            if (template && template.content) {
                // Clone the template content
                const clone = template.content.cloneNode(true);
                // Create a temporary container to get HTML string
                const container = document.createElement('div');
                container.appendChild(clone);
                return container.innerHTML;
            }

            // Fallback if template not found
            console.error('[ReservationModal] Template not found: #' + this.config.templateId);
            return '<div class="p-4 text-red-600">Error: Template de reservaci√≥n no encontrado.</div>';
        },

        /**
         * Initialize controllers after modal content is rendered
         */
        initControllers: function() {
            console.log('[ReservationModal] Inicializando controladores...');

            // Peque√±o delay para asegurar que el DOM est√° listo
            setTimeout(() => {
                // 1Ô∏è‚É£ Inicializar AvailabilityController
                if (typeof window.AvailabilityController !== 'undefined') {
                    console.log('[ReservationModal] Inicializando AvailabilityController...');
                    
                    window.AvailabilityController.init({
                        fechaInputSelector: '#cita-fecha',
                        slotContainerSelector: 'slot-container-admin',
                        isAdmin: true
                    });
                    
                    console.log('[ReservationModal] ‚úÖ AvailabilityController inicializado');
                } else {
                    console.error('[ReservationModal] ‚ùå AvailabilityController no disponible');
                }

                // 2Ô∏è‚É£ Inicializar AdminReservationController
                if (typeof window.AdminReservationController !== 'undefined') {
                    console.log('[ReservationModal] Inicializando AdminReservationController...');
                    
                    const form = document.getElementById('form-crear-cita-admin');
                    const btnCancelar = document.getElementById('btn-cancelar-cita-form');
                    
                    if (form) {
                        // Sobrescribir el comportamiento de submit para cerrar modal despu√©s
                        this.setupFormSubmitHandler(form);
                        
                        window.AdminReservationController.init({
                            btnToggle: null, // No se usa toggle en modal
                            formNuevaCita: form,
                            btnCancelar: btnCancelar,
                            form: form
                        });
                        
                        console.log('[ReservationModal] ‚úÖ AdminReservationController inicializado');
                    } else {
                        console.error('[ReservationModal] ‚ùå Formulario #form-crear-cita-admin no encontrado');
                    }
                } else {
                    console.error('[ReservationModal] ‚ùå AdminReservationController no disponible');
                }

                // 3Ô∏è‚É£ Setup bot√≥n cancelar para cerrar modal
                const btnCancelar = document.getElementById('btn-cancelar-cita-form');
                if (btnCancelar) {
                    btnCancelar.addEventListener('click', () => {
                        this.close();
                    });
                }

                // 4Ô∏è‚É£ Inicializar flujo Servicio ‚Üí Fecha ‚Üí Staff (paralelo)
                this.initAssignmentFlow();

                this.initialized = true;
                console.log('[ReservationModal] ‚úÖ Todos los controladores inicializados');
                
            }, 100); // 100ms delay para asegurar DOM ready
        },

        /**
         * Initialize assignment-based flow (Servicio ‚Üí Fecha ‚Üí Staff)
         * This runs in parallel with legacy flow, only logs results
         */
        initAssignmentFlow: function() {
            console.log('[AA][Reservation] Inicializando flujo de asignaciones...');

            const self = this;
            const servicioSelect = document.getElementById('cita-servicio');
            const fechaInput = document.getElementById('cita-fecha');
            const staffSelect = document.getElementById('aa-reservation-staff');

            if (!servicioSelect || !fechaInput || !staffSelect) {
                console.warn('[AA][Reservation] Elementos del flujo de asignaciones no encontrados');
                return;
            }

            // Reset state
            this.resetState();

            // Listen for service changes
            servicioSelect.addEventListener('change', function() {
                self.state.selectedService = this.value;
                console.log('[AA][Reservation] Servicio seleccionado:', self.state.selectedService);
                self.checkAndLoadAssignments();
            });

            // Listen for date changes using the existing 'aa:admin:date-selected' event
            // This event is fired by CalendarAdminUI when flatpickr changes, and provides a Date object
            // This avoids format issues with reading fechaInput.value directly (which has format "d-m-Y")
            document.addEventListener('aa:admin:date-selected', function(event) {
                const selectedDateObj = event.detail.selectedDate;
                
                if (!selectedDateObj || !(selectedDateObj instanceof Date)) {
                    return;
                }
                
                // Use DateUtils.ymd() to convert Date object to YYYY-MM-DD format
                if (typeof window.DateUtils !== 'undefined' && typeof window.DateUtils.ymd === 'function') {
                    const newDate = window.DateUtils.ymd(selectedDateObj);
                    if (newDate && newDate !== self.state.selectedDate) {
                        self.state.selectedDate = newDate;
                        console.log('[AA][Reservation] Fecha seleccionada (desde evento):', self.state.selectedDate);
                        self.checkAndLoadAssignments();
                    }
                }
            });

            // Listen for staff selection
            staffSelect.addEventListener('change', function() {
                self.state.selectedStaff = this.value;
                self.handleStaffSelection();
            });

            // Set initial service if already selected
            if (servicioSelect.value) {
                this.state.selectedService = servicioSelect.value;
                console.log('[AA][Reservation] Servicio inicial:', this.state.selectedService);
            }

            console.log('[AA][Reservation] ‚úÖ Flujo de asignaciones inicializado');
        },

        /**
         * Reset state
         */
        resetState: function() {
            this.state = {
                selectedService: null,
                selectedDate: null,
                selectedStaff: null,
                currentAssignments: [],
                selectedAssignmentId: null
            };
            this.updateAssignmentIdInput(null);
        },

        /**
         * Update or create hidden input for assignment_id
         * @param {number|null} assignmentId 
         */
        updateAssignmentIdInput: function(assignmentId) {
            const form = document.getElementById('form-crear-cita-admin');
            if (!form) return;

            let input = document.getElementById('assignment-id');
            
            if (assignmentId) {
                if (!input) {
                    // Create hidden input if it doesn't exist
                    input = document.createElement('input');
                    input.type = 'hidden';
                    input.id = 'assignment-id';
                    input.name = 'assignment_id';
                    form.appendChild(input);
                }
                input.value = assignmentId;
            } else {
                // Remove input if assignmentId is null
                if (input) {
                    input.remove();
                }
            }
        },

        /**
         * Extract date (YYYY-MM-DD) from datetime string
         * @param {string} datetime - DateTime string (various formats)
         * @returns {string} Date in YYYY-MM-DD format
         */
        extractDate: function(datetime) {
            if (!datetime) return null;
            
            // If already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(datetime)) {
                return datetime;
            }
            
            // Try to parse and format
            try {
                const date = new Date(datetime);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (e) {
                console.warn('[AA][Reservation] Error parsing date:', e);
            }
            
            // Fallback: extract first 10 chars if looks like date
            if (datetime.length >= 10) {
                return datetime.substring(0, 10);
            }
            
            return datetime;
        },

        /**
         * Check if both service and date are selected, then load assignments
         */
        checkAndLoadAssignments: async function() {
            const { selectedService, selectedDate } = this.state;

            console.log('[AA][Reservation] Verificando:', { selectedService, selectedDate });

            if (!selectedService || !selectedDate) {
                console.log('[AA][Reservation] Faltan datos para cargar asignaciones');
                this.resetStaffSelect();
                return;
            }

            // Both are defined, load assignments
            console.log('[AA][Reservation] ‚úÖ Servicio y fecha definidos, cargando asignaciones...');
            
            await this.loadAssignmentsForServiceAndDate(selectedService, selectedDate);
        },

        /**
         * Load assignments for service and date using AAAssignmentsAvailability
         * @param {string} serviceKey 
         * @param {string} date 
         */
        loadAssignmentsForServiceAndDate: async function(serviceKey, date) {
            const staffSelect = document.getElementById('aa-reservation-staff');
            
            if (!staffSelect) {
                console.error('[AA][Reservation] Staff select not found');
                return;
            }

            // Show loading state
            staffSelect.disabled = true;
            staffSelect.innerHTML = '<option value="">Cargando personal...</option>';

            try {
                // Check if AAAssignmentsAvailability is available
                if (typeof window.AAAssignmentsAvailability === 'undefined') {
                    console.warn('[AA][Reservation] AAAssignmentsAvailability no disponible');
                    staffSelect.innerHTML = '<option value="">Sistema de asignaciones no disponible</option>';
                    return;
                }

                // Call the service
                const result = await window.AAAssignmentsAvailability.getAssignmentsByServiceAndDate(serviceKey, date);

                console.log('[AA][Reservation] Resultado de asignaciones:', result);

                if (result.success && result.data && result.data.assignments) {
                    this.state.currentAssignments = result.data.assignments;
                    this.populateStaffSelect(result.data.assignments);
                } else {
                    this.state.currentAssignments = [];
                    staffSelect.innerHTML = '<option value="">No hay personal disponible</option>';
                    console.log('[AA][Reservation] No hay asignaciones para este servicio y fecha');
                }
            } catch (error) {
                console.error('[AA][Reservation] Error al cargar asignaciones:', error);
                staffSelect.innerHTML = '<option value="">Error al cargar personal</option>';
            }
        },

        /**
         * Populate staff select with unique staff from assignments
         * @param {Array} assignments 
         */
        populateStaffSelect: function(assignments) {
            const staffSelect = document.getElementById('aa-reservation-staff');
            
            if (!staffSelect) return;

            // Extract unique staff
            const staffMap = new Map();
            
            assignments.forEach(function(assignment) {
                if (assignment.staff_id && assignment.staff_name) {
                    staffMap.set(assignment.staff_id, assignment.staff_name);
                }
            });

            console.log('[AA][Reservation] Staff √∫nicos encontrados:', staffMap.size);

            if (staffMap.size === 0) {
                staffSelect.innerHTML = '<option value="">No hay personal disponible</option>';
                staffSelect.disabled = true;
                return;
            }

            // Build options
            let html = '<option value="">-- Selecciona personal --</option>';
            
            staffMap.forEach(function(name, id) {
                html += '<option value="' + id + '">' + name + '</option>';
            });

            staffSelect.innerHTML = html;
            staffSelect.disabled = false;

            console.log('[AA][Reservation] ‚úÖ Select de staff poblado con', staffMap.size, 'opciones');
        },

        /**
         * Reset staff select to initial state
         */
        resetStaffSelect: function() {
            const staffSelect = document.getElementById('aa-reservation-staff');
            
            if (staffSelect) {
                staffSelect.innerHTML = '<option value="">Seleccione primero un servicio y una fecha</option>';
                staffSelect.disabled = true;
            }

            this.state.selectedStaff = null;
            this.state.currentAssignments = [];
            this.state.selectedAssignmentId = null;
            this.updateAssignmentIdInput(null);
        },

        /**
         * Handle staff selection (only log, no slot generation yet)
         */
        handleStaffSelection: function() {
            const { selectedStaff, selectedDate, currentAssignments } = this.state;

            if (!selectedStaff) {
                console.log('[AA][Reservation] Staff deseleccionado');
                return;
            }

            // Filter assignments for selected staff
            const staffAssignments = currentAssignments.filter(function(a) {
                return String(a.staff_id) === String(selectedStaff);
            });

            console.log('[AA][Reservation] Staff seleccionado:', selectedStaff);
            console.log('[AA][Reservation] Asignaciones completas:', staffAssignments);

            // Guardar assignment_id (por ahora usamos el primer assignment si hay m√∫ltiples)
            // TODO: Refinar para seleccionar assignment espec√≠fico cuando se implemente selecci√≥n de slots
            if (staffAssignments && staffAssignments.length > 0) {
                const firstAssignment = staffAssignments[0];
                this.state.selectedAssignmentId = firstAssignment.id;
                this.updateAssignmentIdInput(firstAssignment.id);
                console.log('[AA][Reservation] Assignment ID seleccionado:', firstAssignment.id);
            } else {
                this.state.selectedAssignmentId = null;
                this.updateAssignmentIdInput(null);
            }
            
            // Log details for debugging
            staffAssignments.forEach(function(assignment, index) {
                console.log('[AA][Reservation] Asignaci√≥n #' + (index + 1) + ':', {
                    id: assignment.id,
                    start: assignment.start_time,
                    end: assignment.end_time,
                    staff: assignment.staff_name,
                    area: assignment.service_area_name,
                    capacity: assignment.capacity
                });
            });

            // ============================================
            // üßÆ CALCULAR SLOTS DE 30 MINUTOS
            // ============================================
            // Delegar c√°lculo al service
            if (typeof window.AAAssignmentsAvailability !== 'undefined' && 
                typeof window.AAAssignmentsAvailability.getSlotsForStaffAndDate === 'function') {
                
                const availableSlots = window.AAAssignmentsAvailability.getSlotsForStaffAndDate(
                    staffAssignments,
                    selectedDate,
                    30
                );

                if (availableSlots) {
                    console.log('[AA][Reservation] ‚úÖ Slots disponibles calculados:', availableSlots.length);
                    console.log('[AA][Reservation] üßÆ Slots disponibles:', availableSlots.map(function(s) {
                        return typeof window.DateUtils !== 'undefined' && typeof window.DateUtils.hm === 'function' 
                            ? window.DateUtils.hm(s) 
                            : s.toTimeString().substring(0, 5);
                    }));
                    
                    // ============================================
                    // üìä OBTENER Y CALCULAR SLOTS OCUPADOS
                    // ============================================
                    const self = this;
                    const assignmentIds = staffAssignments.map(function(a) {
                        return parseInt(a.id);
                    });
                    
                    if (assignmentIds.length > 0 && typeof window.AABusyRangesAssignments !== 'undefined' &&
                        typeof window.AABusyRangesAssignments.getBusyRangesByAssignments === 'function') {
                        
                        window.AABusyRangesAssignments.getBusyRangesByAssignments(assignmentIds, selectedDate)
                            .then(function(result) {
                                if (result.success && result.data && result.data.busy_ranges) {
                                    const busyRanges = result.data.busy_ranges;
                                    console.log('[AA][Reservation] üìã Busy ranges obtenidos:', busyRanges.length);
                                    
                                    // Generar slots ocupados desde busy ranges
                                    const occupiedSlots = [];
                                    
                                    busyRanges.forEach(function(range) {
                                        // range.start es datetime (ej: "2026-01-02 15:00:00")
                                        // Extraer solo la hora
                                        const startDateTime = new Date(range.start);
                                        const startTime = window.DateUtils.hm(startDateTime);
                                        
                                        // Calcular duraci√≥n en minutos
                                        const endDateTime = new Date(range.end);
                                        const durationMinutes = Math.round((endDateTime - startDateTime) / (1000 * 60));
                                        
                                        // Generar slots ocupados
                                        const reservationSlots = window.DateUtils.generateSlotsFromStartTime(
                                            startTime,
                                            durationMinutes,
                                            30
                                        );
                                        
                                        occupiedSlots.push(...reservationSlots);
                                        console.log('[AA][Reservation] üìå Reserva:', {
                                            start: startTime,
                                            duration: durationMinutes + ' min',
                                            slots: reservationSlots
                                        });
                                    });
                                    
                                    // Eliminar duplicados y ordenar
                                    const uniqueOccupiedSlots = [...new Set(occupiedSlots)].sort();
                                    console.log('[AA][Reservation] üö´ Slots ocupados (total):', uniqueOccupiedSlots);
                                    
                                    // Descontar slots ocupados de slots disponibles
                                    if (typeof window.DateUtils !== 'undefined' && typeof window.DateUtils.hm === 'function') {
                                        const availableSlotStrings = availableSlots.map(function(s) {
                                            return window.DateUtils.hm(s);
                                        });
                                        
                                        const finalSlots = availableSlotStrings.filter(function(slot) {
                                            return !uniqueOccupiedSlots.includes(slot);
                                        });
                                        
                                        console.log('[AA][Reservation] ‚úÖ Slots disponibles finales (despu√©s de descontar ocupados):', finalSlots);
                                        console.log('[AA][Reservation] üìä Resumen:', {
                                            disponibles: availableSlotStrings.length,
                                            ocupados: uniqueOccupiedSlots.length,
                                            finales: finalSlots.length
                                        });
                                        
                                        // üé® RENDERIZAR SLOTS EN EL SELECTOR LEGACY
                                        self.renderAssignmentSlots(finalSlots, selectedDate, self.state.selectedAssignmentId);
                                    }
                                } else {
                                    // No hay busy ranges, usar slots disponibles directamente
                                    console.log('[AA][Reservation] No hay busy ranges para descontar');
                                    const availableSlotStrings = availableSlots.map(function(s) {
                                        return window.DateUtils.hm(s);
                                    });
                                    // Renderizar slots disponibles (sin ocupados)
                                    self.renderAssignmentSlots(availableSlotStrings, selectedDate, self.state.selectedAssignmentId);
                                }
                            })
                            .catch(function(error) {
                                console.error('[AA][Reservation] Error al obtener busy ranges:', error);
                            });
                    } else {
                        console.log('[AA][Reservation] No se pudieron obtener busy ranges (servicio no disponible)');
                    }
                } else {
                    console.log('[AA][Reservation] No se pudieron calcular slots');
                }
            } else {
                console.warn('[AA][Reservation] AAAssignmentsAvailability.getSlotsForStaffAndDate no disponible');
            }
        },

        /**
         * Render assignment-based slots in the legacy slot selector container
         * Replaces legacy slot UI with assignment-based slots while maintaining compatibility
         * @param {Array<string>} slotsHHMM - Array of time strings in "HH:MM" format
         * @param {string} dateStr - Date string in YYYY-MM-DD format
         * @param {number|string} assignmentId - Assignment ID for data attribute
         */
        renderAssignmentSlots: function(slotsHHMM, dateStr, assignmentId) {
            const container = document.getElementById('slot-container-admin');
            const fechaInput = document.getElementById('cita-fecha');
            
            if (!container) {
                console.warn('[AA][Reservation] No se encontr√≥ #slot-container-admin');
                return;
            }
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Caso: No hay slots disponibles
            if (!slotsHHMM || slotsHHMM.length === 0) {
                container.textContent = 'No hay horarios disponibles para este personal.';
                console.log('[AA][Reservation] Sin slots para renderizar');
                return;
            }
            
            console.log('[AA][Reservation] üé® Renderizando ' + slotsHHMM.length + ' slots en selector legacy');
            
            // Crear select con el mismo formato legacy
            const select = document.createElement('select');
            select.id = 'slot-selector-admin';
            select.className = 'slot-selector-admin';
            select.style.width = '100%';
            select.style.padding = '8px';
            select.style.marginTop = '10px';
            select.style.fontSize = '14px';
            select.style.border = '1px solid #ddd';
            select.style.borderRadius = '4px';
            
            // Agregar opciones
            slotsHHMM.forEach(function(timeStr, index) {
                // Convertir "HH:MM" a Date ISO para el value (compatibilidad legacy)
                const [hours, minutes] = timeStr.split(':').map(Number);
                const slotDate = new Date(dateStr + 'T00:00:00');
                slotDate.setHours(hours, minutes, 0, 0);
                
                const option = document.createElement('option');
                option.value = slotDate.toISOString();
                option.textContent = timeStr;
                
                // Agregar data-assignment-id para futura sustituci√≥n
                if (assignmentId) {
                    option.dataset.assignmentId = assignmentId;
                }
                
                if (index === 0) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
            
            // Evento de cambio (compatibilidad legacy)
            var self = this;
            select.addEventListener('change', function() {
                const chosenSlot = new Date(select.value);
                const selectedOption = select.options[select.selectedIndex];
                
                // Actualizar fechaInput con formato compatible
                if (fechaInput && typeof window.DateUtils !== 'undefined') {
                    const formattedDate = chosenSlot.toLocaleDateString('es-MX', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const formattedTime = window.DateUtils.hm(chosenSlot);
                    fechaInput.value = formattedDate + ' ' + formattedTime;
                }
                
                // Log para debug
                console.log('[AA][Reservation] üïí Slot seleccionado:', {
                    time: window.DateUtils ? window.DateUtils.hm(chosenSlot) : chosenSlot.toTimeString(),
                    iso: chosenSlot.toISOString(),
                    assignmentId: selectedOption.dataset.assignmentId || null
                });
            });
            
            // Agregar al contenedor
            container.appendChild(select);
            
            // Seleccionar primer slot por defecto y actualizar fechaInput
            if (slotsHHMM.length > 0 && fechaInput && typeof window.DateUtils !== 'undefined') {
                const firstSlot = new Date(select.value);
                const formattedDate = firstSlot.toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = window.DateUtils.hm(firstSlot);
                fechaInput.value = formattedDate + ' ' + formattedTime;
            }
            
            console.log('[AA][Reservation] ‚úÖ Select de slots renderizado con ' + slotsHHMM.length + ' opciones');
        },

        /**
         * Setup form submit handler to close modal on success
         * @param {HTMLFormElement} form 
         */
        setupFormSubmitHandler: function(form) {
            const self = this;
            
            // Interceptar el submit para cerrar modal despu√©s de √©xito
            form.addEventListener('submit', async function(e) {
                // El AdminReservationController maneja la l√≥gica de submit
                // Solo necesitamos escuchar el √©xito para cerrar el modal
                
                // Crear observer para detectar cuando se muestra el alert de √©xito
                // y luego cerrar el modal
                const originalAlert = window.alert;
                window.alert = function(message) {
                    originalAlert(message);
                    
                    // Si el mensaje indica √©xito, cerrar modal
                    if (message && message.includes('‚úÖ')) {
                        console.log('[ReservationModal] √âxito detectado, cerrando modal...');
                        self.close();
                    }
                    
                    // Restaurar alert original
                    window.alert = originalAlert;
                };
            }, true); // Capture phase para ejecutar antes
        },

        /**
         * Open the reservation modal
         */
        open: function() {
            if (typeof AAAdmin === 'undefined' || typeof AAAdmin.openModal !== 'function') {
                console.error('[ReservationModal] AAAdmin.openModal no disponible');
                return;
            }

            console.log('[ReservationModal] Abriendo modal...');

            AAAdmin.openModal({
                title: this.config.title,
                body: this.getBodyContent()
            });

            // Inicializar controladores despu√©s de abrir
            this.initControllers();
            
            console.log('[ReservationModal] ‚úÖ Modal abierto');
        },

        /**
         * Close the reservation modal
         */
        close: function() {
            if (typeof AAAdmin === 'undefined' || typeof AAAdmin.closeModal !== 'function') {
                console.error('[ReservationModal] AAAdmin.closeModal no disponible');
                return;
            }

            AAAdmin.closeModal();
            this.initialized = false;
            this.resetState();
            
            console.log('[ReservationModal] Modal cerrado');
        },

        /**
         * Initialize event listeners
         */
        init: function() {
            const self = this;
            const button = document.getElementById(this.config.buttonId);

            if (!button) {
                console.warn('[ReservationModal] Bot√≥n no encontrado: #' + this.config.buttonId);
                return;
            }

            button.addEventListener('click', function(event) {
                event.preventDefault();
                self.open();
            });

            console.log('[ReservationModal] ‚úÖ Inicializado correctamente');
        }
    };

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            ReservationModal.init();
        });
    } else {
        ReservationModal.init();
    }

    // Expose to global scope
    window.AAReservationModal = ReservationModal;

})();



========================================
FILE: includes\admin\ui\modules\assignments\areas-section\areas.js
========================================
/**
 * Areas Section - Service Areas Management
 * 
 * Handles UI logic for managing service areas (zonas de atenci√≥n)
 */

(function() {
    'use strict';

    // Store root element reference for reuse
    let areasRoot = null;

    /**
     * Initialize the areas section
     */
    function initAreasSection() {
        areasRoot = document.getElementById('aa-areas-root');
        
        // Fail safely if root doesn't exist
        if (!areasRoot) {
            console.warn('[Areas Section] Root element #aa-areas-root not found');
            return;
        }

        // Load and render service areas
        loadServiceAreas(areasRoot);
        
        // Setup create area button handler
        setupCreateAreaHandler();
    }

    /**
     * Load service areas from server via AJAX
     * @param {HTMLElement} root - The root container element
     */
    function loadServiceAreas(root) {
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_get_service_areas');

        // Show loading state
        root.innerHTML = '<p class="text-sm text-gray-500">Cargando zonas de atenci√≥n...</p>';

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.data && data.data.service_areas) {
                renderServiceAreas(root, data.data.service_areas);
            } else {
                console.error('[Areas Section] Error en respuesta:', data);
                root.innerHTML = '<p class="text-sm text-red-500">Error al cargar las zonas de atenci√≥n.</p>';
            }
        })
        .catch(function(error) {
            console.error('[Areas Section] Error en petici√≥n AJAX:', error);
            root.innerHTML = '<p class="text-sm text-red-500">Error al conectar con el servidor.</p>';
        });
    }

    /**
     * Render service areas list
     * @param {HTMLElement} root - The root container element
     * @param {Array} serviceAreas - Array of service area objects
     */
    function renderServiceAreas(root, serviceAreas) {
        if (!serviceAreas || serviceAreas.length === 0) {
            root.innerHTML = '<p class="text-sm text-gray-500">No hay zonas registradas.</p>';
            return;
        }

        // Build HTML for service areas list
        let html = '<ul class="space-y-2">';
        
        serviceAreas.forEach(function(area) {
            const isActive = parseInt(area.active) === 1;
            const areaId = parseInt(area.id);
            
            html += '<li class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200">';
            html += '<span class="flex items-center justify-center w-8 h-8 rounded-lg bg-green-100 text-green-600 flex-shrink-0">';
            html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>';
            html += '</svg>';
            html += '</span>';
            html += '<span class="text-sm font-medium text-gray-900">' + escapeHtml(area.name) + '</span>';
            if (area.description) {
                html += '<span class="text-xs text-gray-500 ml-2">- ' + escapeHtml(area.description) + '</span>';
            }
            // Toggle switch
            html += '<div class="ml-auto relative">';
            html += '<label class="flex items-center cursor-pointer">';
            html += '<input type="checkbox" ';
            html += 'class="toggle-area-active peer sr-only" ';
            html += 'data-id="' + areaId + '" ';
            html += 'data-active="' + area.active + '" ';
            if (isActive) {
                html += 'checked ';
            }
            html += '/>';
            html += '<div class="w-11 h-6 bg-gray-300 peer-checked:bg-blue-500 rounded-full transition-colors duration-200"></div>';
            html += '<div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform duration-200 peer-checked:translate-x-5"></div>';
            html += '</label>';
            html += '</div>';
            html += '</li>';
        });
        
        html += '</ul>';

        root.innerHTML = html;
        
        // Setup toggle handlers after rendering
        setupToggleHandlers();
    }

    /**
     * Setup handlers for toggle switches
     */
    function setupToggleHandlers() {
        const toggles = document.querySelectorAll('.toggle-area-active');
        
        toggles.forEach(function(toggle) {
            toggle.addEventListener('change', function() {
                handleToggleChange(this);
            });
        });
    }

    /**
     * Handle toggle change event
     * @param {HTMLElement} toggle - The toggle checkbox element
     */
    function handleToggleChange(toggle) {
        const areaId = parseInt(toggle.getAttribute('data-id'));
        const previousActive = parseInt(toggle.getAttribute('data-active'));
        const newActive = toggle.checked ? 1 : 0;
        
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_toggle_service_area');
        formData.append('id', areaId);
        formData.append('active', newActive);

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Update data attribute to reflect new state
                toggle.setAttribute('data-active', newActive);
            } else {
                // Revert toggle state on error
                toggle.checked = previousActive === 1;
                console.error('[Areas Section] Error al actualizar zona:', data);
            }
        })
        .catch(function(error) {
            // Revert toggle state on error
            toggle.checked = previousActive === 1;
            console.error('[Areas Section] Error en petici√≥n AJAX:', error);
        });
    }

    /**
     * Setup handler for create area button
     */
    function setupCreateAreaHandler() {
        const addButton = document.getElementById('aa-add-area');
        const nameInput = document.getElementById('aa-area-name-input');
        
        if (!addButton || !nameInput) {
            console.warn('[Areas Section] Create area button or input not found');
            return;
        }
        
        // Handle button click
        addButton.addEventListener('click', function() {
            createServiceArea(nameInput);
        });
        
        // Handle Enter key in input
        nameInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                createServiceArea(nameInput);
            }
        });
    }

    /**
     * Create a new service area
     * @param {HTMLElement} nameInput - The input element containing the area name
     */
    function createServiceArea(nameInput) {
        const name = nameInput.value.trim();
        
        // Validate input
        if (!name) {
            console.warn('[Areas Section] Intento de crear zona con nombre vac√≠o');
            return;
        }
        
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_create_service_area');
        formData.append('name', name);

        // Disable button during request
        const addButton = document.getElementById('aa-add-area');
        const originalButtonText = addButton.textContent;
        addButton.disabled = true;
        addButton.textContent = 'Agregando...';

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Clear input
                nameInput.value = '';
                
                // Reload the list of service areas
                if (areasRoot) {
                    loadServiceAreas(areasRoot);
                }
            } else {
                console.error('[Areas Section] Error al crear zona:', data);
            }
        })
        .catch(function(error) {
            console.error('[Areas Section] Error en petici√≥n AJAX:', error);
        })
        .finally(function() {
            // Re-enable button
            if (addButton) {
                addButton.disabled = false;
                addButton.textContent = originalButtonText;
            }
        });
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAreasSection);
    } else {
        // DOM already ready
        initAreasSection();
    }

})();



========================================
FILE: includes\admin\ui\modules\assignments\assignments-module.js
========================================
/**
 * Assignments Module - JavaScript
 * 
 * Main module orchestrator for assignments.
 * Individual sections (areas, staff, assignments) are handled by their own JS files.
 */

(function() {
    'use strict';

    /**
     * Initialize the assignments module
     */
    function initAssignmentsModule() {
        const root = document.getElementById('aa-assignments-root');
        
        // Fail safely if root doesn't exist
        if (!root) {
            console.warn('[Assignments Module] Root element #aa-assignments-root not found');
            return;
        }

        // The root will be populated by assignments-section.js
        // This module just ensures the root is ready
        console.log('[Assignments Module] Root element ready');
    }

    // Initialize on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAssignmentsModule);
    } else {
        // DOM already ready
        initAssignmentsModule();
    }

})();



========================================
FILE: includes\admin\ui\modules\assignments\assignments-section\assignments-section.js
========================================
/**
 * Assignments Section - Assignments Management
 * 
 * Handles UI logic for managing assignments (staff + zone + service + time)
 * Renders assignments as collapsible cards with delete functionality
 */

(function() {
    'use strict';

    // Store root element reference for reuse
    let assignmentsRoot = null;

    /**
     * Initialize the assignments section
     */
    function initAssignmentsSection() {
        assignmentsRoot = document.getElementById('aa-assignments-root');
        
        // Fail safely if root doesn't exist
        if (!assignmentsRoot) {
            console.warn('[Assignments Section] Root element #aa-assignments-root not found');
            return;
        }

        // Load and render assignments
        loadAssignments();
    }

    /**
     * Load assignments from server via AJAX
     */
    function loadAssignments() {
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_get_assignments');

        // Show loading state
        assignmentsRoot.innerHTML = '<p class="text-sm text-gray-500">Cargando asignaciones...</p>';

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.data && data.data.assignments) {
                renderAssignments(data.data.assignments);
            } else {
                console.error('[Assignments Section] Error en respuesta:', data);
                assignmentsRoot.innerHTML = '<p class="text-sm text-red-500">Error al cargar las asignaciones.</p>';
            }
        })
        .catch(function(error) {
            console.error('[Assignments Section] Error en petici√≥n AJAX:', error);
            assignmentsRoot.innerHTML = '<p class="text-sm text-red-500">Error al conectar con el servidor.</p>';
        });
    }

    /**
     * Render assignments as collapsible cards
     * @param {Array} assignments - Array of assignment objects
     */
    function renderAssignments(assignments) {
        if (!assignments || assignments.length === 0) {
            assignmentsRoot.innerHTML = '<p class="text-sm text-gray-500">No hay asignaciones registradas.</p>';
            return;
        }

        // Build HTML for assignments list
        let html = '<div class="space-y-3">';
        
        assignments.forEach(function(assignment) {
            const assignmentId = parseInt(assignment.id);
            const date = formatDate(assignment.assignment_date);
            const timeRange = formatTime(assignment.start_time) + ' - ' + formatTime(assignment.end_time);
            
            // Card container with data-aa-card attribute for collapsible behavior
            html += '<div class="aa-assignment-card border border-gray-200 rounded-lg overflow-hidden" data-aa-card data-id="' + assignmentId + '">';
            
            // Card header (clickable to expand/collapse)
            html += '<div class="aa-assignment-header flex items-center gap-3 p-4 bg-gray-50 cursor-pointer" data-aa-card-toggle>';
            
            // Icon
            html += '<span class="flex items-center justify-center w-10 h-10 rounded-lg bg-purple-100 text-purple-600 flex-shrink-0">';
            html += '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>';
            html += '</svg>';
            html += '</span>';
            
            // Header info
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="text-sm font-medium text-gray-900">' + escapeHtml(date) + '</div>';
            html += '<div class="text-xs text-gray-500">' + escapeHtml(timeRange) + '</div>';
            html += '</div>';
            
            // Chevron indicator (solo uno, al extremo derecho)
            html += '<svg class="aa-card-chevron w-4 h-4 text-gray-400 transition-transform duration-200 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
            html += '</svg>';
            
            html += '</div>'; // End header
            
            // Card body (hidden by default, shown when expanded)
            html += '<div class="aa-assignment-body hidden p-4 bg-white border-t border-gray-100">';
            
            // Assignment details grid
            html += '<div class="grid grid-cols-2 gap-4 mb-4">';
            
            // Responsable (staff name)
            html += '<div>';
            html += '<span class="text-xs text-gray-500 block">Responsable</span>';
            html += '<span class="text-sm font-medium text-gray-900">' + escapeHtml(assignment.staff_name || '-') + '</span>';
            html += '</div>';
            
            // Zona (service area name)
            html += '<div>';
            html += '<span class="text-xs text-gray-500 block">Zona</span>';
            html += '<span class="text-sm font-medium text-gray-900">' + escapeHtml(assignment.service_area_name || '-') + '</span>';
            html += '</div>';
            
            // Servicio (service key)
            html += '<div>';
            html += '<span class="text-xs text-gray-500 block">Servicio</span>';
            html += '<span class="text-sm font-medium text-gray-900">' + escapeHtml(assignment.service_key || '-') + '</span>';
            html += '</div>';
            
            // Capacidad (capacity)
            html += '<div>';
            html += '<span class="text-xs text-gray-500 block">Capacidad</span>';
            html += '<span class="text-sm font-medium text-gray-900">' + escapeHtml(assignment.capacity || '1') + '</span>';
            html += '</div>';
            
            html += '</div>'; // End grid
            
            // Delete button
            html += '<div class="pt-3 border-t border-gray-100">';
            html += '<button type="button" class="aa-delete-assignment px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 text-xs font-medium rounded-lg transition-colors" data-id="' + assignmentId + '">';
            html += '<svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>';
            html += '</svg>';
            html += 'Eliminar';
            html += '</button>';
            html += '</div>';
            
            html += '</div>'; // End body
            
            html += '</div>'; // End card
        });
        
        html += '</div>';

        assignmentsRoot.innerHTML = html;
        
        // Setup card toggle handlers
        setupCardToggleHandlers();
        
        // Setup delete handlers
        setupDeleteHandlers();
    }

    /**
     * Setup handlers for card toggle (expand/collapse)
     */
    function setupCardToggleHandlers() {
        const toggles = assignmentsRoot.querySelectorAll('[data-aa-card-toggle]');
        
        toggles.forEach(function(toggle) {
            toggle.addEventListener('click', function(event) {
                // Don't toggle if clicking on a button inside
                if (event.target.closest('button')) {
                    return;
                }
                
                const card = this.closest('[data-aa-card]');
                if (!card) return;
                
                const body = card.querySelector('.aa-assignment-body');
                const chevron = card.querySelector('.aa-card-chevron');
                
                if (body) {
                    body.classList.toggle('hidden');
                }
                
                if (chevron) {
                    chevron.classList.toggle('rotate-180');
                }
            });
        });
    }

    /**
     * Setup handlers for delete buttons
     */
    function setupDeleteHandlers() {
        const deleteButtons = assignmentsRoot.querySelectorAll('.aa-delete-assignment');
        
        deleteButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.stopPropagation();
                
                const assignmentId = parseInt(this.getAttribute('data-id'));
                if (assignmentId > 0) {
                    handleDeleteAssignment(assignmentId);
                }
            });
        });
    }

    /**
     * Handle assignment deletion
     * @param {number} id - Assignment ID to delete
     */
    function handleDeleteAssignment(id) {
        // Simple confirmation
        if (!confirm('¬øEst√°s seguro de eliminar esta asignaci√≥n?')) {
            return;
        }
        
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_delete_assignment');
        formData.append('id', id);

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Re-render the list
                loadAssignments();
            } else {
                console.error('[Assignments Section] Error al eliminar:', data);
                alert('Error al eliminar la asignaci√≥n');
            }
        })
        .catch(function(error) {
            console.error('[Assignments Section] Error en petici√≥n AJAX:', error);
            alert('Error al conectar con el servidor');
        });
    }

    /**
     * Format date for display
     * @param {string} dateStr - Date string in YYYY-MM-DD format
     * @returns {string} Formatted date
     */
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        
        try {
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            
            const year = parts[0];
            const month = parts[1];
            const day = parts[2];
            
            // Return in DD/MM/YYYY format
            return day + '/' + month + '/' + year;
        } catch (e) {
            return dateStr;
        }
    }

    /**
     * Format time for display
     * @param {string} timeStr - Time string in HH:MM:SS format
     * @returns {string} Formatted time (HH:MM)
     */
    function formatTime(timeStr) {
        if (!timeStr) return '-';
        
        try {
            const parts = timeStr.split(':');
            if (parts.length < 2) return timeStr;
            
            return parts[0] + ':' + parts[1];
        } catch (e) {
            return timeStr;
        }
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    // Initialize on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAssignmentsSection);
    } else {
        // DOM already ready
        initAssignmentsSection();
    }

    // Expose loadAssignments globally for modal to reload list
    window.loadAssignments = loadAssignments;
    window.reloadAssignmentsList = loadAssignments;

    // Listen for assignment created event
    document.addEventListener('aa-assignment-created', function() {
        loadAssignments();
    });

})();



========================================
FILE: includes\admin\ui\modules\assignments\index.php
========================================
<?php
/**
 * Assignments Module - Assignments Management UI
 * 
 * This module handles:
 * - Display of assignments overview
 * - UI for managing staff, zones, services, and assignments
 * - No business logic (data operations handled via AJAX)
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

// Resolver rutas de scripts
$plugin_url = plugin_dir_url(__FILE__);
$module_js_url = $plugin_url . 'assignments-module.js';
?>

<div class="max-w-5xl mx-auto py-2">
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECCI√ìN: Asignaciones
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 overflow-hidden group" open>
        <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Asignaciones</h3>
                        <p class="text-sm text-gray-500 mt-0.5">Gestiona personal, zonas de atenci√≥n, servicios y asignaciones.</p>
                    </div>
                </div>
                <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </summary>
        
        <div class="p-6 transition-all duration-200">
            <!-- Bot√≥n para abrir modal de nueva asignaci√≥n -->
            <div class="mb-4">
                <button type="button" 
                        id="aa-open-assignment-modal" 
                        class="inline-flex items-center gap-2 px-4 py-2.5 hover:bg-indigo-700 text-sm font-medium rounded-lg transition-colors shadow-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Abrir horario
                </button>
            </div>
            
            <!-- Root container for assignments section JS -->
            <div id="aa-assignments-root"></div>
        </div>
    </details>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECCI√ìN: Zonas de atenci√≥n
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 overflow-hidden group">
        <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-green-100 text-green-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Zonas de atenci√≥n</h3>
                        <p class="text-sm text-gray-500 mt-0.5">Define √°reas, consultorios o zonas donde se prestan servicios.</p>
                    </div>
                </div>
                <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </summary>
        
        <div class="p-6 transition-all duration-200">
            <!-- Root container for areas section JS -->
            <div id="aa-areas-root"></div>
            
            <!-- Form to add new service area -->
            <div class="flex gap-2 mt-4">
                <input type="text" 
                       id="aa-area-name-input" 
                       placeholder="Ej: Consultorio 3" 
                       class="flex-1 px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow placeholder:text-gray-400">
                <button type="button" 
                        id="aa-add-area" 
                        class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                    Agregar
                </button>
            </div>
        </div>
    </details>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECCI√ìN: Personal
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 overflow-hidden group">
        <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Personal</h3>
                        <p class="text-sm text-gray-500 mt-0.5">Gestiona el personal que atiende clientes y sus capacidades.</p>
                    </div>
                </div>
                <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </summary>
        
        <div class="p-6 transition-all duration-200">
            <!-- Root container for staff section JS -->
            <div id="aa-staff-root"></div>
            
            <!-- Form to add new staff -->
            <div class="flex gap-2 mt-4">
                <input type="text" 
                       id="aa-staff-name-input" 
                       placeholder="Ej: Juan P√©rez" 
                       class="flex-1 px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow placeholder:text-gray-400">
                <button type="button" 
                        id="aa-add-staff" 
                        class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-sm font-medium rounded-lg transition-colors shadow-sm">
                    Agregar
                </button>
            </div>
        </div>
    </details>

</div>

<!-- Datos iniciales del m√≥dulo -->
<script>
    // Garantizar ajaxurl global para el iframe
    if (typeof window.ajaxurl === 'undefined') {
        window.ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
    }
    
    // Datos del m√≥dulo Assignments
    window.AA_ASSIGNMENTS_DATA = {
        ajaxurl: window.ajaxurl || '<?php echo admin_url('admin-ajax.php'); ?>'
    };
</script>

<!-- M√≥dulo JS -->
<script src="<?php echo esc_url($module_js_url); ?>" defer></script>

<!-- Areas Section JS -->
<script src="<?php echo esc_url($plugin_url . 'areas-section/areas.js'); ?>" defer></script>

<!-- Staff Section JS -->
<script src="<?php echo esc_url($plugin_url . 'staff-section/staff.js'); ?>" defer></script>

<!-- Assignments Section JS -->
<script src="<?php echo esc_url($plugin_url . 'assignments-section/assignments-section.js'); ?>" defer></script>

<!-- Assignment Modal -->
<?php 
$modals_url = plugin_dir_url(dirname(dirname(__FILE__))) . 'modals/assignment/';
?>
<script src="<?php echo esc_url($modals_url . 'index.js'); ?>" defer></script>
<script src="<?php echo esc_url($modals_url . 'assignment-modal.js'); ?>" defer></script>




========================================
FILE: includes\admin\ui\modules\assignments\staff-section\staff.js
========================================
/**
 * Staff Section - Staff/Personnel Management
 * 
 * Handles UI logic for managing staff members (personal)
 */

(function() {
    'use strict';

    // Store root element reference for reuse
    let staffRoot = null;

    /**
     * Initialize the staff section
     */
    function initStaffSection() {
        staffRoot = document.getElementById('aa-staff-root');
        
        // Fail safely if root doesn't exist
        if (!staffRoot) {
            console.warn('[Staff Section] Root element #aa-staff-root not found');
            return;
        }

        // Load and render staff
        loadStaff(staffRoot);
        
        // Setup create staff button handler
        setupCreateStaffHandler();
    }

    /**
     * Load staff from server via AJAX
     * @param {HTMLElement} root - The root container element
     */
    function loadStaff(root) {
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_get_staff');

        // Show loading state
        root.innerHTML = '<p class="text-sm text-gray-500">Cargando personal...</p>';

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success && data.data && data.data.staff) {
                renderStaff(root, data.data.staff);
            } else {
                console.error('[Staff Section] Error en respuesta:', data);
                root.innerHTML = '<p class="text-sm text-red-500">Error al cargar el personal.</p>';
            }
        })
        .catch(function(error) {
            console.error('[Staff Section] Error en petici√≥n AJAX:', error);
            root.innerHTML = '<p class="text-sm text-red-500">Error al conectar con el servidor.</p>';
        });
    }

    /**
     * Render staff list
     * @param {HTMLElement} root - The root container element
     * @param {Array} staffList - Array of staff objects
     */
    function renderStaff(root, staffList) {
        if (!staffList || staffList.length === 0) {
            root.innerHTML = '<p class="text-sm text-gray-500">No hay personal registrado.</p>';
            return;
        }

        // Build HTML for staff list
        let html = '<ul class="space-y-2">';
        
        staffList.forEach(function(staff) {
            const isActive = parseInt(staff.active) === 1;
            const staffId = parseInt(staff.id);
            
            html += '<li class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200">';
            html += '<span class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex-shrink-0">';
            html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>';
            html += '</svg>';
            html += '</span>';
            html += '<span class="text-sm font-medium text-gray-900">' + escapeHtml(staff.name) + '</span>';
            // Toggle switch
            html += '<div class="ml-auto relative">';
            html += '<label class="flex items-center cursor-pointer">';
            html += '<input type="checkbox" ';
            html += 'class="toggle-staff-active peer sr-only" ';
            html += 'data-id="' + staffId + '" ';
            html += 'data-active="' + staff.active + '" ';
            if (isActive) {
                html += 'checked ';
            }
            html += '/>';
            html += '<div class="w-11 h-6 bg-gray-300 peer-checked:bg-blue-500 rounded-full transition-colors duration-200"></div>';
            html += '<div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform duration-200 peer-checked:translate-x-5"></div>';
            html += '</label>';
            html += '</div>';
            html += '</li>';
        });
        
        html += '</ul>';

        root.innerHTML = html;
        
        // Setup toggle handlers after rendering
        setupToggleHandlers();
    }

    /**
     * Setup handlers for toggle switches
     */
    function setupToggleHandlers() {
        const toggles = document.querySelectorAll('.toggle-staff-active');
        
        toggles.forEach(function(toggle) {
            toggle.addEventListener('change', function() {
                handleToggleChange(this);
            });
        });
    }

    /**
     * Handle toggle change event
     * @param {HTMLElement} toggle - The toggle checkbox element
     */
    function handleToggleChange(toggle) {
        const staffId = parseInt(toggle.getAttribute('data-id'));
        const previousActive = parseInt(toggle.getAttribute('data-active'));
        const newActive = toggle.checked ? 1 : 0;
        
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_toggle_staff');
        formData.append('id', staffId);
        formData.append('active', newActive);

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Update data attribute to reflect new state
                toggle.setAttribute('data-active', newActive);
            } else {
                // Revert toggle state on error
                toggle.checked = previousActive === 1;
                console.error('[Staff Section] Error al actualizar personal:', data);
            }
        })
        .catch(function(error) {
            // Revert toggle state on error
            toggle.checked = previousActive === 1;
            console.error('[Staff Section] Error en petici√≥n AJAX:', error);
        });
    }

    /**
     * Setup handler for create staff button
     */
    function setupCreateStaffHandler() {
        const addButton = document.getElementById('aa-add-staff');
        const nameInput = document.getElementById('aa-staff-name-input');
        
        if (!addButton || !nameInput) {
            console.warn('[Staff Section] Create staff button or input not found');
            return;
        }
        
        // Handle button click
        addButton.addEventListener('click', function() {
            createStaff(nameInput);
        });
        
        // Handle Enter key in input
        nameInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                createStaff(nameInput);
            }
        });
    }

    /**
     * Create a new staff member
     * @param {HTMLElement} nameInput - The input element containing the staff name
     */
    function createStaff(nameInput) {
        const name = nameInput.value.trim();
        
        // Validate input
        if (!name) {
            console.warn('[Staff Section] Intento de crear personal con nombre vac√≠o');
            return;
        }
        
        // Get ajaxurl from global data
        const ajaxurl = (window.AA_ASSIGNMENTS_DATA && window.AA_ASSIGNMENTS_DATA.ajaxurl) 
            || window.ajaxurl 
            || '/wp-admin/admin-ajax.php';

        // Prepare FormData for AJAX request
        const formData = new FormData();
        formData.append('action', 'aa_create_staff');
        formData.append('name', name);

        // Disable button during request
        const addButton = document.getElementById('aa-add-staff');
        const originalButtonText = addButton.textContent;
        addButton.disabled = true;
        addButton.textContent = 'Agregando...';

        // Make AJAX request
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                // Clear input
                nameInput.value = '';
                
                // Reload the list of staff
                if (staffRoot) {
                    loadStaff(staffRoot);
                }
            } else {
                console.error('[Staff Section] Error al crear personal:', data);
            }
        })
        .catch(function(error) {
            console.error('[Staff Section] Error en petici√≥n AJAX:', error);
        })
        .finally(function() {
            // Re-enable button
            if (addButton) {
                addButton.disabled = false;
                addButton.textContent = originalButtonText;
            }
        });
    }

    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initStaffSection);
    } else {
        // DOM already ready
        initStaffSection();
    }

})();



========================================
FILE: includes\admin\ui\modules\calendar\calendar-module.js
========================================
/**
 * Calendar Module - Module-specific JavaScript
 */

(function() {
    'use strict';

    // Variables del m√≥dulo para recarga
    let currentSlotRowIndex = null;
    let currentTimeSlots = null;
    let eventListenersConfigured = false;
    let gridClickHandler = null;

    // Funci√≥n para esperar a que las dependencias est√©n disponibles
    function waitForDependencies(callback, maxAttempts = 50) {
        const hasDateUtils = typeof window.DateUtils !== 'undefined' && 
                            typeof window.DateUtils.getWeekdayName === 'function' &&
                            typeof window.DateUtils.getDayIntervals === 'function';
        
        const hasSchedule = typeof window.AA_CALENDAR_DATA !== 'undefined' && 
                           window.AA_CALENDAR_DATA?.schedule;
        
        const hasCalendarService = typeof window.AdminCalendarService !== 'undefined' &&
                                  typeof window.AdminCalendarService.esCitaProxima === 'function' &&
                                  typeof window.AdminCalendarService.calcularPosicionCita === 'function';
        
        const hasCalendarController = typeof window.AdminCalendarController !== 'undefined' &&
                                     typeof window.AdminCalendarController.handleCitaAction === 'function';
        
        const hasDatePickerAdapter = typeof window.DatePickerAdapter !== 'undefined' &&
                                    typeof window.DatePickerAdapter.init === 'function';
        
        const hasFlatpickr = typeof flatpickr !== 'undefined';
        
        const hasCalendarAppointmentCard = typeof window.CalendarAppointmentCard !== 'undefined' &&
                                          typeof window.CalendarAppointmentCard.crearCardCita === 'function';
        
        const hasCalendarAppointments = typeof window.CalendarAppointments !== 'undefined' &&
                                       typeof window.CalendarAppointments.cargarYRenderizarCitas === 'function';
        
        const hasCalendarTimeline = typeof window.CalendarTimeline !== 'undefined' &&
                                   typeof window.CalendarTimeline.renderTimelineForDate === 'function';
        
        if (hasDateUtils && hasSchedule && hasCalendarService && hasCalendarController && hasDatePickerAdapter && hasFlatpickr && hasCalendarAppointmentCard && hasCalendarAppointments && hasCalendarTimeline) {
            callback();
            return;
        }
        
        if (maxAttempts <= 0) {
            console.error('‚ùå Dependencias no disponibles despu√©s de m√∫ltiples intentos');
            console.error('  - DateUtils:', typeof window.DateUtils);
            console.error('  - AA_CALENDAR_DATA:', typeof window.AA_CALENDAR_DATA);
            console.error('  - AdminCalendarService:', typeof window.AdminCalendarService);
            console.error('  - AdminCalendarController:', typeof window.AdminCalendarController);
            console.error('  - DatePickerAdapter:', typeof window.DatePickerAdapter);
            console.error('  - flatpickr:', typeof flatpickr);
            console.error('  - CalendarAppointmentCard:', typeof window.CalendarAppointmentCard);
            console.error('  - CalendarAppointments:', typeof window.CalendarAppointments);
            console.error('  - CalendarTimeline:', typeof window.CalendarTimeline);
            return;
        }
        
        setTimeout(() => waitForDependencies(callback, maxAttempts - 1), 100);
    }

    /**
     * Inicializar el selector de fecha
     */
    function initDatePicker() {
        // Obtener fecha inicial (hoy)
        const today = new Date();
        const todayStr = window.DateUtils.ymd(today);
        
        // Callback cuando cambia la fecha
        function onDateChange(fecha) {
            if (window.AdminCalendarController?.setDate) {
                window.AdminCalendarController.setDate(fecha);
            }
        }
        
        // Inicializar adapter
        if (window.DatePickerAdapter) {
            window.DatePickerAdapter.init('aa-date-picker', onDateChange, todayStr);
        }
        
        // Configurar botones de navegaci√≥n
        const btnPrev = document.getElementById('aa-date-prev');
        const btnNext = document.getElementById('aa-date-next');
        
        if (btnPrev) {
            btnPrev.addEventListener('click', function() {
                if (window.DatePickerAdapter) {
                    window.DatePickerAdapter.prevDay();
                }
            });
        }
        
        if (btnNext) {
            btnNext.addEventListener('click', function() {
                if (window.DatePickerAdapter) {
                    window.DatePickerAdapter.nextDay();
                }
            });
        }
    }

    /**
     * Renderizar timeline para una fecha espec√≠fica
     * @param {string} fechaStr - Fecha en formato YYYY-MM-DD
     */
    function renderTimelineForDate(fechaStr) {
        // Delegar render del timeline a CalendarTimeline
        const result = window.CalendarTimeline?.renderTimelineForDate(fechaStr);
        
        if (!result) {
            // Si no hay resultado (d√≠a sin horarios), no hay nada que hacer
            return;
        }
        
        // Guardar referencias para recarga
        currentSlotRowIndex = result.slotRowIndex;
        currentTimeSlots = result.timeSlots;
        
        // Cargar y renderizar citas del d√≠a seleccionado usando CalendarAppointments
        if (window.CalendarAppointments?.cargarYRenderizarCitas) {
            window.CalendarAppointments.cargarYRenderizarCitas(result.slotRowIndex, result.timeSlots, fechaStr);
        }
        
        // Configurar event listener delegado para acciones de botones
        configurarEventListeners();
    }

    function initCalendar() {
        // Inicializar selector de fecha
        initDatePicker();
        
        // Obtener fecha inicial (hoy o la del controller si existe)
        let fechaInicial;
        if (window.AdminCalendarController?.getCurrentDate) {
            fechaInicial = window.AdminCalendarController.getCurrentDate();
        }
        
        if (!fechaInicial) {
            const today = new Date();
            fechaInicial = window.DateUtils.ymd(today);
        }
        
        // Renderizar timeline para la fecha inicial
        renderTimelineForDate(fechaInicial);
        
        // Inicializar el controller con callbacks
        if (window.AdminCalendarController?.init) {
            window.AdminCalendarController.init(
                recargarTimelineDelDiaActual,
                function(fecha) {
                    // Callback para cargar citas de un d√≠a espec√≠fico
                    renderTimelineForDate(fecha);
                }
            );
        }
        
        // Inicializar AdminConfirmController con el callback de recarga del timeline
        // Esto permite que confirmar/cancelar actualicen autom√°ticamente el timeline
        if (window.AdminConfirmController?.init) {
            window.AdminConfirmController.init(recargarTimelineDelDiaActual);
        }
    }


    /**
     * Configurar event listeners delegados para acciones de botones
     * Protegido contra m√∫ltiples registros
     */
    function configurarEventListeners() {
        const grid = document.getElementById('aa-time-grid');
        if (!grid) return;
        
        // Si ya est√°n configurados, remover el listener anterior antes de agregar uno nuevo
        if (eventListenersConfigured && gridClickHandler) {
            grid.removeEventListener('click', gridClickHandler);
        }
        
        // Crear handler y guardar referencia
        gridClickHandler = function(e) {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            
            const action = btn.getAttribute('data-action');
            const citaId = btn.getAttribute('data-id');
            
            if (!action || !citaId) return;
            
            e.stopPropagation();
            
            // Delegar al controller
            if (window.AdminCalendarController?.handleCitaAction) {
                window.AdminCalendarController.handleCitaAction(action, citaId);
            }
        };
        
        // Registrar el listener
        grid.addEventListener('click', gridClickHandler);
        eventListenersConfigured = true;
    }

    /**
     * Recargar el timeline del d√≠a actual sin recargar la p√°gina
     */
    function recargarTimelineDelDiaActual() {
        // Obtener fecha actual del controller
        let fecha;
        if (window.AdminCalendarController?.getCurrentDate) {
            fecha = window.AdminCalendarController.getCurrentDate();
        }
        
        if (!fecha) {
            const today = new Date();
            fecha = window.DateUtils.ymd(today);
        }
        
        // Re-renderizar timeline completo para la fecha actual
        renderTimelineForDate(fecha);
    }

    // Esperar a que el DOM est√© listo Y las dependencias est√©n disponibles
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            waitForDependencies(initCalendar);
        });
    } else {
        waitForDependencies(initCalendar);
    }

})();


========================================
FILE: includes\admin\ui\modules\calendar\calendar-section\calendar-appointment-card.js
========================================
/**
 * Calendar Appointment Card - Card creation and button rendering
 */

(function() {
    'use strict';

    /**
     * Crear el DOM de la card de cita
     */
    function crearCardCita(cita) {
        const card = document.createElement('div');
        card.className = 'aa-appointment-card';
        card.setAttribute('data-id', cita.id || '');
        
        // Estilos base sin altura fija
        card.style.border = '1px solid #e5e7eb';
        card.style.borderRadius = '4px';
        card.style.overflow = 'hidden';
        card.style.cursor = 'pointer';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.minHeight = '40px';
        
        // Header (siempre visible)
        const header = document.createElement('div');
        header.className = 'aa-appointment-header';
        header.style.padding = '8px 12px';
        header.style.backgroundColor = getEstadoColor(cita.estado);
        header.style.color = '#fff';
        header.style.fontWeight = '500';
        header.style.fontSize = '14px';
        header.style.flexShrink = '0';
        
        const clienteNombre = cita.nombre || 'Sin nombre';
        const servicio = cita.servicio || 'Sin servicio';
        header.textContent = `${clienteNombre} - ${servicio}`;
        
        // Body (oculto por defecto)
        const body = document.createElement('div');
        body.className = 'aa-appointment-body';
        body.setAttribute('hidden', '');
        body.style.padding = '12px';
        body.style.backgroundColor = '#f9fafb';
        body.style.fontSize = '13px';
        body.style.flex = '1';
        
        // Informaci√≥n de la cita
        const info = document.createElement('div');
        info.style.marginBottom = '12px';
        
        if (cita.telefono) {
            const telefono = document.createElement('div');
            telefono.textContent = `üìû ${cita.telefono}`;
            telefono.style.marginBottom = '4px';
            info.appendChild(telefono);
        }
        
        if (cita.correo) {
            const correo = document.createElement('div');
            correo.textContent = `‚úâÔ∏è ${cita.correo}`;
            correo.style.marginBottom = '4px';
            info.appendChild(correo);
        }
        
        const estado = document.createElement('div');
        estado.textContent = `Estado: ${cita.estado || 'pending'}`;
        estado.style.marginBottom = '8px';
        estado.style.fontWeight = '500';
        info.appendChild(estado);
        
        body.appendChild(info);
        
        // Determinar si la cita es pr√≥xima o pasada usando el service
        const esProxima = window.AdminCalendarService?.esCitaProxima(cita) || false;
        
        // Renderizar botones/leyendas seg√∫n reglas
        const botones = renderizarBotonesYCitas(cita, esProxima);
        if (botones) {
            body.appendChild(botones);
        }
        
        // Toggle acorde√≥n: click en header abre/cierra body
        header.addEventListener('click', function(e) {
            e.stopPropagation();
            const isHidden = body.hasAttribute('hidden');
            if (isHidden) {
                body.removeAttribute('hidden');
            } else {
                body.setAttribute('hidden', '');
            }
        });
        
        // Ensamblar card
        card.appendChild(header);
        card.appendChild(body);
        
        return card;
    }

    /**
     * Renderizar botones y leyendas seg√∫n estado y si es pr√≥xima/pasada
     * @param {Object} cita - Objeto de cita
     * @param {boolean} esProxima - true si es pr√≥xima, false si es pasada
     * @returns {HTMLElement|null} - Contenedor de botones/leyendas o null
     */
    function renderizarBotonesYCitas(cita, esProxima) {
        const estado = cita.estado || 'pending';
        const contenedor = document.createElement('div');
        contenedor.style.display = 'flex';
        contenedor.style.gap = '8px';
        contenedor.style.flexWrap = 'wrap';
        
        let tieneContenido = false;
        
        if (esProxima) {
            // ===== CITA PR√ìXIMA =====
            
            if (estado === 'confirmed') {
                // Mostrar bot√≥n Cancelar
                const btnCancelar = crearBoton('Cancelar', 'cancelar', '#ef4444', cita.id);
                contenedor.appendChild(btnCancelar);
                tieneContenido = true;
            }
            else if (estado === 'pending') {
                // Mostrar botones Confirmar y Cancelar
                const btnConfirmar = crearBoton('Confirmar', 'confirmar', '#10b981', cita.id);
                const btnCancelar = crearBoton('Cancelar', 'cancelar', '#ef4444', cita.id);
                contenedor.appendChild(btnConfirmar);
                contenedor.appendChild(btnCancelar);
                tieneContenido = true;
            }
            else if (estado === 'cancelled') {
                // Mostrar leyenda "Cancelada"
                const leyenda = crearLeyenda('Cancelada', '#9ca3af');
                contenedor.appendChild(leyenda);
                tieneContenido = true;
            }
            else if (estado === 'asisti√≥' || estado === 'no asisti√≥') {
                // Caso extremo: mostrar leyenda correspondiente
                const texto = estado === 'asisti√≥' ? 'Asisti√≥' : 'No asisti√≥';
                const leyenda = crearLeyenda(texto, '#6b7280');
                contenedor.appendChild(leyenda);
                tieneContenido = true;
            }
        } else {
            // ===== CITA PASADA =====
            
            if (estado === 'confirmed') {
                // Mostrar botones Asisti√≥ y No asisti√≥
                const btnAsistio = crearBoton('Asisti√≥', 'asistio', '#10b981', cita.id);
                const btnNoAsistio = crearBoton('No asisti√≥', 'no-asistio', '#ef4444', cita.id);
                contenedor.appendChild(btnAsistio);
                contenedor.appendChild(btnNoAsistio);
                tieneContenido = true;
            }
            else if (estado === 'pending') {
                // NO mostrar botones ni leyendas
                // No hacer nada
            }
            else if (estado === 'asisti√≥') {
                // Mostrar leyenda "‚úì Asisti√≥"
                const leyenda = crearLeyenda('‚úì Asisti√≥', '#10b981');
                contenedor.appendChild(leyenda);
                tieneContenido = true;
            }
            else if (estado === 'no asisti√≥') {
                // Mostrar leyenda "‚úï No asisti√≥"
                const leyenda = crearLeyenda('‚úï No asisti√≥', '#ef4444');
                contenedor.appendChild(leyenda);
                tieneContenido = true;
            }
            else if (estado === 'cancelled') {
                // Mostrar leyenda "Cancelada"
                const leyenda = crearLeyenda('Cancelada', '#9ca3af');
                contenedor.appendChild(leyenda);
                tieneContenido = true;
            }
        }
        
        return tieneContenido ? contenedor : null;
    }

    /**
     * Crear un bot√≥n con data-action
     * @param {string} texto - Texto del bot√≥n
     * @param {string} accion - Acci√≥n (confirmar, cancelar, asistio, no-asistio)
     * @param {string} colorFondo - Color de fondo
     * @param {string|number} citaId - ID de la cita
     * @returns {HTMLElement} - Elemento button
     */
    function crearBoton(texto, accion, colorFondo, citaId) {
        const boton = document.createElement('button');
        boton.textContent = texto;
        boton.setAttribute('data-action', accion);
        boton.setAttribute('data-id', citaId);
        boton.style.padding = '6px 12px';
        boton.style.backgroundColor = colorFondo;
        boton.style.color = '#fff';
        boton.style.border = 'none';
        boton.style.borderRadius = '4px';
        boton.style.cursor = 'pointer';
        boton.style.fontSize = '12px';
        
        return boton;
    }

    /**
     * Crear una leyenda (texto informativo)
     * @param {string} texto - Texto de la leyenda
     * @param {string} color - Color del texto
     * @returns {HTMLElement} - Elemento div
     */
    function crearLeyenda(texto, color) {
        const leyenda = document.createElement('div');
        leyenda.textContent = texto;
        leyenda.style.padding = '6px 12px';
        leyenda.style.color = color;
        leyenda.style.fontWeight = '500';
        leyenda.style.fontSize = '12px';
        leyenda.style.border = `1px solid ${color}`;
        leyenda.style.borderRadius = '4px';
        
        // Color de fondo con transparencia seg√∫n el color base
        if (color === '#10b981') {
            leyenda.style.backgroundColor = '#d1fae5'; // verde claro
        } else if (color === '#ef4444') {
            leyenda.style.backgroundColor = '#fee2e2'; // rojo claro
        } else {
            leyenda.style.backgroundColor = '#f3f4f6'; // gris claro
        }
        
        return leyenda;
    }

    /**
     * Obtener color seg√∫n el estado de la cita
     */
    function getEstadoColor(estado) {
        const colores = {
            'pending': '#f59e0b',      // amarillo
            'confirmed': '#10b981',    // verde
            'cancelled': '#ef4444',     // rojo
            'attended': '#10b981',      // verde (mismo que confirmed)
            'asisti√≥': '#10b981',       // verde
            'no asisti√≥': '#9ca3af'     // gris
        };
        return colores[estado] || colores['pending'];
    }

    // Exponer API p√∫blica
    window.CalendarAppointmentCard = {
        crearCardCita: crearCardCita
    };

})();




========================================
FILE: includes\admin\ui\modules\calendar\calendar-section\calendar-appointments.js
========================================
/**
 * Calendar Appointments - Load and render appointments
 */

(function() {
    'use strict';

    // Estado UI local para trackear cita expandida
    let expandedCitaId = null;
    let expandedGroupKey = null; // Identificador del grupo expandido (ej: "5-8")
    
    // Cache de datos de citas para re-renderizado
    let citasCache = null;
    let overlapsCache = null;
    let slotRowIndexCache = null;
    let timeSlotsCache = null;

    /**
     * Cargar citas de un d√≠a espec√≠fico y renderizarlas en el timeline
     * @param {Map} slotRowIndex - Mapa de slots
     * @param {Array} timeSlots - Array de time slots
     * @param {string} fechaStr - Fecha en formato YYYY-MM-DD (opcional, usa hoy por defecto)
     */
    function cargarYRenderizarCitas(slotRowIndex, timeSlots, fechaStr) {
        // Si no se proporciona fecha, usar hoy
        if (!fechaStr) {
            const today = new Date();
            fechaStr = window.DateUtils.ymd(today);
        }
        
        // Preparar datos para la petici√≥n AJAX
        const formData = new FormData();
        formData.append('action', 'aa_get_citas_por_dia');
        formData.append('fecha', fechaStr);
        
        if (window.AA_CALENDAR_DATA?.nonce) {
            formData.append('_wpnonce', window.AA_CALENDAR_DATA.nonce);
        }
        
        const ajaxurl = window.AA_CALENDAR_DATA?.ajaxurl || (typeof ajaxurl !== 'undefined' ? ajaxurl : '/wp-admin/admin-ajax.php');
        
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data && data.data.citas) {
                // Calcular posiciones de TODAS las citas primero
                const citasConPosicion = [];
                
                data.data.citas.forEach(cita => {
                    // Usar el service para calcular posici√≥n
                    const posicion = window.AdminCalendarService?.calcularPosicionCita(cita);
                    if (!posicion) return;
                    
                    const { slotInicio, bloquesOcupados } = posicion;
                    
                    // Obtener el √≠ndice de fila del slot inicial
                    const slotData = slotRowIndex.get(slotInicio);
                    if (!slotData) return; // Slot no encontrado
                    const startRow = slotData.rowIndex;
                    
                    citasConPosicion.push({
                        cita: cita,
                        id: cita.id,
                        startRow: startRow,
                        bloquesOcupados: bloquesOcupados,
                        slotInicio: slotInicio
                    });
                });
                
                // Calcular solapamientos usando CalendarOverlap
                const overlaps = window.CalendarOverlap?.computeOverlaps(citasConPosicion) || {};
                
                // Guardar en cache para re-renderizado
                citasCache = citasConPosicion;
                overlapsCache = overlaps;
                slotRowIndexCache = slotRowIndex;
                timeSlotsCache = timeSlots;
                
                // Resetear estado expandido al cargar nuevas citas
                expandedCitaId = null;
                expandedGroupKey = null;
                
                // Renderizar todas las citas
                renderizarTodasLasCitas(citasConPosicion, overlaps, slotRowIndex, timeSlots);
            }
        })
        .catch(err => {
            console.error('Error al cargar citas:', err);
        });
    }

    /**
     * Renderizar todas las citas con manejo de estado expandido
     */
    function renderizarTodasLasCitas(citasConPosicion, overlaps, slotRowIndex, timeSlots) {
        // Limpiar citas existentes del grid (solo las cards, no los elementos del timeline)
        const grid = document.getElementById('aa-time-grid');
        if (!grid) return;
        
        // Eliminar solo los wrappers y cards, no los elementos del timeline (labels y content)
        const elementosAEliminar = [];
        grid.childNodes.forEach(node => {
            if (node.nodeType === 1) {
                // Si es un wrapper de cita o una card directa
                if (node.classList && (
                    node.classList.contains('aa-appointment-card') ||
                    (node.querySelector && node.querySelector('.aa-appointment-card'))
                )) {
                    elementosAEliminar.push(node);
                }
            }
        });
        elementosAEliminar.forEach(el => el.remove());
        
        // Agrupar citas por grupos de solapamiento real
        // Usar un algoritmo de componentes conectados basado en overlaps
        const gruposSolapamiento = [];
        const citasSinGrupo = [];
        const procesadas = new Set();
        
        citasConPosicion.forEach((citaConPos, index) => {
            if (procesadas.has(index)) return;
            
            const overlapInfo = overlaps[citaConPos.id];
            if (overlapInfo && overlapInfo.overlapCount > 1) {
                // Esta cita est√° en un grupo de solapamiento
                // Encontrar todas las citas que se solapan con esta (transitivamente)
                const grupo = [];
                const porProcesar = [index];
                
                while (porProcesar.length > 0) {
                    const idxActual = porProcesar.pop();
                    if (procesadas.has(idxActual)) continue;
                    
                    procesadas.add(idxActual);
                    const citaActual = citasConPosicion[idxActual];
                    grupo.push(citaActual);
                    
                    // Buscar otras citas que se solapan con esta
                    citasConPosicion.forEach((otraCita, otroIndex) => {
                        if (procesadas.has(otroIndex)) return;
                        
                        const otraOverlap = overlaps[otraCita.id];
                        if (otraOverlap && otraOverlap.overlapCount > 1) {
                            // Verificar si se solapan en el mismo rango de filas
                            const startRow1 = citaActual.startRow;
                            const endRow1 = startRow1 + citaActual.bloquesOcupados;
                            const startRow2 = otraCita.startRow;
                            const endRow2 = startRow2 + otraCita.bloquesOcupados;
                            
                            // Si se solapan verticalmente
                            if (startRow1 < endRow2 && startRow2 < endRow1) {
                                porProcesar.push(otroIndex);
                            }
                        }
                    });
                }
                
                if (grupo.length > 0) {
                    gruposSolapamiento.push(grupo);
                }
            } else {
                // Cita sin solapamiento
                procesadas.add(index);
                citasSinGrupo.push(citaConPos);
            }
        });
        
        // Renderizar grupos de solapamiento
        gruposSolapamiento.forEach((grupo) => {
            // Calcular key del grupo para comparaci√≥n
            let minStartRow = Infinity;
            let maxEndRow = -Infinity;
            grupo.forEach(c => {
                minStartRow = Math.min(minStartRow, c.startRow);
                maxEndRow = Math.max(maxEndRow, c.startRow + c.bloquesOcupados);
            });
            const groupKey = `${minStartRow}-${maxEndRow}`;
            
            renderizarGrupoCitas(grupo, overlaps, slotRowIndex, timeSlots, groupKey);
        });
        
        // Renderizar citas sin solapamiento
        citasSinGrupo.forEach((citaConPos) => {
            // Cada cita sin solapamiento es su propio grupo
            const groupKey = `${citaConPos.startRow}-${citaConPos.startRow + citaConPos.bloquesOcupados}`;
            renderizarGrupoCitas([citaConPos], overlaps, slotRowIndex, timeSlots, groupKey);
        });
    }
    
    /**
     * Renderizar un grupo de citas (pueden estar solapadas o no)
     * @param {Array} grupo - Array de citas del grupo
     * @param {Object} overlaps - Mapa de overlaps
     * @param {Map} slotRowIndex - Mapa de slots
     * @param {Array} timeSlots - Array de time slots
     * @param {string} groupKey - Identificador √∫nico del grupo (ej: "5-8")
     */
    function renderizarGrupoCitas(grupo, overlaps, slotRowIndex, timeSlots, groupKey) {
        if (grupo.length === 0) return;
        
        const grid = document.getElementById('aa-time-grid');
        if (!grid) return;
        
        // Calcular el rango que cubre todas las citas del grupo
        let minStartRow = Infinity;
        let maxEndRow = -Infinity;
        
        grupo.forEach(citaConPos => {
            minStartRow = Math.min(minStartRow, citaConPos.startRow);
            maxEndRow = Math.max(maxEndRow, citaConPos.startRow + citaConPos.bloquesOcupados);
        });
        
        const startRow = minStartRow;
        const bloquesOcupados = maxEndRow - minStartRow;
        
        // Verificar si hay solapamiento en este grupo
        const tieneSolapamiento = grupo.some(c => overlaps[c.id] && overlaps[c.id].overlapCount > 1);
        
        // Flag para determinar si este grupo est√° expandido
        const isExpandedGroup = expandedCitaId !== null && expandedGroupKey === groupKey;
        
        // Estructura clara: una sola rama l√≥gica por caso
        if (isExpandedGroup) {
            // Modo expandido: renderizar solo la cita expandida
            const citaExpandida = grupo.find(c => c.id === expandedCitaId);
            if (citaExpandida) {
                // Renderizar solo la cita expandida con ancho 100%
                // Usar el rango original de la cita, no el del grupo
                renderizarCitaExpandida(citaExpandida, citaExpandida.startRow, citaExpandida.bloquesOcupados);
            }
        } else if (tieneSolapamiento) {
            // Modo split horizontal: renderizar todas las citas del grupo con flexbox
            const wrapper = document.createElement('div');
            wrapper.style.gridColumn = '2';
            wrapper.style.gridRow = `${startRow} / span ${bloquesOcupados}`;
            wrapper.style.display = 'flex';
            wrapper.style.width = '100%';
            wrapper.style.gap = '2px';
            wrapper.style.position = 'relative';
            
            grupo.forEach(citaConPos => {
                const overlapInfo = overlaps[citaConPos.id];
                const card = crearCardConInteraccion(citaConPos.cita, overlapInfo, false);
                if (card) {
                    // Usar flex: 1 para dividir el espacio equitativamente
                    card.style.flex = '1';
                    card.style.minWidth = '0'; // Permite que flex funcione correctamente
                    card.style.position = 'relative'; // Para que los clicks funcionen
                    wrapper.appendChild(card);
                }
            });
            
            grid.appendChild(wrapper);
        } else {
            // Sin solapamiento: renderizar normalmente
            grupo.forEach(citaConPos => {
                const card = crearCardConInteraccion(citaConPos.cita, null, false);
                if (card) {
                    card.style.gridColumn = '2';
                    card.style.gridRow = `${citaConPos.startRow} / span ${citaConPos.bloquesOcupados}`;
                    grid.appendChild(card);
                }
            });
        }
    }
    
    /**
     * Renderizar una cita en modo expandido (ancho 100%)
     */
    function renderizarCitaExpandida(citaConPos, startRow, bloquesOcupados) {
        const grid = document.getElementById('aa-time-grid');
        if (!grid) return;
        
        const card = crearCardConInteraccion(citaConPos.cita, null, true);
        if (!card) return;
        
        // Configurar para modo expandido
        card.style.gridColumn = '2';
        card.style.gridRow = `${startRow} / span ${bloquesOcupados}`;
        card.style.width = '100%';
        card.style.position = 'relative'; // Permite crecimiento vertical
        
        // Mostrar el body autom√°ticamente en modo expandido
        const body = card.querySelector('.aa-appointment-body');
        if (body) {
            body.removeAttribute('hidden');
        }
        
        grid.appendChild(card);
    }
    
    /**
     * Crear card con interacci√≥n de expandir/colapsar
     * @param {Object} cita - Objeto de cita
     * @param {Object} overlapInfo - Informaci√≥n de solapamiento
     * @param {boolean} isExpanded - Si la cita est√° en modo expandido
     */
    function crearCardConInteraccion(cita, overlapInfo, isExpanded) {
        if (!cita.fecha) return null;
        
        // Crear la card usando CalendarAppointmentCard
        const card = window.CalendarAppointmentCard?.crearCardCita(cita);
        if (!card) return null;
        
        // Interceptar el click del header para manejar expandir/colapsar
        const header = card.querySelector('.aa-appointment-header');
        const body = card.querySelector('.aa-appointment-body');
        
        if (header && body) {
            // Remover todos los listeners existentes clonando el header
            const nuevoHeader = header.cloneNode(true);
            header.parentNode.replaceChild(nuevoHeader, header);
            
            // Agregar nuestro handler personalizado
            nuevoHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                const currentBody = card.querySelector('.aa-appointment-body');
                if (!currentBody) return;
                
                const isHidden = currentBody.hasAttribute('hidden');
                
                if (isHidden) {
                    // Abrir acorde√≥n
                    if (overlapInfo && overlapInfo.overlapCount > 1) {
                        // Si hay solapamiento, expandir esta cita (ocultar solo las del mismo grupo)
                        if (expandedCitaId !== cita.id) {
                            expandedCitaId = cita.id;
                            // Calcular el groupKey de esta cita encontrando su grupo
                            if (citasCache && overlapsCache) {
                                const citaData = citasCache.find(ct => ct.id === cita.id);
                                if (citaData) {
                                    let minStartRow = citaData.startRow;
                                    let maxEndRow = citaData.startRow + citaData.bloquesOcupados;
                                    
                                    // Encontrar todas las citas que se solapan con esta
                                    citasCache.forEach(c => {
                                        if (c.id === cita.id) return;
                                        
                                        const o = overlapsCache[c.id];
                                        if (o && o.overlapCount > 1) {
                                            const cStartRow = c.startRow;
                                            const cEndRow = c.startRow + c.bloquesOcupados;
                                            
                                            // Si se solapan verticalmente
                                            if (citaData.startRow < cEndRow && cStartRow < (citaData.startRow + citaData.bloquesOcupados)) {
                                                minStartRow = Math.min(minStartRow, cStartRow);
                                                maxEndRow = Math.max(maxEndRow, cEndRow);
                                            }
                                        }
                                    });
                                    
                                    expandedGroupKey = `${minStartRow}-${maxEndRow}`;
                                }
                            }
                            
                            // Re-renderizar todas las citas
                            if (citasCache && overlapsCache && slotRowIndexCache && timeSlotsCache) {
                                renderizarTodasLasCitas(citasCache, overlapsCache, slotRowIndexCache, timeSlotsCache);
                            }
                        } else {
                            // Ya est√° expandida, solo mostrar el body
                            currentBody.removeAttribute('hidden');
                        }
                    } else {
                        // Sin solapamiento, solo toggle normal
                        currentBody.removeAttribute('hidden');
                    }
                } else {
                    // Cerrar acorde√≥n
                    currentBody.setAttribute('hidden', '');
                    
                    // Si esta cita estaba expandida, colapsar y re-renderizar
                    if (expandedCitaId === cita.id) {
                        expandedCitaId = null;
                        expandedGroupKey = null;
                        // Re-renderizar todas las citas
                        if (citasCache && overlapsCache && slotRowIndexCache && timeSlotsCache) {
                            renderizarTodasLasCitas(citasCache, overlapsCache, slotRowIndexCache, timeSlotsCache);
                        }
                    }
                }
            });
        }
        
        return card;
    }

    // Exponer API p√∫blica
    window.CalendarAppointments = {
        cargarYRenderizarCitas: cargarYRenderizarCitas
    };

})();




========================================
FILE: includes\admin\ui\modules\calendar\calendar-section\calendar-overlap.js
========================================
/**
 * Calendar Overlap - Overlap detection and horizontal split calculation
 */

(function() {
    'use strict';

    /**
     * Detectar si dos rangos se solapan
     * @param {number} start1 - Inicio del rango 1
     * @param {number} end1 - Fin del rango 1 (exclusivo)
     * @param {number} start2 - Inicio del rango 2
     * @param {number} end2 - Fin del rango 2 (exclusivo)
     * @returns {boolean} - true si se solapan
     */
    function rangosSeSolapan(start1, end1, start2, end2) {
        return start1 < end2 && start2 < end1;
    }

    /**
     * Calcular solapamientos y asignar √≠ndices para split horizontal
     * @param {Array} citas - Array de objetos con { id, startRow, bloquesOcupados }
     * @returns {Object} - Mapa de id -> { overlapIndex, overlapCount }
     */
    function computeOverlaps(citas) {
        if (!citas || citas.length === 0) {
            return {};
        }

        // Mapa resultado: id -> { overlapIndex, overlapCount }
        const resultado = {};

        // Encontrar grupos de citas que se solapan (componentes conectados)
        const grupos = [];
        const procesadas = new Set();

        citas.forEach((cita, index) => {
            if (procesadas.has(index)) return;

            // Encontrar todas las citas que se solapan con esta (transitivamente)
            const grupo = [];
            const porProcesar = [index];

            while (porProcesar.length > 0) {
                const idxActual = porProcesar.pop();
                if (procesadas.has(idxActual)) continue;
                
                procesadas.add(idxActual);
                const citaActual = citas[idxActual];
                grupo.push(citaActual);

                const startRow = citaActual.startRow;
                const endRow = startRow + citaActual.bloquesOcupados;

                // Buscar todas las citas que se solapan con esta
                citas.forEach((otraCita, otroIndex) => {
                    if (procesadas.has(otroIndex)) return;
                    
                    const otraStartRow = otraCita.startRow;
                    const otraEndRow = otraStartRow + otraCita.bloquesOcupados;
                    
                    // Verificar si se solapan
                    if (rangosSeSolapan(startRow, endRow, otraStartRow, otraEndRow)) {
                        porProcesar.push(otroIndex);
                    }
                });
            }

            if (grupo.length > 0) {
                grupos.push(grupo);
            }
        });

        // Asignar √≠ndices a cada grupo
        grupos.forEach(grupo => {
            // Ordenar por startRow para asignar √≠ndices consistentes
            grupo.sort((a, b) => a.startRow - b.startRow);
            
            const overlapCount = grupo.length;
            
            // Asignar overlapIndex y overlapCount a todas las citas del grupo
            grupo.forEach((cita, index) => {
                resultado[cita.id] = {
                    overlapIndex: index,
                    overlapCount: overlapCount
                };
            });
        });

        return resultado;
    }

    // Exponer API p√∫blica
    window.CalendarOverlap = {
        computeOverlaps: computeOverlaps
    };

})();




========================================
FILE: includes\admin\ui\modules\calendar\calendar-section\calendar-timeline.js
========================================
/**
 * Calendar Timeline - Timeline rendering and time slots
 */

(function() {
    'use strict';

    /**
     * Renderizar timeline para una fecha espec√≠fica
     * @param {string} fechaStr - Fecha en formato YYYY-MM-DD
     * @returns {Object} - Objeto con slotRowIndex y timeSlots para uso externo
     */
    function renderTimelineForDate(fechaStr) {
        const grid = document.getElementById('aa-time-grid');
        if (!grid) {
            console.error('‚ùå No se encontr√≥ el contenedor #aa-time-grid');
            return null;
        }

        const schedule = window.AA_CALENDAR_DATA.schedule;
        
        // Convertir fecha string a Date
        const fecha = new Date(fechaStr + 'T00:00:00');
        const weekday = window.DateUtils.getWeekdayName(fecha);
        const intervals = window.DateUtils.getDayIntervals(schedule, weekday);
        
        // Configurar CSS Grid
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = 'auto 1fr';
        grid.style.gridAutoRows = 'auto';

        // Limpiar contenido existente
        grid.innerHTML = '';

        // Si no hay intervalos o el d√≠a no est√° habilitado
        if (!intervals || intervals.length === 0) {
            const mensaje = document.createElement('div');
            mensaje.style.gridColumn = '1 / -1';
            mensaje.style.padding = '2rem';
            mensaje.style.textAlign = 'center';
            mensaje.style.color = '#6b7280';
            mensaje.textContent = 'No hay horarios configurados para hoy';
            grid.appendChild(mensaje);
            return null;
        }

        // Funci√≥n para convertir minutos a formato HH:MM
        function minutesToTimeStr(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }

        // Generar todos los bloques de 30 minutos de todos los intervalos
        const timeSlots = [];
        
        intervals.forEach((interval) => {
            // Generar bloques de 30 minutos dentro del intervalo
            for (let min = interval.start; min < interval.end; min += 30) {
                timeSlots.push(min);
            }
        });

        // Mapa de minutos -> √≠ndice de fila en el grid (para calcular grid-row)
        const slotRowIndex = new Map();
        
        // Obtener hora actual en minutos para diferenciar pasado/futuro
        // Solo mostrar indicador si es el d√≠a actual
        const now = new Date();
        const todayStr = window.DateUtils.ymd(now);
        const isToday = fechaStr === todayStr;
        const minutosActuales = isToday ? window.DateUtils.minutesFromDate(now) : null;

        // Renderizar labels y content directamente en el grid
        timeSlots.forEach((minutes, index) => {
            const timeStr = minutesToTimeStr(minutes);
            
            // Label (columna 1)
            const label = document.createElement('div');
            label.className = 'aa-time-label';
            label.textContent = timeStr;
            label.style.gridColumn = '1';
            label.style.gridRow = `${index + 1}`;
            label.style.padding = '8px 12px';
            label.style.minWidth = '40px';
            label.style.position = 'relative';
            
            // Diferenciar visualmente slots pasados vs futuros (SOLO en label, solo si es hoy)
            if (isToday && minutosActuales !== null && minutes < minutosActuales) {
                // Slot pasado: fondo gris tenue en el label
                label.style.backgroundColor = '#f3f4f6';
            } else {
                // Slot actual o futuro: fondo normal en el label
                label.style.backgroundColor = '#ffffff';
            }
            
            grid.appendChild(label);
            
            // Content (columna 2) - vac√≠o por ahora, las citas se insertar√°n aqu√≠
            const content = document.createElement('div');
            content.className = 'aa-time-content';
            content.style.gridColumn = '2';
            content.style.gridRow = `${index + 1}`;
            content.style.minHeight = '40px';
            // Sin estilos de fondo - √°rea limpia para citas
            grid.appendChild(content);
            
            // Guardar referencia al label y √≠ndice de fila para acceso r√°pido
            slotRowIndex.set(minutes, {
                rowIndex: index + 1,
                labelElement: label
            });
        });

        // Agregar indicador de hora actual (SOLO en label, solo si es hoy)
        if (isToday && minutosActuales !== null) {
            agregarIndicadorHoraActual(slotRowIndex, minutosActuales);
        }

        // Retornar referencias para uso externo
        return {
            slotRowIndex: slotRowIndex,
            timeSlots: timeSlots
        };
    }

    /**
     * Agregar indicador visual de hora actual en el label
     */
    function agregarIndicadorHoraActual(slotRowIndex, minutosActuales) {
        // Redondear al slot de 30 minutos correspondiente
        const slotActual = Math.floor(minutosActuales / 30) * 30;
        
        // Obtener el label del slot actual
        const slotData = slotRowIndex.get(slotActual);
        if (!slotData || !slotData.labelElement) return; // Slot no encontrado en el timeline
        
        const label = slotData.labelElement;
        
        // Crear indicador dentro del label
        const indicador = document.createElement('div');
        indicador.className = 'aa-time-now-indicator';
        indicador.style.position = 'absolute';
        indicador.style.left = '0';
        indicador.style.right = '0';
        indicador.style.top = '50%';
        indicador.style.transform = 'translateY(-50%)';
        indicador.style.height = '2px';
        indicador.style.backgroundColor = '#ef4444';
        indicador.style.zIndex = '5';
        
        // Agregar un peque√±o c√≠rculo en el lado izquierdo
        const circulo = document.createElement('div');
        circulo.style.position = 'absolute';
        circulo.style.left = '0';
        circulo.style.top = '50%';
        circulo.style.transform = 'translate(-50%, -50%)';
        circulo.style.width = '8px';
        circulo.style.height = '8px';
        circulo.style.backgroundColor = '#ef4444';
        circulo.style.borderRadius = '50%';
        indicador.appendChild(circulo);
        
        // Insertar el indicador dentro del label
        label.appendChild(indicador);
    }

    // Exponer API p√∫blica
    window.CalendarTimeline = {
        renderTimelineForDate: renderTimelineForDate
    };

})();




========================================
FILE: includes\admin\ui\modules\calendar\index.php
========================================
<?php
/**
 * Calendar Module - Calendar Management UI
 * 
 * This module handles:
 * - Display of calendar view
 * - UI for managing appointments
 * - No business logic (data operations handled outside)
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

// Obtener schedule
$schedule = get_option('aa_schedule', []);

// Resolver rutas de scripts
$plugin_url = plugin_dir_url(__FILE__);
$module_js_url = $plugin_url . 'calendar-module.js';
?>

<details open class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden group">

    <!-- =========================
         üîπ HEADER / SUMMARY
         ========================= -->
    <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
        <div class="flex items-center justify-between gap-3">

            <!-- Izquierda: icono + texto -->
            <div class="flex items-center gap-3">
                <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                    <!-- Icono calendario -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </span>

                <div>
                    <h3 class="text-lg font-semibold text-gray-900">
                        Calendario
                    </h3>
                    <p class="text-sm text-gray-500 mt-0.5">
                        Agenda del d√≠a y pr√≥ximas citas
                    </p>
                </div>
            </div>

            <!-- Derecha: flecha (aunque est√© abierto) -->
            <svg class="w-5 h-5 text-gray-400 transition-transform duration-200 group-open:rotate-180"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 9l-7 7-7-7"/>
            </svg>

        </div>
    </summary>

    <!-- =========================
         üîπ CONTENIDO / BODY
         ========================= -->
    <div class="p-6 transition-all duration-200">

        <!-- =========================
             üîπ SELECTOR DE FECHA
             ========================= -->
        <div id="aa-date-selector" class="mb-4 flex items-center gap-2">
            <!-- Bot√≥n anterior -->
            <button id="aa-date-prev" type="button" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 transition-colors">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            
            <!-- Input Flatpickr -->
            <input type="text" id="aa-date-picker" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Seleccionar fecha" readonly>
            
            <!-- Bot√≥n siguiente -->
            <button id="aa-date-next" type="button" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 transition-colors">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>

        <!-- =========================
             üîπ AGENDA TIMELINE
             ========================= -->
        <section class="aa-day-timeline relative bg-white rounded-lg border border-gray-200 overflow-hidden">

            <!-- Indicador de hora actual -->
            <div
                id="aa-time-now-indicator"
                class="aa-time-now-indicator pointer-events-none absolute left-0 right-0 z-10">
                <!-- l√≠nea / punto se insertan por JS -->
            </div>

            <!-- Grid de horarios -->
            <div id="aa-time-grid" class="aa-time-grid">
              <!-- üî• JS renderiza aqu√≠ din√°micamente las filas de horarios -->
            </div>

        </section>

    </div>

</details>

<!-- Scripts: Orden cr√≠tico - datos primero, luego dependencias, luego m√≥dulo -->
<!-- Datos base del calendario -->
<script>
  // Datos espec√≠ficos del m√≥dulo Calendar (complementa variables globales de layout.php)
  window.AA_CALENDAR_DATA = {
    schedule: <?php echo wp_json_encode($schedule); ?>,
    nonce: '<?php echo wp_create_nonce('aa_proximas_citas'); ?>',
    historialNonce: '<?php echo wp_create_nonce('aa_historial_citas'); ?>',
    ajaxurl: window.ajaxurl || '<?php echo admin_url('admin-ajax.php'); ?>'
  };
</script>

<!-- 
    Scripts compartidos (Flatpickr, dateUtils, services, controllers) 
    est√°n cargados globalmente desde layout.php 
-->

<!-- Archivos de secci√≥n del calendario (espec√≠ficos del m√≥dulo) -->
<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'calendar-section/calendar-appointment-card.js'); ?>" defer></script>
<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'calendar-section/calendar-overlap.js'); ?>" defer></script>
<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'calendar-section/calendar-appointments.js'); ?>" defer></script>
<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'calendar-section/calendar-timeline.js'); ?>" defer></script>

<!-- M√≥dulo del calendario (SIEMPRE AL FINAL) -->
<script src="<?php echo esc_url($module_js_url); ?>" defer></script>


========================================
FILE: includes\admin\ui\modules\clients\clients-module.js
========================================
/**
 * Clients Module - Module-specific JavaScript
 */

(function() {
    'use strict';

    // Estado del m√≥dulo
    let currentQuery = '';
    let currentOffset = 0;
    let currentLimit = 10;
    let hasNext = false;
    let hasPrev = false;
    let searchTimeout = null;

    /**
     * Crear contenido del formulario para nuevo cliente
     * @returns {HTMLElement} - Elemento del formulario
     */
    function createNewClientForm() {
        const form = document.createElement('form');
        form.id = 'aa-modal-form-cliente';
        form.className = 'aa-modal-form';

        // Campo: Nombre
        const nombreGroup = document.createElement('div');
        nombreGroup.className = 'aa-form-group';
        
        const nombreLabel = document.createElement('label');
        nombreLabel.setAttribute('for', 'modal-cliente-nombre');
        nombreLabel.textContent = 'Nombre completo *';
        
        const nombreInput = document.createElement('input');
        nombreInput.type = 'text';
        nombreInput.id = 'modal-cliente-nombre';
        nombreInput.name = 'nombre';
        nombreInput.required = true;
        nombreInput.placeholder = 'Ej: Juan P√©rez';
        
        nombreGroup.appendChild(nombreLabel);
        nombreGroup.appendChild(nombreInput);

        // Campo: Tel√©fono
        const telefonoGroup = document.createElement('div');
        telefonoGroup.className = 'aa-form-group';
        
        const telefonoLabel = document.createElement('label');
        telefonoLabel.setAttribute('for', 'modal-cliente-telefono');
        telefonoLabel.textContent = 'Tel√©fono *';
        
        const telefonoInput = document.createElement('input');
        telefonoInput.type = 'tel';
        telefonoInput.id = 'modal-cliente-telefono';
        telefonoInput.name = 'telefono';
        telefonoInput.required = true;
        telefonoInput.placeholder = 'Ej: 5512345678';
        
        telefonoGroup.appendChild(telefonoLabel);
        telefonoGroup.appendChild(telefonoInput);

        // Campo: Correo
        const correoGroup = document.createElement('div');
        correoGroup.className = 'aa-form-group';
        
        const correoLabel = document.createElement('label');
        correoLabel.setAttribute('for', 'modal-cliente-correo');
        correoLabel.textContent = 'Correo electr√≥nico *';
        
        const correoInput = document.createElement('input');
        correoInput.type = 'email';
        correoInput.id = 'modal-cliente-correo';
        correoInput.name = 'correo';
        correoInput.required = true;
        correoInput.placeholder = 'Ej: cliente@email.com';
        
        correoGroup.appendChild(correoLabel);
        correoGroup.appendChild(correoInput);

        // Mensaje de estado (para errores/√©xito)
        const statusMsg = document.createElement('div');
        statusMsg.id = 'modal-cliente-status';
        statusMsg.className = 'aa-form-status';
        statusMsg.style.display = 'none';

        // Ensamblar formulario
        form.appendChild(nombreGroup);
        form.appendChild(telefonoGroup);
        form.appendChild(correoGroup);
        form.appendChild(statusMsg);

        return form;
    }

    /**
     * Crear footer del modal con botones
     * @returns {HTMLElement} - Elemento del footer
     */
    function createModalFooter() {
        const footer = document.createElement('div');
        footer.className = 'aa-modal-actions';

        // Bot√≥n Cancelar
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'aa-btn-cancelar';
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.setAttribute('data-aa-modal-close', '');

        // Bot√≥n Guardar
        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.id = 'aa-modal-save-cliente';
        saveBtn.className = 'aa-btn-guardar';
        saveBtn.textContent = 'Guardar Cliente';

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);

        return footer;
    }

    /**
     * Mostrar mensaje de estado en el formulario
     */
    function showFormStatus(message, isError) {
        const statusEl = document.getElementById('modal-cliente-status');
        if (!statusEl) return;

        statusEl.textContent = message;
        statusEl.style.display = 'block';
        statusEl.className = 'aa-form-status ' + (isError ? 'aa-form-error' : 'aa-form-success');
    }

    /**
     * Guardar cliente via AJAX
     */
    function saveNewClient() {
        const form = document.getElementById('aa-modal-form-cliente');
        if (!form) return;

        const nombre = document.getElementById('modal-cliente-nombre').value.trim();
        const telefono = document.getElementById('modal-cliente-telefono').value.trim();
        const correo = document.getElementById('modal-cliente-correo').value.trim();

        // Validaci√≥n b√°sica
        if (!nombre || !telefono || !correo) {
            showFormStatus('Todos los campos son obligatorios.', true);
            return;
        }

        // Validar formato de correo
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(correo)) {
            showFormStatus('El correo electr√≥nico no es v√°lido.', true);
            return;
        }

        // Obtener nonce
        const nonce = window.AA_CLIENTS_NONCES ? window.AA_CLIENTS_NONCES.crear_cliente : '';
        if (!nonce) {
            showFormStatus('Error de seguridad: nonce no disponible.', true);
            return;
        }

        // Preparar datos
        const ajaxurl = window.ajaxurl || '/wp-admin/admin-ajax.php';
        const formData = new FormData();
        formData.append('action', 'aa_crear_cliente');
        formData.append('_ajax_nonce', nonce);
        formData.append('nombre', nombre);
        formData.append('telefono', telefono);
        formData.append('correo', correo);

        // Deshabilitar bot√≥n mientras se procesa
        const saveBtn = document.getElementById('aa-modal-save-cliente');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
        }

        // Llamar AJAX
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(result) {
            if (result.success) {
                showFormStatus('Cliente guardado correctamente.', false);
                
                // Cerrar modal despu√©s de 1 segundo y recargar lista
                setTimeout(function() {
                    if (window.AAAdmin && window.AAAdmin.closeModal) {
                        window.AAAdmin.closeModal();
                    }
                    // Recargar lista de clientes
                    currentOffset = 0;
                    searchClients();
                }, 1000);
            } else {
                const errorMsg = result.data && result.data.message 
                    ? result.data.message 
                    : 'Error al guardar el cliente.';
                showFormStatus(errorMsg, true);
                
                // Rehabilitar bot√≥n
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Cliente';
                }
            }
        })
        .catch(function(error) {
            console.error('Error AJAX:', error);
            showFormStatus('Error de conexi√≥n. Intenta de nuevo.', true);
            
            // Rehabilitar bot√≥n
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cliente';
            }
        });
    }

    /**
     * Abrir modal de nuevo cliente
     */
    function openNewClientModal() {
        if (!window.AAAdmin || !window.AAAdmin.openModal) {
            console.error('AAAdmin.openModal no est√° disponible');
            alert('Error: Sistema de modales no disponible');
            return;
        }

        const formContent = createNewClientForm();
        const footerContent = createModalFooter();

        window.AAAdmin.openModal({
            title: 'Nuevo Cliente',
            body: formContent,
            footer: footerContent
        });

        // Agregar event listener al bot√≥n guardar despu√©s de que el modal est√© abierto
        setTimeout(function() {
            const saveBtn = document.getElementById('aa-modal-save-cliente');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveNewClient);
            }

            // Focus en primer campo
            const nombreInput = document.getElementById('modal-cliente-nombre');
            if (nombreInput) {
                nombreInput.focus();
            }
        }, 100);
    }

    /**
     * Crear contenido del formulario para editar cliente
     * @param {Object} cliente - Datos del cliente a editar
     * @returns {HTMLElement} - Elemento del formulario
     */
    function createEditClientForm(cliente) {
        const form = document.createElement('form');
        form.id = 'aa-modal-form-editar-cliente';
        form.className = 'aa-modal-form';

        // Campo oculto: ID del cliente
        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.id = 'modal-editar-cliente-id';
        idInput.name = 'cliente_id';
        idInput.value = cliente.id || '';
        form.appendChild(idInput);

        // Campo: Nombre
        const nombreGroup = document.createElement('div');
        nombreGroup.className = 'aa-form-group';
        
        const nombreLabel = document.createElement('label');
        nombreLabel.setAttribute('for', 'modal-editar-cliente-nombre');
        nombreLabel.textContent = 'Nombre completo *';
        
        const nombreInput = document.createElement('input');
        nombreInput.type = 'text';
        nombreInput.id = 'modal-editar-cliente-nombre';
        nombreInput.name = 'nombre';
        nombreInput.required = true;
        nombreInput.value = cliente.nombre || '';
        nombreInput.placeholder = 'Ej: Juan P√©rez';
        
        nombreGroup.appendChild(nombreLabel);
        nombreGroup.appendChild(nombreInput);

        // Campo: Tel√©fono
        const telefonoGroup = document.createElement('div');
        telefonoGroup.className = 'aa-form-group';
        
        const telefonoLabel = document.createElement('label');
        telefonoLabel.setAttribute('for', 'modal-editar-cliente-telefono');
        telefonoLabel.textContent = 'Tel√©fono *';
        
        const telefonoInput = document.createElement('input');
        telefonoInput.type = 'tel';
        telefonoInput.id = 'modal-editar-cliente-telefono';
        telefonoInput.name = 'telefono';
        telefonoInput.required = true;
        telefonoInput.value = cliente.telefono || '';
        telefonoInput.placeholder = 'Ej: 5512345678';
        
        telefonoGroup.appendChild(telefonoLabel);
        telefonoGroup.appendChild(telefonoInput);

        // Campo: Correo
        const correoGroup = document.createElement('div');
        correoGroup.className = 'aa-form-group';
        
        const correoLabel = document.createElement('label');
        correoLabel.setAttribute('for', 'modal-editar-cliente-correo');
        correoLabel.textContent = 'Correo electr√≥nico *';
        
        const correoInput = document.createElement('input');
        correoInput.type = 'email';
        correoInput.id = 'modal-editar-cliente-correo';
        correoInput.name = 'correo';
        correoInput.required = true;
        correoInput.value = cliente.correo || '';
        correoInput.placeholder = 'Ej: cliente@email.com';
        
        correoGroup.appendChild(correoLabel);
        correoGroup.appendChild(correoInput);

        // Mensaje de estado (para errores/√©xito)
        const statusMsg = document.createElement('div');
        statusMsg.id = 'modal-editar-cliente-status';
        statusMsg.className = 'aa-form-status';
        statusMsg.style.display = 'none';

        // Ensamblar formulario
        form.appendChild(nombreGroup);
        form.appendChild(telefonoGroup);
        form.appendChild(correoGroup);
        form.appendChild(statusMsg);

        return form;
    }

    /**
     * Crear footer del modal de edici√≥n con botones
     * @returns {HTMLElement} - Elemento del footer
     */
    function createEditModalFooter() {
        const footer = document.createElement('div');
        footer.className = 'aa-modal-actions';

        // Bot√≥n Cancelar
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'aa-btn-cancelar';
        cancelBtn.textContent = 'Cancelar';
        cancelBtn.setAttribute('data-aa-modal-close', '');

        // Bot√≥n Guardar
        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.id = 'aa-modal-save-editar-cliente';
        saveBtn.className = 'aa-btn-guardar';
        saveBtn.textContent = 'Guardar Cambios';

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);

        return footer;
    }

    /**
     * Mostrar mensaje de estado en el formulario de edici√≥n
     */
    function showEditFormStatus(message, isError) {
        const statusEl = document.getElementById('modal-editar-cliente-status');
        if (!statusEl) return;

        statusEl.textContent = message;
        statusEl.style.display = 'block';
        statusEl.className = 'aa-form-status ' + (isError ? 'aa-form-error' : 'aa-form-success');
    }

    /**
     * Guardar cliente editado via AJAX
     */
    function saveEditedClient() {
        const form = document.getElementById('aa-modal-form-editar-cliente');
        if (!form) return;

        const clienteId = document.getElementById('modal-editar-cliente-id').value;
        const nombre = document.getElementById('modal-editar-cliente-nombre').value.trim();
        const telefono = document.getElementById('modal-editar-cliente-telefono').value.trim();
        const correo = document.getElementById('modal-editar-cliente-correo').value.trim();

        // Validaci√≥n b√°sica
        if (!clienteId || !nombre || !telefono || !correo) {
            showEditFormStatus('Todos los campos son obligatorios.', true);
            return;
        }

        // Validar formato de correo
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(correo)) {
            showEditFormStatus('El correo electr√≥nico no es v√°lido.', true);
            return;
        }

        // Obtener nonce
        const nonce = window.AA_CLIENTS_NONCES ? window.AA_CLIENTS_NONCES.editar_cliente : '';
        if (!nonce) {
            showEditFormStatus('Error de seguridad: nonce no disponible.', true);
            return;
        }

        // Preparar datos
        const ajaxurl = window.ajaxurl || '/wp-admin/admin-ajax.php';
        const formData = new FormData();
        formData.append('action', 'aa_editar_cliente');
        formData.append('_ajax_nonce', nonce);
        formData.append('cliente_id', clienteId);
        formData.append('nombre', nombre);
        formData.append('telefono', telefono);
        formData.append('correo', correo);

        // Deshabilitar bot√≥n mientras se procesa
        const saveBtn = document.getElementById('aa-modal-save-editar-cliente');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
        }

        // Llamar AJAX
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(result) {
            if (result.success) {
                showEditFormStatus('Cliente actualizado correctamente.', false);
                
                // Cerrar modal despu√©s de 1 segundo y recargar lista
                setTimeout(function() {
                    if (window.AAAdmin && window.AAAdmin.closeModal) {
                        window.AAAdmin.closeModal();
                    }
                    // Recargar lista de clientes
                    searchClients();
                }, 1000);
            } else {
                const errorMsg = result.data && result.data.message 
                    ? result.data.message 
                    : 'Error al actualizar el cliente.';
                showEditFormStatus(errorMsg, true);
                
                // Rehabilitar bot√≥n
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Guardar Cambios';
                }
            }
        })
        .catch(function(error) {
            console.error('Error AJAX:', error);
            showEditFormStatus('Error de conexi√≥n. Intenta de nuevo.', true);
            
            // Rehabilitar bot√≥n
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cambios';
            }
        });
    }

    /**
     * Abrir modal de editar cliente
     * @param {Object} cliente - Datos del cliente a editar
     */
    function openEditClientModal(cliente) {
        if (!window.AAAdmin || !window.AAAdmin.openModal) {
            console.error('AAAdmin.openModal no est√° disponible');
            alert('Error: Sistema de modales no disponible');
            return;
        }

        const formContent = createEditClientForm(cliente);
        const footerContent = createEditModalFooter();

        window.AAAdmin.openModal({
            title: 'Editar Cliente',
            body: formContent,
            footer: footerContent
        });

        // Agregar event listener al bot√≥n guardar despu√©s de que el modal est√© abierto
        setTimeout(function() {
            const saveBtn = document.getElementById('aa-modal-save-editar-cliente');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveEditedClient);
            }

            // Focus en primer campo
            const nombreInput = document.getElementById('modal-editar-cliente-nombre');
            if (nombreInput) {
                nombreInput.focus();
            }
        }, 100);
    }

    /**
     * Renderizar una tarjeta de cliente
     */
    function createClientCard(cliente) {
        // Crear tarjeta
        const card = document.createElement('div');
        card.className = 'aa-appointment-card';
        card.setAttribute('data-aa-card', '');

        // Header con nombre del cliente
        const header = document.createElement('div');
        header.className = 'aa-appointment-header';
        header.setAttribute('data-aa-card-toggle', '');
        header.textContent = cliente.nombre || 'Sin nombre';

        // Overlay wrapper
        const overlay = document.createElement('div');
        overlay.className = 'aa-card-overlay';

        // Body wrapper dentro del overlay
        const body = document.createElement('div');
        body.className = 'aa-card-body';

        // Mantener clase original para compatibilidad visual
        body.classList.add('aa-appointment-body');

        // Tel√©fono
        const telefono = document.createElement('div');
        telefono.textContent = 'Tel√©fono: ' + (cliente.telefono || 'N/A');
        body.appendChild(telefono);

        // Correo
        const correo = document.createElement('div');
        correo.textContent = 'Correo: ' + (cliente.correo || 'N/A');
        body.appendChild(correo);

        // Fecha de registro
        const fechaRegistro = document.createElement('div');
        fechaRegistro.textContent = 'Fecha de registro: ' + (cliente.created_at || 'N/A');
        body.appendChild(fechaRegistro);

        // Total de citas
        const totalCitas = document.createElement('div');
        totalCitas.textContent = 'Total de citas: ' + (cliente.total_citas || 0);
        body.appendChild(totalCitas);

        // Bot√≥n de editar
        const editButton = document.createElement('button');
        editButton.type = 'button';
        editButton.className = 'aa-btn-editar-cliente';
        editButton.title = 'Editar cliente';
        editButton.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg> Editar';
        
        // Event listener para abrir modal de edici√≥n
        editButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            openEditClientModal(cliente);
        });
        
        body.appendChild(editButton);

        // Ensamblar estructura: overlay > body > contenido
        overlay.appendChild(body);

        // Ensamblar tarjeta
        card.appendChild(header);
        card.appendChild(overlay);

        return card;
    }

    /**
     * Renderizar grid de tarjetas de clientes
     */
    function renderClientsGrid(clients) {
        // Obtener el contenedor
        const container = document.getElementById('aa-clients-grid');
        if (!container) {
            console.warn('Contenedor #aa-clients-grid no encontrado');
            return;
        }

        // Validar datos
        if (!Array.isArray(clients) || clients.length === 0) {
            container.innerHTML = '<p>No se encontraron clientes</p>';
            return;
        }

        // Limpiar contenedor
        container.innerHTML = '';

        // Renderizar cada tarjeta
        clients.forEach(function(cliente) {
            const card = createClientCard(cliente);
            container.appendChild(card);
        });
    }

    /**
     * Renderizar barra de acciones
     */
    function renderActionBar() {
        const container = document.getElementById('aa-clients-grid');
        if (!container) return;

        const parent = container.parentElement;
        if (!parent) return;

        // Verificar si ya existe la barra de acciones
        let actionBar = document.getElementById('aa-clients-action-bar');
        if (actionBar) {
            return; // Ya existe, no recrear
        }

        // Crear barra de acciones
        actionBar = document.createElement('div');
        actionBar.id = 'aa-clients-action-bar';
        actionBar.className = 'aa-clients-action-bar';

        // Input de b√∫squeda
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.id = 'aa-clients-search';
        searchInput.placeholder = 'Buscar por nombre, correo o tel√©fono';
        searchInput.className = 'aa-clients-search-input';

        // Bot√≥n "+ Nuevo"
        const newButton = document.createElement('button');
        newButton.id = 'aa-clients-new';
        newButton.textContent = '+ Nuevo';
        newButton.className = 'aa-clients-new-button';

        // Contenedor de paginaci√≥n
        const paginationContainer = document.createElement('div');
        paginationContainer.className = 'aa-clients-pagination';

        // Bot√≥n anterior
        const prevButton = document.createElement('button');
        prevButton.id = 'aa-clients-prev';
        prevButton.textContent = '‚Üê';
        prevButton.className = 'aa-clients-pagination-button';
        prevButton.disabled = true;

        // Bot√≥n siguiente
        const nextButton = document.createElement('button');
        nextButton.id = 'aa-clients-next';
        nextButton.textContent = '‚Üí';
        nextButton.className = 'aa-clients-pagination-button';
        nextButton.disabled = true;

        // Ensamblar paginaci√≥n
        paginationContainer.appendChild(prevButton);
        paginationContainer.appendChild(nextButton);

        // Ensamblar barra de acciones
        actionBar.appendChild(searchInput);
        actionBar.appendChild(newButton);
        actionBar.appendChild(paginationContainer);

        // Insertar antes del grid
        parent.insertBefore(actionBar, container);

        // Event listeners
        setupEventListeners();
    }

    /**
     * Configurar event listeners
     */
    function setupEventListeners() {
        const searchInput = document.getElementById('aa-clients-search');
        const prevButton = document.getElementById('aa-clients-prev');
        const nextButton = document.getElementById('aa-clients-next');
        const newButton = document.getElementById('aa-clients-new');

        // Bot√≥n "+ Nuevo" abre modal
        if (newButton) {
            newButton.addEventListener('click', function(event) {
                event.preventDefault();
                openNewClientModal();
            });
        }

        // B√∫squeda con debounce
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    currentQuery = searchInput.value.trim();
                    currentOffset = 0; // Reiniciar offset al buscar
                    searchClients();
                }, 300);
            });

            // B√∫squeda inmediata al presionar Enter
            searchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.keyCode === 13) {
                    event.preventDefault();
                    
                    // Cancelar cualquier debounce activo
                    clearTimeout(searchTimeout);
                    
                    // Actualizar query y reiniciar offset
                    currentQuery = searchInput.value.trim();
                    currentOffset = 0;
                    
                    // Ejecutar b√∫squeda inmediatamente
                    searchClients();
                }
            });
        }

        // Paginaci√≥n anterior
        if (prevButton) {
            prevButton.addEventListener('click', function() {
                if (hasPrev && currentOffset >= currentLimit) {
                    currentOffset -= currentLimit;
                    searchClients();
                }
            });
        }

        // Paginaci√≥n siguiente
        if (nextButton) {
            nextButton.addEventListener('click', function() {
                if (hasNext) {
                    currentOffset += currentLimit;
                    searchClients();
                }
            });
        }
    }

    /**
     * Actualizar estado de botones de paginaci√≥n y visibilidad del contenedor
     */
    function updatePaginationButtons(total, limit) {
        const paginationContainer = document.querySelector('.aa-clients-pagination');
        const prevButton = document.getElementById('aa-clients-prev');
        const nextButton = document.getElementById('aa-clients-next');

        // Ocultar completamente la paginaci√≥n si no hay m√°s de una p√°gina
        if (paginationContainer) {
            if (total && limit && total <= limit) {
                paginationContainer.style.display = 'none';
            } else {
                paginationContainer.style.display = '';
                
                // Actualizar estado de botones solo cuando la paginaci√≥n est√° visible
                if (prevButton) {
                    prevButton.disabled = !hasPrev;
                }

                if (nextButton) {
                    nextButton.disabled = !hasNext;
                }
            }
        }
    }

    /**
     * Buscar clientes via AJAX
     */
    function searchClients() {
        // Obtener ajaxurl
        const ajaxurl = window.ajaxurl || (typeof ajaxurl !== 'undefined' ? ajaxurl : '/wp-admin/admin-ajax.php');

        // Preparar datos
        const formData = new FormData();
        formData.append('action', 'aa_search_clientes');
        formData.append('query', currentQuery);
        formData.append('limit', currentLimit);
        formData.append('offset', currentOffset);

        // Mostrar estado de carga
        const container = document.getElementById('aa-clients-grid');
        if (container) {
            container.innerHTML = '<p>Cargando...</p>';
        }

        // Llamar AJAX
        fetch(ajaxurl, {
            method: 'POST',
            body: formData
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(result) {
            if (result.success && result.data) {
                const data = result.data;
                
                // Actualizar estado
                hasNext = data.has_next || false;
                hasPrev = data.has_prev || false;

                // Procesar clientes (agregar total_citas si no existe)
                const clients = (data.clients || []).map(function(cliente) {
                    // Si no tiene total_citas, calcularlo (o usar 0)
                    if (typeof cliente.total_citas === 'undefined') {
                        cliente.total_citas = 0;
                    }
                    return cliente;
                });

                // Renderizar grid
                renderClientsGrid(clients);

                // Actualizar botones de paginaci√≥n y visibilidad
                updatePaginationButtons(data.total, data.limit);
            } else {
                console.error('Error en b√∫squeda de clientes:', result);
                if (container) {
                    container.innerHTML = '<p>Error al cargar clientes</p>';
                }
            }
        })
        .catch(function(error) {
            console.error('Error AJAX:', error);
            if (container) {
                container.innerHTML = '<p>Error al cargar clientes</p>';
            }
        });
    }

    /**
     * Inicializar m√≥dulo
     */
    function init() {
        // Renderizar barra de acciones
        renderActionBar();

        // Siempre cargar datos via AJAX (ordenados por total_citas DESC)
        searchClients();
    }

    // Escuchar DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Clients module loaded');
        init();
    });

})();




========================================
FILE: includes\admin\ui\modules\clients\index.php
========================================
<?php
/**
 * Clients Module - Clients Management UI
 * 
 * This module handles:
 * - Display of clients list
 * - UI for adding/editing clients
 * - No business logic (data operations handled via AJAX)
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');
?>

<div class="max-w-5xl mx-auto py-2">
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECCI√ìN: Clientes
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 group" open>
        <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </span>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Clientes</h3>
                        <p class="text-sm text-gray-500 mt-0.5">Crea, busca o edita clientes</p>
                    </div>
                </div>
                <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </summary>
        
        <div class="p-3 transition-all duration-200">
            <div id="aa-clients-grid" class="aa-clients-grid"></div>
        </div>
    </details>

</div>

<script>
    // Garantizar ajaxurl global para el iframe
    if (typeof window.ajaxurl === 'undefined') {
        window.ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
    }
    
    // Nonces para operaciones de clientes
    window.AA_CLIENTS_NONCES = {
        crear_cliente: '<?php echo wp_create_nonce('aa_crear_cliente'); ?>',
        editar_cliente: '<?php echo wp_create_nonce('aa_editar_cliente'); ?>'
    };
</script>

<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'clients-module.js'); ?>" defer></script>



========================================
FILE: includes\admin\ui\modules\settings\index.php
========================================
<?php
/**
 * Settings Module - Configuration UI
 * 
 * This module handles:
 * - Display of settings form
 * - UI interactions for settings
 * - No business logic (data saving handled outside via WordPress Settings API)
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

// Get data for form
$schedule = get_option('aa_schedule', []);
$days = [
    'monday'    => 'Lunes',
    'tuesday'   => 'Martes',
    'wednesday' => 'Mi√©rcoles',
    'thursday'  => 'Jueves',
    'friday'    => 'Viernes',
    'saturday'  => 'S√°bado',
    'sunday'    => 'Domingo'
];
?>

<div class="max-w-5xl mx-auto py-2">
    
    <form method="post" action="<?php echo esc_url(admin_url('options.php')); ?>">
        <?php settings_fields('agenda_automatizada_settings'); ?>
        <?php do_settings_sections('agenda_automatizada_settings'); ?>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             SECCI√ìN: Horarios y Disponibilidad
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 overflow-hidden group">
            <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </span>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Horarios y Disponibilidad</h3>
                            <p class="text-sm text-gray-500 mt-0.5">Define los d√≠as y horarios de atenci√≥n</p>
                        </div>
                    </div>
                    <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </summary>
            
            <div class="p-3 transition-all duration-200">
                <div class="grid gap-3">
                    <?php foreach ($days as $key => $label): 
                        $enabled   = !empty($schedule[$key]['enabled']);
                        $intervals = $schedule[$key]['intervals'] ?? [];
                    ?>
                    <div class="aa-day-block group rounded-lg border border-gray-200 bg-gray-50/50 hover:border-blue-200 hover:bg-blue-50/30 transition-all duration-200 overflow-hidden <?php echo $enabled ? 'border-blue-200 bg-blue-50/40' : ''; ?>">
                        <div class="px-4 py-3 flex items-center justify-between">
                            <label class="flex items-center gap-3 cursor-pointer flex-1">
                                <div class="relative">
                                    <input type="checkbox" 
                                           name="aa_schedule[<?php echo esc_attr($key); ?>][enabled]" 
                                           value="1" 
                                           <?php checked($enabled, true); ?> 
                                           class="peer sr-only">
                                    <div class="w-11 h-6 bg-gray-300 peer-checked:bg-blue-500 rounded-full transition-colors duration-200"></div>
                                    <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform duration-200 peer-checked:translate-x-5"></div>
                                </div>
                                <span class="aa-day-name font-medium text-gray-700 select-none"><?php echo esc_html($label); ?></span>
                            </label>
                            
                            <?php if ($enabled && !empty($intervals)): ?>
                            <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded-full border border-gray-200">
                                <?php echo count($intervals); ?> intervalo<?php echo count($intervals) > 1 ? 's' : ''; ?>
                            </span>
                            <?php endif; ?>
                        </div>

                        <div class="day-intervals border-t border-gray-200 bg-white px-3 py-4 rounded-b-lg" 
                             data-day="<?php echo esc_attr($key); ?>" 
                             style="<?php echo $enabled ? '' : 'display:none;'; ?>">
                            
                            <div class="space-y-3">
                                <?php if (!empty($intervals)): ?>
                                    <?php foreach ($intervals as $i => $interval): ?>
                                    <div class="interval flex flex-wrap items-center gap-2 sm:gap-3" data-day="<?php echo esc_attr($key); ?>" data-index="<?php echo $i; ?>">
                                        <div class="aa-time-input-wrapper flex items-center gap-1">
                                            <input type="time" 
                                                   name="aa_schedule[<?php echo esc_attr($key); ?>][intervals][<?php echo $i; ?>][start]" 
                                                   value="<?php echo esc_attr($interval['start']); ?>" 
                                                   step="1800"
                                                   class="aa-timepicker-mobile w-[7rem] px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                                        </div>
                                        <span class="text-gray-400 font-light">-</span>
                                        <div class="aa-time-input-wrapper flex items-center gap-1">
                                            <input type="time" 
                                                   name="aa_schedule[<?php echo esc_attr($key); ?>][intervals][<?php echo $i; ?>][end]" 
                                                   value="<?php echo esc_attr($interval['end']); ?>" 
                                                   step="1800"
                                                   class="aa-timepicker-mobile w-[7rem] px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow">
                                        </div>
                                        <button type="button" 
                                                class="remove-interval ml-auto text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                                title="Eliminar intervalo">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </div>
                            
                            <button type="button" 
                                    class="add-interval mt-3 inline-flex items-center gap-2 px-3 py-1.5 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                A√±adir intervalo
                            </button>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </details>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             GRID: Servicios + Par√°metros (2 columnas en desktop)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="grid lg:grid-cols-2 gap-6 mb-6">

            <!-- SECCI√ìN: Tipos de Cita / Servicios -->
            <details class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden group">
                <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                </svg>
                            </span>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Tipos de Cita</h3>
                                <p class="text-sm text-gray-500 mt-0.5">Servicios que ofreces</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                </summary>
                
                <div class="p-6 transition-all duration-200" id="aa-motivos-container">
                    <ul id="aa-motivos-list" class="space-y-2 mb-4"></ul>

                    <div class="flex gap-2">
                        <input type="text" 
                               id="aa-motivo-input" 
                               placeholder="Ej: Corte de cabello" 
                               class="flex-1 px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow placeholder:text-gray-400">
                        <button type="button" 
                                id="aa-add-motivo" 
                                class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                            Agregar
                        </button>
                    </div>

                    <input type="hidden" name="aa_google_motivo" id="aa-google-motivo-hidden"
                        value='<?php echo esc_attr(get_option("aa_google_motivo", json_encode(["Cita general"]))); ?>'>
                </div>
            </details>

            <!-- SECCI√ìN: Par√°metros Generales -->
            <details class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden group">
                <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </span>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Par√°metros</h3>
                                <p class="text-sm text-gray-500 mt-0.5">Duraci√≥n y ventana de citas</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </div>
                </summary>
                
                <div class="p-6 space-y-5 transition-all duration-200">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_slot_duration">
                            Duraci√≥n de cada cita
                        </label>
                        <select name="aa_slot_duration" id="aa_slot_duration" 
                                class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-shadow">
                            <option value="30" <?php selected(get_option('aa_slot_duration', 30), 30); ?>>30 minutos</option>
                            <option value="60" <?php selected(get_option('aa_slot_duration', 30), 60); ?>>60 minutos</option>
                            <option value="90" <?php selected(get_option('aa_slot_duration', 30), 90); ?>>90 minutos</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_future_window">
                            Ventana de disponibilidad
                        </label>
                        <select name="aa_future_window" id="aa_future_window" 
                                class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-shadow">
                            <option value="15" <?php selected(get_option('aa_future_window', 15), 15); ?>>15 d√≠as</option>
                            <option value="30" <?php selected(get_option('aa_future_window', 15), 30); ?>>30 d√≠as</option>
                            <option value="45" <?php selected(get_option('aa_future_window', 15), 45); ?>>45 d√≠as</option>
                            <option value="60" <?php selected(get_option('aa_future_window', 15), 60); ?>>60 d√≠as</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1.5">L√≠mite para agendar citas en el futuro</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_timezone">
                            Zona horaria
                        </label>
                        <select name="aa_timezone" id="aa_timezone" 
                                class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 bg-white transition-shadow">
                            <?php
                            $saved_tz = get_option('aa_timezone', 'America/Mexico_City');
                            $timezones = [
                                'America/Mexico_City' => 'M√©xico (CDMX) - GMT-6',
                                'America/Cancun' => 'Canc√∫n - GMT-5',
                                'America/Tijuana' => 'Tijuana - GMT-8',
                                'America/Monterrey' => 'Monterrey - GMT-6',
                                'America/Bogota' => 'Colombia (Bogot√°) - GMT-5',
                                'America/Lima' => 'Per√∫ (Lima) - GMT-5',
                                'America/Argentina/Buenos_Aires' => 'Argentina - GMT-3',
                                'America/Santiago' => 'Chile (Santiago) - GMT-3',
                                'America/New_York' => 'EE.UU. (Este) - GMT-5',
                                'America/Los_Angeles' => 'EE.UU. (Pac√≠fico) - GMT-8',
                                'Europe/Madrid' => 'Espa√±a (Madrid) - GMT+1',
                                'Europe/London' => 'Reino Unido - GMT+0',
                            ];
                            foreach ($timezones as $value => $label) {
                                printf(
                                    '<option value="%s" %s>%s</option>',
                                    esc_attr($value),
                                    selected($saved_tz, $value, false),
                                    esc_html($label)
                                );
                            }
                            ?>
                        </select>
                    </div>
                </div>
            </details>

        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             SECCI√ìN: Datos del Negocio
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 overflow-hidden group">
            <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </span>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Datos del Negocio</h3>
                            <p class="text-sm text-gray-500 mt-0.5">Informaci√≥n para confirmaciones y recordatorios</p>
                        </div>
                    </div>
                    <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </summary>
            
            <div class="p-3 transition-all duration-200">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_business_name">
                            Nombre del negocio
                        </label>
                        <input type="text" name="aa_business_name" id="aa_business_name"
                               value="<?php echo esc_attr(get_option('aa_business_name', '')); ?>" 
                               placeholder="Ej: Sal√≥n de Belleza Mar√≠a"
                               class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow placeholder:text-gray-400">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa_whatsapp_number">
                            WhatsApp del negocio
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                            </span>
                            <input type="tel" name="aa_whatsapp_number" id="aa_whatsapp_number"
                                   value="<?php echo esc_attr(get_option('aa_whatsapp_number', '')); ?>" 
                                   placeholder="521234567890"
                                   pattern="[0-9]{10,15}"
                                   class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow placeholder:text-gray-400">
                        </div>
                        <p class="text-xs text-gray-500 mt-1.5">C√≥digo de pa√≠s + n√∫mero, sin espacios</p>
                    </div>

                    <div class="md:col-span-2">
                        <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="aa_is_virtual" value="1" 
                                       id="aa-is-virtual-checkbox"
                                       <?php checked(get_option('aa_is_virtual', 0), 1); ?>
                                       class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-300 peer-checked:bg-emerald-500 rounded-full transition-colors"></div>
                                <div class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform peer-checked:translate-x-5"></div>
                            </label>
                            <span class="text-sm text-gray-700">Las citas son virtuales (sin direcci√≥n f√≠sica)</span>
                        </div>
                    </div>

                    <div class="md:col-span-2" id="aa-address-row">
                        <label class="block text-sm font-medium text-gray-700 mb-2" for="aa-business-address">
                            Direcci√≥n f√≠sica
                        </label>
                        <textarea name="aa_business_address" 
                                  id="aa-business-address" 
                                  rows="2" 
                                  placeholder="Ej: Av. Reforma 123, Col. Centro, CDMX"
                                  class="w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-shadow placeholder:text-gray-400 resize-none"><?php echo esc_textarea(get_option('aa_business_address', '')); ?></textarea>
                    </div>
                </div>
            </div>
        </details>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             SECCI√ìN: Google Calendar
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <details class="bg-white rounded-xl shadow border border-gray-200 mb-6 overflow-hidden group">
            <summary class="px-4 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white cursor-pointer list-none">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 text-blue-600">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                            </svg>
                        </span>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Google Calendar</h3>
                            <p class="text-sm text-gray-500 mt-0.5">Sincroniza citas para evitar conflictos</p>
                        </div>
                    </div>
                    <svg class="aa-chevron w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </summary>
            
            <div class="p-3 transition-all duration-200">
                <?php 
                $google_email = get_option('aa_google_email', '');
                $is_sync_invalid = SyncService::is_sync_invalid();

                echo '<input type="hidden" name="aa_google_email" value="' . esc_attr($google_email) . '">';
                
                if ($google_email && !$is_sync_invalid): ?>
                    <!-- Estado: Conectado -->
                    <div class="flex flex-wrap items-center justify-between gap-3 p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            <span class="flex items-center justify-center w-10 h-10 rounded-full bg-emerald-100 flex-shrink-0">
                                <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </span>
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-medium text-emerald-700">Sincronizado</p>
                                <p class="text-sm text-emerald-600 truncate"><?php echo esc_html($google_email); ?></p>
                            </div>
                        </div>
                        <a href="<?php echo esc_url(admin_url('admin-post.php?action=aa_disconnect_google')); ?>" 
                           class="px-4 py-2 text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors whitespace-nowrap ml-auto">
                            Desconectar
                        </a>
                    </div>
                <?php elseif ($google_email && $is_sync_invalid): ?>
                    <!-- Estado: Requiere reconexi√≥n -->
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="flex items-start gap-3">
                            <span class="flex items-center justify-center w-10 h-10 rounded-full bg-amber-100 flex-shrink-0 mt-0.5">
                                <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                            </span>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-amber-800">Reconexi√≥n requerida</p>
                                <p class="text-sm text-amber-700 mt-1">El token ha caducado. Reconecta para seguir sincronizando.</p>
                                <p class="text-xs text-amber-600 mt-2">Cuenta anterior: <?php echo esc_html($google_email); ?></p>
                                <a href="<?php echo esc_url(SyncService::get_auth_url()); ?>" 
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="inline-flex items-center gap-2 mt-3 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-medium rounded-lg transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    Reconectar con Google
                                </a>
                            </div>
                        </div>
                    </div>
                <?php else: ?>
                    <!-- Estado: No conectado -->
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h4 class="text-base font-medium text-gray-900 mb-1">Sin sincronizaci√≥n</h4>
                        <p class="text-sm text-gray-500 mb-4 max-w-sm mx-auto">
                            Conecta tu cuenta de Google Calendar para sincronizar tus citas autom√°ticamente
                        </p>
                        <a href="<?php echo esc_url(SyncService::get_auth_url()); ?>" 
                           target="_blank"
                           rel="noopener noreferrer"
                           class="inline-flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg transition-colors shadow-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Conectar con Google
                        </a>
                    </div>
                <?php endif; ?>
            </div>
        </details>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
             BOT√ìN GUARDAR
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="-mx-4 lg:w-screen lg:relative lg:left-1/2 lg:-translate-x-1/2 lg:mx-0 px-4 lg:px-[calc((100vw-80rem)/2+1rem)] py-4 mt-6 flex justify-end">
            <button type="submit" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-lg shadow-blue-500/25 transition-all hover:shadow-xl hover:shadow-blue-500/30 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Guardar Configuraci√≥n
            </button>
        </div>

    </form>
</div>

<!-- Time picker logic handled in module.js -->

<!-- Module JS -->
<script src="<?php echo esc_url(plugin_dir_url(__FILE__) . 'module.js'); ?>"></script>



========================================
FILE: includes\admin\ui\modules\settings\module.js
========================================
/**
 * Settings Module - Module-specific JavaScript
 * 
 * Handles all UI logic for the Settings module:
 * - Motivos (appointment types) management
 * - Virtual address toggle
 * - Schedule intervals (day toggles, interval creation/deletion)
 * - Time input conversion (mobile vs desktop)
 * - Minute normalization (00/30 only)
 */

(function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Settings module loaded');

        // ================================
        // üîπ Motivos Management
        // ================================
        initMotivos();

        // ================================
        // üîπ Virtual Address Toggle
        // ================================
        initVirtualAddressToggle();

        // ================================
        // üîπ Schedule Intervals Management
        // ================================
        initDayToggles();
        initIntervals();
        convertInputsToDesktopSelectors();
        observeResizeChanges();
    });

    // ================================
    // üîπ UTILITY FUNCTIONS
    // ================================

    /**
     * Detect if current viewport is mobile
     * Uses media query and device characteristics for reliable detection in iframes
     */
    function isMobile() {
        // Use matchMedia for reliable detection (works in iframes)
        if (window.matchMedia && window.matchMedia('(max-width: 639px)').matches) {
            return true;
        }
        // Fallback: check for touch device characteristics
        if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) {
            // Touch device - check if viewport is small
            return window.innerWidth < 640;
        }
        // Final fallback for older browsers
        return window.innerWidth < 640;
    }

    /**
     * Parse HH:mm string to {hour, minute} object
     */
    function parseTime(timeStr) {
        if (!timeStr) return { hour: 0, minute: 0 };
        const [hour, minute] = timeStr.split(':').map(Number);
        return { hour: hour || 0, minute: minute || 0 };
    }

    /**
     * Format {hour, minute} to HH:mm string
     */
    function formatTime(hour, minute) {
        return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    }

    /**
     * Normalize minute to valid value (00 or 30)
     */
    function normalizeMinutes(minute) {
        if (minute < 15) return 0;
        if (minute >= 15 && minute < 45) return 30;
        return 0;
    }

    // ================================
    // üîπ MOTIVOS MANAGEMENT
    // ================================

    function initMotivos() {
        const hiddenInput = document.getElementById("aa-google-motivo-hidden");
        const motivosList = document.getElementById("aa-motivos-list");
        const addButton = document.getElementById("aa-add-motivo");
        const motivoInput = document.getElementById("aa-motivo-input");

        if (!hiddenInput || !motivosList || !addButton || !motivoInput) return;

        // Read saved motivos or use empty array
        let motivos = [];
        try {
            motivos = JSON.parse(hiddenInput.value || "[]");
            if (!Array.isArray(motivos)) motivos = [];
        } catch (e) {
            motivos = [];
        }

        function renderMotivos() {
            motivosList.innerHTML = "";
            motivos.forEach((motivo, index) => {
                const li = document.createElement("li");
                li.style.marginBottom = "5px";
                li.style.display = "flex";
                li.style.alignItems = "center";
                li.style.gap = "10px";

                li.innerHTML = `
                    <span class="flex-1">${motivo}</span>
                    <button type="button" class="remove-motivo ml-auto p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" data-index="${index}" title="Eliminar">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                `;
                motivosList.appendChild(li);
            });
            hiddenInput.value = JSON.stringify(motivos);
        }

        addButton.addEventListener("click", function () {
            const nuevo = motivoInput.value.trim();
            if (!nuevo) return;
            motivos.push(nuevo);
            motivoInput.value = "";
            renderMotivos();
        });

        motivosList.addEventListener("click", function (e) {
            if (e.target.classList.contains("remove-motivo")) {
                const index = parseInt(e.target.dataset.index, 10);
                motivos.splice(index, 1);
                renderMotivos();
            }
        });

        renderMotivos();
    }

    // ================================
    // üîπ VIRTUAL ADDRESS TOGGLE
    // ================================

    function initVirtualAddressToggle() {
        const virtualCheckbox = document.getElementById('aa-is-virtual-checkbox');
        const addressField = document.getElementById('aa-business-address');
        const addressRow = document.getElementById('aa-address-row');

        if (!virtualCheckbox || !addressField || !addressRow) return;

        function toggleAddressField() {
            if (virtualCheckbox.checked) {
                addressField.disabled = true;
                addressField.style.opacity = '0.5';
                addressRow.style.opacity = '0.6';
            } else {
                addressField.disabled = false;
                addressField.style.opacity = '1';
                addressRow.style.opacity = '1';
            }
        }

        toggleAddressField();
        virtualCheckbox.addEventListener('change', toggleAddressField);
    }

    // ================================
    // üîπ TIME INPUT CREATION
    // ================================

    /**
     * Create time selector (mobile: native input, desktop: select dropdowns)
     */
    function createTimeSelector(name, value) {
        const { hour, minute } = parseTime(value);
        const wrapper = document.createElement('div');
        wrapper.className = 'aa-time-input-wrapper flex items-center gap-1';
        
        if (isMobile()) {
            return createMobileTimeInput(wrapper, name, hour, minute);
        } else {
            return createDesktopTimeSelectors(wrapper, name, hour, minute);
        }
    }

    /**
     * Create mobile native time input
     */
    function createMobileTimeInput(wrapper, name, hour, minute) {
        const input = document.createElement('input');
        input.type = 'time';
        input.name = name;
        input.step = '1800'; // 30 minutes in seconds
        const normalizedM = normalizeMinutes(minute);
        input.value = formatTime(hour, normalizedM) || '00:00';
        input.className = 'aa-timepicker-mobile w-[7rem] px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow';
        wrapper.appendChild(input);
        return wrapper;
    }

    /**
     * Create desktop time selectors (hour + minute dropdowns)
     */
    function createDesktopTimeSelectors(wrapper, name, hour, minute) {
        const validMinutes = [0, 30];
        const normalizedMinute = normalizeMinutes(minute);

        // Hour selector
        const hourSelect = document.createElement('select');
        hourSelect.className = 'aa-time-hour w-16 px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white';
        
        for (let h = 0; h < 24; h++) {
            const option = document.createElement('option');
            option.value = h;
            option.textContent = String(h).padStart(2, '0');
            if (h === hour) option.selected = true;
            hourSelect.appendChild(option);
        }

        // Minute selector (only 00 and 30)
        const minuteSelect = document.createElement('select');
        minuteSelect.className = 'aa-time-minute w-16 px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow bg-white';
        
        validMinutes.forEach(m => {
            const option = document.createElement('option');
            option.value = m;
            option.textContent = String(m).padStart(2, '0');
            if (m === normalizedMinute) option.selected = true;
            minuteSelect.appendChild(option);
        });

        // Hidden input for form submission (HH:mm format)
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = name;
        hiddenInput.value = formatTime(hour, normalizedMinute);
        hiddenInput.className = 'aa-time-value';

        // Update hidden input when selectors change
        function updateHidden() {
            const h = parseInt(hourSelect.value);
            const m = parseInt(minuteSelect.value);
            const validM = validMinutes.includes(m) ? m : 0;
            hiddenInput.value = formatTime(h, validM);
        }
        hourSelect.addEventListener('change', updateHidden);
        minuteSelect.addEventListener('change', updateHidden);

        // Separator
        const colon = document.createElement('span');
        colon.className = 'text-gray-400';
        colon.textContent = ':';

        // Make wrapper clickable
        bindWrapperClicks(wrapper, hourSelect, colon);

        wrapper.appendChild(hourSelect);
        wrapper.appendChild(colon);
        wrapper.appendChild(minuteSelect);
        wrapper.appendChild(hiddenInput);
        
        return wrapper;
    }

    /**
     * Bind click and keyboard events to time wrapper
     */
    function bindWrapperClicks(wrapper, hourSelect, colon) {
        wrapper.style.cursor = 'pointer';
        wrapper.setAttribute('role', 'button');
        wrapper.setAttribute('tabindex', '0');
        
        wrapper.addEventListener('click', function(e) {
            if (e.target === wrapper || e.target === colon || (!e.target.closest('select'))) {
                e.preventDefault();
                e.stopPropagation();
                hourSelect.focus();
                hourSelect.click();
            }
        });
        
        wrapper.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                hourSelect.focus();
                hourSelect.click();
            }
        });
    }

    // ================================
    // üîπ DAY TOGGLES
    // ================================

    /**
     * Initialize day toggle checkboxes to show/hide intervals
     */
    function initDayToggles() {
        document.querySelectorAll(".aa-day-block input[type=checkbox]").forEach(checkbox => {
            checkbox.addEventListener("change", function() {
                const day = this.name.match(/\[(.*?)\]/)[1];
                const container = document.querySelector(`.day-intervals[data-day="${day}"]`);
                if (!container) return;
    
                if (this.checked) {
                    container.style.display = "block";
                } else {
                    // üî• CLAVE: limpiar intervalos al desactivar
                    const intervalsContainer = container.querySelector('.space-y-3');
                    if (intervalsContainer) {
                        intervalsContainer.innerHTML = '';
                    }
                    container.style.display = "none";
                }
            });
        });
    }
    

    // ================================
    // üîπ INTERVALS MANAGEMENT
    // ================================

    /**
     * Initialize interval containers and bind add/remove handlers
     */
    function initIntervals() {
        document.querySelectorAll(".day-intervals").forEach(container => {
            bindAddInterval(container);
            bindRemoveInterval(container);
        });
    }

    /**
     * Bind add interval button handler
     */
    function bindAddInterval(container) {
        container.addEventListener("click", function(e) {
            if (!e.target.classList.contains("add-interval")) return;
            
            e.preventDefault();
            const day = this.dataset.day;
            // Find the space-y-3 container that holds all intervals
            const intervalsContainer = this.querySelector('.space-y-3');
            if (!intervalsContainer) return;
            
            const index = intervalsContainer.querySelectorAll(".interval").length;

            const intervalDiv = document.createElement("div");
            intervalDiv.classList.add("interval");
            intervalDiv.classList.add("flex", "flex-wrap", "items-center", "gap-2", "sm:gap-3");
            intervalDiv.setAttribute('data-day', day);
            intervalDiv.setAttribute('data-index', index);

            const startWrapper = createTimeSelector(`aa_schedule[${day}][intervals][${index}][start]`, '00:00');
            const endWrapper = createTimeSelector(`aa_schedule[${day}][intervals][${index}][end]`, '23:30');

            const separator = document.createTextNode('-');
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-interval ml-auto p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors';
            removeBtn.title = 'Eliminar intervalo';
            removeBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
            `;

            intervalDiv.appendChild(startWrapper);
            intervalDiv.appendChild(separator);
            intervalDiv.appendChild(endWrapper);
            intervalDiv.appendChild(removeBtn);

            // Insert into the space-y-3 container, not directly into day-intervals
            intervalsContainer.appendChild(intervalDiv);
        });
    }

    /**
     * Bind remove interval button handler
     */
    function bindRemoveInterval(container) {
        container.addEventListener("click", function(e) {
            if (!e.target.classList.contains("remove-interval") && !e.target.closest(".remove-interval")) return;
            
            e.preventDefault();
            const interval = e.target.closest(".interval");
            if (interval) interval.remove();
        });
    }

    // ================================
    // üîπ INPUT CONVERSION
    // ================================

    /**
     * Convert existing mobile time inputs to desktop selectors if needed
     */
    function convertInputsToDesktopSelectors() {
        document.querySelectorAll('.aa-timepicker-mobile').forEach(input => {
            if (input.dataset.converted) return;
            
            if (!isMobile()) {
                const wrapper = input.closest('.aa-time-input-wrapper');
                if (!wrapper) return;
                
                const name = input.name;
                const value = input.value || '00:00';
                const newWrapper = createTimeSelector(name, value);
                
                if (wrapper.parentNode) {
                    wrapper.parentNode.replaceChild(newWrapper, wrapper);
                }
            } else {
                input.dataset.converted = 'true';
            }
        });
    }

    // ================================
    // üîπ RESIZE OBSERVATION
    // ================================

    /**
     * Observe window resize to reconvert inputs when switching mobile/desktop
     */
    function observeResizeChanges() {
        let resizeTimeout;
        let wasMobile = isMobile();
        
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                const nowMobile = isMobile();
                if (wasMobile !== nowMobile) {
                    // Device type changed, reload to re-render
                    location.reload();
                }
                wasMobile = nowMobile;
            }, 300);
        });
    }

})();



========================================
FILE: includes\admin\ui\README.md
========================================
# Admin UI Architecture

## Overview

This directory contains the admin UI layer that renders inside an iframe. This is **UI only** - no business logic.

## Directory Structure

```
ui/
‚îú‚îÄ‚îÄ index.php              # Entry point & router
‚îú‚îÄ‚îÄ shared/                # Reusable components
‚îÇ   ‚îú‚îÄ‚îÄ layout.php         # Main HTML structure
‚îÇ   ‚îú‚îÄ‚îÄ header.php         # Navigation header
‚îÇ   ‚îî‚îÄ‚îÄ footer.php         # Footer
‚îú‚îÄ‚îÄ modules/               # UI modules
‚îÇ   ‚îú‚îÄ‚îÄ settings/          # Settings module
‚îÇ   ‚îú‚îÄ‚îÄ services/          # Services module
‚îÇ   ‚îî‚îÄ‚îÄ calendar/          # Calendar module
‚îî‚îÄ‚îÄ assets/                # Static assets
    ‚îú‚îÄ‚îÄ css/
    ‚îÇ   ‚îî‚îÄ‚îÄ admin.css      # Tailwind CSS entry point
    ‚îî‚îÄ‚îÄ js/
        ‚îî‚îÄ‚îÄ main.js        # Shared JavaScript
```

## How It Works

1. **Entry Point** (`index.php`): Routes to modules based on `?module=` query parameter
2. **Layout** (`shared/layout.php`): Provides HTML structure, loads CSS/JS
3. **Modules**: Each module has its own `index.php` (view) and `module.js` (module-specific JS)
4. **Assets**: Shared CSS (Tailwind) and JS utilities

## Adding a New Module

1. Create folder: `modules/your-module/`
2. Add `index.php` with your module's HTML
3. Add `module.js` for module-specific JavaScript
4. Add navigation link in `shared/header.php`

## Important Notes

- **No business logic** in this layer
- All data operations happen via AJAX to WordPress endpoints
- Use Tailwind CSS classes for styling
- Keep modules isolated and independent




========================================
FILE: includes\admin\ui\shared\footer.php
========================================
<?php
/**
 * Shared Footer - Footer content
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');
?>
<footer class="border-t border-gray-200 bg-gray-50/50 flex-shrink-0">
    <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-center gap-2">
            <p class="text-xs text-gray-500">
                Agenda Automatizada
            </p>
            <span class="text-gray-300">‚Ä¢</span>
            <p class="text-xs text-gray-500">
                v2.0.0
            </p>
        </div>
    </div>
</footer>




========================================
FILE: includes\admin\ui\shared\header.php
========================================
<?php
/**
 * Shared Header - Compact tab navigation with icons
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');
?>
<header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="px-4 py-3">
        <!-- Branding + Action Button Row -->
        <div class="flex items-center justify-between mb-3">
            <!-- Left: Branding -->
            <div class="flex items-center gap-2">
                <span class="flex items-center justify-center w-7 h-7 rounded-lg bg-blue-100 text-blue-600 flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </span>
                <h1 class="text-sm font-semibold text-gray-900 truncate">Agenda Automatizada</h1>
            </div>
            
            <!-- Right: Appointments + Notifications + Agendar Button -->
            <div class="flex items-center gap-2">
                <!-- Group: Small icon buttons (Explorer + Notifications) -->
                <div class="flex items-center gap-0">
                    <!-- Appointments Explorer Button -->
                    <button 
                        id="aa-btn-open-appointments-modal" 
                        type="button"
                        class="inline-flex items-center justify-center w-9 h-9 text-gray-500 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                        aria-label="Ver citas"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M15 19H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8" />
                            <circle cx="11" cy="11" r="2.5" stroke-width="2" />
                            <path stroke-linecap="round" stroke-width="2" d="M13.2 12.8L15.6 15.2" />
                        </svg>
                    </button>
                    
                    <!-- Notifications Container (relative for popover positioning) -->
                    <div class="relative">
                        <!-- Notifications Bell -->
                        <button 
                            id="aa-btn-notifications" 
                            type="button"
                            class="inline-flex items-center justify-center w-9 h-9 text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                            aria-label="Notificaciones"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                        </button>
                        <span id="aa-notifications-badge" class="absolute top-0 right-2 text-xs font-medium text-gray-500 leading-none">0</span>
                        
                        <!-- Notifications Popover (hidden by default) -->
                        <div id="aa-notifications-popover" class="hidden absolute right-0 top-full mt-2 z-50 w-80 bg-white rounded-lg shadow-lg border border-gray-200">
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-semibold text-gray-900">Notificaciones</h3>
                                    <button 
                                        id="aa-btn-close-notifications" 
                                        type="button"
                                        class="text-gray-400 hover:text-gray-600 transition-colors"
                                        aria-label="Cerrar"
                                    >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="aa-notifications-content">
                                    <!-- Content will be rendered dynamically by notifications.js -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Agendar Button -->
                <button 
                    id="aa-btn-open-reservation-modal" 
                    type="button"
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    <span>Agendar</span>
                </button>
            </div>
        </div>
        
        <!-- Tab Navigation - Icon above, label below -->
        <nav class="flex items-center justify-center gap-2">
            <!-- Configuraci√≥n -->
            <a href="<?php echo esc_url(admin_url('admin-post.php?action=aa_iframe_content&module=settings')); ?>" 
               class="flex flex-col items-center justify-center min-w-[60px] px-2 py-2 rounded-lg transition-all <?php echo (isset($active_module) && $active_module === 'settings') ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'; ?>">
                <span class="flex items-center justify-center w-6 h-6 mb-1 <?php echo (isset($active_module) && $active_module === 'settings') ? 'text-blue-600' : 'text-gray-500'; ?>">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </span>
                <span class="text-xs font-medium leading-tight text-center">Config</span>
            </a>
            
            <!-- Calendario -->
            <a href="<?php echo esc_url(admin_url('admin-post.php?action=aa_iframe_content&module=calendar')); ?>" 
               class="flex flex-col items-center justify-center min-w-[60px] px-2 py-2 rounded-lg transition-all <?php echo (isset($active_module) && $active_module === 'calendar') ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'; ?>">
                <span class="flex items-center justify-center w-6 h-6 mb-1 <?php echo (isset($active_module) && $active_module === 'calendar') ? 'text-blue-600' : 'text-gray-500'; ?>">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </span>
                <span class="text-xs font-medium leading-tight text-center">Calendario</span>
            </a>
            
            <!-- Clientes -->
            <a href="<?php echo esc_url(admin_url('admin-post.php?action=aa_iframe_content&module=clients')); ?>" 
               class="flex flex-col items-center justify-center min-w-[60px] px-2 py-2 rounded-lg transition-all <?php echo (isset($active_module) && $active_module === 'clients') ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'; ?>">
                <span class="flex items-center justify-center w-6 h-6 mb-1 <?php echo (isset($active_module) && $active_module === 'clients') ? 'text-blue-600' : 'text-gray-500'; ?>">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </span>
                <span class="text-xs font-medium leading-tight text-center">Clientes</span>
            </a>
            
            <!-- Asignaciones -->
            <a href="<?php echo esc_url(admin_url('admin-post.php?action=aa_iframe_content&module=assignments')); ?>" 
               class="flex flex-col items-center justify-center min-w-[60px] px-2 py-2 rounded-lg transition-all <?php echo (isset($active_module) && $active_module === 'assignments') ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'; ?>">
                <span class="flex items-center justify-center w-6 h-6 mb-1 <?php echo (isset($active_module) && $active_module === 'assignments') ? 'text-blue-600' : 'text-gray-500'; ?>">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </span>
                <span class="text-xs font-medium leading-tight text-center">Asignaciones</span>
            </a>
        </nav>
    </div>
</header>




========================================
FILE: includes\admin\ui\shared\layout.php
========================================
<?php
/**
 * Shared Layout - Main HTML structure for admin UI
 * 
 * This file provides:
 * - HTML document structure
 * - Tailwind CSS inclusion
 * - Shared header/navigation
 * - Module content area
 * - Shared footer
 * - Shared scripts (utils, services, adapters)
 * - Transversal modals (reservation, etc.)
 * - Admin reservation system (migrated from enqueueController.php)
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

// Get module name and path from parent scope (set in index.php)
$active_module = isset($active_module) ? $active_module : 'settings';
$module_path = isset($module_path) ? $module_path : '';

// ============================================
// üîπ PREPARE DATA FOR JS (antes del HTML)
// ============================================

// Configuraci√≥n general
$timezone = get_option('aa_timezone', 'America/Mexico_City');
$schedule = get_option('aa_schedule', []);
$future_window = intval(get_option('aa_future_window', 15));
$slot_duration = intval(get_option('aa_slot_duration', 60));
$email = sanitize_email(get_option('aa_google_email', ''));

// Datos de disponibilidad local (reservas confirmadas)
global $wpdb;
$table = $wpdb->prefix . 'aa_reservas';
$slot_duration_db = intval(get_option('aa_slot_duration', 60));
$timezone_string = get_option('aa_timezone', 'America/Mexico_City');

// Obtener hora actual seg√∫n timezone del negocio
try {
    $tz = new DateTimeZone($timezone_string);
    $now = new DateTime('now', $tz);
    $now_str = $now->format('Y-m-d H:i:s');
} catch (Exception $e) {
    $now_str = current_time('mysql');
}

$confirmed = $wpdb->get_results($wpdb->prepare("
    SELECT 
        fecha as start,
        DATE_ADD(fecha, INTERVAL duracion MINUTE) as end,
        servicio as title,
        nombre as attendee
    FROM $table 
    WHERE estado = 'confirmed' 
    AND DATE_ADD(fecha, INTERVAL duracion MINUTE) >= %s
    ORDER BY fecha ASC
", $now_str));

$local_busy = [];
foreach ($confirmed as $row) {
    $local_busy[] = [
        'start' => $row->start,
        'end' => $row->end,
        'title' => $row->title,
        'attendee' => $row->attendee
    ];
}

// Send headers
header('Content-Type: text/html; charset=utf-8');
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Automatizada - Admin</title>
    
    <!-- Tailwind CSS (usando constante global para URL limpia) -->
    <link rel="stylesheet" href="<?php echo esc_url(AA_PLUGIN_URL . 'includes/admin/ui/assets/css/admin.css'); ?>">
    
    <!-- Flatpickr CSS (requerido por calendario y modales) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
</head>
<body class="flex flex-col min-h-screen" style="background-color: rgb(240, 240, 241);">

<!-- ============================================
     üîπ GLOBAL DATA (antes de cualquier script)
     ============================================ -->
<script>
    // Variables globales requeridas por servicios y controladores
    window.ajaxurl = '<?php echo esc_js(admin_url('admin-ajax.php')); ?>';
    
    // Variables para ReservationService
    window.wpaa_vars = {
        ajax_url: '<?php echo esc_js(admin_url('admin-ajax.php')); ?>',
        timezone: '<?php echo esc_js($timezone); ?>',
        locale: 'es-MX',
        nonce: '<?php echo esc_js(wp_create_nonce('aa_reservation_nonce')); ?>'
    };
    
    // Configuraci√≥n de disponibilidad
    window.aa_backend = {
        ajax_url: '<?php echo esc_js(admin_url('admin-ajax.php')); ?>',
        action: 'aa_get_availability',
        email: '<?php echo esc_js($email); ?>',
        gsync_status: '<?php echo esc_js(get_option("aa_estado_gsync", "active")); ?>'
    };
    
    window.aa_schedule = <?php echo wp_json_encode($schedule); ?>;
    window.aa_future_window = <?php echo intval($future_window); ?>;
    window.aa_slot_duration = <?php echo intval($slot_duration); ?>;
    
    // Disponibilidad local (reservas confirmadas de BD)
    window.aa_local_availability = {
        local_busy: <?php echo wp_json_encode($local_busy); ?>,
        slot_duration: <?php echo intval($slot_duration); ?>,
        timezone: '<?php echo esc_js($timezone); ?>',
        total_confirmed: <?php echo count($local_busy); ?>
    };
    
    // Nonces para acciones admin
    window.aa_asistant_vars = {
        nonce_confirmar: '<?php echo esc_js(wp_create_nonce('aa_confirmar_cita')); ?>',
        nonce_cancelar: '<?php echo esc_js(wp_create_nonce('aa_cancelar_cita')); ?>',
        nonce_crear_cliente: '<?php echo esc_js(wp_create_nonce('aa_crear_cliente')); ?>',
        nonce_crear_cita: '<?php echo esc_js(wp_create_nonce('aa_reservation_nonce')); ?>',
        nonce_crear_cliente_desde_cita: '<?php echo esc_js(wp_create_nonce('aa_crear_cliente_desde_cita')); ?>',
        nonce_editar_cliente: '<?php echo esc_js(wp_create_nonce('aa_editar_cliente')); ?>'
    };
</script>

<!-- ============================================
     üîπ SHARED ADMIN JS (orden cr√≠tico)
     ============================================ -->

<!-- Shared Admin JS (AAAdmin namespace) -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'includes/admin/ui/assets/js/main.js'); ?>" defer></script>

<!-- Notifications -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'includes/admin/ui/assets/js/notifications.js'); ?>" defer></script>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js" defer></script>

<!-- Utils -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/utils/dateUtils.js'); ?>" defer></script>

<!-- UI Components -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/ui/calendarAdminUI.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/ui/slotSelectorAdminUI.js'); ?>" defer></script>

<!-- Availability Services (orden de dependencias) -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availability/proxyFetch.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availability/combineLocalExternal.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availability/busyRanges.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availability/slotCalculator.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availabilityService.js'); ?>" defer></script>

<!-- Availability Services - Assignments (parallel, non-legacy) -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availability/availabilityAssignments.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/availability/busyRangesAssignments.js'); ?>" defer></script>

<!-- Other Services -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/reservationService.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/adminCalendarService.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/services/confirmService.js'); ?>" defer></script>

<!-- Controllers -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/controllers/availabilityController.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/controllers/adminReservationController.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/controllers/adminCalendarController.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/controllers/adminConfirmController.js'); ?>" defer></script>
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/controllers/appointmentsController.js'); ?>" defer></script>

<!-- UI Adapters -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'assets/js/ui-adapters/datePickerAdapter.js'); ?>" defer></script>

<!-- Transversal Modal: Reservation (√∫ltimo, usa todos los anteriores) -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'includes/admin/ui/modals/reservation/reservation.js'); ?>" defer></script>

<!-- Transversal Modal: Appointments -->
<script src="<?php echo esc_url(AA_PLUGIN_URL . 'includes/admin/ui/modals/appointments/appointments-modal.js'); ?>" defer></script>

    <div id="aa-admin-app" class="w-full">
        <?php require_once __DIR__ . '/header.php'; ?>
        
        <main id="aa-admin-content" class="flex-1 px-4 py-8">

            <?php
            // Load module content
            if (file_exists($module_path)) {
                require_once $module_path;
            } else {
                echo '<div class="p-4 bg-red-50 text-red-700 rounded">M√≥dulo no encontrado.</div>';
            }
            ?>
        </main>
        
        <?php require_once __DIR__ . '/footer.php'; ?>
    </div>

    <!-- Shared Modals (base structure) -->
    <?php require_once __DIR__ . '/modals.php'; ?>
    
    <!-- Transversal Modal Templates (uses <template> tag, content not rendered until cloned by JS) -->
    <?php require_once dirname(__DIR__) . '/modals/reservation/index.php'; ?>
    <?php require_once dirname(__DIR__) . '/modals/appointments/index.php'; ?>

</body>
</html>
<?php
// Terminate execution to prevent WordPress output
die();




========================================
FILE: includes\admin\ui\shared\modals.php
========================================
<?php
/**
 * Shared Modals - Base HTML structure for modal system
 * 
 * This file provides:
 * - Root container for modals
 * - Overlay for backdrop
 * - Modal structure (header, body, footer)
 * - Close button and data attributes
 * 
 * No PHP logic, only HTML structure.
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');
?>

<!-- Modal System Root -->
<div id="aa-modal-root" class="aa-modal-root hidden">
    <!-- Overlay (backdrop) -->
    <div class="aa-modal-overlay" data-aa-modal-close></div>
    
    <!-- Modal Container -->
    <div class="aa-modal">
        <!-- Modal Header -->
        <div class="aa-modal-header">
            <h2 class="aa-modal-title"></h2>
            <button type="button" class="aa-modal-close" data-aa-modal-close aria-label="Cerrar">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="aa-modal-body"></div>
        
        <!-- Modal Footer -->
        <div class="aa-modal-footer"></div>
    </div>
</div>




========================================
FILE: includes\admin\ui\TAILWIND.md
========================================
# Tailwind CSS Setup for Admin UI

## Overview

Tailwind CSS is configured **only** for the iframe-based admin UI located in `includes/admin/ui/`.

The iframe is completely isolated from WordPress admin styles, so Tailwind can safely use its preflight (CSS reset) without affecting WordPress.

## Installation

1. Install dependencies:
```bash
npm install
```

## Build Commands

### Development (Watch Mode)
Watch for changes and automatically rebuild CSS:
```bash
npm run watch:css
```

### Production Build
Build minified CSS for production:
```bash
npm run build:css
```

## Configuration

- **Config file**: `tailwind.config.js` (root of plugin)
- **CSS entry**: `includes/admin/ui/assets/css/admin.css`
- **Content scanning**: Only scans files in `includes/admin/ui/**/*.php` and `includes/admin/ui/**/*.js`

## How It Works

1. Tailwind scans PHP and JS files in the `includes/admin/ui/` directory
2. It extracts all Tailwind utility classes used in those files
3. It generates CSS with only the classes that are actually used
4. The compiled CSS is written back to `admin.css`
5. The iframe loads this CSS file (already configured in `layout.php`)

## Important Notes

- **Scope**: Tailwind ONLY affects the iframe UI. It does NOT affect WordPress admin or frontend.
- **Isolation**: The iframe is a separate HTML document, so Tailwind's preflight is safe to use.
- **Mobile-first**: Tailwind uses mobile-first breakpoints by default.
- **No prefix needed**: Since it's isolated in an iframe, no prefix is required.

## Usage in PHP Files

Use Tailwind classes directly in your PHP templates:

```php
<div class="bg-white rounded-lg shadow-sm p-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Title</h2>
    <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Click me
    </button>
</div>
```

## Usage in JavaScript

You can also use Tailwind classes in dynamically generated HTML:

```javascript
const element = document.createElement('div');
element.className = 'p-4 bg-gray-50 rounded-md';
```

## Custom Styles

Add custom CSS after the Tailwind directives in `admin.css`:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Your custom styles here */
.custom-component {
    /* ... */
}
```




========================================
FILE: includes\auth-helper.php
========================================
<?php
if (!defined('ABSPATH')) exit;

/**
 * Obtiene el dominio limpio para identificar al cliente en el backend.
 * Para localhost, incluye el primer nivel del path para diferenciar instalaciones.
 * 
 * Ejemplos:
 *   http://localhost/wpagenda -> localhost/wpagenda
 *   http://localhost/agendatheme -> localhost/agendatheme
 *   https://www.example.com/ -> example.com
 *   https://sitio.deoia.com -> sitio.deoia.com
 * 
 * @return string Dominio limpio
 */
function aa_get_clean_domain() {
    $site_url = get_site_url();
    $parsed = parse_url($site_url);
    
    $host = $parsed['host'] ?? 'localhost';
    
    // Si tiene puerto no est√°ndar, agregarlo
    if (!empty($parsed['port']) && $parsed['port'] != 80 && $parsed['port'] != 443) {
        $host .= ':' . $parsed['port'];
    }
    
    // Eliminar www.
    $host = preg_replace('/^www\./', '', $host);
    
    // üîπ Si es localhost, incluir el primer nivel del path para diferenciar instalaciones
    if ($host === 'localhost' || strpos($host, 'localhost:') === 0 || $host === '127.0.0.1') {
        $path = trim($parsed['path'] ?? '', '/');
        $first_path = explode('/', $path)[0] ?? '';
        
        if (!empty($first_path)) {
            return $host . '/' . $first_path;
        }
    }
    
    return $host;
}

/**
 * Env√≠a una petici√≥n autenticada con HMAC al backend
 * 
 * @param string $endpoint URL completa del endpoint (ej: 'http://localhost:3000/correo/confirmacion')
 * @param string $method M√©todo HTTP ('GET' o 'POST')
 * @param array $data Datos a enviar (opcional para GET, requerido para POST)
 * @return array|WP_Error Respuesta del backend o error
 */
function aa_send_authenticated_request($endpoint, $method = 'POST', $data = []) {
    // üîπ Usar la funci√≥n centralizada para obtener el domain
    $domain = aa_get_clean_domain();
    
    $client_secret = get_option('aa_client_secret');
    
    if (!$client_secret) {
        error_log("‚ùå aa_auth: No hay client_secret configurado");
        return new WP_Error('no_secret', 'Client secret no configurado. Conecta con Google primero.');
    }

    // üîπ Generar timestamp y nonce
    $timestamp = round(microtime(true) * 1000); // epoch en milisegundos
    $nonce = wp_generate_uuid4(); // UUID √∫nico
    
    // üîπ Preparar el body (vac√≠o si es GET)
    // ‚úÖ IMPORTANTE: JSON sin espacios para que coincida con el backend
    $body = '';
    if ($method === 'POST' && !empty($data)) {
        $json = json_encode($data, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
        // Eliminar espacios despu√©s de : y ,
        $body = preg_replace('/:\s+/', ':', $json);
        $body = preg_replace('/,\s+/', ',', $body);
    }
    
    // üîπ Extraer path + query string
    $parsed = parse_url($endpoint);
    $path = $parsed['path'] ?? '/';
    if (!empty($parsed['query'])) {
        $path .= '?' . $parsed['query'];
    }
    
    // üîπ Construir mensaje a firmar: METHOD + PATH + BODY + TIMESTAMP + NONCE
    $message = $method . $path . $body . $timestamp . $nonce;
    
    // üîπ Calcular firma HMAC-SHA256
    $signature = hash_hmac('sha256', $message, $client_secret);
    
    // üîπ Headers de autenticaci√≥n
    $headers = [
        'Content-Type' => 'application/json',
        'X-Client-Id' => $domain,
        'X-Timestamp' => (string)$timestamp,
        'X-Nonce' => $nonce,
        'X-Signature' => $signature,
        'X-Client-Secret' => $client_secret,
    ];
    
    // üîπ Configurar argumentos para wp_remote_request
    $args = [
        'headers' => $headers,
        'method' => $method,
        'timeout' => 30,
    ];
    
    if ($method === 'POST' && $body) {
        $args['body'] = $body;
    }
    
    // üîπ Log mejorado
    error_log("üîê aa_auth: Enviando request autenticado");
    error_log("   Domain: $domain");
    error_log("   Client Secret (primeros 10 chars): " . substr($client_secret, 0, 10) . "...");
    error_log("   Method: $method");
    error_log("   Path: $path");
    error_log("   Body length: " . strlen($body));
    error_log("   Body compacto: " . $body);
    error_log("   Timestamp: $timestamp");
    error_log("   Message to sign: " . substr($message, 0, 200) . "...");
    error_log("   Signature: $signature");
    
    return wp_remote_request($endpoint, $args);
}


========================================
FILE: includes\controllers\availability-controller.php
========================================
<?php
/**
 * Controlador: Disponibilidad Local
 */

if (!defined('ABSPATH')) exit;

require_once plugin_dir_path(__FILE__) . '../models/ReservationsModel.php';
require_once plugin_dir_path(__FILE__) . '../services/availability-proxy.php';

/**
 * Hook para encolar datos de disponibilidad local en el FRONTEND
 * Prioridad 20 para ejecutarse DESPU√âS de wpaa_enqueue_frontend_assets (10)
 */
add_action('wp_enqueue_scripts', 'aa_enqueue_local_availability_data', 20);

function aa_enqueue_local_availability_data() {
    global $post;
    if (!is_a($post, 'WP_Post') || !has_shortcode($post->post_content, 'agenda_automatizada')) {
        return;
    }
    
    // ‚úÖ Verificar que el script est√© encolado antes de localizarlo
    if (!wp_script_is('wpaa-availability-controller', 'enqueued')) {
        error_log("‚ö†Ô∏è [AvailabilityController-Frontend] wpaa-availability-controller NO est√° encolado");
        return;
    }
    
    $local_busy = ReservationsModel::get_internal_busy_slots();
    
    error_log("üìä [AvailabilityController-Frontend] Slots ocupados locales: " . count($local_busy));
    
    $availability_config = [
        'local_busy' => $local_busy,
        'slot_duration' => intval(get_option('aa_slot_duration', 60)),
        'timezone' => get_option('aa_timezone', 'America/Mexico_City'),
        'total_confirmed' => ReservationsModel::count_confirmed(),
    ];
    
    wp_localize_script(
        'wpaa-availability-controller',
        'aa_local_availability',
        $availability_config
    );
    
    error_log("‚úÖ [AvailabilityController-Frontend] Datos locales enviados");
}

/**
 * Hook para encolar datos de disponibilidad local en el ADMIN
 * Prioridad 20 para ejecutarse DESPU√âS de wpaa_enqueue_admin_assets (10)
 */
add_action('admin_enqueue_scripts', 'aa_enqueue_admin_local_availability_data', 20);

function aa_enqueue_admin_local_availability_data($hook) {
    if ($hook !== 'toplevel_page_aa_asistant_panel' && $hook !== 'agenda-automatizada_page_aa_asistant_panel') {
        return;
    }
    
    // ‚úÖ Verificar que el script est√© encolado
    if (!wp_script_is('wpaa-availability-controller-admin', 'enqueued')) {
        error_log("‚ö†Ô∏è [AvailabilityController-Admin] wpaa-availability-controller-admin NO est√° encolado");
        return;
    }
    
    $local_busy = ReservationsModel::get_internal_busy_slots();
    
    error_log("üìä [AvailabilityController-Admin] Slots ocupados locales: " . count($local_busy));
    
    $availability_config = [
        'local_busy' => $local_busy,
        'slot_duration' => intval(get_option('aa_slot_duration', 60)),
        'timezone' => get_option('aa_timezone', 'America/Mexico_City'),
        'total_confirmed' => ReservationsModel::count_confirmed(),
    ];
    
    wp_localize_script(
        'wpaa-availability-controller-admin',
        'aa_local_availability',
        $availability_config
    );
    
    error_log("‚úÖ [AvailabilityController-Admin] Datos locales enviados");
}


========================================
FILE: includes\controllers\confirmController.php
========================================
<?php
/**
 * Controlador: Confirmaci√≥n de Citas
 * 
 * Responsable de:
 * - Validar peticiones AJAX para confirmaci√≥n desde admin
 * - Validar peticiones AJAX para env√≠o de correos de confirmaci√≥n
 * - Gestionar endpoint REST API para confirmaci√≥n desde el backend
 * - Validar nonces y permisos
 * - Sanitizar par√°metros
 * - Delegar a confirm-backend-service.php
 * - Retornar respuestas JSON
 * 
 * NO contiene l√≥gica de negocio, ni actualizaciones de BD directas.
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Controllers
 */

if (!defined('ABSPATH')) exit;

// üîπ Incluir servicios necesarios
require_once plugin_dir_path(__FILE__) . '../services/confirm-backend-service.php';
require_once plugin_dir_path(__FILE__) . '../models/ReservationsModel.php';

// ===============================
// üîπ AJAX: Confirmar cita desde admin
// ===============================
add_action('wp_ajax_aa_confirmar_cita', 'aa_ajax_confirmar_cita');

function aa_ajax_confirmar_cita() {
    // ‚úÖ Validar nonce
    check_ajax_referer('aa_confirmar_cita', '_wpnonce');
    
    // ‚úÖ Verificar permisos
    if (!current_user_can('aa_view_panel') && !current_user_can('administrator')) {
        wp_send_json_error(['message' => 'No tienes permisos.']);
    }
    
    // ‚úÖ Validar y sanitizar par√°metros
    if (!isset($_POST['id']) || empty($_POST['id'])) {
        wp_send_json_error(['message' => 'ID de reserva no proporcionado.']);
    }
    
    $reserva_id = intval($_POST['id']);
    
    if ($reserva_id <= 0) {
        wp_send_json_error(['message' => 'ID inv√°lido.']);
    }
    
    // ‚úÖ Delegar al servicio de backend
    $result = confirm_backend_service_confirmar($reserva_id);
    
    // ‚úÖ Retornar respuesta
    if (isset($result['success']) && $result['success']) {
        wp_send_json_success($result);
    } else {
        wp_send_json_error($result);
    }
}

// ===============================
// üîπ AJAX: Enviar correo de confirmaci√≥n
// ===============================
add_action('wp_ajax_nopriv_aa_enviar_confirmacion', 'aa_ajax_enviar_confirmacion');
add_action('wp_ajax_aa_enviar_confirmacion', 'aa_ajax_enviar_confirmacion');

function aa_ajax_enviar_confirmacion() {
    error_log("üî• AJAX aa_enviar_confirmacion activado");
    
    // üîπ Decodificar JSON del body
    $raw_input = file_get_contents('php://input');
    $datos = json_decode($raw_input, true);

    if (!$datos) {
        wp_send_json_error(['message' => 'JSON inv√°lido o vac√≠o']);
        return;
    }
    
    error_log("üì§ JSON COMPLETO QUE SE ENV√çA AL BACKEND:");
    error_log(json_encode($datos, JSON_PRETTY_PRINT));

    // ‚úÖ Delegar al servicio
    $result = confirm_backend_service_enviar_correo($datos);
    
    // ‚úÖ Retornar respuesta
    if ($result['success']) {
        wp_send_json_success($result);
    } else {
        wp_send_json_error($result);
    }
}

// ===============================
// üîπ REST API: Confirmar reserva desde backend
// ===============================
add_action('rest_api_init', function () {
    register_rest_route('aa/v1', '/confirmar-reserva', [
        'methods' => 'POST',
        'callback' => 'aa_rest_confirmar_reserva',
        'permission_callback' => '__return_true',
    ]);
});

function aa_rest_confirmar_reserva(WP_REST_Request $request) {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    $id = intval($request['id_reserva']);

    if (!$id) {
        return new WP_REST_Response(['error' => 'id_reserva faltante'], 400);
    }

    // üîπ Obtener datos de la reserva antes de actualizar
    $reserva = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE id = %d",
        $id
    ));
    
    if (!$reserva) {
        return new WP_REST_Response(['error' => 'Reserva no encontrada'], 404);
    }

    // üîπ Preparar datos a actualizar
    $update_data = ['estado' => 'confirmed'];
    $update_format = ['%s'];
    
    // üîπ Si viene calendar_uid, tambi√©n lo guardamos
    $calendar_uid = sanitize_text_field($request['calendar_uid']);
    if (!empty($calendar_uid)) {
        $update_data['calendar_uid'] = $calendar_uid;
        $update_format[] = '%s';
        error_log("‚úÖ calendar_uid recibido para reserva ID $id: $calendar_uid");
    }

    // üîπ Actualizar registro
    $updated = $wpdb->update(
        $table,
        $update_data,
        ['id' => $id],
        $update_format,
        ['%d']
    );
    
    if ($updated === false) {
        error_log("‚ùå Error al actualizar reserva ID $id: " . $wpdb->last_error);
        return new WP_REST_Response(['error' => 'Error al actualizar'], 500);
    }

    error_log("‚úÖ Reserva ID $id actualizada: estado=confirmed" . (!empty($calendar_uid) ? ", calendar_uid=$calendar_uid" : ""));
    
    // =========================================================================
    // üõ°Ô∏è L√ìGICA DE CANCELACI√ìN EN CASCADA (tambi√©n para correos)
    // =========================================================================
    $conflictos = ReservationsModel::get_pending_conflicts($reserva->fecha, $id);

    if (!empty($conflictos)) {
        error_log("‚öîÔ∏è [REST API] Se encontraron " . count($conflictos) . " citas pendientes en conflicto para la fecha: " . $reserva->fecha);
        
        foreach ($conflictos as $conflicto) {
            $cancelado = $wpdb->update(
                $table, 
                ['estado' => 'cancelled'], 
                ['id' => $conflicto->id]
            );
            
            if ($cancelado !== false) {
                error_log("üö´ [Auto-Cancel REST] Cita ID {$conflicto->id} ({$conflicto->nombre}) cancelada autom√°ticamente por ocupaci√≥n de slot.");
                
                // üîî Marcar notificaci√≥n como le√≠da
                $notifications_table = $wpdb->prefix . 'aa_notifications';
                $notification_id = $wpdb->get_var($wpdb->prepare(
                    "SELECT id FROM $notifications_table 
                    WHERE entity_type = %s AND entity_id = %d",
                    'reservation',
                    $conflicto->id
                ));
                
                if ($notification_id) {
                    $notification_updated = $wpdb->update(
                        $notifications_table,
                        ['is_read' => 1],
                        ['id' => $notification_id],
                        ['%d'],
                        ['%d']
                    );
                    
                    if ($notification_updated !== false) {
                        error_log("‚úÖ [Auto-Cancel REST] Notificaci√≥n ID $notification_id marcada como le√≠da para cita cancelada ID {$conflicto->id}");
                    } else {
                        error_log("‚ö†Ô∏è [Auto-Cancel REST] Error al marcar notificaci√≥n como le√≠da: " . $wpdb->last_error);
                    }
                }
            }
        }
    }
    // =========================================================================
    
    // =========================================================================
    // üîî ACTUALIZAR NOTIFICACI√ìN: pending -> confirmed
    // =========================================================================
    $notifications_table = $wpdb->prefix . 'aa_notifications';
    
    // Buscar notificaci√≥n existente con type='pending'
    $existing_notification_id = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $notifications_table 
        WHERE entity_type = %s AND entity_id = %d AND type = %s",
        'reservation',
        $id,
        'pending'
    ));
    
    // Si existe, actualizarla a 'confirmed' y marcar como no le√≠da
    if ($existing_notification_id) {
        $notification_updated = $wpdb->update(
            $notifications_table,
            [
                'type' => 'confirmed',
                'is_read' => 0
            ],
            ['id' => $existing_notification_id],
            ['%s', '%d'],
            ['%d']
        );
        
        if ($notification_updated !== false) {
            error_log("‚úÖ [REST API] Notificaci√≥n ID $existing_notification_id actualizada: pending -> confirmed (unread)");
        } else {
            error_log("‚ö†Ô∏è [REST API] Error al actualizar notificaci√≥n ID $existing_notification_id: " . $wpdb->last_error);
        }
    } else {
        error_log("‚ÑπÔ∏è [REST API] No se encontr√≥ notificaci√≥n pending para reserva ID $id (fail-safe)");
    }
    // =========================================================================
    
    $response_data = [
        'success' => true,
        'id' => $id,
        'estado' => 'confirmed'
    ];
    
    if (!empty($calendar_uid)) {
        $response_data['calendar_uid'] = $calendar_uid;
    }

    return new WP_REST_Response($response_data, 200);
}




========================================
FILE: includes\controllers\enqueueController.php
========================================
<?php
defined('ABSPATH') or die('¬°Sin acceso directo!');

/**
 * Helper para resolver rutas absolutas en plugin_dir_* con paths relativos.
 */
function wpaa_path($relative) {
    return plugin_dir_path(__FILE__) . '../../' . ltrim($relative, '/');
}

function wpaa_url($relative) {
    return plugin_dir_url(__FILE__) . '../../' . ltrim($relative, '/');
}

/**
 * Registrar un script JS con soporte para m√≥dulos ES6.
 */
function wpaa_register_js($handle, $relative_path, $deps = [], $is_module = false) {
    $url  = wpaa_url($relative_path);
    $path = wpaa_path($relative_path);

    wp_enqueue_script($handle, $url, $deps, filemtime($path), true);

    if ($is_module) {
        add_filter('script_loader_tag', function($tag, $h) use ($handle) {
            if ($h === $handle) {
                return str_replace('<script ', '<script type="module" ', $tag);
            }
            return $tag;
        }, 10, 2);
    }
}

/**
 * Localizaci√≥n segura y compacta de variables.
 */
function wpaa_localize($handle, $object_name, $data) {
    wp_localize_script($handle, $object_name, $data);
}

/**
 * Obtener locale seg√∫n timezone.
 */
function wpaa_locale_from_timezone($tz) {
    $map = [
        'America/Mexico_City' => 'es-MX', 'America/Cancun' => 'es-MX',
        'America/Tijuana' => 'es-MX', 'America/Monterrey' => 'es-MX',
        'America/Bogota' => 'es-CO', 'America/Lima' => 'es-PE',
        'America/Argentina/Buenos_Aires' => 'es-AR', 'America/Santiago' => 'es-CL',
        'America/New_York' => 'en-US', 'America/Los_Angeles' => 'en-US',
        'Europe/Madrid' => 'es-ES', 'Europe/London' => 'en-GB'
    ];
    return $map[$tz] ?? 'es-MX';
}

/* ============================================================
   FRONTEND
============================================================ */
// ===============================
// üîπ FRONTEND: Shortcode [agenda_automatizada]
// ===============================
add_action('wp_enqueue_scripts', 'wpaa_enqueue_frontend_assets');

function wpaa_enqueue_frontend_assets() {
    global $post;
    if (!is_a($post, 'WP_Post') || !has_shortcode($post->post_content, 'agenda_automatizada')) {
        return;
    }

    // CSS
    wp_enqueue_style('flatpickr-css', 'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css');
    wp_enqueue_style('wpaa-calendar-default', wpaa_url('css/calendar-default.css'), [], filemtime(wpaa_path('css/calendar-default.css')));

    // JS externos
    wp_enqueue_script('flatpickr-js', 'https://cdn.jsdelivr.net/npm/flatpickr', [], null, true);
    wp_enqueue_script('flatpickr-es', 'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js', ['flatpickr-js'], null, true);

    // ‚úÖ IMPORTANTE: Cargar datos locales ANTES de cualquier script
    wpaa_localize_local_availability();

    $frontend_scripts = [
        ['wpaa-date-utils',              'assets/js/utils/dateUtils.js',              [], false],
        ['aa-wpagenda-kernel',           'assets/js/ui-adapters/WPAgenda.js',         ['wpaa-date-utils'], false],
        ['aa-calendar-default-adapter',  'assets/js/ui-adapters/calendarDefaultAdapter.js', ['wpaa-date-utils', 'aa-wpagenda-kernel'], false],
        ['aa-slots-default-adapter',     'assets/js/ui-adapters/slotsDefaultAdapter.js', ['wpaa-date-utils', 'aa-wpagenda-kernel'], false],
        ['aa-modal-default-adapter',     'assets/js/ui-adapters/modalDefaultAdapter.js', ['wpaa-date-utils', 'aa-wpagenda-kernel'], false],
        ['wpaa-calendar-ui',             'assets/js/ui/calendarUI.js', ['flatpickr-js', 'flatpickr-es', 'wpaa-date-utils'], false],
        ['wpaa-slot-selector-ui',        'assets/js/ui/slotSelectorUI.js', ['wpaa-date-utils'], false],
        ['wpaa-proxy-fetch',             'assets/js/services/availability/proxyFetch.js', [], false],
        ['wpaa-combine-local-external',  'assets/js/services/availability/combineLocalExternal.js', [], false],
        ['wpaa-busy-ranges',             'assets/js/services/availability/busyRanges.js', [], false],
        ['wpaa-slot-calculator',         'assets/js/services/availability/slotCalculator.js', ['wpaa-date-utils'], false],
        ['wpaa-availability-service',    'assets/js/services/availabilityService.js', ['wpaa-date-utils', 'wpaa-proxy-fetch', 'wpaa-combine-local-external', 'wpaa-busy-ranges', 'wpaa-slot-calculator'], false],
        ['wpaa-reservation-service',     'assets/js/services/reservationService.js', [], false],
        ['wpaa-availability-controller', 'assets/js/controllers/availabilityController.js', ['wpaa-date-utils', 'wpaa-calendar-ui', 'wpaa-slot-selector-ui', 'wpaa-availability-service', 'aa-wpagenda-kernel', 'aa-calendar-default-adapter', 'aa-slots-default-adapter', 'aa-modal-default-adapter'], false],
        ['wpaa-reservation-controller',  'assets/js/controllers/reservationController.js', ['wpaa-reservation-service', 'aa-wpagenda-kernel', 'aa-calendar-default-adapter', 'aa-slots-default-adapter', 'aa-modal-default-adapter'], false],
        ['wpaa-main-frontend',           'assets/js/main-frontend.js', ['wpaa-availability-controller', 'wpaa-reservation-controller'], false],
    ];

    foreach ($frontend_scripts as [$h, $p, $d, $m]) {
        wpaa_register_js($h, $p, $d, $m);
    }

    wpaa_localize('wpaa-availability-controller', 'aa_backend', [
        'ajax_url'     => admin_url('admin-ajax.php'),
        'action'       => 'aa_get_availability',
        'email'        => get_option('aa_google_email', ''),
        'gsync_status' => get_option('aa_estado_gsync', 'active'),
    ]);

    wpaa_localize('wpaa-availability-controller', 'aa_schedule',      get_option('aa_schedule', []));
    wpaa_localize('wpaa-availability-controller', 'aa_future_window', intval(get_option('aa_future_window', 15)));
    wpaa_localize('wpaa-availability-controller', 'aa_slot_duration', intval(get_option('aa_slot_duration', 60)));

    wpaa_localize('wpaa-reservation-service', 'aa_reservation_config', [
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce'    => wp_create_nonce('aa_reservation_nonce'),
    ]);

    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    
    wpaa_localize('wpaa-reservation-controller', 'wpaa_vars', [
        'ajax_url' => admin_url('admin-ajax.php'),
        'nonce' => wp_create_nonce('aa_reservation_nonce'),
        'whatsapp_number' => get_option('aa_whatsapp_number', '5215522992290'),
        'timezone' => $timezone,
        'locale' => wpaa_locale_from_timezone($timezone)
    ]);
}

/**
 * Inyectar disponibilidad local ANTES de scripts JS
 */
function wpaa_localize_local_availability($script_handle = 'wpaa-availability-controller') {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    $slot_duration = intval(get_option('aa_slot_duration', 60));
    $timezone_string = get_option('aa_timezone', 'America/Mexico_City');
    
    // Obtener hora actual seg√∫n timezone del negocio
    try {
        $tz = new DateTimeZone($timezone_string);
        $now = new DateTime('now', $tz);
        $now_str = $now->format('Y-m-d H:i:s');
    } catch (Exception $e) {
        $now_str = current_time('mysql');
    }
    
    $confirmed = $wpdb->get_results($wpdb->prepare("
        SELECT 
            fecha as start,
            DATE_ADD(fecha, INTERVAL duracion MINUTE) as end,
            servicio as title,
            nombre as attendee
        FROM $table 
        WHERE estado = 'confirmed' 
        AND DATE_ADD(fecha, INTERVAL duracion MINUTE) >= %s
        ORDER BY fecha ASC
    ", $now_str));

    $local_busy = [];
    foreach ($confirmed as $row) {
        $local_busy[] = [
            'start' => $row->start,
            'end' => $row->end,
            'title' => $row->title,
            'attendee' => $row->attendee
        ];
    }

    wp_localize_script($script_handle, 'aa_local_availability', [
        'local_busy' => $local_busy,
        'slot_duration' => $slot_duration,
        'timezone' => $timezone_string,
        'total_confirmed' => count($local_busy)
    ]);
}

/* ============================================================
   ADMIN
============================================================ */
function wpaa_enqueue_admin_assets($hook) {

    // üîπ Estilos comunes para p√°ginas del plugin (solo contenedor del iframe, NO Tailwind)
    // IMPORTANTE: Tailwind CSS (admin.css) se carga SOLO dentro del iframe via layout.php
    // NO debe cargarse aqu√≠ para evitar afectar el admin legacy de WordPress
    $plugin_pages = [
        'toplevel_page_agenda-automatizada-settings'
    ];
    
    if (in_array($hook, $plugin_pages)) {
        // Solo cargar estilos comunes para el contenedor del iframe (NO Tailwind)
        wp_enqueue_style(
            'wpaa-admin-common-styles',
            wpaa_url('css/styles.css'),
            [],
            filemtime(wpaa_path('css/styles.css'))
        );
    }

    // --- Pantalla principal de ajustes ---
    // Note: Settings page now uses iframe-based UI, so JS is loaded inside the iframe
    // No global enqueue needed here - JS is loaded by the iframe UI module
}
add_action('admin_enqueue_scripts', 'wpaa_enqueue_admin_assets');



========================================
FILE: includes\controllers\proximasCitasController.php
========================================
<?php
/**
 * Controlador: Pr√≥ximas Citas y Gesti√≥n de Estado
 * 
 * Maneja:
 * - Obtenci√≥n y filtrado de pr√≥ximas citas (AJAX)
 * - Confirmaci√≥n manual de citas
 * - Cancelaci√≥n de citas (con eliminaci√≥n en Google Calendar)
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Controllers
 */

if (!defined('ABSPATH')) exit;

// ===============================
// üîπ AJAX: Obtener citas por d√≠a (para timeline del calendario)
// ===============================
add_action('wp_ajax_aa_get_citas_por_dia', 'aa_ajax_get_citas_por_dia');

function aa_ajax_get_citas_por_dia() {
    // Verificar nonce
    check_ajax_referer('aa_proximas_citas');
    
    // Verificar permisos
    if (!current_user_can('aa_view_panel') && !current_user_can('administrator')) {
        wp_send_json_error(['message' => 'No tienes permisos.']);
    }
    
    global $wpdb;
    $table_reservas = $wpdb->prefix . 'aa_reservas';
    $table_clientes = $wpdb->prefix . 'aa_clientes';
    
    // üîπ Obtener fecha (opcional)
    $fecha = isset($_POST['fecha']) ? sanitize_text_field($_POST['fecha']) : '';
    
    // Si NO viene fecha, usar la fecha actual en zona horaria local
    if (empty($fecha)) {
        $timezone = get_option('aa_timezone', 'America/Mexico_City');
        $fecha = wp_date('Y-m-d', null, new DateTimeZone($timezone));
    }
    
    // Validar formato de fecha (YYYY-MM-DD)
    if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $fecha)) {
        wp_send_json_error(['message' => 'Formato de fecha inv√°lido. Use YYYY-MM-DD']);
    }
    
    // üîπ Construir rango del d√≠a: inicio 00:00:00 y fin 23:59:59
    $fecha_inicio = $fecha . ' 00:00:00';
    $fecha_fin = $fecha . ' 23:59:59';
    
    // üîπ Consulta: SELECT expl√≠cito desde aa_reservas con LEFT JOIN a aa_clientes
    // Usa datos reales del cliente desde aa_clientes, nunca datos legacy de reservas
    $query = "SELECT 
                r.id,
                r.servicio,
                r.fecha,
                r.duracion,
                r.estado,
                r.calendar_uid,
                r.created_at,
                r.id_cliente,
                c.nombre,
                c.telefono,
                c.correo,
                DATE_ADD(r.fecha, INTERVAL IFNULL(r.duracion, 60) MINUTE) as fecha_fin
              FROM $table_reservas r
              LEFT JOIN $table_clientes c ON r.id_cliente = c.id
              WHERE r.fecha BETWEEN %s AND %s 
              ORDER BY r.fecha ASC";
    
    $citas = $wpdb->get_results($wpdb->prepare($query, $fecha_inicio, $fecha_fin));
    
    wp_send_json_success([
        'fecha' => $fecha,
        'citas' => $citas
    ]);
}

// ===============================
// üîπ AJAX: Cancelar cita (con eliminaci√≥n en Google Calendar)
// ===============================
add_action('wp_ajax_aa_cancelar_cita', 'aa_ajax_cancelar_cita');

function aa_ajax_cancelar_cita() {
    check_ajax_referer('aa_cancelar_cita');
    
    if (!current_user_can('aa_view_panel') && !current_user_can('administrator')) {
        wp_send_json_error(['message' => 'No tienes permisos.']);
    }
    
    $id = intval($_POST['id']);
    if (!$id) {
        wp_send_json_error(['message' => 'ID inv√°lido.']);
    }
    
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    // üîπ Obtener datos de la reserva (especialmente calendar_uid)
    $reserva = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE id = %d",
        $id
    ));
    
    if (!$reserva) {
        wp_send_json_error(['message' => 'Reserva no encontrada.']);
    }
    
    // üîπ PASO 1: Actualizar estado en WordPress
    $updated = $wpdb->update($table, ['estado' => 'cancelled'], ['id' => $id]);
    
    if ($updated === false) {
        wp_send_json_error(['message' => 'Error al actualizar en BD.']);
    }
    
    error_log("‚úÖ Cita ID $id marcada como 'cancelled' en WordPress");
    
    // üîî Marcar notificaci√≥n como le√≠da
    $notifications_table = $wpdb->prefix . 'aa_notifications';
    $notification_id = $wpdb->get_var($wpdb->prepare(
        "SELECT id FROM $notifications_table 
        WHERE entity_type = %s AND entity_id = %d",
        'reservation',
        $id
    ));
    
    if ($notification_id) {
        $notification_updated = $wpdb->update(
            $notifications_table,
            ['is_read' => 1],
            ['id' => $notification_id],
            ['%d'],
            ['%d']
        );
        
        if ($notification_updated !== false) {
            error_log("‚úÖ [Cancel] Notificaci√≥n ID $notification_id marcada como le√≠da para cita cancelada ID $id");
        } else {
            error_log("‚ö†Ô∏è [Cancel] Error al marcar notificaci√≥n como le√≠da: " . $wpdb->last_error);
        }
    }
    
    // üîπ PASO 2: Eliminar evento de Google Calendar (si existe calendar_uid Y hay email configurado)
    $calendar_deleted = false;
    $google_email = get_option('aa_google_email', ''); // ‚úÖ Obtener email configurado
    
    // ‚úÖ CONDICI√ìN AGREGADA: !empty($google_email)
    if (!empty($reserva->calendar_uid) && !empty($google_email)) {
        error_log("üóìÔ∏è Intentando eliminar evento de Google Calendar: {$reserva->calendar_uid}");
        
        // üîπ Usar la funci√≥n centralizada para obtener el domain
        $domain = aa_get_clean_domain();
        
        // Determinar URL del backend
        $site_url = get_site_url();
        $backend_url = (strpos($site_url, 'localhost') !== false)
            ? 'http://localhost:3000/cancelaciones/cancelar-cita'
            : 'https://deoia-oauth-backend.onrender.com/cancelaciones/cancelar-cita';
        
        // Datos para enviar al backend
        $backend_data = [
            'domain' => $domain,
            'calendar_uid' => $reserva->calendar_uid,
        ];
        
        error_log("üì§ Enviando solicitud de cancelaci√≥n a: $backend_url");
        
        // Enviar petici√≥n autenticada con HMAC
        $response = aa_send_authenticated_request($backend_url, 'POST', $backend_data);
        
        if (is_wp_error($response)) {
            error_log("‚ö†Ô∏è Error al contactar backend para cancelar: " . $response->get_error_message());
            // No fallar aqu√≠, la cita ya fue cancelada en WordPress
        } else {
            $status = wp_remote_retrieve_response_code($response);
            $body = wp_remote_retrieve_body($response);
            $decoded = json_decode($body, true);
            
            error_log("üì• Respuesta del backend (HTTP $status): " . print_r($decoded, true));
            
            if ($status >= 200 && $status < 300 && isset($decoded['success']) && $decoded['success']) {
                error_log("‚úÖ Evento eliminado de Google Calendar exitosamente");
                $calendar_deleted = true;
            } elseif ($status === 404 || $status === 410) {
                error_log("‚ÑπÔ∏è El evento ya no existe en Google Calendar (puede haber sido eliminado antes)");
                $calendar_deleted = true; // Consideramos exitoso si ya no existe
            } else {
                error_log("‚ö†Ô∏è El backend respondi√≥ con error al intentar cancelar en Google Calendar");
            }
        }
    } else {
        // Log espec√≠fico para saber por qu√© no se ejecut√≥
        if (empty($google_email)) {
            error_log("‚ÑπÔ∏è Cancelaci√≥n LOCAL solamente: No hay 'aa_google_email' configurado.");
        } else {
            error_log("‚ÑπÔ∏è La cita ID $id no tiene 'calendar_uid' asociado, no se eliminar√° de Google Calendar");
        }
    }
    
    wp_send_json_success([
        'message' => 'Cita cancelada correctamente.',
        'calendar_deleted' => $calendar_deleted
    ]);
}


========================================
FILE: includes\controllers\WebhooksController.php
========================================
<?php
/**
 * Webhooks Controller
 * 
 * Maneja webhooks entrantes del backend de OAuth.
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Api
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

/**
 * Class Webhooks_Controller
 * 
 * Controlador REST para procesar webhooks entrantes.
 */
class Webhooks_Controller extends WP_REST_Controller {

    /**
     * Constructor.
     */
    public function __construct() {
        $this->namespace = 'aa/v1';
        $this->rest_base = 'webhooks';
    }

    /**
     * Registra las rutas del controlador.
     */
    public function register_routes() {
        register_rest_route($this->namespace, '/' . $this->rest_base . '/sync-status', array(
            array(
                'methods'             => WP_REST_Server::CREATABLE,
                'callback'            => array($this, 'handle_sync_status'),
                'permission_callback' => '__return_true', // P√∫blico - validaremos el payload
                'args'                => $this->get_sync_status_params(),
            ),
        ));
    }

    /**
     * Define los par√°metros esperados para el endpoint sync-status.
     *
     * @return array Par√°metros de validaci√≥n.
     */
    protected function get_sync_status_params() {
        return array(
            'status' => array(
                'required'          => true,
                'type'              => 'string',
                'description'       => 'Estado de sincronizaci√≥n (invalid o valid)',
                'sanitize_callback' => 'sanitize_text_field',
                'validate_callback' => function($param, $request, $key) {
                    return in_array($param, array('invalid', 'valid'), true);
                },
            ),
        );
    }

    /**
     * Maneja el webhook de cambio de estado de sincronizaci√≥n.
     *
     * @param WP_REST_Request $request Objeto de solicitud REST.
     * @return WP_REST_Response|WP_Error Respuesta de la API.
     */
    public function handle_sync_status($request) {
        // Obtener el par√°metro de estado
        $status = $request->get_param('status');

        // Delegar la l√≥gica de negocio al servicio
        $result = SyncService::update_sync_status($status);

        // Verificar si el servicio report√≥ un fallo
        if (!$result['success']) {
            return new WP_Error(
                'sync_update_failed',
                $result['message'],
                array('status' => 400)
            );
        }

        // Respuesta exitosa
        return new WP_REST_Response($result, 200);
    }
}



========================================
FILE: includes\models\AssignmentsModel.php
========================================
<?php
/**
 * Modelo: Assignments
 * 
 * Responsable de:
 * - Consultas a las tablas de assignments (aa_staff, aa_service_areas, aa_assignments)
 * - Acceso reutilizable a datos de asignaciones
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Models
 */

if (!defined('ABSPATH')) exit;

class AssignmentsModel {

    /**
     * Obtener zonas de atenci√≥n (service areas)
     * 
     * @param bool $only_active Si es true, solo retorna zonas activas
     * @return array Array asociativo con las zonas de atenci√≥n
     */
    public static function get_service_areas($only_active = true) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_service_areas';
        
        $where_clause = '';
        if ($only_active) {
            $where_clause = "WHERE active = 1";
        }
        
        $query = "SELECT id, name, description, active, created_at 
                  FROM $table 
                  $where_clause 
                  ORDER BY name ASC";
        
        $results = $wpdb->get_results($query, ARRAY_A);
        
        if ($wpdb->last_error) {
            error_log("‚ùå [AssignmentsModel] Error al obtener zonas de atenci√≥n: " . $wpdb->last_error);
            return [];
        }
        
        return $results ? $results : [];
    }

    /**
     * Crear nueva zona de atenci√≥n (service area)
     * 
     * @param string $name Nombre de la zona de atenci√≥n
     * @return array|false Array con id y name en √©xito, false en error
     */
    public static function create_service_area($name) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_service_areas';
        
        // Sanitizar nombre
        $name = sanitize_text_field($name);
        
        // Validar que el nombre no est√© vac√≠o
        if (empty($name)) {
            error_log("‚ùå [AssignmentsModel] Intento de crear zona con nombre vac√≠o");
            return false;
        }
        
        // Insertar en la base de datos
        $result = $wpdb->insert(
            $table,
            [
                'name' => $name,
                'active' => 1,
                'created_at' => current_time('mysql')
            ],
            ['%s', '%d', '%s']
        );
        
        if ($result === false) {
            error_log("‚ùå [AssignmentsModel] Error al crear zona de atenci√≥n: " . $wpdb->last_error);
            return false;
        }
        
        $new_id = $wpdb->insert_id;
        
        if (!$new_id) {
            error_log("‚ùå [AssignmentsModel] Zona creada pero no se obtuvo insert_id");
            return false;
        }
        
        error_log("‚úÖ [AssignmentsModel] Zona de atenci√≥n creada ID: $new_id (nombre: $name)");
        
        return [
            'id' => $new_id,
            'name' => $name
        ];
    }

    /**
     * Actualizar estado activo de una zona de atenci√≥n
     * 
     * @param int $id ID de la zona de atenci√≥n
     * @param int $active 0 para desactivar, 1 para activar
     * @return bool true en √©xito, false en error
     */
    public static function set_service_area_active($id, $active) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_service_areas';
        
        // Validar par√°metros
        $id = intval($id);
        $active = intval($active);
        
        // Asegurar que active sea 0 o 1
        $active = ($active === 1) ? 1 : 0;
        
        if ($id <= 0) {
            error_log("‚ùå [AssignmentsModel] ID inv√°lido para actualizar zona: $id");
            return false;
        }
        
        // Actualizar en la base de datos
        $result = $wpdb->update(
            $table,
            ['active' => $active],
            ['id' => $id],
            ['%d'],
            ['%d']
        );
        
        if ($result === false) {
            error_log("‚ùå [AssignmentsModel] Error al actualizar zona de atenci√≥n ID $id: " . $wpdb->last_error);
            return false;
        }
        
        error_log("‚úÖ [AssignmentsModel] Zona de atenci√≥n ID $id actualizada (active = $active)");
        
        return true;
    }

    /**
     * Obtener personal (staff)
     * 
     * @param bool $only_active Si es true, solo retorna personal activo
     * @return array Array asociativo con el personal
     */
    public static function get_staff($only_active = false) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_staff';
        
        $where_clause = '';
        if ($only_active) {
            $where_clause = "WHERE active = 1";
        }
        
        $query = "SELECT id, name, active, created_at 
                  FROM $table 
                  $where_clause 
                  ORDER BY name ASC";
        
        $results = $wpdb->get_results($query, ARRAY_A);
        
        if ($wpdb->last_error) {
            error_log("‚ùå [AssignmentsModel] Error al obtener personal: " . $wpdb->last_error);
            return [];
        }
        
        return $results ? $results : [];
    }

    /**
     * Crear nuevo personal (staff)
     * 
     * @param string $name Nombre del personal
     * @return array|false Array con id y name en √©xito, false en error
     */
    public static function create_staff($name) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_staff';
        
        // Sanitizar nombre
        $name = sanitize_text_field($name);
        
        // Validar que el nombre no est√© vac√≠o
        if (empty($name)) {
            error_log("‚ùå [AssignmentsModel] Intento de crear personal con nombre vac√≠o");
            return false;
        }
        
        // Insertar en la base de datos
        $result = $wpdb->insert(
            $table,
            [
                'name' => $name,
                'active' => 1,
                'created_at' => current_time('mysql')
            ],
            ['%s', '%d', '%s']
        );
        
        if ($result === false) {
            error_log("‚ùå [AssignmentsModel] Error al crear personal: " . $wpdb->last_error);
            return false;
        }
        
        $new_id = $wpdb->insert_id;
        
        if (!$new_id) {
            error_log("‚ùå [AssignmentsModel] Personal creado pero no se obtuvo insert_id");
            return false;
        }
        
        error_log("‚úÖ [AssignmentsModel] Personal creado ID: $new_id (nombre: $name)");
        
        return [
            'id' => $new_id,
            'name' => $name
        ];
    }

    /**
     * Actualizar estado activo de un miembro del personal
     * 
     * @param int $id ID del personal
     * @param int $active 0 para desactivar, 1 para activar
     * @return bool true en √©xito, false en error
     */
    public static function set_staff_active($id, $active) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_staff';
        
        // Validar par√°metros
        $id = intval($id);
        $active = intval($active);
        
        // Asegurar que active sea 0 o 1
        $active = ($active === 1) ? 1 : 0;
        
        if ($id <= 0) {
            error_log("‚ùå [AssignmentsModel] ID inv√°lido para actualizar personal: $id");
            return false;
        }
        
        // Actualizar en la base de datos
        $result = $wpdb->update(
            $table,
            ['active' => $active],
            ['id' => $id],
            ['%d'],
            ['%d']
        );
        
        if ($result === false) {
            error_log("‚ùå [AssignmentsModel] Error al actualizar personal ID $id: " . $wpdb->last_error);
            return false;
        }
        
        error_log("‚úÖ [AssignmentsModel] Personal ID $id actualizado (active = $active)");
        
        return true;
    }

    /**
     * Obtener asignaciones
     * 
     * @return array Array asociativo con las asignaciones enriquecidas con nombres de staff y zonas
     */
    public static function get_assignments() {
        global $wpdb;
        $assignments_table = $wpdb->prefix . 'aa_assignments';
        $staff_table = $wpdb->prefix . 'aa_staff';
        $service_areas_table = $wpdb->prefix . 'aa_service_areas';
        
        $query = "SELECT 
                    a.id,
                    a.assignment_date,
                    a.start_time,
                    a.end_time,
                    a.service_key,
                    a.capacity,
                    a.status,
                    s.name AS staff_name,
                    sa.name AS service_area_name
                  FROM $assignments_table a
                  LEFT JOIN $staff_table s ON s.id = a.staff_id
                  LEFT JOIN $service_areas_table sa ON sa.id = a.service_area_id
                  ORDER BY a.assignment_date ASC, a.start_time ASC";
        
        $results = $wpdb->get_results($query, ARRAY_A);
        
        if ($wpdb->last_error) {
            error_log("‚ùå [AssignmentsModel] Error al obtener asignaciones: " . $wpdb->last_error);
            return [];
        }
        
        return $results ? $results : [];
    }

    /**
     * Eliminar una asignaci√≥n
     * 
     * @param int $id ID de la asignaci√≥n a eliminar
     * @return bool true en √©xito, false en error
     */
    public static function delete_assignment($id) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_assignments';
        
        // Validar ID
        $id = intval($id);
        
        if ($id <= 0) {
            error_log("‚ùå [AssignmentsModel] ID inv√°lido para eliminar asignaci√≥n: $id");
            return false;
        }
        
        // Eliminar de la base de datos
        $result = $wpdb->delete(
            $table,
            ['id' => $id],
            ['%d']
        );
        
        if ($result === false) {
            error_log("‚ùå [AssignmentsModel] Error al eliminar asignaci√≥n ID $id: " . $wpdb->last_error);
            return false;
        }
        
        if ($result === 0) {
            error_log("‚ö†Ô∏è [AssignmentsModel] No se encontr√≥ asignaci√≥n con ID $id para eliminar");
            return false;
        }
        
        error_log("‚úÖ [AssignmentsModel] Asignaci√≥n ID $id eliminada correctamente");
        
        return true;
    }

    /**
     * Crear nueva asignaci√≥n
     * 
     * Valida colisiones con asignaciones existentes antes de insertar.
     * 
     * @param array $data Datos de la asignaci√≥n:
     *   - assignment_date (string): Fecha YYYY-MM-DD
     *   - start_time (string): Hora inicio HH:MM
     *   - end_time (string): Hora fin HH:MM
     *   - staff_id (int): ID del personal
     *   - service_area_id (int): ID de la zona
     *   - service_key (string): Clave del servicio
     *   - capacity (int): Capacidad (default 1)
     * @return array|false Array con la asignaci√≥n creada, array con error, o false
     */
    public static function create_assignment($data) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_assignments';
        
        // Validar datos requeridos
        $required = ['assignment_date', 'start_time', 'end_time', 'staff_id', 'service_area_id', 'service_key'];
        foreach ($required as $field) {
            if (empty($data[$field])) {
                error_log("‚ùå [AssignmentsModel] Campo requerido vac√≠o: $field");
                return false;
            }
        }
        
        // Normalizar horas a formato HH:MM:SS
        $start_time = strlen($data['start_time']) === 5 ? $data['start_time'] . ':00' : $data['start_time'];
        $end_time = strlen($data['end_time']) === 5 ? $data['end_time'] . ':00' : $data['end_time'];
        
        // Verificar colisi√≥n por staff (mismo personal, misma fecha, horario traslapado)
        $staff_collision = self::check_staff_collision(
            $data['assignment_date'],
            $start_time,
            $end_time,
            $data['staff_id']
        );
        
        if ($staff_collision) {
            error_log("‚ùå [AssignmentsModel] Colisi√≥n detectada: personal ya tiene asignaci√≥n en ese horario");
            return [
                'error' => 'El personal seleccionado ya tiene una asignaci√≥n en ese horario'
            ];
        }
        
        // Verificar colisi√≥n por zona (misma zona, misma fecha, horario traslapado)
        $area_collision = self::check_area_collision(
            $data['assignment_date'],
            $start_time,
            $end_time,
            $data['service_area_id']
        );
        
        if ($area_collision) {
            error_log("‚ùå [AssignmentsModel] Colisi√≥n detectada: zona ya tiene asignaci√≥n en ese horario");
            return [
                'error' => 'La zona seleccionada ya tiene una asignaci√≥n en ese horario'
            ];
        }
        
        // Preparar datos para inserci√≥n
        $insert_data = [
            'assignment_date' => $data['assignment_date'],
            'start_time' => $start_time,
            'end_time' => $end_time,
            'staff_id' => intval($data['staff_id']),
            'service_area_id' => intval($data['service_area_id']),
            'service_key' => sanitize_text_field($data['service_key']),
            'capacity' => isset($data['capacity']) ? intval($data['capacity']) : 1,
            'status' => 'active',
            'created_at' => current_time('mysql')
        ];
        
        // Insertar en la base de datos
        $result = $wpdb->insert(
            $table,
            $insert_data,
            ['%s', '%s', '%s', '%d', '%d', '%s', '%d', '%s', '%s']
        );
        
        if ($result === false) {
            error_log("‚ùå [AssignmentsModel] Error al insertar asignaci√≥n: " . $wpdb->last_error);
            return false;
        }
        
        $new_id = $wpdb->insert_id;
        
        if (!$new_id) {
            error_log("‚ùå [AssignmentsModel] Asignaci√≥n creada pero no se obtuvo insert_id");
            return false;
        }
        
        error_log("‚úÖ [AssignmentsModel] Asignaci√≥n creada ID: $new_id");
        
        // Retornar datos de la asignaci√≥n creada
        $insert_data['id'] = $new_id;
        return $insert_data;
    }

    /**
     * Verificar colisi√≥n de horario para un staff
     * 
     * @param string $date Fecha de la asignaci√≥n
     * @param string $start_time Hora inicio
     * @param string $end_time Hora fin
     * @param int $staff_id ID del personal
     * @param int|null $exclude_id ID de asignaci√≥n a excluir (para ediciones)
     * @return bool true si hay colisi√≥n, false si no
     */
    public static function check_staff_collision($date, $start_time, $end_time, $staff_id, $exclude_id = null) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_assignments';
        
        // Query para detectar traslape de horarios
        // Traslape ocurre cuando:
        // - Nuevo inicio < Existente fin Y Nuevo fin > Existente inicio
        $query = $wpdb->prepare(
            "SELECT COUNT(*) FROM $table 
             WHERE assignment_date = %s 
             AND staff_id = %d 
             AND status = 'active'
             AND (
                 (%s < end_time AND %s > start_time)
             )",
            $date,
            $staff_id,
            $start_time,
            $end_time
        );
        
        if ($exclude_id) {
            $query .= $wpdb->prepare(" AND id != %d", $exclude_id);
        }
        
        $count = $wpdb->get_var($query);
        
        return intval($count) > 0;
    }

    /**
     * Verificar colisi√≥n de horario para una zona
     * 
     * @param string $date Fecha de la asignaci√≥n
     * @param string $start_time Hora inicio
     * @param string $end_time Hora fin
     * @param int $service_area_id ID de la zona
     * @param int|null $exclude_id ID de asignaci√≥n a excluir (para ediciones)
     * @return bool true si hay colisi√≥n, false si no
     */
    public static function check_area_collision($date, $start_time, $end_time, $service_area_id, $exclude_id = null) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_assignments';
        
        // Query para detectar traslape de horarios
        $query = $wpdb->prepare(
            "SELECT COUNT(*) FROM $table 
             WHERE assignment_date = %s 
             AND service_area_id = %d 
             AND status = 'active'
             AND (
                 (%s < end_time AND %s > start_time)
             )",
            $date,
            $service_area_id,
            $start_time,
            $end_time
        );
        
        if ($exclude_id) {
            $query .= $wpdb->prepare(" AND id != %d", $exclude_id);
        }
        
        $count = $wpdb->get_var($query);
        
        return intval($count) > 0;
    }

    // ============================================
    // M√âTODOS PARA DISPONIBILIDAD BASADA EN ASSIGNMENTS
    // ============================================

    /**
     * Obtener todas las fechas con asignaciones activas
     * 
     * @return array Array de fechas √∫nicas (YYYY-MM-DD)
     */
    public static function get_assignment_dates() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_assignments';
        
        $query = "SELECT DISTINCT assignment_date 
                  FROM $table 
                  WHERE status = 'active' 
                  AND assignment_date >= CURDATE()
                  ORDER BY assignment_date ASC";
        
        $results = $wpdb->get_col($query);
        
        if ($wpdb->last_error) {
            error_log("‚ùå [AssignmentsModel] Error al obtener fechas de asignaciones: " . $wpdb->last_error);
            return [];
        }
        
        return $results ? $results : [];
    }

    /**
     * Obtener fechas con asignaciones para un servicio espec√≠fico
     * 
     * @param string $service_key Clave del servicio
     * @param string|null $start_date Fecha inicio (YYYY-MM-DD)
     * @param string|null $end_date Fecha fin (YYYY-MM-DD)
     * @return array Array de fechas √∫nicas
     */
    public static function get_assignment_dates_by_service($service_key, $start_date = null, $end_date = null) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_assignments';
        
        $where_clauses = ["status = 'active'", "service_key = %s"];
        $params = [$service_key];
        
        // Por defecto, desde hoy
        if ($start_date) {
            $where_clauses[] = "assignment_date >= %s";
            $params[] = $start_date;
        } else {
            $where_clauses[] = "assignment_date >= CURDATE()";
        }
        
        if ($end_date) {
            $where_clauses[] = "assignment_date <= %s";
            $params[] = $end_date;
        }
        
        $where_sql = implode(' AND ', $where_clauses);
        
        $query = $wpdb->prepare(
            "SELECT DISTINCT assignment_date 
             FROM $table 
             WHERE $where_sql
             ORDER BY assignment_date ASC",
            ...$params
        );
        
        $results = $wpdb->get_col($query);
        
        if ($wpdb->last_error) {
            error_log("‚ùå [AssignmentsModel] Error al obtener fechas por servicio: " . $wpdb->last_error);
            return [];
        }
        
        return $results ? $results : [];
    }

    /**
     * Obtener asignaciones por servicio y fecha
     * Incluye datos enriquecidos de staff y zona
     * 
     * @param string $service_key Clave del servicio
     * @param string $date Fecha (YYYY-MM-DD)
     * @return array Array de asignaciones
     */
    public static function get_assignments_by_service_and_date($service_key, $date) {
        global $wpdb;
        $assignments_table = $wpdb->prefix . 'aa_assignments';
        $staff_table = $wpdb->prefix . 'aa_staff';
        $service_areas_table = $wpdb->prefix . 'aa_service_areas';
        
        $query = $wpdb->prepare(
            "SELECT 
                a.id,
                a.assignment_date,
                a.start_time,
                a.end_time,
                a.service_key,
                a.capacity,
                a.staff_id,
                a.service_area_id,
                s.name AS staff_name,
                sa.name AS service_area_name
             FROM $assignments_table a
             LEFT JOIN $staff_table s ON s.id = a.staff_id
             LEFT JOIN $service_areas_table sa ON sa.id = a.service_area_id
             WHERE a.service_key = %s 
             AND a.assignment_date = %s
             AND a.status = 'active'
             ORDER BY a.start_time ASC",
            $service_key,
            $date
        );
        
        $results = $wpdb->get_results($query, ARRAY_A);
        
        if ($wpdb->last_error) {
            error_log("‚ùå [AssignmentsModel] Error al obtener asignaciones por servicio y fecha: " . $wpdb->last_error);
            return [];
        }
        
        return $results ? $results : [];
    }

    /**
     * Obtener rangos ocupados para asignaciones espec√≠ficas
     * Consulta reservas existentes que ocupan las asignaciones
     * 
     * @param array $assignment_ids Array de IDs de asignaciones
     * @param string $date Fecha (YYYY-MM-DD)
     * @return array Array de rangos ocupados
     */
    public static function get_busy_ranges_by_assignment_ids($assignment_ids, $date) {
        global $wpdb;
        $reservas_table = $wpdb->prefix . 'aa_reservas';
        $assignments_table = $wpdb->prefix . 'aa_assignments';
        
        if (empty($assignment_ids)) {
            return [];
        }
        
        // Sanitizar IDs
        $ids = array_map('intval', $assignment_ids);
        $ids_placeholder = implode(',', $ids);
        
        // Obtener las asignaciones primero para conocer sus horarios
        $assignments_query = "SELECT id, start_time, end_time, capacity 
                              FROM $assignments_table 
                              WHERE id IN ($ids_placeholder)";
        
        $assignments = $wpdb->get_results($assignments_query, ARRAY_A);
        
        if ($wpdb->last_error || empty($assignments)) {
            error_log("‚ùå [AssignmentsModel] Error al obtener asignaciones: " . $wpdb->last_error);
            return [];
        }
        
        // Por ahora, retornar los rangos de tiempo de las asignaciones
        // En el futuro, esto consultar√° las reservas existentes
        $busy_ranges = [];
        
        foreach ($assignments as $assignment) {
            // Consultar reservas que caen dentro del horario de esta asignaci√≥n
            // IMPORTANTE: Solo considerar reservas con el mismo assignment_id
            $reservas_query = $wpdb->prepare(
                "SELECT 
                    fecha as start,
                    DATE_ADD(fecha, INTERVAL duracion MINUTE) as end,
                    servicio as title
                 FROM $reservas_table 
                 WHERE DATE(fecha) = %s
                 AND estado = 'confirmed'
                 AND assignment_id = %d
                 AND TIME(fecha) >= %s
                 AND TIME(fecha) < %s",
                $date,
                $assignment['id'],
                $assignment['start_time'],
                $assignment['end_time']
            );
            
            $reservas = $wpdb->get_results($reservas_query, ARRAY_A);
            
            if ($reservas) {
                foreach ($reservas as $reserva) {
                    $busy_ranges[] = [
                        'assignment_id' => $assignment['id'],
                        'start' => $reserva['start'],
                        'end' => $reserva['end'],
                        'title' => $reserva['title']
                    ];
                }
            }
        }
        
        return $busy_ranges;
    }
}




========================================
FILE: includes\models\ReservationsModel.php
========================================
<?php
/**
 * Modelo: Reservaciones
 * 
 * Responsable de:
 * - Consultas a la tabla wp_aa_reservas
 * - Obtenci√≥n de slots ocupados localmente
 * - Formateo de datos para disponibilidad
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Models
 */

if (!defined('ABSPATH')) exit;

class ReservationsModel {

    /**
     * Obtener slots ocupados desde la base de datos local
     * 
     * @return array Array de slots ocupados con formato [start, end]
     */
    public static function get_internal_busy_slots() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        // üîπ Obtener slot_duration configurado
        $slot_duration = intval(get_option('aa_slot_duration', 60));
        
        // üîπ Consultar solo citas confirmadas que NO han terminado
        $now = aa_get_current_datetime();
        
        $rows = $wpdb->get_results($wpdb->prepare("
            SELECT 
                fecha as start,
                DATE_ADD(fecha, INTERVAL %d MINUTE) as end,
                servicio,
                nombre
            FROM $table 
            WHERE estado = 'confirmed'
            AND DATE_ADD(fecha, INTERVAL %d MINUTE) >= %s
            ORDER BY fecha ASC
        ", $slot_duration, $slot_duration, $now));
        
        if ($wpdb->last_error) {
            error_log("‚ùå [ReservationsModel] Error en consulta: " . $wpdb->last_error);
            return [];
        }
        
        error_log("‚úÖ [ReservationsModel] Encontradas " . count($rows) . " citas confirmadas");
        
        // üîπ Formatear resultados en estructura compatible con Google Calendar
        return array_map(function($row) {
            return [
                'start' => $row->start,
                'end'   => $row->end,
                'title' => $row->servicio ?? 'Cita',
                'attendee' => $row->nombre ?? 'Sin nombre'
            ];
        }, $rows);
    }
    
    /**
     * Obtener todas las citas confirmadas (para debug)
     * 
     * @return array
     */
    public static function get_all_confirmed() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        $rows = $wpdb->get_results("
            SELECT * 
            FROM $table 
            WHERE estado = 'confirmed'
            ORDER BY fecha DESC
            LIMIT 50
        ");
        
        return $rows ?? [];
    }
    
    /**
     * Contar citas confirmadas
     * 
     * @return int
     */
    public static function count_confirmed() {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        $count = $wpdb->get_var("
            SELECT COUNT(*) 
            FROM $table 
            WHERE estado = 'confirmed'
        ");
        
        return intval($count);
    }

    /**
     * Obtener citas pendientes que coinciden en fecha/hora (para cancelaci√≥n autom√°tica)
     * 
     * @param string $fecha DateTime string (Y-m-d H:i:s)
     * @param int $exclude_id ID de la cita que estamos confirmando (para no cancelarla a ella misma)
     * @return array
     */
    public static function get_pending_conflicts($fecha, $exclude_id) {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_reservas';
        
        // Buscamos citas PENDIENTES que tengan EXACTAMENTE la misma fecha de inicio
        // y que no sean la cita actual.
        $rows = $wpdb->get_results($wpdb->prepare("
            SELECT id, nombre, correo, fecha 
            FROM $table 
            WHERE estado = 'pending' 
            AND fecha = %s 
            AND id != %d
        ", $fecha, $exclude_id));
        
        return $rows ?? [];
    }
}


========================================
FILE: includes\services\appointmentsService.php
========================================
<?php
/**
 * Appointments Service
 * 
 * Provides AJAX endpoint for fetching appointments with filters.
 * Used by the Appointments Explorer modal.
 * 
 * @package AgendaAutomatizada
 * @since 1.0.0
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

/**
 * Register AJAX endpoint for fetching appointments
 */
add_action('wp_ajax_aa_get_appointments', 'aa_get_appointments');

/**
 * Get appointments with optional filters
 * 
 * Parameters (via $_GET):
 * - type: pending | confirmed | cancelled (optional, legacy)
 * - unread: true | false (optional, legacy)
 * - page: int (default 1)
 * - time[]: future | past (optional, panel filter)
 * - status[]: pending | confirmed | cancelled (optional, panel filter)
 * - notification[]: unread | read (optional, panel filter)
 * 
 * @return void JSON response
 */
function aa_get_appointments() {
    global $wpdb;
    
    // Fixed limit
    $limit = 20;
    
    // Get parameters - legacy filters
    $type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : '';
    $unread = isset($_GET['unread']) && $_GET['unread'] === 'true';
    $page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
    
    // Get panel filters (arrays)
    $time_filters = isset($_GET['time']) && is_array($_GET['time']) 
        ? array_map('sanitize_text_field', $_GET['time']) 
        : [];
    $status_filters = isset($_GET['status']) && is_array($_GET['status']) 
        ? array_map('sanitize_text_field', $_GET['status']) 
        : [];
    $notification_filters = isset($_GET['notification']) && is_array($_GET['notification']) 
        ? array_map('sanitize_text_field', $_GET['notification']) 
        : [];
    
    // Validate type if provided (legacy)
    $valid_types = ['pending', 'confirmed', 'cancelled'];
    if ($type && !in_array($type, $valid_types)) {
        wp_send_json_error(['message' => 'Tipo de filtro inv√°lido']);
        return;
    }
    
    // Validate panel filter values
    $valid_time = ['future', 'past'];
    $valid_status = ['pending', 'confirmed', 'cancelled'];
    $valid_notification = ['unread', 'read'];
    
    $time_filters = array_filter($time_filters, function($v) use ($valid_time) {
        return in_array($v, $valid_time);
    });
    $status_filters = array_filter($status_filters, function($v) use ($valid_status) {
        return in_array($v, $valid_status);
    });
    $notification_filters = array_filter($notification_filters, function($v) use ($valid_notification) {
        return in_array($v, $valid_notification);
    });
    
    // Tables
    $reservas_table = $wpdb->prefix . 'aa_reservas';
    $notifications_table = $wpdb->prefix . 'aa_notifications';
    $clientes_table = $wpdb->prefix . 'aa_clientes';
    
    // Get current datetime in business timezone
    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    $now = new DateTime('now', new DateTimeZone($timezone));
    $now_sql = $now->format('Y-m-d H:i:s');
    
    // Build WHERE clauses
    $where_clauses = [];
    $join_clause = '';
    $needs_notification_join = false;
    
    // Legacy type filter (maps to estado in reservas) - only if no status panel filters
    if ($type && empty($status_filters)) {
        $where_clauses[] = $wpdb->prepare("r.estado = %s", $type);
    }
    
    // Panel: Status filter
    if (!empty($status_filters)) {
        $placeholders = implode(',', array_fill(0, count($status_filters), '%s'));
        $where_clauses[] = $wpdb->prepare("r.estado IN ($placeholders)", ...$status_filters);
    }
    
    // Panel: Time filter
    if (!empty($time_filters)) {
        $time_conditions = [];
        if (in_array('future', $time_filters)) {
            $time_conditions[] = $wpdb->prepare("r.fecha >= %s", $now_sql);
        }
        if (in_array('past', $time_filters)) {
            $time_conditions[] = $wpdb->prepare("r.fecha < %s", $now_sql);
        }
        if (!empty($time_conditions)) {
            $where_clauses[] = '(' . implode(' OR ', $time_conditions) . ')';
        }
    }
    
    // Panel: Notification filter
    if (!empty($notification_filters)) {
        $needs_notification_join = true;
        
        // If both unread and read are selected, no filter needed (show all)
        if (count($notification_filters) === 1) {
            if (in_array('unread', $notification_filters)) {
                $where_clauses[] = "n_filter.is_read = 0";
            } else if (in_array('read', $notification_filters)) {
                $where_clauses[] = "(n_filter.is_read = 1 OR n_filter.id IS NULL)";
            }
        }
    }
    
    // Legacy unread filter - only if no notification panel filters
    if ($unread && empty($notification_filters)) {
        $join_clause = "INNER JOIN {$notifications_table} n ON n.entity_type = 'reservation' AND n.entity_id = r.id AND n.is_read = 0";
        
        // If type is specified, also filter by notification type
        if ($type) {
            $where_clauses[] = $wpdb->prepare("n.type = %s", $type);
        }
    }
    
    // Add notification join for panel filter if needed
    if ($needs_notification_join && empty($join_clause)) {
        $join_clause = "LEFT JOIN {$notifications_table} n_filter ON n_filter.entity_type = 'reservation' AND n_filter.entity_id = r.id";
    }
    
    // Build WHERE string
    $where_sql = '';
    if (!empty($where_clauses)) {
        $where_sql = 'WHERE ' . implode(' AND ', $where_clauses);
    }
    
    // Count total for pagination
    $count_sql = "
        SELECT COUNT(DISTINCT r.id)
        FROM {$reservas_table} r
        {$join_clause}
        {$where_sql}
    ";
    
    $total_items = (int) $wpdb->get_var($count_sql);
    $total_pages = ceil($total_items / $limit);
    
    // Ensure page is within bounds
    $page = min($page, max(1, $total_pages));
    $offset = ($page - 1) * $limit;
    
    // Get appointments with unread notification status
    // Use subquery to check if there's an unread notification for each appointment
    $select_sql = "
        SELECT DISTINCT
            r.id,
            r.servicio,
            r.fecha,
            r.duracion,
            r.nombre,
            r.telefono,
            r.correo,
            r.estado,
            r.created_at,
            r.id_cliente,
            c.nombre as cliente_nombre,
            CASE 
                WHEN EXISTS (
                    SELECT 1 
                    FROM {$notifications_table} n 
                    WHERE n.entity_type = 'reservation' 
                    AND n.entity_id = r.id 
                    AND n.is_read = 0
                ) THEN 1 
                ELSE 0 
            END as unread
        FROM {$reservas_table} r
        LEFT JOIN {$clientes_table} c ON r.id_cliente = c.id
        {$join_clause}
        {$where_sql}
        ORDER BY r.created_at DESC
        LIMIT %d OFFSET %d
    ";
    
    $results = $wpdb->get_results(
        $wpdb->prepare($select_sql, $limit, $offset)
    );
    
    // Format items for frontend
    $items = [];
    foreach ($results as $row) {
        // Get timezone for date formatting
        $timezone = get_option('aa_timezone', 'America/Mexico_City');
        
        // Format date
        $fecha_formatted = '';
        $hora_formatted = '';
        
        if ($row->fecha) {
            try {
                $date = new DateTime($row->fecha, new DateTimeZone($timezone));
                $fecha_formatted = $date->format('d/m/Y');
                $hora_formatted = $date->format('H:i');
            } catch (Exception $e) {
                $fecha_formatted = $row->fecha;
                $hora_formatted = '';
            }
        }
        
        $items[] = [
            'id' => (int) $row->id,
            'servicio' => $row->servicio,
            'fecha' => $fecha_formatted,
            'hora' => $hora_formatted,
            'duracion' => (int) $row->duracion,
            'nombre' => $row->nombre,
            'cliente_nombre' => $row->cliente_nombre ?: $row->nombre,
            'telefono' => $row->telefono,
            'correo' => $row->correo,
            'estado' => $row->estado,
            'created_at' => $row->created_at,
            'unread' => isset($row->unread) ? (bool) $row->unread : false
        ];
    }
    
    // Send response
    wp_send_json_success([
        'items' => $items,
        'pagination' => [
            'page' => $page,
            'total_pages' => $total_pages,
            'total_items' => $total_items,
            'has_prev' => $page > 1,
            'has_next' => $page < $total_pages
        ],
        'filters' => [
            'type' => $type,
            'unread' => $unread,
            'time' => $time_filters,
            'status' => $status_filters,
            'notification' => $notification_filters
        ]
    ]);
}

/**
 * Register AJAX endpoint for marking a single appointment notification as read
 */
add_action('wp_ajax_aa_mark_appointment_notification_read', 'aa_mark_appointment_notification_read');

/**
 * Mark notification as read for a specific appointment
 * 
 * Parameters (via $_POST or $_GET):
 * - appointment_id: int (required)
 * 
 * @return void JSON response
 */
function aa_mark_appointment_notification_read() {
    global $wpdb;
    
    // Get appointment_id
    $appointment_id = isset($_REQUEST['appointment_id']) ? intval($_REQUEST['appointment_id']) : 0;
    
    if (!$appointment_id) {
        wp_send_json_error(['message' => 'appointment_id es requerido']);
        return;
    }
    
    $notifications_table = $wpdb->prefix . 'aa_notifications';
    
    // Mark notification as read for this specific appointment
    $result = $wpdb->update(
        $notifications_table,
        ['is_read' => 1],
        [
            'entity_type' => 'reservation',
            'entity_id' => $appointment_id,
            'is_read' => 0
        ],
        ['%d'],
        ['%s', '%d', '%d']
    );
    
    if ($result === false) {
        error_log("‚ùå Error marking appointment notification as read: " . $wpdb->last_error);
        wp_send_json_error(['message' => 'Error al marcar notificaci√≥n como le√≠da']);
        return;
    }
    
    // Return success (even if no rows were updated, it's not an error)
    wp_send_json_success([
        'message' => 'Notificaci√≥n marcada como le√≠da',
        'updated' => $result
    ]);
}



========================================
FILE: includes\services\assignmentsService.php
========================================
<?php
/**
 * Assignments Service
 * 
 * Provides AJAX endpoints for assignments management.
 * Handles service areas, staff, and assignments operations.
 * 
 * @package AgendaAutomatizada
 * @since 2.0.0
 */

defined('ABSPATH') or die('¬°Sin acceso directo!');

/**
 * Register AJAX endpoints
 */
add_action('wp_ajax_aa_get_service_areas', 'aa_get_service_areas');
add_action('wp_ajax_aa_create_service_area', 'aa_create_service_area');
add_action('wp_ajax_aa_toggle_service_area', 'aa_toggle_service_area');
add_action('wp_ajax_aa_get_staff', 'aa_get_staff');
add_action('wp_ajax_aa_create_staff', 'aa_create_staff');
add_action('wp_ajax_aa_toggle_staff', 'aa_toggle_staff');
add_action('wp_ajax_aa_get_assignments', 'aa_get_assignments');
add_action('wp_ajax_aa_delete_assignment', 'aa_delete_assignment');
add_action('wp_ajax_aa_get_services', 'aa_get_services');
add_action('wp_ajax_aa_create_assignment', 'aa_create_assignment');

// Endpoints para disponibilidad basada en assignments
add_action('wp_ajax_aa_get_assignment_dates', 'aa_get_assignment_dates');
add_action('wp_ajax_aa_get_assignment_dates_by_service', 'aa_get_assignment_dates_by_service');
add_action('wp_ajax_aa_get_assignments_by_service_and_date', 'aa_get_assignments_by_service_and_date');
add_action('wp_ajax_aa_get_busy_ranges_by_assignments', 'aa_get_busy_ranges_by_assignments');

/**
 * Get service areas (zonas de atenci√≥n)
 * 
 * Returns list of service areas, optionally filtered by active status.
 * 
 * @return void JSON response
 */
function aa_get_service_areas() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Obtener par√°metro opcional (por defecto incluir todas para UI de edici√≥n)
    $only_active = isset($_GET['only_active']) && $_GET['only_active'] === 'true';
    
    try {
        // Llamar al modelo
        $service_areas = AssignmentsModel::get_service_areas($only_active);
        
        wp_send_json_success([
            'service_areas' => $service_areas,
            'count' => count($service_areas)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener zonas de atenci√≥n: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener las zonas de atenci√≥n: ' . $e->getMessage()
        ]);
    }
}

/**
 * Create service area (zona de atenci√≥n)
 * 
 * Creates a new service area in the database.
 * 
 * @return void JSON response
 */
function aa_create_service_area() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Leer y validar datos POST
    if (!isset($_POST['name']) || empty($_POST['name'])) {
        wp_send_json_error(['message' => 'El nombre de la zona es requerido']);
        return;
    }
    
    // Sanitizar nombre
    $name = sanitize_text_field($_POST['name']);
    
    // Validar que no est√© vac√≠o despu√©s de sanitizar
    if (empty(trim($name))) {
        wp_send_json_error(['message' => 'El nombre de la zona no puede estar vac√≠o']);
        return;
    }
    
    try {
        // Llamar al modelo para crear la zona
        $result = AssignmentsModel::create_service_area($name);
        
        if ($result === false) {
            wp_send_json_error([
                'message' => 'Error al crear la zona de atenci√≥n en la base de datos'
            ]);
            return;
        }
        
        wp_send_json_success([
            'message' => 'Zona de atenci√≥n creada correctamente',
            'area' => $result
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al crear zona de atenci√≥n: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al crear la zona de atenci√≥n: ' . $e->getMessage()
        ]);
    }
}

/**
 * Toggle service area active status
 * 
 * Activates or deactivates a service area.
 * 
 * @return void JSON response
 */
function aa_toggle_service_area() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Leer y validar datos POST
    if (!isset($_POST['id']) || !isset($_POST['active'])) {
        wp_send_json_error(['message' => 'Faltan par√°metros requeridos']);
        return;
    }
    
    $id = intval($_POST['id']);
    $active = intval($_POST['active']);
    
    // Validar que active sea 0 o 1
    if ($active !== 0 && $active !== 1) {
        wp_send_json_error(['message' => 'El valor de active debe ser 0 o 1']);
        return;
    }
    
    // Validar ID
    if ($id <= 0) {
        wp_send_json_error(['message' => 'ID inv√°lido']);
        return;
    }
    
    try {
        // Llamar al modelo para actualizar el estado
        $result = AssignmentsModel::set_service_area_active($id, $active);
        
        if ($result === false) {
            wp_send_json_error([
                'message' => 'Error al actualizar el estado de la zona de atenci√≥n'
            ]);
            return;
        }
        
        wp_send_json_success([
            'message' => 'Estado de la zona actualizado correctamente',
            'id' => $id,
            'active' => $active
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al actualizar zona de atenci√≥n: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al actualizar el estado: ' . $e->getMessage()
        ]);
    }
}

/**
 * Get staff (personal)
 * 
 * Returns list of staff members, optionally filtered by active status.
 * 
 * @return void JSON response
 */
function aa_get_staff() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Obtener par√°metro opcional (por defecto incluir todos para UI de edici√≥n)
    $only_active = isset($_GET['only_active']) && $_GET['only_active'] === 'true';
    
    try {
        // Llamar al modelo
        $staff = AssignmentsModel::get_staff($only_active);
        
        wp_send_json_success([
            'staff' => $staff,
            'count' => count($staff)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener personal: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener el personal: ' . $e->getMessage()
        ]);
    }
}

/**
 * Create staff member (personal)
 * 
 * Creates a new staff member in the database.
 * 
 * @return void JSON response
 */
function aa_create_staff() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Leer y validar datos POST
    if (!isset($_POST['name']) || empty($_POST['name'])) {
        wp_send_json_error(['message' => 'El nombre del personal es requerido']);
        return;
    }
    
    // Sanitizar nombre
    $name = sanitize_text_field($_POST['name']);
    
    // Validar que no est√© vac√≠o despu√©s de sanitizar
    if (empty(trim($name))) {
        wp_send_json_error(['message' => 'El nombre del personal no puede estar vac√≠o']);
        return;
    }
    
    try {
        // Llamar al modelo para crear el personal
        $result = AssignmentsModel::create_staff($name);
        
        if ($result === false) {
            wp_send_json_error([
                'message' => 'Error al crear el personal en la base de datos'
            ]);
            return;
        }
        
        wp_send_json_success([
            'message' => 'Personal creado correctamente',
            'staff' => $result
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al crear personal: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al crear el personal: ' . $e->getMessage()
        ]);
    }
}

/**
 * Toggle staff active status
 * 
 * Activates or deactivates a staff member.
 * 
 * @return void JSON response
 */
function aa_toggle_staff() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Leer y validar datos POST
    if (!isset($_POST['id']) || !isset($_POST['active'])) {
        wp_send_json_error(['message' => 'Faltan par√°metros requeridos']);
        return;
    }
    
    $id = intval($_POST['id']);
    $active = intval($_POST['active']);
    
    // Validar que active sea 0 o 1
    if ($active !== 0 && $active !== 1) {
        wp_send_json_error(['message' => 'El valor de active debe ser 0 o 1']);
        return;
    }
    
    // Validar ID
    if ($id <= 0) {
        wp_send_json_error(['message' => 'ID inv√°lido']);
        return;
    }
    
    try {
        // Llamar al modelo para actualizar el estado
        $result = AssignmentsModel::set_staff_active($id, $active);
        
        if ($result === false) {
            wp_send_json_error([
                'message' => 'Error al actualizar el estado del personal'
            ]);
            return;
        }
        
        wp_send_json_success([
            'message' => 'Estado del personal actualizado correctamente',
            'id' => $id,
            'active' => $active
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al actualizar personal: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al actualizar el estado: ' . $e->getMessage()
        ]);
    }
}

/**
 * Get assignments
 * 
 * Returns list of all assignments.
 * 
 * @return void JSON response
 */
function aa_get_assignments() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    try {
        // Llamar al modelo
        $assignments = AssignmentsModel::get_assignments();
        
        wp_send_json_success([
            'assignments' => $assignments,
            'count' => count($assignments)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener asignaciones: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener las asignaciones: ' . $e->getMessage()
        ]);
    }
}

/**
 * Delete assignment
 * 
 * Deletes an assignment from the database.
 * 
 * @return void JSON response
 */
function aa_delete_assignment() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Leer y validar datos POST
    if (!isset($_POST['id'])) {
        wp_send_json_error(['message' => 'El ID de la asignaci√≥n es requerido']);
        return;
    }
    
    $id = intval($_POST['id']);
    
    // Validar ID
    if ($id <= 0) {
        wp_send_json_error(['message' => 'ID inv√°lido']);
        return;
    }
    
    try {
        // Llamar al modelo para eliminar la asignaci√≥n
        $result = AssignmentsModel::delete_assignment($id);
        
        if ($result === false) {
            wp_send_json_error([
                'message' => 'Error al eliminar la asignaci√≥n'
            ]);
            return;
        }
        
        wp_send_json_success([
            'message' => 'Asignaci√≥n eliminada correctamente',
            'id' => $id
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al eliminar asignaci√≥n: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al eliminar la asignaci√≥n: ' . $e->getMessage()
        ]);
    }
}

/**
 * Get services list
 * 
 * Returns list of configured services from aa_google_motivo option.
 * 
 * @return void JSON response
 */
function aa_get_services() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    try {
        // Obtener servicios desde la opci√≥n
        $motivos_json = get_option('aa_google_motivo', json_encode(['Cita general']));
        $motivos = json_decode($motivos_json, true);
        
        if (!is_array($motivos) || empty($motivos)) {
            $motivos = ['Cita general'];
        }
        
        wp_send_json_success([
            'services' => $motivos,
            'count' => count($motivos)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener servicios: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener los servicios: ' . $e->getMessage()
        ]);
    }
}

/**
 * Create assignment
 * 
 * Creates a new assignment in the database.
 * Validates for collisions with existing assignments.
 * 
 * @return void JSON response
 */
function aa_create_assignment() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Validar campos requeridos
    $required_fields = ['assignment_date', 'start_time', 'end_time', 'staff_id', 'service_area_id', 'service_key'];
    
    foreach ($required_fields as $field) {
        if (!isset($_POST[$field]) || empty($_POST[$field])) {
            wp_send_json_error(['message' => "El campo $field es requerido"]);
            return;
        }
    }
    
    // Sanitizar datos
    $data = [
        'assignment_date' => sanitize_text_field($_POST['assignment_date']),
        'start_time' => sanitize_text_field($_POST['start_time']),
        'end_time' => sanitize_text_field($_POST['end_time']),
        'staff_id' => intval($_POST['staff_id']),
        'service_area_id' => intval($_POST['service_area_id']),
        'service_key' => sanitize_text_field($_POST['service_key']),
        'capacity' => isset($_POST['capacity']) ? intval($_POST['capacity']) : 1
    ];
    
    // Validar formato de fecha
    if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $data['assignment_date'])) {
        wp_send_json_error(['message' => 'Formato de fecha inv√°lido']);
        return;
    }
    
    // Validar formato de hora
    if (!preg_match('/^\d{2}:\d{2}(:\d{2})?$/', $data['start_time']) || 
        !preg_match('/^\d{2}:\d{2}(:\d{2})?$/', $data['end_time'])) {
        wp_send_json_error(['message' => 'Formato de hora inv√°lido']);
        return;
    }
    
    // Validar que hora fin sea posterior a hora inicio
    if ($data['start_time'] >= $data['end_time']) {
        wp_send_json_error(['message' => 'La hora de fin debe ser posterior a la hora de inicio']);
        return;
    }
    
    // Validar IDs positivos
    if ($data['staff_id'] <= 0 || $data['service_area_id'] <= 0) {
        wp_send_json_error(['message' => 'IDs inv√°lidos']);
        return;
    }
    
    try {
        // Llamar al modelo para crear la asignaci√≥n
        $result = AssignmentsModel::create_assignment($data);
        
        if ($result === false) {
            wp_send_json_error([
                'message' => 'Error al crear la asignaci√≥n en la base de datos'
            ]);
            return;
        }
        
        if (isset($result['error'])) {
            wp_send_json_error([
                'message' => $result['error']
            ]);
            return;
        }
        
        wp_send_json_success([
            'message' => 'Asignaci√≥n creada correctamente',
            'assignment' => $result
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al crear asignaci√≥n: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al crear la asignaci√≥n: ' . $e->getMessage()
        ]);
    }
}

// ============================================
// ENDPOINTS PARA DISPONIBILIDAD BASADA EN ASSIGNMENTS
// ============================================

/**
 * Get all assignment dates
 * 
 * Returns all unique dates that have active assignments.
 * 
 * @return void JSON response
 */
function aa_get_assignment_dates() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    try {
        $dates = AssignmentsModel::get_assignment_dates();
        
        wp_send_json_success([
            'dates' => $dates,
            'count' => count($dates)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener fechas de asignaciones: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener las fechas: ' . $e->getMessage()
        ]);
    }
}

/**
 * Get assignment dates by service
 * 
 * Returns dates that have assignments for a specific service.
 * 
 * @return void JSON response
 */
function aa_get_assignment_dates_by_service() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Validar campo requerido
    if (!isset($_POST['service_key']) || empty($_POST['service_key'])) {
        wp_send_json_error(['message' => 'El campo service_key es requerido']);
        return;
    }
    
    $service_key = sanitize_text_field($_POST['service_key']);
    $start_date = isset($_POST['start_date']) ? sanitize_text_field($_POST['start_date']) : null;
    $end_date = isset($_POST['end_date']) ? sanitize_text_field($_POST['end_date']) : null;
    
    try {
        $dates = AssignmentsModel::get_assignment_dates_by_service($service_key, $start_date, $end_date);
        
        wp_send_json_success([
            'service_key' => $service_key,
            'dates' => $dates,
            'count' => count($dates)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener fechas por servicio: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener las fechas: ' . $e->getMessage()
        ]);
    }
}

/**
 * Get assignments by service and date
 * 
 * Returns all assignments for a specific service on a specific date.
 * 
 * @return void JSON response
 */
function aa_get_assignments_by_service_and_date() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Validar campos requeridos
    if (!isset($_POST['service_key']) || empty($_POST['service_key'])) {
        wp_send_json_error(['message' => 'El campo service_key es requerido']);
        return;
    }
    
    if (!isset($_POST['date']) || empty($_POST['date'])) {
        wp_send_json_error(['message' => 'El campo date es requerido']);
        return;
    }
    
    $service_key = sanitize_text_field($_POST['service_key']);
    $date = sanitize_text_field($_POST['date']);
    
    // Validar formato de fecha
    if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $date)) {
        wp_send_json_error(['message' => 'Formato de fecha inv√°lido. Use YYYY-MM-DD']);
        return;
    }
    
    try {
        $assignments = AssignmentsModel::get_assignments_by_service_and_date($service_key, $date);
        
        wp_send_json_success([
            'service_key' => $service_key,
            'date' => $date,
            'assignments' => $assignments,
            'count' => count($assignments)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener asignaciones por servicio y fecha: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener las asignaciones: ' . $e->getMessage()
        ]);
    }
}

/**
 * Get busy ranges by assignment IDs
 * 
 * Returns busy time ranges for specific assignments on a date.
 * 
 * @return void JSON response
 */
function aa_get_busy_ranges_by_assignments() {
    // Validar permisos
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'No tienes permisos para realizar esta acci√≥n']);
        return;
    }
    
    // Validar campos requeridos
    if (!isset($_POST['assignment_ids']) || empty($_POST['assignment_ids'])) {
        wp_send_json_error(['message' => 'El campo assignment_ids es requerido']);
        return;
    }
    
    if (!isset($_POST['date']) || empty($_POST['date'])) {
        wp_send_json_error(['message' => 'El campo date es requerido']);
        return;
    }
    
    // Parsear assignment_ids (puede venir como JSON string)
    $assignment_ids_raw = $_POST['assignment_ids'];
    if (is_string($assignment_ids_raw)) {
        $assignment_ids = json_decode($assignment_ids_raw, true);
    } else {
        $assignment_ids = $assignment_ids_raw;
    }
    
    if (!is_array($assignment_ids) || empty($assignment_ids)) {
        wp_send_json_error(['message' => 'assignment_ids debe ser un array no vac√≠o']);
        return;
    }
    
    $date = sanitize_text_field($_POST['date']);
    
    // Validar formato de fecha
    if (!preg_match('/^\d{4}-\d{2}-\d{2}$/', $date)) {
        wp_send_json_error(['message' => 'Formato de fecha inv√°lido. Use YYYY-MM-DD']);
        return;
    }
    
    try {
        $busy_ranges = AssignmentsModel::get_busy_ranges_by_assignment_ids($assignment_ids, $date);
        
        wp_send_json_success([
            'assignment_ids' => $assignment_ids,
            'date' => $date,
            'busy_ranges' => $busy_ranges,
            'count' => count($busy_ranges)
        ]);
    } catch (Exception $e) {
        error_log("‚ùå [assignmentsService] Error al obtener busy ranges: " . $e->getMessage());
        wp_send_json_error([
            'message' => 'Error al obtener los rangos ocupados: ' . $e->getMessage()
        ]);
    }
}




========================================
FILE: includes\services\availability-proxy.php
========================================
<?php
if (!defined('ABSPATH')) exit;

function aa_build_availability_url_for($email) {
    $backend_url = AA_API_BASE_URL . "/calendar/availability";

    $now = new DateTime('now', new DateTimeZone('UTC'));
    $future = new DateTime('+1 month', new DateTimeZone('UTC'));

    // üîπ Usar la funci√≥n centralizada para obtener el domain
    $domain = aa_get_clean_domain();

    $params = [
        'domain'  => $domain,
        'email'   => $email,
        'timeMin' => $now->format(DateTime::ATOM),
        'timeMax' => $future->format(DateTime::ATOM),
    ];

    return $backend_url . '?' . http_build_query($params);
}

// Endpoint AJAX (p√∫blico y autenticado) que act√∫a como proxy al backend
add_action('wp_ajax_nopriv_aa_get_availability', 'aa_ajax_get_availability');
add_action('wp_ajax_aa_get_availability', 'aa_ajax_get_availability');

function aa_ajax_get_availability() {
    $email = isset($_REQUEST['email']) ? sanitize_email(wp_unslash($_REQUEST['email'])) : sanitize_email(get_option('aa_google_email', ''));

    if (empty($email)) {
        error_log("‚ùå aa_availability: No hay email configurado");
        wp_send_json_error(['message' => 'No email configured'], 400);
    }

    $backend_url = aa_build_availability_url_for($email);
    
    error_log("üì§ aa_availability: Consultando disponibilidad");
    error_log("   Email: $email");
    error_log("   URL: $backend_url");

    $response = aa_send_authenticated_request($backend_url, 'GET');

    if (is_wp_error($response)) {
        error_log("‚ùå aa_availability: Error WP - " . $response->get_error_message());
        wp_send_json_error(['message' => 'request_failed', 'error' => $response->get_error_message()], 500);
    }

    $code = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    
    error_log("üì• aa_availability: Respuesta recibida (status $code)");

    if ($code === 401 || $code === 403) {
        $decoded = json_decode($body, true);
        error_log("üîí Error de autenticaci√≥n en availability: " . ($decoded['error'] ?? 'Sin detalles'));
        wp_send_json_error([
            'message' => 'authentication_failed',
            'error' => $decoded['error'] ?? 'Unauthorized'
        ], $code);
    }

    if ($code >= 500) {
        $decoded = json_decode($body, true);
        error_log("üî• Error 500 del backend: " . print_r($decoded, true));
        wp_send_json_error([
            'message' => 'backend_error',
            'error' => $decoded['error'] ?? 'Internal server error'
        ], $code);
    }

    status_header($code);
    header('Content-Type: application/json; charset=utf-8');
    echo $body;
    wp_die();
}


========================================
FILE: includes\services\ClienteService.php
========================================
<?php
/**
 * ClienteService
 * 
 * Centraliza la l√≥gica de b√∫squeda y creaci√≥n de clientes para WP Agenda Automatizada.
 * 
 * Reglas de b√∫squeda:
 * - El tel√©fono es la clave primaria de b√∫squeda
 * - El correo es secundaria
 * - Si existe cliente por tel√©fono, usar ese
 * - Si no hay tel√©fono o no existe, buscar por correo
 * - Si no existe ninguno, crear cliente nuevo
 * - NO eliminar clientes duplicados
 * - NO modificar el esquema de base de datos
 */

if (!defined('ABSPATH')) exit;

class ClienteService {
    
    /**
     * Obtiene o crea un cliente basado en tel√©fono (prioritario) o correo.
     * 
     * @param array $data Array con las claves: 'nombre', 'telefono', 'correo'
     * @return int ID del cliente (existente o nuevo)
     * @throws Exception Si no se puede crear o encontrar el cliente
     */
    public static function getOrCreate(array $data): int {
        global $wpdb;
        
        // Sanitizar y validar datos de entrada
        $nombre = isset($data['nombre']) ? sanitize_text_field($data['nombre']) : '';
        $telefono = isset($data['telefono']) ? sanitize_text_field($data['telefono']) : '';
        $correo = isset($data['correo']) ? sanitize_email($data['correo']) : '';
        
        // Validar que al menos nombre est√© presente
        if (empty($nombre)) {
            throw new Exception('El nombre es obligatorio para crear o buscar un cliente.');
        }
        
        $table = $wpdb->prefix . 'aa_clientes';
        
        // 1. Buscar por tel√©fono (clave primaria de b√∫squeda)
        if (!empty($telefono)) {
            $cliente = self::findByTelefono($telefono);
            if ($cliente) {
                // Retornar ID del cliente existente sin modificar datos
                return (int) $cliente->id;
            }
        }
        
        // 2. Si no hay tel√©fono o no existe, buscar por correo (clave secundaria)
        if (!empty($correo)) {
            $cliente = self::findByCorreo($correo);
            if ($cliente) {
                // Retornar ID del cliente existente sin modificar datos
                return (int) $cliente->id;
            }
        }
        
        // 3. Si no existe ninguno, crear cliente nuevo
        return self::createCliente($nombre, $telefono, $correo);
    }
    
    /**
     * Busca un cliente por tel√©fono.
     * 
     * @param string $telefono Tel√©fono a buscar
     * @return object|null Cliente encontrado o null
     */
    private static function findByTelefono(string $telefono): ?object {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_clientes';
        
        $telefono_sanitizado = sanitize_text_field($telefono);
        
        return $wpdb->get_row($wpdb->prepare(
            "SELECT id, nombre, telefono, correo FROM $table WHERE telefono = %s LIMIT 1",
            $telefono_sanitizado
        ));
    }
    
    /**
     * Busca un cliente por correo.
     * 
     * @param string $correo Correo a buscar
     * @return object|null Cliente encontrado o null
     */
    private static function findByCorreo(string $correo): ?object {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_clientes';
        
        $correo_sanitizado = sanitize_email($correo);
        
        return $wpdb->get_row($wpdb->prepare(
            "SELECT id, nombre, telefono, correo FROM $table WHERE correo = %s LIMIT 1",
            $correo_sanitizado
        ));
    }
    
    /**
     * Crea un nuevo cliente en la base de datos.
     * 
     * @param string $nombre Nombre del cliente
     * @param string $telefono Tel√©fono del cliente
     * @param string $correo Correo del cliente
     * @return int ID del cliente creado
     * @throws Exception Si no se puede crear el cliente
     */
    private static function createCliente(string $nombre, string $telefono, string $correo): int {
        global $wpdb;
        $table = $wpdb->prefix . 'aa_clientes';
        
        // Validar que el correo no est√© duplicado (si se proporciona)
        if (!empty($correo)) {
            $correo_existente = self::findByCorreo($correo);
            if ($correo_existente) {
                // Si existe por correo, retornar ese ID (no deber√≠a llegar aqu√≠, pero por seguridad)
                return (int) $correo_existente->id;
            }
        }
        
        // Preparar datos para inserci√≥n
        $insert_data = [
            'nombre' => $nombre,
            'telefono' => $telefono,
            'correo' => $correo,
            'created_at' => current_time('mysql')
        ];
        
        // Insertar cliente
        $result = $wpdb->insert(
            $table,
            $insert_data,
            ['%s', '%s', '%s', '%s']
        );
        
        if ($result === false) {
            error_log("‚ùå Error al crear cliente: " . $wpdb->last_error);
            throw new Exception('Error al crear el cliente en la base de datos: ' . $wpdb->last_error);
        }
        
        $cliente_id = $wpdb->insert_id;
        
        if (!$cliente_id) {
            error_log("‚ùå Cliente creado pero no se obtuvo insert_id");
            throw new Exception('Error: No se pudo obtener el ID del cliente creado.');
        }
        
        error_log("‚úÖ Nuevo cliente creado ID: $cliente_id (nombre: $nombre, tel: $telefono, correo: $correo)");
        
        return (int) $cliente_id;
    }
}




========================================
FILE: includes\services\confirm-backend-service.php
========================================
<?php
/**
 * Servicio: Confirmaci√≥n de Citas con Backend
 * 
 * Responsable de:
 * - Obtener datos de la reserva desde WordPress
 * - Construir payload para el backend
 * - Enviar petici√≥n autenticada con HMAC
 * - Actualizar estado de la reserva en WordPress
 * - Ejecutar cancelaci√≥n en cascada de citas conflictivas
 * - Enviar correos de confirmaci√≥n al backend
 * 
 * NO contiene validaciones de AJAX ni permisos (eso es del controlador).
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Services
 */

if (!defined('ABSPATH')) exit;

/**
 * Confirmar una cita enviando solicitud al backend
 * 
 * @param int $reserva_id ID de la reserva
 * @return array ['success' => bool, 'message' => string, 'data' => array]
 */
function confirm_backend_service_confirmar($reserva_id) {
    global $wpdb;
    $table = $wpdb->prefix . 'aa_reservas';
    
    // 1Ô∏è‚É£ Obtener datos de la reserva
    $reserva = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE id = %d",
        $reserva_id
    ));
    
    if (!$reserva) {
        return [
            'success' => false,
            'message' => 'Reserva no encontrada.'
        ];
    }
    
    // üîπ PASO 1: Actualizar estado en WordPress PRIMERO
    $updated = $wpdb->update($table, ['estado' => 'confirmed'], ['id' => $reserva_id]);
    
    if ($updated === false) {
        error_log("‚ùå [ConfirmService] Error al actualizar estado en WordPress");
        return [
            'success' => false,
            'message' => 'Error al actualizar el estado en la base de datos.'
        ];
    }
    
    error_log("‚úÖ [ConfirmService] Cita ID $reserva_id marcada como 'confirmed' en WordPress");
    
    // =========================================================================
    // üõ°Ô∏è L√ìGICA DE CANCELACI√ìN EN CASCADA
    // =========================================================================
    require_once plugin_dir_path(__FILE__) . '../models/ReservationsModel.php';

    $conflictos = ReservationsModel::get_pending_conflicts($reserva->fecha, $reserva_id);

    if (!empty($conflictos)) {
        error_log("‚öîÔ∏è [ConfirmService] Se encontraron " . count($conflictos) . " citas pendientes en conflicto para la fecha: " . $reserva->fecha);
        
        foreach ($conflictos as $conflicto) {
            $cancelado = $wpdb->update(
                $table, 
                ['estado' => 'cancelled'], 
                ['id' => $conflicto->id]
            );
            
            if ($cancelado !== false) {
                error_log("üö´ [Auto-Cancel] Cita ID {$conflicto->id} ({$conflicto->nombre}) cancelada autom√°ticamente por ocupaci√≥n de slot.");
                
                // üîî Marcar notificaci√≥n como le√≠da
                $notifications_table = $wpdb->prefix . 'aa_notifications';
                $notification_id = $wpdb->get_var($wpdb->prepare(
                    "SELECT id FROM $notifications_table 
                    WHERE entity_type = %s AND entity_id = %d",
                    'reservation',
                    $conflicto->id
                ));
                
                if ($notification_id) {
                    $notification_updated = $wpdb->update(
                        $notifications_table,
                        ['is_read' => 1],
                        ['id' => $notification_id],
                        ['%d'],
                        ['%d']
                    );
                    
                    if ($notification_updated !== false) {
                        error_log("‚úÖ [Auto-Cancel] Notificaci√≥n ID $notification_id marcada como le√≠da para cita cancelada ID {$conflicto->id}");
                    } else {
                        error_log("‚ö†Ô∏è [Auto-Cancel] Error al marcar notificaci√≥n como le√≠da: " . $wpdb->last_error);
                    }
                }
            }
        }
    }
    // =========================================================================

     // ---------------------------------------------------------
    // üõë Validar si existe email antes de seguir
    // ---------------------------------------------------------
    $google_email = get_option('aa_google_email', '');

    if (empty($google_email)) {
        error_log("‚ÑπÔ∏è [ConfirmService] Modo Local: Sin email configurado.");
        return [
            'success' => true,
            'message' => 'Cita confirmada localmente (Sin sincronizaci√≥n con Google Calendar).',
            'data' => [
                'existed' => false,
                'calendar_sync' => false
            ]
        ];
    }
    // ---------------------------------------------------------

    // 2Ô∏è‚É£ Obtener configuraci√≥n
    $business_name = get_option('aa_business_name', get_bloginfo('name'));
    $business_address = get_option('aa_business_address', 'No especificada');
    
    // üîπ Obtener duraci√≥n de la reserva guardada o usar configuraci√≥n como fallback
    $duracion = isset($reserva->duracion) && !empty($reserva->duracion) 
        ? intval($reserva->duracion) 
        : intval(get_option('aa_slot_duration', 60));
    // Validar que sea 30, 60 o 90
    if (!in_array($duracion, [30, 60, 90])) {
        $duracion = 60;
    }
    
    // 3Ô∏è‚É£ Obtener dominio limpio usando la funci√≥n centralizada
    $domain = aa_get_clean_domain();
    
    // 4Ô∏è‚É£ Determinar URL del backend
    $backend_url = (strpos(get_site_url(), 'localhost') !== false)
        ? 'http://localhost:3000/calendar/crear-reserva-directa'
        : 'https://deoia-oauth-backend.onrender.com/calendar/crear-reserva-directa';
    
    // 5Ô∏è‚É£ Formatear fecha seg√∫n el backend espera (ISO 8601 con timezone)
    $timezone = get_option('aa_timezone', 'America/Mexico_City');
    
    try {
        $fecha_obj = new DateTime($reserva->fecha, new DateTimeZone($timezone));
        $fecha_iso = $fecha_obj->format('c'); // Formato: 2025-11-17T09:30:00-06:00
    } catch (Exception $e) {
        error_log("‚ùå [ConfirmService] Error al formatear fecha: " . $e->getMessage());
        return [
            'success' => false,
            'message' => 'Error al formatear la fecha de la reserva.'
        ];
    }
    
    // 6Ô∏è‚É£ Construir payload para el backend
    $payload = [
        'domain' => $domain,
        'nombre' => $reserva->nombre,
        'servicio' => $reserva->servicio,
        'fecha' => $fecha_iso,
        'telefono' => $reserva->telefono,
        'email' => $reserva->correo,
        'slot_duration' => $duracion, // Mantener compatibilidad con backend
        'businessName' => $business_name,
        'businessAddress' => $business_address,
        'id_reserva' => $reserva_id
    ];
    
    error_log("üì§ [ConfirmService] Enviando confirmaci√≥n al backend:");
    error_log("   URL: $backend_url");
    error_log("   Payload: " . json_encode($payload, JSON_PRETTY_PRINT));
    
    // 7Ô∏è‚É£ Enviar petici√≥n autenticada con HMAC
    $response = aa_send_authenticated_request($backend_url, 'POST', $payload);
    
    if (is_wp_error($response)) {
        error_log("‚ö†Ô∏è [ConfirmService] Error al contactar backend: " . $response->get_error_message());
        return [
            'success' => true,
            'message' => 'Cita confirmada en WordPress, pero no se pudo sincronizar con Google Calendar: ' . $response->get_error_message(),
            'calendar_sync' => false
        ];
    }
    
    // 8Ô∏è‚É£ Procesar respuesta
    $status = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    $decoded = json_decode($body, true);
    
    error_log("üì• [ConfirmService] Respuesta del backend (HTTP $status):");
    error_log("   " . print_r($decoded, true));
    
    if ($status >= 200 && $status < 300 && isset($decoded['success']) && $decoded['success']) {
        // ‚úÖ Backend confirm√≥ exitosamente
        
        // 9Ô∏è‚É£ Actualizar calendar_uid en WordPress
        $calendar_uid = $decoded['data']['event_id'] ?? null;
        
        if ($calendar_uid) {
            $wpdb->update($table, ['calendar_uid' => $calendar_uid], ['id' => $reserva_id]);
            error_log("‚úÖ [ConfirmService] calendar_uid actualizado: $calendar_uid");
        }
        
        return [
            'success' => true,
            'message' => $decoded['data']['existed'] 
                ? 'Cita confirmada. El evento ya exist√≠a en Google Calendar.' 
                : 'Cita confirmada y agregada a Google Calendar.',
            'data' => [
                'event_id' => $calendar_uid,
                'event_link' => $decoded['data']['event_link'] ?? null,
                'existed' => $decoded['data']['existed'] ?? false,
                'calendar_sync' => true
            ]
        ];
        
    } else {
        // ‚ùå Backend respondi√≥ con error
        $error_message = $decoded['message'] ?? 'Error desconocido del backend.';
        
        error_log("‚ö†Ô∏è [ConfirmService] Backend respondi√≥ con error: $error_message");
        
        return [
            'success' => true,
            'message' => "Cita confirmada en WordPress, pero fall√≥ la sincronizaci√≥n con Google Calendar: $error_message",
            'calendar_sync' => false
        ];
    }
}

/**
 * Enviar correo de confirmaci√≥n al backend
 * 
 * @param array $datos Datos de la reserva desde AJAX
 * @return array ['success' => bool, 'message' => string, 'data' => array]
 */
function confirm_backend_service_enviar_correo($datos) {
    // üîπ Usar la funci√≥n centralizada para obtener el domain
    $domain = aa_get_clean_domain();

    error_log("üß© [EmailService] Dominio detectado: $domain");

    // üîπ Obtener duraci√≥n de los datos de la reserva o usar configuraci√≥n como fallback
    $duracion = isset($datos['duracion']) ? intval($datos['duracion']) : intval(get_option('aa_slot_duration', 60));
    // Validar que sea 30, 60 o 90
    if (!in_array($duracion, [30, 60, 90])) {
        $duracion = 60;
    }

    // üîπ Reorganizar datos para enviar al backend
    $backend_data = [
        'domain' => $domain,
        'nombre' => $datos['nombre'] ?? '',
        'servicio' => $datos['servicio'] ?? '',
        'fecha' => $datos['fecha'] ?? '',
        'telefono' => $datos['telefono'] ?? '',
        'email' => $datos['correo'] ?? '',
        'id_reserva' => $datos['id_reserva'] ?? null,
        'businessName' => get_option('aa_business_name', 'Nuestro negocio'),
        'businessAddress' => get_option('aa_business_address', 'No especificada'),
        'whatsapp' => get_option('aa_whatsapp_number', ''),
        'slot_duration' => $duracion, // Mantener compatibilidad con backend
    ];

    error_log("üì¶ [EmailService] Datos reorganizados para backend:");
    error_log(print_r($backend_data, true));

    // üîπ Determinar URL del backend seg√∫n entorno
    $site_url = get_site_url();
    $backend_url = (strpos($site_url, 'localhost') !== false)
        ? 'http://localhost:3000/correos/confirmacion'
        : 'https://deoia-oauth-backend.onrender.com/correos/confirmacion';

    // üîπ Enviar petici√≥n autenticada con HMAC
    $response = aa_send_authenticated_request($backend_url, 'POST', $backend_data);

    if (is_wp_error($response)) {
        error_log("‚ùå [EmailService] Error al contactar backend: " . $response->get_error_message());
        return [
            'success' => false,
            'message' => 'Error de conexi√≥n con el backend',
            'error' => $response->get_error_message()
        ];
    }

    $status = wp_remote_retrieve_response_code($response);
    $body = wp_remote_retrieve_body($response);
    $decoded = json_decode($body, true);

    error_log("üì• [EmailService] Respuesta del backend (status $status): " . print_r($decoded, true));

    if ($status >= 200 && $status < 300 && isset($decoded['success']) && $decoded['success']) {
        return [
            'success' => true,
            'message' => 'Correos enviados correctamente',
            'backend_response' => $decoded
        ];
    } else {
        return [
            'success' => false,
            'message' => 'El backend respondi√≥ con error',
            'backend_response' => $decoded
        ];
    }
}


========================================
FILE: includes\services\notificationsService.php
========================================
<?php
/**
 * NotificationsService
 * 
 * Service for handling notifications-related operations.
 * Provides AJAX endpoints for retrieving unread notifications data.
 * 
 * @package WP_Agenda_Automatizada
 */

if (!defined('ABSPATH')) exit;

/**
 * Register AJAX endpoint for getting unread notifications count
 */
add_action('wp_ajax_aa_get_unread_notifications', 'aa_ajax_get_unread_notifications');

/**
 * AJAX handler: Get unread notifications count
 * 
 * Returns JSON with:
 * - total: total count of unread notifications
 * - by_type: object with counts grouped by type
 * 
 * @return void Sends JSON response via wp_send_json_success()
 */
function aa_ajax_get_unread_notifications() {
    global $wpdb;
    
    $table = $wpdb->prefix . 'aa_notifications';
    
    // Verify table exists
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table'") === $table;
    
    if (!$table_exists) {
        wp_send_json_success([
            'total' => 0,
            'by_type' => []
        ]);
    }
    
    // Query: Get counts grouped by type for unread notifications
    $results = $wpdb->get_results(
        "SELECT type, COUNT(*) as count 
         FROM $table 
         WHERE is_read = 0 
         GROUP BY type",
        ARRAY_A
    );
    
    // Build by_type object and calculate total
    $by_type = [];
    $total = 0;
    
    if ($results && is_array($results)) {
        foreach ($results as $row) {
            $type = sanitize_key($row['type']);
            $count = intval($row['count']);
            $by_type[$type] = $count;
            $total += $count;
        }
    }
    
    // Return response
    wp_send_json_success([
        'total' => $total,
        'by_type' => $by_type
    ]);
}

/**
 * Register AJAX endpoint for marking notifications as read by type
 */
add_action('wp_ajax_aa_mark_notifications_as_read', 'aa_ajax_mark_notifications_as_read');

/**
 * AJAX handler: Mark notifications as read by type
 * 
 * Updates is_read = 1 for all unread notifications of a specific type.
 * 
 * @return void Sends JSON response via wp_send_json_success()
 */
function aa_ajax_mark_notifications_as_read() {
    global $wpdb;
    
    // Get and validate type parameter
    $type = isset($_REQUEST['type']) ? sanitize_key($_REQUEST['type']) : '';
    
    if (empty($type)) {
        wp_send_json_error(['message' => 'Type parameter is required']);
        return;
    }
    
    // Validate type value (whitelist allowed types)
    $allowed_types = ['pending', 'confirmed', 'cancelled'];
    if (!in_array($type, $allowed_types, true)) {
        wp_send_json_error(['message' => 'Invalid type parameter']);
        return;
    }
    
    $table = $wpdb->prefix . 'aa_notifications';
    
    // Verify table exists
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$table'") === $table;
    
    if (!$table_exists) {
        wp_send_json_error(['message' => 'Notifications table does not exist']);
        return;
    }
    
    // Update notifications: mark as read where is_read = 0 and type matches
    $result = $wpdb->query(
        $wpdb->prepare(
            "UPDATE $table 
             SET is_read = 1 
             WHERE is_read = 0 AND type = %s",
            $type
        )
    );
    
    if ($result === false) {
        error_log("‚ùå Error marking notifications as read: " . $wpdb->last_error);
        wp_send_json_error(['message' => 'Database error: ' . $wpdb->last_error]);
        return;
    }
    
    // Return success response
    wp_send_json_success();
}




========================================
FILE: includes\services\SyncService.php
========================================
<?php
/**
 * Sync Service
 * 
 * Servicio para gestionar el estado de sincronizaci√≥n con Google Calendar.
 * 
 * @package WP_Agenda_Automatizada
 * @subpackage Services
 */

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

/**
 * Class SyncService
 * 
 * Maneja la l√≥gica de negocio relacionada con el estado de sincronizaci√≥n.
 */
class SyncService {

    /**
     * Actualiza el estado de sincronizaci√≥n de Google Calendar.
     *
     * @param string $status Estado de sincronizaci√≥n ('invalid' o 'valid')
     * @return array Array con 'success' (bool) y 'message' (string)
     * @throws Exception Si el estado no es v√°lido o la actualizaci√≥n falla
     */
    public static function update_sync_status($status) {
        // Validaci√≥n estricta: solo se acepta 'invalid' en este momento
        if ($status !== 'invalid') {
            return array(
                'success' => false,
                'message' => 'Solo se acepta el estado "invalid" en este momento'
            );
        }

        // Intentar actualizar la opci√≥n de estado de sincronizaci√≥n
        $updated = update_option('aa_estado_gsync', 'invalid');

        // Verificar si la actualizaci√≥n fue exitosa
        if (!$updated && get_option('aa_estado_gsync') !== 'invalid') {
            return array(
                'success' => false,
                'message' => 'No se pudo actualizar el estado de sincronizaci√≥n'
            );
        }

        // Registrar el evento en logs
        if (function_exists('error_log')) {
            error_log(sprintf(
                '[WP Agenda] Estado de sincronizaci√≥n actualizado a: %s en %s',
                $status,
                current_time('mysql')
            ));
        }

        // Retornar √©xito
        return array(
            'success' => true,
            'message' => 'Estado de sincronizaci√≥n actualizado correctamente',
            'status'  => $status
        );
    }

    /**
     * Obtiene el estado actual de sincronizaci√≥n.
     *
     * @return string Estado actual ('valid' o 'invalid')
     */
    public static function get_sync_status() {
        return get_option('aa_estado_gsync', 'valid');
    }

    /**
     * Restablece el estado de sincronizaci√≥n a v√°lido.
     *
     * @return bool True si se actualiz√≥ correctamente, false en caso contrario
     */
    public static function reset_sync_status() {
        $updated = update_option('aa_estado_gsync', 'valid');
        
        if ($updated || get_option('aa_estado_gsync') === 'valid') {
            if (function_exists('error_log')) {
                error_log(sprintf(
                    '[WP Agenda] Estado de sincronizaci√≥n restablecido a: valid en %s',
                    current_time('mysql')
                ));
            }
            return true;
        }
        
        return false;
    }

    /**
     * Verifica si el estado de sincronizaci√≥n es inv√°lido.
     *
     * @return bool True si el estado es 'invalid', false en caso contrario
     */
    public static function is_sync_invalid() {
        return self::get_sync_status() === 'invalid';
    }

    /**
     * Genera la URL de autorizaci√≥n OAuth de Google.
     *
     * @return string URL completa para iniciar el flujo OAuth
     */
    public static function get_auth_url() {
        $backend_url = AA_API_BASE_URL . '/oauth/authorize';
        $state = home_url();
        $redirect_uri = admin_url('admin-post.php?action=aa_connect_google');
        
        // üîπ Obtener el email del administrador de WordPress para usarlo como contact_email
        $contact_email = get_option('admin_email', '');
        
        return $backend_url 
            . '?state=' . urlencode($state) 
            . '&redirect_uri=' . urlencode($redirect_uri)
            . '&contact_email=' . urlencode($contact_email);
    }

    /**
     * Maneja el √©xito de la autenticaci√≥n OAuth.
     * Actualiza el email y secret del cliente, y resetea el estado de sincronizaci√≥n a v√°lido.
     *
     * @param string $email Email de la cuenta de Google conectada
     * @param string $secret Secret del cliente OAuth
     * @return bool True si se actualiz√≥ correctamente
     */
    public static function handle_oauth_success($email, $secret) {
        // Actualizar opciones de WordPress
        update_option('aa_google_email', sanitize_email($email));
        update_option('aa_client_secret', sanitize_text_field($secret));
        
        // Resetear el estado de sincronizaci√≥n a v√°lido
        $reset_success = self::reset_sync_status();
        
        // Registrar en logs
        if (function_exists('error_log')) {
            error_log(sprintf(
                '[WP Agenda] OAuth exitoso - Email: %s, Estado sync: valid en %s',
                $email,
                current_time('mysql')
            ));
        }
        
        return $reset_success;
    }

    /**
     * Notifica al backend sobre la desconexi√≥n de Google Calendar.
     * Env√≠a una petici√≥n autenticada con HMAC al endpoint /oauth/service.
     *
     * @return array|WP_Error Respuesta del backend o error
     */
    public static function notify_backend_disconnect_google() {
        // Asegurar que el helper est√© disponible
        if (!function_exists('aa_get_clean_domain')) {
            require_once dirname(dirname(__FILE__)) . '/auth-helper.php';
        }
        
        if (!function_exists('aa_send_authenticated_request')) {
            error_log('[WP Agenda] Error: aa_send_authenticated_request no disponible');
            return new WP_Error('helper_unavailable', 'Funci√≥n de autenticaci√≥n no disponible');
        }

        // Construir payload
        $domain = aa_get_clean_domain();
        $payload = [
            'domain' => $domain,
            'service' => 'disconnect_google',
        ];

        // Construir endpoint
        $endpoint = AA_API_BASE_URL . '/oauth/service';

        // Enviar petici√≥n autenticada
        $response = aa_send_authenticated_request($endpoint, 'POST', $payload);

        // Manejar respuesta
        if (is_wp_error($response)) {
            error_log(sprintf(
                '[WP Agenda] Error al notificar desconexi√≥n al backend: %s',
                $response->get_error_message()
            ));
            return $response;
        }

        // Verificar c√≥digo de respuesta HTTP
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);

        if ($response_code >= 200 && $response_code < 300) {
            error_log(sprintf(
                '[WP Agenda] Backend notificado correctamente de desconexi√≥n (code: %d, domain: %s)',
                $response_code,
                $domain
            ));
        } else {
            error_log(sprintf(
                '[WP Agenda] Backend respondi√≥ con error al notificar desconexi√≥n (code: %d, body: %s)',
                $response_code,
                $response_body
            ));
        }

        return [
            'code' => $response_code,
            'body' => $response_body,
        ];
    }
}



========================================
FILE: views\admin-controls.php
========================================
<?php
if (!defined('ABSPATH')) exit;

// üîπ Banner de notificaci√≥n global cuando la sincronizaci√≥n est√° inv√°lida
add_action('admin_notices', function() {
    // Solo mostrar en p√°ginas del plugin para administradores
    if (!current_user_can('manage_options')) return;
    
    if (SyncService::is_sync_invalid()) {
        ?>
        <div class="notice notice-error">
            <p>
                <strong>‚ö†Ô∏è Sincronizaci√≥n de Google Calendar detenida</strong><br>
                El token de autenticaci√≥n ha caducado o fue rechazado. 
                <a href="<?php echo esc_url(admin_url('admin.php?page=agenda-automatizada-settings')); ?>">
                    Dir√≠gete a la configuraci√≥n para reconectar tu cuenta de Google.
                </a>
            </p>
        </div>
        <?php
    }
});

// Crear p√°gina de configuraci√≥n en el men√∫ de WordPress
add_action('admin_menu', function() {
    add_menu_page(
        'Agenda Automatizada',
        'Agenda Automatizada',
        'manage_options',
        'agenda-automatizada-settings',
        'aa_render_settings_iframe_page',
        'dashicons-calendar-alt'
    );
});

// Render iframe container for settings page
function aa_render_settings_iframe_page() {
    $iframe_url = admin_url('admin-post.php?action=aa_iframe_content&module=settings');
    ?>
    <div class="wrap aa-iframe-wrapper" style="margin: 0; padding: 0;">
        <iframe 
            id="aa-settings-iframe"
            src="<?php echo esc_url($iframe_url); ?>"
            style="width: 100%; border: none; display: block;"
            scrolling="no"
        ></iframe>
    </div>
    <?php
}

// Registrar settings
add_action('admin_init', function() {
    register_setting('agenda_automatizada_settings', 'aa_schedule');
    register_setting('agenda_automatizada_settings', 'aa_slot_duration');
    register_setting('agenda_automatizada_settings', 'aa_future_window');
    register_setting('agenda_automatizada_settings', 'aa_google_email');
    register_setting('agenda_automatizada_settings', 'aa_google_motivo');
    register_setting('agenda_automatizada_settings', 'aa_timezone');
    register_setting('agenda_automatizada_settings', 'aa_business_name');
    register_setting('agenda_automatizada_settings', 'aa_business_address');
    register_setting('agenda_automatizada_settings', 'aa_is_virtual');
    register_setting('agenda_automatizada_settings', 'aa_whatsapp_number');
});

// Note: Settings page UI has been moved to includes/admin/ui/modules/settings/
// This file now only contains backend logic (register_setting, admin_post handlers, etc.)

// Guardar el email de Google al volver del backend
add_action('admin_post_aa_connect_google', function() {
    if (!current_user_can('manage_options')) return;

    $email = !empty($_GET['email']) ? $_GET['email'] : '';
    $secret = !empty($_GET['client_secret']) ? $_GET['client_secret'] : '';

    if ($email && $secret) {
        // Usar el servicio para manejar el √©xito del OAuth
        SyncService::handle_oauth_success($email, $secret);
    }

    wp_redirect(admin_url('admin.php?page=agenda-automatizada-settings'));
    exit;
});

// Desconectar Google
add_action('admin_post_aa_disconnect_google', function() {
    if (!current_user_can('manage_options')) return;

    // Notificar al backend sobre la desconexi√≥n (no rompe el flujo si falla)
    SyncService::notify_backend_disconnect_google();

    // Eliminar opciones de Google
    delete_option('aa_google_email');
    
    // Opcional: marcar sincronizaci√≥n como inv√°lida
    update_option('aa_estado_gsync', 'disconnected');
    
    wp_redirect(admin_url('admin-post.php?action=aa_iframe_content&module=settings'));
    exit;
});


// creacion de asistentes 
// ------------------------------------------------
// --------------------------------

// üîπ Secci√≥n para gesti√≥n de asistentes
function aa_render_asistentes_section() {
    if (!current_user_can('administrator')) return;

    if (isset($_POST['aa_crear_asistente'])) {
        // Verificar nonce de seguridad
        check_admin_referer('aa_crear_asistente_nonce');

        $nombre = sanitize_text_field($_POST['aa_nombre']);
        $email = sanitize_email($_POST['aa_email']);
        $password = sanitize_text_field($_POST['aa_password']);

        // Crear usuario de WordPress
        $user_id = wp_create_user($email, $password, $email);
        if (!is_wp_error($user_id)) {
            wp_update_user([
                'ID' => $user_id,
                'display_name' => $nombre,
                'role' => 'aa_asistente'
            ]);

            // Enviar correo de bienvenida
            $subject = 'Acceso a tu panel de asistente';
            $message = "Hola $nombre,\n\n".
                       "Se te ha creado una cuenta para acceder al panel de asistente.\n\n".
                       "Usuario: $email\n".
                       "Contrase√±a: $password\n".
                       "Accede aqu√≠: " . wp_login_url() . "\n\n".
                       "Por seguridad, cambia tu contrase√±a al iniciar sesi√≥n.";
            wp_mail($email, $subject, $message);

            echo '<div class="updated"><p>‚úÖ Asistente creado y notificado por correo.</p></div>';
        } else {
            echo '<div class="error"><p>‚ùå Error: '.$user_id->get_error_message().'</p></div>';
        }
    }

    if (isset($_POST['aa_inhabilitar_asistente'])) {
        // Verificar nonce de seguridad
        check_admin_referer('aa_inhabilitar_asistente_nonce');

        $id = intval($_POST['aa_user_id']);
        if ($id) {
            wp_update_user(['ID' => $id, 'role' => '']); // sin rol = inhabilitado
            echo '<div class="updated"><p>‚úÖ Asistente inhabilitado correctamente.</p></div>';
        }
    }

    // Obtener lista de asistentes
    $asistentes = get_users(['role' => 'aa_asistente']);
    ?>
    
    <header class="aa-section-header">
        <h2>üë• Gesti√≥n de Asistentes</h2>
        <p>Crea y administra las cuentas de los asistentes que pueden gestionar citas.</p>
    </header>

    <div class="aa-section-body">
        <!-- Formulario crear asistente -->
        <div class="aa-subsection aa-create-assistant">
            <h3 class="aa-subsection-title">Crear nuevo asistente</h3>
            <form method="post" class="aa-assistant-form">
                <?php wp_nonce_field('aa_crear_asistente_nonce'); ?>
                
                <div class="aa-field-group">
                    <label class="aa-field-label" for="aa_nombre">Nombre completo</label>
                    <div class="aa-field-control">
                        <input type="text" id="aa_nombre" name="aa_nombre" required placeholder="Ej: Mar√≠a Garc√≠a">
                    </div>
                </div>

                <div class="aa-field-group">
                    <label class="aa-field-label" for="aa_email">Correo electr√≥nico</label>
                    <div class="aa-field-control">
                        <input type="email" id="aa_email" name="aa_email" required placeholder="correo@ejemplo.com">
                    </div>
                </div>

                <div class="aa-field-group">
                    <label class="aa-field-label" for="aa_password">Contrase√±a</label>
                    <div class="aa-field-control">
                        <input type="text" id="aa_password" name="aa_password" required placeholder="Contrase√±a inicial">
                        <p class="aa-field-hint">El asistente recibir√° esta contrase√±a por correo.</p>
                    </div>
                </div>

                <div class="aa-form-actions">
                    <input type="submit" name="aa_crear_asistente" class="button button-primary" value="Crear Asistente">
                </div>
            </form>
        </div>

        <!-- Lista de asistentes activos -->
        <div class="aa-subsection aa-assistant-list">
            <h3 class="aa-subsection-title">Asistentes activos</h3>
            
            <?php if (empty($asistentes)): ?>
                <p class="aa-empty-state">No hay asistentes registrados.</p>
            <?php else: ?>
                <div class="aa-assistants-grid">
                    <?php foreach ($asistentes as $user): ?>
                        <div class="aa-assistant-card">
                            <div class="aa-assistant-info">
                                <span class="aa-assistant-name"><?php echo esc_html($user->display_name); ?></span>
                                <span class="aa-assistant-email"><?php echo esc_html($user->user_email); ?></span>
                                <span class="aa-assistant-date">Creado: <?php echo esc_html(date('d/m/Y', strtotime($user->user_registered))); ?></span>
                            </div>
                            <div class="aa-assistant-actions">
                                <form method="post">
                                    <?php wp_nonce_field('aa_inhabilitar_asistente_nonce'); ?>
                                    <input type="hidden" name="aa_user_id" value="<?php echo esc_attr($user->ID); ?>">
                                    <input type="submit" name="aa_inhabilitar_asistente" class="button aa-btn-disable" value="Inhabilitar" 
                                           onclick="return confirm('¬øEst√°s seguro de inhabilitar este asistente?');">
                                </form>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
        </div>
    </div>
    
    <?php
}

// Iframe auto-resize handler (parent window)
add_action('admin_footer', function () {
    $screen = get_current_screen();
    if (!$screen || $screen->id !== 'toplevel_page_agenda-automatizada-settings') {
        return;
    }
    ?>
    <script>
        (function () {
            'use strict';
            
            const iframe = document.getElementById('aa-settings-iframe');
            if (!iframe) return;

            window.addEventListener('message', function (event) {
                // Security: Only accept messages from same origin
                if (event.origin !== window.location.origin) return;

                if (event.data && event.data.type === 'aa-iframe-resize') {
                    const newHeight = event.data.height;
                    
                    // Only update if height actually changed (avoid unnecessary reflows)
                    if (iframe.style.height !== newHeight + 'px') {
                        iframe.style.height = newHeight + 'px';
                    }
                }
            });
        })();
    </script>
    <?php
});



========================================
FILE: views\templates\proximas-citas-template.php
========================================
<?php
/**
 * Template: Tabla de pr√≥ximas citas (AJAX)
 * 
 * Este template renderiza la secci√≥n de pr√≥ximas citas con:
 * - Filtros de b√∫squeda y ordenamiento
 * - Contenedor para carga din√°mica con AJAX
 * - Paginaci√≥n
 * 
 * JavaScript responsable: assets/js/ui/proximasCitasUI.js

 */

if (!defined('ABSPATH')) exit;
?>

<h2>Pr√≥ximas citas</h2>

<!-- ===============================
     üîπ FILTROS DE B√öSQUEDA
     =============================== -->
<div class="aa-historial-filtros">
    <input 
        type="text" 
        id="aa-buscar-proximas" 
        placeholder="Buscar por nombre, tel√©fono, correo o servicio..."
    >
    
    <select id="aa-ordenar-proximas">
        <option value="fecha_asc">M√°s pr√≥ximas primero</option>
        <option value="fecha_desc">M√°s lejanas primero</option>
        <option value="cliente_asc">Cliente (A-Z)</option>
        <option value="cliente_desc">Cliente (Z-A)</option>
        <option value="estado_asc">Estado (A-Z)</option>
        <option value="estado_desc">Estado (Z-A)</option>
    </select>
    
    <button id="aa-btn-buscar-proximas" class="aa-btn-nuevo-cliente">
        üîç Buscar
    </button>
    
    <button id="aa-btn-limpiar-proximas" class="aa-btn-cancelar-form">
        ‚úï Limpiar
    </button>
</div>

<!-- ===============================
     üîπ CONTENEDOR DE TABLA (Carga AJAX)
     =============================== -->
<div id="aa-proximas-container">
    <p style="text-align: center; color: #999;">
        ‚è≥ Cargando pr√≥ximas citas...
    </p>
</div>

<!-- ===============================
     üîπ PAGINACI√ìN (Generada din√°micamente)
     =============================== -->
<div class="aa-paginacion" id="aa-proximas-paginacion"></div>

